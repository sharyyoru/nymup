if (self.CavalryLogger) { CavalryLogger.start_js_script(document.currentScript); }/*FB_PKG_DELIM*/

__d("MAWAbPropsConverters",["MAWAbPropsTypes","WALogger"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["convertDbAbPropsToParsed: unsure how to read ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["convertAbPropsParsedToDbEntity: unsure how to read ",""]);i=function(){return a};return a}function a(a){var b={expoKeyStr:a.expoKeyStr,internalExpoKeys:a.internalExpoKeys?Array.from(a.internalExpoKeys):[],lastSyncTime:a.lastSyncTime,refresh:a.refresh};a.abHash!=null&&(b.abHash=a.abHash);a.abKey!=null&&(b.abKey=a.abKey);if(a.propExpoKeys){var c=a.propExpoKeys,e=[];Object.keys(c).forEach(function(a){a=Number(a);var b={expoKey:a};c[a]!=null&&(b.value=c[a]);e.push(b)});b.propExpoKeys=e}if(a.propValues){var f=a.propValues,g=[];Object.keys(f).forEach(function(a){var b={name:a,value:{}};switch(typeof f[a]){case"boolean":b.value.boolValue=f[a];break;case"number":b.value.intValue=f[a];break;case"string":b.value.strValue=f[a];break;default:d("WALogger").WARN(i(),f[a]);return}g.push(b)});b.propValues=g}return b}function b(a){var b={expoKeyStr:a.expoKeyStr,internalExpoKeys:a.internalExpoKeys,lastSyncTime:a.lastSyncTime,propExpoKeys:a.propExpoKeys,refresh:a.refresh};a.hash!=null&&(b.abHash=a.hash);a.abKey!=null&&(b.abKey=a.abKey);if(a.propValues){var c=a.propValues,e={};Object.keys(c).forEach(function(a){d("MAWAbPropsTypes").AbPropConfigs[a]!=null&&(e[a]=c[a])});b.propValues=e}return b}function c(a){var b=a.abKey,c=a.abHash,e=a.lastSyncTime,f=a.expoKeyStr,g=a.refresh,i=a.internalExpoKeys,j=a.propExpoKeys;a=a.propValues;b={abKey:b,abHash:c,lastSyncTime:e,refresh:g,expoKeyStr:f};i!=null&&(b.internalExpoKeys=new Set(i));if(j!=null){var k={};j.forEach(function(a){a.expoKey!=null&&(k[a.expoKey]=a.value)});b.propExpoKeys=k}if(a!=null){var l={};a.forEach(function(a){var b=a.name,c=d("MAWAbPropsTypes").AbPropConfigs[b];if(c==null||c.length<2)return;c=c[1];switch(typeof c){case"boolean":l[b]=a.value.boolValue;return;case"number":l[b]=a.value.intValue;return;case"string":l[b]=a.value.strValue;return;default:d("WALogger").WARN(h(),c);return}});b.propValues=l}return b}g.convertAbPropsParsedToDbEntity=a;g.convertAbPropsDataToParsed=b;g.convertDbAbPropsToParsed=c},98);
__d("MAWAbProps",["MAWAbPropsConverters","MAWAbPropsToUI","MAWAbPropsTypes","MAWBridge","MAWGlobals","Promise","WAAbProps","WAAbPropsCache","WAGlobals","WALogger","err","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["ABProps inited"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Starting ABProps store"]);i=function(){return a};return a}var j;function a(){if(!j)throw c("err")("Trying to get hash before AbProps gets initialized");return b("Promise").resolve(j.getHash())}function e(){if(!j)throw c("err")("Trying to get refresh secs before AbProps gets initialized");return b("Promise").resolve(j.getRefreshSecs())}var k={getHash:a,getRefreshSecs:e,getAbProps:function(){if(!j)throw c("err")("Trying to read ABProps before they gets initialized");return b("Promise").resolve(j.readAll())},setAbProps:function(a){var c,e;return b("regeneratorRuntime").async(function(f){while(1)switch(f.prev=f.next){case 0:e=d("MAWAbPropsConverters").convertAbPropsDataToParsed(a);(c=j)==null?void 0:c.rewrite(e);f.next=4;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().setAbProps(d("MAWAbPropsConverters").convertAbPropsParsedToDbEntity(e)));case 4:l(e);case 5:case"end":return f.stop()}},null,this)}};function l(a){if(!a.propValues)return;a=d("MAWAbPropsToUI").prepareAbPropsForUI(a.propValues);d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"ABPropsUpdated",value:a}]})}function f(){var a,c;return b("regeneratorRuntime").async(function(e){while(1)switch(e.prev=e.next){case 0:d("WALogger").LOG(i());if(!d("WAGlobals").getConfig().transactions.getAbProps){e.next=7;break}e.next=4;return b("regeneratorRuntime").awrap(d("WAGlobals").getTransactions().getAbProps());case 4:e.t0=e.sent;e.next=10;break;case 7:e.next=9;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().getAbProps());case 9:e.t0=e.sent;case 10:a=e.t0,c={},a&&a.abProps&&(c=d("MAWAbPropsConverters").convertDbAbPropsToParsed(a.abProps)),j=new(d("WAAbPropsCache").AbPropsCache)(c),d("WAAbProps").startAbProps(k,d("MAWAbPropsTypes").AbPropConfigs),l(c),d("WALogger").LOG(h());case 17:case"end":return e.stop()}},null,this)}function m(a,b){if(!j)throw c("err")("Trying to override ABProp before they get initialized");j.overrideAbProp(a,b);l(d("MAWAbPropsConverters").convertAbPropsDataToParsed(j.readAll()))}function n(){if(!j)throw c("err")("Trying to read ABProps before they get initialized");return j.readAll()}function o(a){if(!j)throw c("err")("Trying to read ABProp "+a+" before AbProps gets initialized");var b=j.getAbProp(a);return b!=null?b:d("MAWAbPropsTypes").getAbDefault(a)}g.getHash=a;g.getRefreshSecs=e;g.initAbProps=f;g.overrideAbProp=m;g.getAbProps=n;g.getAbProp=o},98);
__d("MAWDbAppDataTxns",["MAWAckLevel.re","WALogger"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["updateAppDataSystemAck on sent appData"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["updateAppDataSystemAck on non existing appData"]);i=function(){return a};return a}function a(a,b,c){return a.appData.get({externalId:b}).then(function(b){if(!b){d("WALogger").LOG(i());return null}if(b.ack>d("MAWAckLevel.re").ACK.clock){d("WALogger").LOG(h());return b}var e=babelHelpers["extends"]({},b,{ack:c});return a.appData.put(e).then(function(){return e})})}function b(a,b){return a.appData.bulkGet(b)}g.updateAppDataSystemAck=a;g.bulkGetAppData=b},98);
__d("MAWDbGroupInviteTxns",["MAWDbParticipant","MAWDexieTable","WAGlobals","WAJids","WAMsgType"],function(a,b,c,d,e,f,g){"use strict";function a(a,b){return a.groupInvites.bulkGet(b)}function b(a,b){return a.groupInvites.put(b).then(function(){return b})}function h(a,b,c){return a.groupInvites.where("invitedParticipantId").equals(c).filter(function(a){return a.inviterJid===b}).first()}function c(a,b){if(b.type===d("WAMsgType").MSG_TYPE.GROUP_INVITE){var c=b.author;b=d("MAWDbParticipant").craftParticipantId(b.thread,b.invitedParticipantUserJid);c=c===d("WAJids").AUTHOR_ME?d("WAGlobals").getMyUserJid():d("WAJids").authorAsUserJid(c);return!c?d("MAWDexieTable").dexieResolve():h(a,c,b)}else return d("MAWDexieTable").dexieResolve()}g.bulkGetGroupInvites=a;g.putGroupInvite=b;g.maybeGetGroupInvite=h;g.getAndCheckGroupInviteFromMsg=c},98);
__d("MAWDbPendingReceiptTxns",["MAWDbPendingReceipt","WAJids"],function(a,b,c,d,e,f,g){"use strict";function a(a,b){var c=b.map(function(a){var b=a.thread,c=a.externalId;a=a.author;return d("MAWDbPendingReceipt").craftPendingReceiptId(b,c,a)});return a.pendingReceipts.where("id").anyOf(c).toArray().then(function(c){var e=new Map();c.forEach(function(a){e.set(a.id,a)});var f=b.map(function(a){var b=a.thread,c=a.externalId,f=a.author,g=d("MAWDbPendingReceipt").craftPendingReceiptId(b,c,f),h=e.get(g),i=(h=h)!=null?h:{id:g,thread:b,externalId:c,author:f,deliveryReceipts:[],readReceipts:[]};f===d("WAJids").AUTHOR_ME?(a.deliveryReceipts.forEach(function(a){i.deliveryReceipts.push(a)}),a.readReceipts.forEach(function(a){i.readReceipts.push(a)})):(i.deliveryReceipts=[],a.readReceipts.forEach(function(a){i.readReceipts.push(a)}));return i});return a.pendingReceipts.bulkPut(f).then(function(){return f})})}function b(a,b){return a.pendingReceipts.bulkGet(b)}g.bulkAddPendingReceipts=a;g.getPendingReceipts=b},98);
__d("MAWDbPrekeyTxns",["MAWSignalUtils","err"],function(a,b,c,d,e,f,g){function a(a,b){return a.prekeyGeneration.get(b).then(function(b){if(b==null)throw c("err")("Expected a prekey generation row");b=d("MAWSignalUtils").getPrekeyIdsInRange(b.startingId,b.endingId);return h(a,b).then(function(a){return a.filter(Boolean).map(function(a){return a.encoded})})})}function b(a,b){return a.prekey.bulkDelete(b).then(function(){})}function h(a,b){return a.prekey.bulkGet(b)}function e(a,b){return a.prekeyGeneration.bulkGet(b)}g.getPrekeysForGeneration=a;g.bulkDeletePreKeys=b;g.getPrekeys=h;g.getPrekeyGenerations=e},98);
__d("MAWDbSenderKeySessionTxns",["WACryptoUtils","WAResultOrError"],function(a,b,c,d,e,f,g){"use strict";function a(a,b){var c=b.map(function(a){return a.id});return h(a,c).then(function(a){for(var c=0;c<a.length;c++){var e=a[c],f=b[c].record;if(e==null&&f==null||e!=null&&f!=null&&d("WACryptoUtils").uint8ArraysEqual(f,e.record))continue;else return d("WAResultOrError").makeError("mismatch")}return d("WAResultOrError").makeSuccess()})}function b(a,b){return a.senderKeySessions.bulkPut(b).then(function(){})}function c(a,b){return a.senderKeySessions.where("groupJid").equals(b)["delete"]()}function h(a,b){return a.senderKeySessions.bulkGet(b)}g.bulkCheckSenderKeySessionsMatch=a;g.bulkPutSenderKeySessions=b;g.deleteSenderKeysByGroupJid=c;g.getSenderKeySessionsBySenderKeySessionId=h},98);
__d("MAWDbSessionTxns",["WAResultOrError","WASignalOther"],function(a,b,c,d,e,f,g){function a(a,b){var c=b.map(function(a){return a.id});return h(a,c).then(function(a){for(var c=0;c<a.length;c++){var e=a[c]?d("WASignalOther").castToSessionHash(a[c].session.buffer):null,f=b[c].oldHash;if(e==null&&f==null||e!=null&&f!=null&&d("WASignalOther").areSessionHashesEqual(e,f))continue;return d("WAResultOrError").makeError("mismatch")}return d("WAResultOrError").makeSuccess()})}function b(a,b){return a.session.bulkPut(b).then(function(){})}function h(a,b){return a.session.bulkGet(b)}g.bulkCheckSessionsMatch=a;g.bulkSaveSessions=b;g.bulkGetSessions=h},98);
__d("MAWDbSignedPrekeyTxns",["MAWDbMetaTxns","err"],function(a,b,c,d,e,f,g){function a(a){return d("MAWDbMetaTxns").maybeGetLastSignedPrekeyId(a).then(function(b){if(b==null)throw c("err")("Last signed prekey id and signed prekey store should both have values or both be null");return a.signedPrekey.get({keyId:b}).then(function(a){if(a==null)throw c("err")("No signed prekey matches the lastSignedPrekeyId supplied");return a.encoded})})}function b(a,b){return a.signedPrekey.bulkGet(b)}g.getLatestSignedPreKey=a;g.getSignedPrekeys=b},98);
__d("MAWDebugMockCryptoManager",["Promise","WACryptoManager","WACryptoManagerUtils","WAGlobals","WALogger","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[DEBUG] cannot restore CryptoManager from debug. Please re-load the page"]);h=function(){return a};return a}var i=null,j=null,k;function l(){return b("Promise").resolve()}function a(){var a;return b("regeneratorRuntime").async(function(c){while(1)switch(c.prev=c.next){case 0:a=d("WAGlobals").getCryptoManager();i=a.db;if(j){c.next=6;break}c.next=5;return b("regeneratorRuntime").awrap(d("WACryptoManager").generateSignedPreKey(a));case 5:j=c.sent;case 6:k=d("WACryptoManagerUtils").decryptMsg,d("WACryptoManagerUtils").decryptMsg=function(a,c,d,e){return b("regeneratorRuntime").async(function(a){while(1)switch(a.prev=a.next){case 0:a.next=2;return b("regeneratorRuntime").awrap(e(d));case 2:return a.abrupt("return",{success:!0,value:void 0});case 3:case"end":return a.stop()}},null,this)},a.db={loadSession:l,saveSessionIfMatches:function(){return b("Promise").resolve({success:!0,value:void 0})},handleNewSessionIfMatches:function(){return b("Promise").resolve({success:!0,value:void 0})},loadSignedPreKey:function(){return b("Promise").resolve(null)},loadOneTimePreKey:function(){return b("Promise").resolve(null)},getLastPreKeyGenerationId:l,saveOneTimePreKeyIfMatches:function(){return b("Promise").resolve({success:!0,value:void 0})},savePreKeysGenerationIfMatches:function(){return b("Promise").resolve({success:!0,value:void 0})},getPreKeyGenerationsTimestamps:function(){return b("Promise").resolve([])},loadPreKeys:function(){if(j)return b("Promise").resolve({preKeys:[],signedPreKey:j});var a=new Error("Cannot return value from mocked LoadPreKeys");a.stack;throw a},updateDevicesForUser:l,loadLatestSignedPreKey:function(){return b("Promise").resolve(new Uint8Array())},loadSenderKeySession:function(){return b("Promise").resolve({success:!0,value:new Uint8Array()})},saveSenderKeySession:l,saveSenderKeySessionIfMatches:function(){return b("Promise").resolve({success:!0,value:void 0})},saveSignedPreKeyIfNew:function(){return b("Promise").resolve({type:"success"})}};case 9:case"end":return c.stop()}},null,this)}function c(){if(!i||!k){d("WALogger").ERROR(h());return}d("WACryptoManagerUtils").decryptMsg=k;var a=d("WAGlobals").getCryptoManager();a.db=i}g.mockCryptoManager=a;g.restoreCryptoManager=c},98);
__d("MAWConvertAppData",["WAAppData","WAArmadilloApplication.pb","WAJids","WALogger","WAStanzaUtils","WATimeUtils","err"],function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unknown appdata type: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["missing keys in EncryptedBackupsSecrets"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["status in EncryptedBackupsSecretsEpoch has invalid value"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["missing keys in EncryptedBackupsSecretsEpoch"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unknown appdata sync action type: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unknown appdata sync action type: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["No participant in messageKey in message action when it is group chat and message is not fromMe: ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Missing messageKey in message action: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unknown appdata sync action type: ",""]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["Missing chatId in chat actoin: ",""]);q=function(){return a};return a}function r(a){a=d("WAJids").interpretAndValidateJid(a);if(a.jidType==="msgrUser")return a.userJid;else if(a.jidType==="group")return a.groupJid;else{a.jidType;throw c("err")("Incorrect jid type: "+a.jidType)}}function s(a){a=d("WAJids").interpretAndValidateJid(a);if(a.jidType==="msgrUser")return a.userJid;else if(a.jidType==="msgrDevice")return d("WAJids").extractUserJid(a.deviceJid);else{a.jidType;throw c("err")("Incorrect jid type: "+a.jidType)}}function t(a){return a!=null?d("WATimeUtils").castLongIntToUnixTime(a):void 0}function u(a){return a==null?void 0:{lastMessageTimestamp:t(a.lastMessageTimestamp),lastSystemMessageTimestamp:t(a.lastSystemMessageTimestamp),messages:a.messages==null?[]:a.messages.map(function(a){return{ts:t(a.timestamp),key:a.key==null?void 0:{id:a.key.id,fromMe:a.key.fromMe}}})}}function v(a,b){var c=a.chatId;if(c==null){d("WALogger").WARN(q(),a);return null}if(a.chatArchive!=null){var e=a.chatArchive;e=u(e.messageRange);return{type:"chat_archive",chatJid:r(c),ts:b,messageRange:e}}else if(a.chatDelete!=null){e=a.chatDelete;e=u(e.messageRange);return{type:"chat_delete",chatJid:r(c),ts:b,messageRange:e}}else if(a.chatRead!=null){e=a.chatRead;var f=u(e.messageRange);return{type:"chat_read",chatJid:r(c),read:e.read,ts:b,messageRange:f}}else{d("WALogger").WARN(p(),a);return null}}function w(a){var b=a.key,c=b==null?void 0:b.remoteJid,e=b==null?void 0:b.id,f=b==null?void 0:b.fromMe;if(b==null||c==null||f==null||e==null){d("WALogger").WARN(o(),a);return null}var g=r(c),h=d("WAJids").interpretAsGroupJid(g)!=null;if(h&&!f){if((b==null?void 0:b.participant)==null){d("WALogger").WARN(n(),a);return null}h=s(b.participant)}else f?h=d("WAJids").AUTHOR_ME:h=s(c);b={chat:g,author:h,externalId:d("WAStanzaUtils").toStanzaId(e)};if(a.messageDelete!=null)return{type:"delete_for_me",protocolMsgId:b};else{d("WALogger").WARN(m(),a);return null}}function x(a){var b=[];for(var c=0;c<a.length;c++){var e=a[c],f=t(e.actionTimestamp);if(e.chatAction!=null){f=v(e.chatAction,f);f!=null&&b.push({chatAction:f})}else if(e.messageAction!=null){f=w(e.messageAction);f!=null&&b.push({messageAction:f})}else d("WALogger").WARN(l(),e)}return b}function y(a){var b=a.status,c=a.id,e=a.anonId;a=a.rootKey;if(b==null||c==null||e==null||a==null){d("WALogger").WARN(k());return null}var f;if(b===d("WAArmadilloApplication.pb").ARMADILLO_SIGNAL_ENCRYPTED_BACKUPS_SECRETS_EPOCH_EPOCHSTATUS.ES_OPEN)f=d("WAAppData").EPOCH_STATUS_OPEN;else if(b===d("WAArmadilloApplication.pb").ARMADILLO_SIGNAL_ENCRYPTED_BACKUPS_SECRETS_EPOCH_EPOCHSTATUS.ES_CLOSE)f=d("WAAppData").EPOCH_STATUS_CLOSE;else{d("WALogger").WARN(j());return null}return{id:c,anonId:e,rootKey:a,status:f}}function z(a){var b=a.backupId,c=a.serverDataId,e=a.tempOcmfClientState,f=a.mailboxRootKey,g=a.obliviousValidationToken;a=a.epoch;if(b==null||c==null||e==null||f==null||g==null){d("WALogger").WARN(i());return null}return{backupId:b,serverDataId:c,tempOcmfClientState:e,mailboxRootKey:f,obliviousValidationToken:g,epoch:a.map(y).reduce(function(a,b){if(b!=null)return a.concat([b]);else return a},[])}}function a(a){var b;if(((b=a.applicationData)==null?void 0:(b=b.metadataSync)==null?void 0:b.actions)!=null){return{type:"meta_sync",actions:x((b=a.applicationData)==null?void 0:(b=b.metadataSync)==null?void 0:b.actions)}}else if(((b=a.signal)==null?void 0:b.encryptedBackupsSecrets)!=null){b=z(a.signal.encryptedBackupsSecrets);return b==null?null:{type:"backups_secrets",encryptedBackupsSecrets:b}}else{d("WALogger").WARN(h(),a);return null}}function A(a){return a==null?void 0:{lastMessageTimestamp:a.lastMessageTimestamp,lastSystemMessageTimestamp:a.lastSystemMessageTimestamp,messages:a.messages.map(function(a){return{timestamp:a.ts,key:a.key==null?void 0:{id:a.key.id,fromMe:a.key.fromMe}}})}}function b(a){if(a.type==="meta_sync")return{applicationData:D(a)};else{a.type;return{signal:{encryptedBackupsSecrets:B(a.encryptedBackupsSecrets)}}}}function B(a){return{backupId:a.backupId,serverDataId:a.serverDataId,epoch:a.epoch.map(C),tempOcmfClientState:a.tempOcmfClientState,mailboxRootKey:a.mailboxRootKey,obliviousValidationToken:a.obliviousValidationToken}}function C(a){var b;a.status===d("WAAppData").EPOCH_STATUS_OPEN?b=d("WAArmadilloApplication.pb").ARMADILLO_SIGNAL_ENCRYPTED_BACKUPS_SECRETS_EPOCH_EPOCHSTATUS.ES_OPEN:a.status===d("WAAppData").EPOCH_STATUS_CLOSE&&(b=d("WAArmadilloApplication.pb").ARMADILLO_SIGNAL_ENCRYPTED_BACKUPS_SECRETS_EPOCH_EPOCHSTATUS.ES_CLOSE);return{id:a.id,anonId:a.anonId,rootKey:a.rootKey,status:b}}function D(a){return{metadataSync:{actions:a.actions.map(function(a){if(a.chatAction)return{actionTimestamp:a.chatAction.ts,chatAction:E(a.chatAction)};else return{messageAction:F(a.messageAction)}})}}}function E(a){var b=A(a.messageRange),c=a.chatJid;switch(a.type){case"chat_archive":return{chatId:c,chatArchive:{archived:a.archived,messageRange:b}};case"chat_delete":return{chatId:c,chatDelete:{messageRange:b}};default:a.type;return{chatId:c,chatRead:{read:a.read,messageRange:b}}}}function F(a){if(a.type==="delete_for_me"){var b=a.protocolMsgId.chat,e=d("WAJids").interpretAsGroupJid(b)!=null;return{messageDelete:{},key:{remoteJid:b,fromMe:d("WAJids").isAuthorMe(a.protocolMsgId.author),participant:!d("WAJids").isAuthorMe(a.protocolMsgId.author)&&e?a.protocolMsgId.author:void 0,id:a.protocolMsgId.externalId}}}else throw c("err")("No other available type")}g.parseAppData=a;g.convertAppData=b},98);
__d("MAWHandleAppDataUtil",["MAWConvertAppData","MAWGlobals","Promise","WAArmadilloApplication.pb","WAComms","WACryptoManagerUtils","WALogger","WAMsgApplication.pb","WAMsgTransport.pb","WAParseMessageApplication","WAParseMessageTransport","WAReceiptUtils","WAResultOrError","WAWap","decodeProtobuf","err","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleAppdata ",""]);h=function(){return a};return a}function a(a){var e,f,g,l,m;return b("regeneratorRuntime").async(function(n){while(1)switch(n.prev=n.next){case 0:d("WALogger").DEV(h(),a);e=a.from,f=a.encs;if(!(f.length!==1)){n.next=4;break}throw c("err")("Appdata should contain one message, this one has: "+f.length);case 4:g=f[0];n.next=7;return b("regeneratorRuntime").awrap(i(g,e));case 7:l=n.sent;if(l.success){n.next=13;break}n.next=11;return b("regeneratorRuntime").awrap(k(a));case 11:n.next=25;break;case 13:m=d("MAWConvertAppData").parseAppData(l.value);if(!(m!=null)){n.next=23;break}if(!(m.type==="meta_sync")){n.next=20;break}n.next=18;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().writeMetaSyncs(m.actions));case 18:n.next=23;break;case 20:m.type;n.next=23;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().handleEncryptedBackupsSecret(m.encryptedBackupsSecrets));case 23:n.next=25;return b("regeneratorRuntime").awrap(j(a));case 25:return n.abrupt("return","NO_ACK");case 26:case"end":return n.stop()}},null,this)}function i(a,e){var f,g;return b("regeneratorRuntime").async(function(h){while(1)switch(h.prev=h.next){case 0:if(!(a.e2eType==="skmsg")){h.next=2;break}throw c("err")("Appdata should not contain skmsg encs");case 2:f=null;h.next=5;return b("regeneratorRuntime").awrap(d("WACryptoManagerUtils").decryptMsg(a.e2eType,e,a.ciphertext,function(a,e){e=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMsgTransport.pb").MessageTransportSpec,a);a=d("WAParseMessageTransport").parseMessageTransport(e,null);if(a.type!=="applicationPayload")throw c("err")("Appdata contains unexpected message transport.");e=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMsgApplication.pb").MessageApplicationSpec,a.applicationPayload.payload);a=d("WAParseMessageApplication").parseMessageApplication(e);if(a.type==="error")throw c("err")("Appdata contains unparseable message application.");if(a.subprotocolType!=="armadillo")throw c("err")("Appdata contains unexpected message application: "+a.subprotocolType);e=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAArmadilloApplication.pb").ArmadilloSpec,a.payload);if(e.payload==null)throw c("err")("Appdata contains unparseable armadillo data.");f=e.payload;return b("Promise").resolve()},a.retryCount));case 5:g=h.sent;if(!(f!=null)){h.next=8;break}return h.abrupt("return",d("WAResultOrError").makeSuccess(f));case 8:if(!g.success){h.next=10;break}throw c("err")("Failed to parse appdata for unknown reason.");case 10:return h.abrupt("return",d("WAResultOrError").makeError("identity-missing"));case 11:case"end":return h.stop()}},null,this)}function j(a){var b=a.externalId;a=a.from;d("WAComms").castStanza(d("WAWap").wap("receipt",{id:d("WAWap").CUSTOM_STRING(b),to:d("WAWap").DEVICE_JID(a),category:"peer_appdata"}))}function k(a){var b=a.externalId,c=a.ts,e=a.from;a=a.encs;return d("WAReceiptUtils").sendRetryReceipt({externalId:b,ts:c,from:{type:"device",deviceJid:e},retryCount:a[0].retryCount,participant:null,recipient:null,category:"peer_appdata"})}g.handleParsedAppData=a},98);
__d("MAWHandleAppData",["MAWHandleAppDataUtil","WAParseEnc","WAServerJob","WAStanzaUtils","WAWapParser","err"],function(a,b,c,d,e,f,g){"use strict";a=new(d("WAWapParser").WapParser)("appdataParser",function(a){a.assertTag("appdata");var b=a.attrJidWithType();if(b.jidType!=="msgrDevice")throw c("err")("Incorrect from type in appdata message: "+b.jidType);return{externalId:d("WAStanzaUtils").toStanzaId(a.attrString("id")),from:b.deviceJid,ts:a.attrTime("t"),encs:a.mapChildrenWithTag("enc",d("WAParseEnc").parseEncNode)}});b=d("WAServerJob").defineServerJob("handleAppdata",a,d("MAWHandleAppDataUtil").handleParsedAppData);g.handleAppdata=b},98);
__d("MAWHandleChatState",["MAWBridge","MAWBridgeTypes","MAWGlobals","Promise","WAHandleChatState","WALogger","WAServerJob","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleChatStatus status for ",": ",""]);h=function(){return a};return a}c=d("WAServerJob").defineServerJob("handleChatState",d("WAHandleChatState").chatStateParser,a);function a(a){var c,e,f;return b("regeneratorRuntime").async(function(g){while(1)switch(g.prev=g.next){case 0:d("WALogger").LOG(h(),a.jid,a.status);g.next=3;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().getThreadIdByJid(a.jid));case 3:c=g.sent;c!=null&&(e=a.type==="user"?a.jid:a.participant,f={tag:"ReceivedChatState",value:d("MAWBridgeTypes").createBridgeReceivedChatState(c,e,a.status)},d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[f]}));return g.abrupt("return",b("Promise").resolve("NO_ACK"));case 6:case"end":return g.stop()}},null,this)}g.handleChatState=c},98);
__d("MAWRotateCAT",["MAWBridge","MAWDeviceRegistrationTypes","MAWGlobals","WAArrayBufferUtils","WALogger","WAPromiseRetryLoop","WARetryUtils","regeneratorRuntime"],function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Rotate CAT finished, ending rotate CAT promise retry loop"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unable to rotate CAT"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["CAT Finished Rotating"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Starting rotate CAT Task Bridge event"]);l=function(){return a};return a}function m(){d("WALogger").LOG(l());return d("MAWBridge").getBridge().sendAndReceive("event","rotateCryptoAuthToken",{}).then(function(a){d("MAWGlobals").setFbCat(d("WAArrayBufferUtils").stringToArrayBuffer(a.encrypted_serialized_cat));d("WALogger").LOG(k());return!0})["catch"](function(a){d("WALogger").WARN(j(),a);return!1})}function a(){var a=0,c=new(d("WAPromiseRetryLoop").PromiseRetryLoop)({name:"rotateCAT",timer:d("WARetryUtils").FIBONACCI_BACKOFF,code:function(c){var e;return b("regeneratorRuntime").async(function(f){while(1)switch(f.prev=f.next){case 0:a===d("MAWDeviceRegistrationTypes").MAX_ROTATE_CRYPTO_AUTH_TOKEN_RETRIES&&d("WALogger").ERROR(i());f.next=3;return b("regeneratorRuntime").awrap(m());case 3:e=f.sent,e&&(d("WALogger").LOG(h()),c()),a++;case 6:case"end":return f.stop()}},null,this)}});c.start();return c.promise()}g.rotateCAT=m;g.tryRotateCAT=a},98);
__d("MAWHandleFailure",["MAWRotateCAT","Promise","WAHandleFailure","WAHandleFailureUtils","WALogger","WAServerJob","regeneratorRuntime"],function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["failure reason "," not implemented yet"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleFailure: got failure code ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Crypto auth token Error: ",", rotating CAT"]);j=function(){return a};return a}function a(a){return b("regeneratorRuntime").async(function(c){while(1)switch(c.prev=c.next){case 0:c.t0=a.reason;c.next=c.t0===d("WAHandleFailureUtils").FAILURE_CODES.GENERIC_FAILURE?3:c.t0===d("WAHandleFailureUtils").FAILURE_CODES.NOT_AUTHORIZED?3:c.t0===d("WAHandleFailureUtils").FAILURE_CODES.TEMP_BANNED?3:c.t0===d("WAHandleFailureUtils").FAILURE_CODES.BANNED?3:c.t0===d("WAHandleFailureUtils").FAILURE_CODES.NOT_FOUND?3:c.t0===d("WAHandleFailureUtils").FAILURE_CODES.CAT_EXPIRED?6:c.t0===d("WAHandleFailureUtils").FAILURE_CODES.CAT_INVALID?6:c.t0===d("WAHandleFailureUtils").FAILURE_CODES.INTERNAL_ERROR?10:12;break;case 3:c.next=5;return b("regeneratorRuntime").awrap(d("WAHandleFailureUtils").deregisterPhone());case 5:return c.abrupt("break",14);case 6:d("WALogger").WARN(j(),a.reason);c.next=9;return b("regeneratorRuntime").awrap(d("MAWRotateCAT").rotateCAT());case 9:return c.abrupt("break",14);case 10:d("WALogger").WARN(i(),a.reason);return c.abrupt("break",14);case 12:d("WALogger").WARN(h(),a.reason);return c.abrupt("return",b("Promise").reject("failure reason "+a.reason+" not implemented yet"));case 14:return c.abrupt("return",b("Promise").resolve("NO_ACK"));case 15:case"end":return c.stop()}},null,this)}c=d("WAServerJob").defineServerJob("handleFailure",d("WAHandleFailure").failureParser,a);g.handleFailure=c},98);
__d("MAWHandleThreadNotification",["MAWFolderTypes","MAWGlobals","Promise","WALogger","WAWap","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleThreadNotification (",") unknown thread action"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleThreadNotification (",") connected"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleThreadNotification (",") with folder id ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleThreadNotification with jid: ",""]);k=function(){return a};return a}function a(a){var c,e,f;return b("regeneratorRuntime").async(function(g){while(1)switch(g.prev=g.next){case 0:c=a.id,e=a.chatJid,f=a.actions;d("WALogger").LOG(k(),c);g.next=4;return b("regeneratorRuntime").awrap(b("Promise").all(f.map(function(a){var f,g;return b("regeneratorRuntime").async(function(k){while(1)switch(k.prev=k.next){case 0:if(!(a.type==="folder")){k.next=7;break}g=(f=a.folderId)!=null?f:d("MAWFolderTypes").FOLDER_ID.INBOX;d("WALogger").LOG(j(),c,g);k.next=5;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().updateThreadFolder(e,g));case 5:k.next=14;break;case 7:if(!(a.type==="connected")){k.next=13;break}d("WALogger").LOG(i(),c);k.next=11;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().handleConnectedAdminMsg(e));case 11:k.next=14;break;case 13:d("WALogger").ERROR(h(),c);case 14:case"end":return k.stop()}},null,this)})));case 4:return g.abrupt("return",d("WAWap").wap("ack",{id:d("WAWap").CUSTOM_STRING(c),"class":"notification",to:d("WAWap").S_WHATSAPP_NET,type:d("WAWap").CUSTOM_STRING("fbid:thread")}));case 5:case"end":return g.stop()}},null,this)}g.handleThreadNotification=a},98);
__d("MAWHandleNotification",["MAWHandleThreadNotification","WAHandleNotification"],function(a,b,c,d,e,f,g){"use strict";a=d("WAHandleNotification").createHandleNotification({handleThreadNotification:d("MAWHandleThreadNotification").handleThreadNotification});g.handleNotification=a},98);
__d("MAWConstants",[],function(a,b,c,d,e,f){"use strict";a=5;f.MESSAGE_RETRY_COUNT_LIMIT=a},66);
__d("MAWSendAppDataUtils",["MAWBridge","MAWConvertAppData","MAWGlobals","MAWJobDefinitions","WAArmadilloApplication.pb","WAComms","WAEncUserMsg","WALogger","WAOdsEnums","WAWap","WAWapParser","encodeProtobuf","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Got phash mismatch on appdata, local[","] server[","]"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["MAWSendAppData Failed to encrypt appdata"]);i=function(){return a};return a}function a(a,c,e,f,g){var l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B;return b("regeneratorRuntime").async(function(C){while(1)switch(C.prev=C.next){case 0:l=d("encodeProtobuf").encodeProtobuf(d("WAArmadilloApplication.pb").ArmadilloSpec,{payload:d("MAWConvertAppData").convertAppData(a)});m={payload:{subProtocol:{armadillo:{payload:l.readByteArray(),version:1}}}};n=null;o=null;p=null;q=null;if(!(f==null)){C.next=17;break}r=Array.from(e.entries()).map(function(a){var b=a[0];a=a[1];return{identity:a.pubKey,jid:b}});s=[{devicesInfo:r,user:d("MAWGlobals").getMyUserJid()}];C.next=11;return b("regeneratorRuntime").awrap(d("WAEncUserMsg").encryptUserMsg(s,{type:"appdata",messageApplication:m,version:"v3"},[]));case 11:t=C.sent;n=g===!0?null:t.phash;o=t.participants;p=d("WAWap").USER_JID(d("MAWGlobals").getMyUserJid());C.next=24;break;case 17:u=f.to,v=f.encProps,w=f.sessionInfo,x=f.identityKey;C.next=20;return b("regeneratorRuntime").awrap(d("WAEncUserMsg").encryptDeviceJidMessage(u,{type:"appdata",messageApplication:m,version:"v3"},v,w,x));case 20:y=C.sent,p=d("WAWap").DEVICE_JID(u),o=y==null?void 0:y.node,q=y==null?void 0:y.baseKey;case 24:if(!(o==null)){C.next=27;break}d("WALogger").LOG(i());return C.abrupt("return",{type:"error"});case 27:z=j(c,p,o,n!=null);C.next=30;return b("regeneratorRuntime").awrap(d("WAComms").sendStanzaAndReturnAck(z,{id:c,"class":"appdata",from:f==null?d("MAWGlobals").getMyUserJid():f.to,participant:null}));case 30:A=C.sent;B=k.parse(A);if(!B.success){C.next=41;break}if(!(B.success.phash!=null&&n!=null&&B.success.phash!==n)){C.next=38;break}d("WALogger").LOG(h(),n,B.success.phash);d("MAWBridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:d("WAOdsEnums").Entity.PHASH_MISMATCH,key:"appdata"});C.next=38;return b("regeneratorRuntime").awrap(d("MAWGlobals").getJobManager().waitUntilPersisted(d("MAWJobDefinitions").jobSerializers.resendWrittenAppData(c)));case 38:return C.abrupt("return",{type:"success",baseKey:q});case 41:return C.abrupt("return",{type:"error"});case 42:case"end":return C.stop()}},null,this)}function j(a,b,c,e){return d("WAWap").wap("appdata",{to:b,category:"peer",id:d("WAWap").CUSTOM_STRING(a),device_list_check:e?"true":"false"},c)}var k=new(d("WAWapParser").WapParser)("sendAppData",function(a){a.assertTag("ack");return{t:a.maybeAttrInt("t"),phash:a.maybeAttrString("phash")}});g.sendAppData=a},98);
__d("MAWHandleRetryRequest",["MAWConstants","MAWGlobals","MAWQplProxy","MAWSendAppDataUtils","WACryptoManagerUtils","WACryptoUtils","WAJids","WALogger","WAPreKeysStanzaUtils","WASendMsgUtil","WAServerJob","WAStanzaUtils","WAWap","WAWapParser","err","qpl","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleRetryRequest denied with type "," id: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleRetryRequest denied with type ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unknown receipt category: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleRetryRequest denied due to retry count ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleRetryRequest called ",""]);l=function(){return a};return a}e=new(d("WAWapParser").WapParser)("receipt",function(a){a.assertTag("receipt");a.assertAttr("type","retry");var b=null;a.hasChild("keys")&&(b=babelHelpers["extends"]({regId:a.child("registration").contentUint(4)},d("WAPreKeysStanzaUtils").readSessionInfo(a.child("keys"))));var c=a.child("retry");return{externalId:d("WAStanzaUtils").toStanzaId(a.attrString("id")),from:a.attrFromJidChat(),retryCount:c.hasAttr("count")?c.attrInt("count"):0,timestamp:c.attrTime("t"),regId:a.child("registration").contentUint(4),offline:a.hasAttr("offline"),keys:b,recipient:a.maybeAttrUserJid("recipient"),category:a.maybeAttrString("category")}});function a(a){var e,f,g,h,o,p,q,r,s,t,u,v,w,x,y;return b("regeneratorRuntime").async(function(z){while(1)switch(z.prev=z.next){case 0:e=a.externalId,f=a.from,g=a.retryCount;d("WALogger").LOG(l(),e);h=d("WAWap").wap("ack",{id:d("WAWap").CUSTOM_STRING(e),to:d("WAWap").TO_JID(f),participant:d("WAWap").PARTICIPANT_JID(f),"class":"receipt",type:"retry"});if(!(g>=d("MAWConstants").MESSAGE_RETRY_COUNT_LIMIT)){z.next=7;break}d("WALogger").LOG(k(),g);d("MAWQplProxy").startQplUserFlow(c("qpl")._(25308942,"164"),{"int":{retries:g}}).endFail("retry-count");return z.abrupt("return",h);case 7:d("MAWQplProxy").startQplUserFlow(c("qpl")._(25308942,"164"),{"int":{retries:g}}).endSuccess();if(!(a.category==="peer_appdata"||a.category==="peer")){z.next=12;break}z.next=11;return b("regeneratorRuntime").awrap(m(a));case 11:return z.abrupt("return",h);case 12:if(!(a.category!=null)){z.next=15;break}d("WALogger").WARN(j(),a.category);return z.abrupt("return",h);case 15:o=f.chat;if(!(f.type==="device"&&d("WAJids").extractUserJid(f.author)===d("WAJids").extractUserJid(d("MAWGlobals").getMyDeviceJid()))){z.next=21;break}p=a.recipient;if(!(p==null)){z.next=20;break}throw c("err")("Received retry request from peer without recipient set");case 20:o=p;case 21:q={chat:o,author:"@me",externalId:e};z.next=24;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().getMsgForRetry(q,f.author));case 24:r=z.sent;if(!(r.type!=="unacked")){z.next=28;break}d("WALogger").LOG(i(),r.type);return z.abrupt("return",h);case 28:if(!(f.type==="group")){z.next=31;break}z.next=31;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().markParticipantNeedsKey(f.chat,f.author));case 31:s=r.messageType,t=r.protocolMsgId,u=r.deviceIdentity,v=r.messageApplication;z.next=34;return b("regeneratorRuntime").awrap(n(a,u));case 34:w=z.sent;z.next=37;return b("regeneratorRuntime").awrap(d("WASendMsgUtil").sendMessage({type:"direct",chat:o,to:f.author,externalId:e,messageApplication:v,messageType:s,protocolMsgId:t,encProps:{count:g},sessionInfo:w,identityKey:u.pubKey,version:"v3"}));case 37:x=z.sent;if(!(g>=2&&x.type==="success"&&x.baseKey!=null)){z.next=42;break}y=x.baseKey;z.next=42;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().writeMsgRetry(q,f.author,y));case 42:return z.abrupt("return",h);case 43:case"end":return z.stop()}},null,this)}function m(a){var c,e,f,g,i,j,k,l,m,o;return b("regeneratorRuntime").async(function(p){while(1)switch(p.prev=p.next){case 0:c=a.externalId,e=a.from,f=a.retryCount;p.next=3;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().getAppDataForRetry(c,e.author));case 3:g=p.sent;if(!(g.type!=="unacked")){p.next=7;break}d("WALogger").LOG(h(),g.type,c);return p.abrupt("return");case 7:i=g.appData,j=g.permittedIdentitiesPerDevice,k=g.deviceIdentity;p.next=10;return b("regeneratorRuntime").awrap(n(a,k));case 10:l=p.sent;p.next=13;return b("regeneratorRuntime").awrap(d("MAWSendAppDataUtils").sendAppData(i,c,j,{to:e.author,encProps:{count:f},sessionInfo:l,identityKey:k.pubKey}));case 13:m=p.sent;if(!(f>=2&&m.type==="success"&&m.baseKey!=null)){p.next=18;break}o=m.baseKey;p.next=18;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().writeAppDataRetry(c,e.author,o));case 18:case"end":return p.stop()}},null,this)}function n(a,c){var e,f,g,h,i,j,k;return b("regeneratorRuntime").async(function(l){while(1)switch(l.prev=l.next){case 0:e=void 0;l.next=3;return b("regeneratorRuntime").awrap(d("WACryptoManagerUtils").getParticipantInfo(a.from.author));case 3:f=l.sent;a.keys!=null?((g=a.keys,h=a.timestamp),i={keys:g,timestamp:h,baseKey:c.baseKey},j=o(a,f),j?e={type:"compareTSAndUseSession",session:i}:e={type:"useSession",session:i}):(k=f==null||a.regId!==f.regId,k&&(e={type:"requestNewSession"}));return l.abrupt("return",e);case 6:case"end":return l.stop()}},null,this)}function o(a,b){if(!a.offline)return!1;var c=b==null||a.regId!==b.regId;b=b!=null&&a.keys!=null&&!d("WACryptoUtils").uint8ArraysEqual(b.pubKey,a.keys.identity);return c||b}f=d("WAServerJob").defineServerJob("handleRetryRequest",e,a);g.handleRetryRequest=f},98);
__d("MAWHandleStanza",["MAWHandleAppData","MAWHandleChatState","MAWHandleFailure","MAWHandleNotification","MAWHandleRetryRequest","WACacheHandler","WAHandleIncomingMsg","WAHandleReceipt","WAHandleStanza","WAHandleStreamError"],function(a,b,c,d,e,f,g){"use strict";var h=new(d("WACacheHandler").CacheHandler)(d("WAHandleReceipt").handleBulkReceipts,d("WAHandleIncomingMsg").handleBulkMsgs,d("MAWHandleNotification").handleNotification),i={message:function(a){return h.handleStanza(a,d("WAHandleIncomingMsg").handleMsg,"online")},messageOffline:function(a){return h.handleStanza(a,d("WAHandleIncomingMsg").handleMsg,"offline")},notification:function(a){return h.handleStanza(a,d("MAWHandleNotification").handleNotification,"online")},notificationOffline:function(a){return h.handleStanza(a,d("MAWHandleNotification").handleNotification,"offline")},receipt:function(a){return h.handleStanza(a,d("WAHandleReceipt").handleReceipt,"online")},receiptOffline:function(a){return h.handleStanza(a,d("WAHandleReceipt").handleReceipt,"offline")},retryReceipt:function(a){return h.handleStanza(a,d("MAWHandleRetryRequest").handleRetryRequest,"online")},appData:d("MAWHandleAppData").handleAppdata,chatState:d("MAWHandleChatState").handleChatState,failure:d("MAWHandleFailure").handleFailure,streamError:function(a){return d("WAHandleStreamError").handleStreamError(a,h)}};function a(a){return d("WAHandleStanza").handleStanza(a,i,h)}g.orchestrator=h;g.handleStanza=a},98);
__d("MAWDebugOfflineMessages",["MAWAsMessageApplication","MAWDbMsg","MAWDebugMockCryptoManager","MAWHandleStanza","MAWJids","WAAsMessageTransport","WAExternalIdFromRandomHex","WAGlobals","WAHex","WALogger","WAMsgTransport.pb","WAMsgType","WATimeUtils","WAWap","encodeProtobuf","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["generateOfflineMsgTraffic usage:\nDebug.generateOfflineMsgTraffic(\n  [\n    {\n      type: 'msg',\n      sender: UserJid,\n      thread: ChatId,\n      count: number,\n    }\n  ]\n);\nExample:\nDebug.generateOfflineMsgTraffic(\n  [\n    {\n      type: 'msg',\n\n      // Put your test user jid and thread here:\n      sender: '59982010005371:1@msgr',\n      thread: 2,\n\n      count: 1000,\n    },\n    {\n      type: 'msg',\n      // Put your test user jid and thread here:\n      sender: '59982010005371:1@msgr',\n      thread: 2,\n\n      count: 200,\n    },\n  ]);\n    "]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Offline stanzas are sent. Do not forget to unmock the crypto manager by calling: Debug.restoreCryptoManager()"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Stanzas generated: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Wrapping stanzas into offline_preview"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["mockOfflineTraffic: generated "," msgs for ",""]);l=function(){return a};return a}function m(a,b,c,e){var f=[];for(var g=0;g<b;g++){var h=g+1,i=n(a,"mock message-"+h,c,e);f.push(i);h%100===0&&d("WALogger").LOG(l(),h,String(a))}return f}function a(a){var c,e,f,g,h;return b("regeneratorRuntime").async(function(l){while(1)switch(l.prev=l.next){case 0:if(a){l.next=3;break}o();return l.abrupt("return");case 3:l.next=5;return b("regeneratorRuntime").awrap(d("MAWDebugMockCryptoManager").mockCryptoManager());case 5:c=[];for(e=0;e<a.length;e++)f=a[e],g=m(f.sender,f.count,f.thread,f.chatJid),c=[].concat(c,g);d("WALogger").LOG(k());h=c.length;c.unshift(p(h));c.push(q(h));d("WALogger").LOG(j(),c);c.forEach(function(a){d("MAWHandleStanza").handleStanza(a)});d("WALogger").LOG(i());case 14:case"end":return l.stop()}},null,this)}function n(a,b,c,e){var f=d("WAGlobals").getMyDeviceJid(),g=d("WAExternalIdFromRandomHex").externalIdFromRandomHex(d("WAHex").randomHex(16)),h=d("WATimeUtils").unixTime();c={rowId:999,ts:h,externalId:g,msgId:d("MAWDbMsg").craftMsgId(1,2),thread:c,threadJid:e,author:a,ack:0,type:d("WAMsgType").MSG_TYPE.TEXT,msgContent:{content:b},altIndex:null};e=d("MAWAsMessageApplication").asMessageApplication(c,null);b=d("WAAsMessageTransport").asMessageTransport(e,null);c=d("encodeProtobuf").encodeProtobuf(d("WAMsgTransport.pb").MessageTransportSpec,b).readByteArray();e=d("WAWap").wap("enc",{v:d("WAWap").CUSTOM_STRING("3"),type:d("WAWap").CUSTOM_STRING("msg")},c);return d("WAWap").wap("message",{from:d("WAWap").CUSTOM_STRING(a),id:d("WAWap").CUSTOM_STRING(g),to:d("WAWap").TO_WAP_JID({deviceJid:d("MAWJids").unsafeCoerceToMsgrDeviceJid(f),jidType:"msgrDevice"}),type:d("WAWap").CUSTOM_STRING("text"),t:d("WAWap").INT(h),offline:d("WAWap").CUSTOM_STRING(String(1))},e)}function o(){d("WALogger").LOG(h())}function p(a){return d("WAWap").wap("ib",{from:d("WAWap").S_WHATSAPP_NET},d("WAWap").wap("offline_preview",{count:d("WAWap").INT(a)}))}function q(a){return d("WAWap").wap("ib",{from:d("WAWap").S_WHATSAPP_NET},d("WAWap").wap("offline",{count:d("WAWap").INT(a)}))}g.mockOfflineMsgTraffic=a},98);
__d("MAWEphemeralCleaner",["MAWGating.re","MAWMsgCleaner","WALogger","err"],function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["EphemeralCleaner: Adding timestamps for UI(",") and backend(",")"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["startEphemeralCleaner invoked"]);j=function(){return a};return a}var k=null;function a(a,b){d("MAWGating.re").isEphemeralMessagesEnabled()&&(d("WALogger").LOG(j()),k==null&&(k={ui:new(d("MAWMsgCleaner").MsgCleaner)(a,d("MAWMsgCleaner").CLEANER_TYPE.EPHEMERAL),backend:new(d("MAWMsgCleaner").MsgCleaner)(b,d("MAWMsgCleaner").CLEANER_TYPE.EPHEMERAL)}))}function b(a,b){if(d("MAWGating.re").isEphemeralMessagesEnabled())if(k==null){var e="Trying to add new ephemeral timestamp before the cleaner is initialized!";d("WALogger").ERROR(i(),e);throw c("err")(e)}else{e=k;var f=e.ui;e=e.backend;d("WALogger").DEV(h(),a,b);f.update(a);e.update(b)}}function e(){return k}function f(){k=null}g.startEphemeralCleaner=a;g.addNewEphemeralTimestamp=b;g.getEphemeralCleaner_FOR_TESTING_ONLY=e;g.resetEphemeralCleaner_FOR_TESTING_ONLY=f},98);
__d("MAWEphemeralSettingsTxns",["MAWDbContactsTxns","MAWDbThreadTxns","MAWDexieTable","MAWEphemeralAdminMsgBuildTxns","MAWEphemeralUtil","MAWGating.re","MAWGlobals","MAWJids","MAWWriteMsgTxns","WAJids","WALogger","WAResultOrError","err"],function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Received invalid chat jid for incoming ephemeral settings"]);h=function(){return a};return a}function a(a,b,c,e,f,g,i){var j=e.ephemeralExpirationInSec,k=e.ephemeralLastUpdatedOrSetTimestamp,l=d("WAJids").interpretAsUserJid(f);if(l==null){d("WALogger").ERROR(h());return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeSuccess(null))}var m=d("WAJids").isAuthorMe(b)?d("MAWGlobals").getMyUserJid():b,n=d("MAWJids").toDeviceJid(m,c.id);return d("MAWDbContactsTxns").getContact(a,l).then(function(c){var e,h=c==null?void 0:c.ephemeralSetting,o=h==null||h.ephemeralExpirationInSec===0;if(h!=null&&!d("MAWEphemeralUtil").shouldUpdateContactEphemeralSetting(k,j,h.ephemeralLastUpdatedOrSetTimestamp,h.ephemeralExpirationInSec,n,d("MAWGlobals").getMyDeviceJid()))if(k!==h.ephemeralLastUpdatedOrSetTimestamp)return d("WAResultOrError").makeSuccess({dbEphemeralSettingMsg:null,outOfSyncEphemeralSetting:{chatJid:f,correctEphemeralExpirationInSec:h.ephemeralExpirationInSec,correctEphemeralLastUpdatedOrSetTimestamp:h.ephemeralLastUpdatedOrSetTimestamp}});else return d("WAResultOrError").makeSuccess(null);var p={ephemeralLastUpdatedOrSetTimestamp:k,ephemeralExpirationInSec:j};e=[].concat((e=c==null?void 0:c.devices)!=null?e:[]);m===l&&!e.includes(n)&&e.push(n);c=c==null?{contactJid:l,devices:e,dhash:void 0,ephemeralSetting:p}:babelHelpers["extends"]({},c,{devices:e,ephemeralSetting:p,ephemeralSyncResponseBackoffInfo:void 0});return a.contacts.put(c).then(function(){if(h==null||h.ephemeralExpirationInSec!==j)return d("MAWWriteMsgTxns").writeIncomingEphemeralSettingMsg(a,b,j,g,f,o,null,i).then(function(a){return a.success?d("WAResultOrError").makeSuccess({dbEphemeralSettingMsg:a.value}):a});else return d("WAResultOrError").makeSuccess(null)})})}function b(a,b,e,f){var g=e;if(g<0)throw c("err")("Ephemeral duration should be 0 or more");var h=d("MAWEphemeralUtil").getUserJidForEphemeralSetting(b);return d("MAWDbThreadTxns").getThreadByJid(a,b).then(function(b){return!b.success?{success:!1}:d("MAWDbContactsTxns").getContact(a,h).then(function(c){if(!d("MAWEphemeralUtil").shouldUpdateForOutgoingUserEphemeralSettingChange(c,g,f))return{success:!1};var e,i=!0;if(c==null)e={contactJid:h,devices:[],dhash:void 0,ephemeralSetting:{ephemeralExpirationInSec:g,ephemeralLastUpdatedOrSetTimestamp:f}};else{var j=c.ephemeralSetting;i=j==null||j.ephemeralExpirationInSec===0;e=babelHelpers["extends"]({},c,{ephemeralSetting:{ephemeralExpirationInSec:g,ephemeralLastUpdatedOrSetTimestamp:f}})}return d("MAWDexieTable").dexieAll([a.contacts.put(e),d("MAWEphemeralAdminMsgBuildTxns").writeEphemeralSettingAdminMsg(a,d("MAWGlobals").getMyUserJid(),g,f,b.value,i)]).then(function(){return{success:!0}})})})}function e(a,b,e){if(!d("MAWGating.re").isEphemeralMessagesEnabled())return d("MAWDexieTable").dexieResolve();b=d("MAWEphemeralUtil").getUserJidForEphemeralSetting(b);return d("MAWDbContactsTxns").getContact(a,b).then(function(b){if(b==null||b.ephemeralSetting==null)throw c("err")("Contact and ephemeral setting should not be null when receiving the server ack for outgoing ephemeral setting change");b=babelHelpers["extends"]({},b,{ephemeralSetting:{ephemeralExpirationInSec:b.ephemeralSetting.ephemeralExpirationInSec,ephemeralLastUpdatedOrSetTimestamp:e}});return a.contacts.put(b).then(function(){})})}function f(a,b){var e=d("WAJids").interpretAsUserJid(b);if(e==null)throw c("err")("Unexpected chatJid input to isEphemeralMessagesEnabledForContact");return d("MAWDbContactsTxns").getContact(a,e).then(function(a){if(a==null)return d("WAResultOrError").makeError("no_ephemeral_setting");a=a.ephemeralSetting;return a!=null&&a.ephemeralExpirationInSec>0?d("WAResultOrError").makeSuccess({outOfSyncEphemeralSetting:{chatJid:b,correctEphemeralExpirationInSec:a.ephemeralExpirationInSec,correctEphemeralLastUpdatedOrSetTimestamp:a.ephemeralLastUpdatedOrSetTimestamp}}):d("WAResultOrError").makeError("no_ephemeral_setting")})}function i(a,b){return d("MAWDbContactsTxns").getContact(a,b).then(function(b){if(b==null)return d("WAResultOrError").makeError("missing_contact");if(b.ephemeralSyncResponseBackoffInfo==null)return d("WAResultOrError").makeSuccess();b.ephemeralSyncResponseBackoffInfo=void 0;return a.contacts.put(b).then(function(){return d("WAResultOrError").makeSuccess()})})}g.handleAndWriteIncomingEphemeralSetting=a;g.handleAndWriteOutgoingUserEphemeralSettingChange=b;g.updateContactWhenEphemeralSettingChangeMarkedSent=e;g.getOutOfSyncEphemeralSettingForIncomingNonEphemeralMsg=f;g.maybeResetEphemeralSyncResponseBackoffInfo=i},98);
__d("MAWEstimateStorage",["regeneratorRuntime"],function(a,b,c,d,e,f){function a(){var a,c,d,e,f,g;return b("regeneratorRuntime").async(function(h){while(1)switch(h.prev=h.next){case 0:a=navigator.storage;if(!((a==null?void 0:a.estimate)==null)){h.next=3;break}return h.abrupt("return",null);case 3:h.next=5;return b("regeneratorRuntime").awrap(a.estimate());case 5:c=h.sent;d=c.usage,e=c.quota,f=c.usageDetails;Number.isFinite(d)||(d=0);Number.isFinite(e)||(e=0);g=e-d;return h.abrupt("return",{usage:d,quota:e,available:g,caches:f==null?void 0:f.caches});case 11:case"end":return h.stop()}},null,this)}f.estimateStorage=a},66);
__d("MAWIDB",[],function(a,b,c,d,e,f){var g;try{g=self.indexedDB}catch(a){throw a}a=g;f["default"]=a},66);
__d("MAWScanDbUsage",[],function(a,b,c,d,e,f){function a(a,b){if(b==="lru-media-meta-info"){b=0;a.size&&typeof a.size==="number"&&(b+=a.size);b+=g(a);return b}return g(a)}function b(a,b,c){return a}function c(a,b){return!1}function g(a){var b=0;JSON.stringify(a,function(a,c){if(c instanceof ArrayBuffer)b+=c.byteLength;else if(c instanceof Blob)b+=c.size;else if(typeof c==="number")b+=8;else if(typeof c==="boolean")b+=1;else if(typeof c==="string")b+=2*c.length;else return c});return b}f.estimateSize=a;f.getSampleRateOverride=b;f.skipRow=c},66);
__d("MAWEstimateIDBUsage",["MAWEstimateStorage","MAWIDB","MAWIndexedDbMetadata","MAWScanDbUsage","Promise","WAGlobals","WAJids","nullthrows","regeneratorRuntime"],function(a,b,c,d,e,f,g){function a(a,e,f){var g,i,k,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H;return b("regeneratorRuntime").async(function(I){while(1)switch(I.prev=I.next){case 0:a===void 0&&(a=!0);e===void 0&&(e=.05);f===void 0&&(f=!0);g=1e4;i=[];k=d("WAJids").extractUserId(d("WAGlobals").getMyUserJid());n=d("MAWIndexedDbMetadata").DB_NAME+"_"+k;o=c("nullthrows")(c("MAWIDB"));I.next=10;return b("regeneratorRuntime").awrap(j(o.open(n)));case 10:p=I.sent,q=p.objectStoreNames,r=new Map(),s={name:n,size:0,stores:[]},t=[],u=function(){if(w){if(x>=v.length)return"break";y=v[x++]}else{x=v.next();if(x.done)return"break";y=x.value}var a=y,b=p.transaction(a,"readonly");b=b.objectStore(a);t.push(j(b.count()).then(function(b){r.set(a,b);return}))},(v=q,w=Array.isArray(v),x=0,v=w?v:v[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]());case 17:z=u();if(!(z==="break")){I.next=20;break}return I.abrupt("break",22);case 20:I.next=17;break;case 22:I.next=24;return b("regeneratorRuntime").awrap(b("Promise").all(t));case 24:A=function(){var a,c,f,h,i,j,k,l,o;return b("regeneratorRuntime").async(function(q){while(1)switch(q.prev=q.next){case 0:if(!C){q.next=6;break}if(!(D>=B.length)){q.next=3;break}return q.abrupt("return","break");case 3:E=B[D++];q.next=10;break;case 6:D=B.next();if(!D.done){q.next=9;break}return q.abrupt("return","break");case 9:E=D.value;case 10:a=E;c=p.transaction(a,"readonly");f=c.objectStore(a);h=r.get(a);if(!(h==null)){q.next=16;break}return q.abrupt("return","continue");case 16:i=d("MAWScanDbUsage").getSampleRateOverride(e,a,n);j=Math.min(Math.ceil(h*i),g);k=j;l=0;q.next=22;return b("regeneratorRuntime").awrap(m(f,function(b){if(d("MAWScanDbUsage").skipRow(b,a))return!0;l+=d("MAWScanDbUsage").estimateSize(b,a);k--;return k>0}));case 22:o=void 0,j-k==0?o=0:o=Math.round(l*(h/(j-k))),s.stores.push({name:a,size:o,rowCount:h}),s.size+=o;case 26:case"end":return q.stop()}},null,this)},(B=q,C=Array.isArray(B),D=0,B=C?B:B[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]());case 26:I.next=28;return b("regeneratorRuntime").awrap(A());case 28:F=I.sent;I.t0=F;I.next=I.t0==="break"?32:I.t0==="continue"?33:34;break;case 32:return I.abrupt("break",36);case 33:return I.abrupt("continue",34);case 34:I.next=26;break;case 36:s.stores.sort(function(a,b){return b.size-a.size});i.push(s);i.sort(function(a,b){return b.size-a.size});a&&!f&&(console.table(i),i.forEach(function(a){var b=a.stores.map(function(b){return{db:a.name,store:b.name,size:b.size,rowCount:b.rowCount}});console.table(b)}));I.next=42;return b("regeneratorRuntime").awrap(d("MAWEstimateStorage").estimateStorage());case 42:G=I.sent;H={usage:G==null?void 0:G.usage,quota:G==null?void 0:G.quota,webCache:G==null?void 0:G.caches,debugEstimations:i,sampleRate:e};return I.abrupt("return",h(f?l(H):H));case 45:case"end":return I.stop()}},null,this)}function h(a){var b=a.debugEstimations,c=JSON.stringify(a,null,2),d=[],e="****************************";d.push(e);d.push("*******Storage Script*******");d.push(e);var f="Storage Api estimation: quota = "+i(a.quota)+" MB, usage = "+i(a.usage)+" MB";a.webCache!=null&&(f+=", webCache = "+i(a.webCache)+" MB");d.push(f);d.push("DB sampleRate = "+a.sampleRate*100+"%, lru-media-store table is 100%");b.forEach(function(a){d.push("db: "+a.name+", size = "+i(a.size)+" MB")});d.push(e);d.push("Detailed db scan result in bytes:");d.push(c);return d.join("\n")}function i(a){return a!=null&&a!==0?Math.round(a/1e6).toString():"0"}function j(a){return new(b("Promise"))(function(b,c){a.onsuccess=function(a){b(a.target.result)},a.onerror=function(a){c(a.target.result)}})}function k(a){if(a!=null&&a!==0){a=Math.round(a/1e6);a=Math.round(a/100)*100;return a*1e6}return 0}function l(a){var b=a.debugEstimations.map(function(a){var b=a.stores.map(function(a){return{name:a.name,rowCount:a.rowCount,size:k(a.size)}});return{name:a.name,size:k(a.size),stores:b}});return{debugEstimations:b,usage:a.usage==null?a.usage:k(a.usage),quota:a.quota==null?a.quota:k(a.quota),webCache:a.webCache==null?a.webCache:k(a.webCache),sampleRate:a.sampleRate}}function m(a,c){return new(b("Promise"))(function(b,d){var e=a.openCursor(null,"prev");e.onsuccess=function(a){a=a.target.result;a&&c(a.value)?a["continue"]():b()};e.onerror=function(a){d(a.target.result)}})}g.estimateIndexedDbUsage=a},98);
__d("MAWSetEphemeralSettingsFromFrontendApi",["MAWEphemeralSettingsTxns","MAWGlobals","MAWIndexedDb","MAWJobDefinitions","MAWTransactionMode","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";var h=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READWRITE,groupInfo:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READWRITE,chunk:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY})(function(a,b,c,e){return d("MAWEphemeralSettingsTxns").handleAndWriteOutgoingUserEphemeralSettingChange(a,b,c,e)});a=function(a){var b=a.threadId,c=a.ephemeralExpirationInSec,e=d("WATimeUtils").unixTime();return h(b,c,e).then(function(a){a.success&&d("MAWGlobals").getJobManager().fireAndForget(d("MAWJobDefinitions").jobSerializers.sendEphemeralSettingMsg(b,{ephemeralSetting:{ephemeralExpirationInSec:c,ephemeralLastUpdatedOrSetTimestamp:e},isForSyncResponse:!1}));return a})};g.setEphemeralSettingsFromFrontend=a},98);
__d("MAWDebug",["MAWAbProps","MAWBridge","MAWDbAppDataTxns","MAWDbChunkTxns","MAWDbContactsTxns","MAWDbGroupInfoTxns","MAWDbGroupInviteTxns","MAWDbIdentityTxns","MAWDbMediaTxns","MAWDbMetaTxns","MAWDbMsgTxns","MAWDbMsgTypeVersionTxns","MAWDbObjDecode","MAWDbObjEncode","MAWDbParticipantTxns","MAWDbPendingReceiptTxns","MAWDbPersonalSenderKeyStatusTxns","MAWDbPrekeyTxns","MAWDbReactionsTxns","MAWDbReceiptTxns","MAWDbSenderKeySessionTxns","MAWDbSessionTxns","MAWDbSignedPrekeyTxns","MAWDbThreadTxns","MAWDbUnrenderedMsgTxns","MAWDebugMockCryptoManager","MAWDebugOfflineMessages","MAWEphemeralCleaner","MAWEphemeralSettingsTxns","MAWEstimateIDBUsage","MAWGlobals","MAWHMACKey","MAWIndexedDb","MAWJobDefinitions","MAWKeychain","MAWKeychainNaClCrypto","MAWKeychainV2","MAWRotateCAT","MAWSetEphemeralSettingsFromFrontendApi","MAWTransactionMode","WAArmadilloApplication.pb","WAArrayBufferUtils","WAComms","WACryptoUtils","WADeviceUpdateUtils","WAGzip","WAIdentityUtils","WAJids","WALogger","WASignalOther","WATimeUtils","err","gkx","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Could not find contact info"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Could not find contact info"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["generateICDCInfo failed with error ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Could not find contact info"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["generateICDCInfo failed with error ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["generateICDCInfo failed with error ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["CAT was successfully updated"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["New Cat: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["Old Cat: ",""]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["Comms has no open socket"]);q=function(){return a};return a}c("gkx")("5421")&&(self.Debug={revokeMsg:function(a){return d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.revokeMsgs([a]))},sendMsg:function(a,b){return d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.sendMsg(a,b))},sendEphemeralSettingMsg:function(a,b){return d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.sendEphemeralSettingMsg(a,b))},sendReaction:function(a,b,c,e){return d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.sendReactionMsg(a,b,c,e))},sendXMAShareMsg:function(a,b,c,e){var f="test";return d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.sendXMAShareMsg(a,f,void 0,void 0,(a=c)!=null?a:"hey",babelHelpers["extends"]({},b,{xmaMessageType:d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_EXTENDED_CONTENT_MESSAGE_EXTENDEDCONTENTTYPE.FB_FEED_SHARE}),void 0,void 0,e))},executeQuery:function(a){var b=Object.keys(d("MAWIndexedDb").CURRENT_MAW_STORES).reduce(function(a,b){return babelHelpers["extends"]({},a,(a={},a[b+""]=d("MAWTransactionMode").READWRITE,a))},{});return r(d("MAWIndexedDb").makeMsgrTransactor(b)(a)())},forwardMsg:function(a,b){return d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.forwardMsg(a,b))},generateOfflineMsgTraffic:d("MAWDebugOfflineMessages").mockOfflineMsgTraffic,restoreCryptoManager:d("MAWDebugMockCryptoManager").restoreCryptoManager,uploadMedia:function(a){return d("MAWBridge").getBridge().sendAndReceive("backend","uploadMedia",a)},downloadMedia:function(){return d("MAWBridge").getBridge().sendAndReceive("backend","downloadMedia",{})},getCurrentUserDeviceList:function(){return d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.getCurrentUserDeviceList())},getDevices:function(a){return d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.getDevices(a))},getProtocolMsgId:function(a){return d("MAWBridge").getBridge().sendAndReceive("backend","getProtocolMsgIdByMsgId",{msgId:a})},createThread:function(a){return d("MAWBridge").getBridge().sendAndReceive("backend","createThread",{contactFbid:a,offlineThreadingId:null})},notifyDeviceChange:function(a){return d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.notifyDeviceChange(a))},generateAndUploadPreKeys:function(){return d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.generateAndUploadPreKeys())},handleDebugStanza:function(a){var b=d("WAComms").singletonOrThrowIfUninitialized("handleDebugStanza");if(b.socket)return b.handleStanza(a,b.socketId,0);else d("WALogger").LOG(q())},rotateSignedPreKey:function(){return d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.rotateSignedPreKey())},rotateCryptoAuthToken:function(){var a=d("WAArrayBufferUtils").arrayBufferToString(d("MAWGlobals").getFbCat());d("WALogger").LOG(p(),a);return d("MAWRotateCAT").tryRotateCAT().then(function(){var b=d("WAArrayBufferUtils").arrayBufferToString(d("MAWGlobals").getFbCat());d("WALogger").LOG(o(),b);a!==b&&d("WALogger").LOG(n())})},markThreadAsRead:function(a,b){return d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.markThreadAsRead(a,b))},reportUserSpam:function(a,b){return d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.reportUserSpam(a,"frx",b,["harassment"],"fake debug context"))},createGroup:function(a,b,c){return d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.createGroup(a,b,c))},queryAllGroups:function(){return d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.queryGroups())},leaveGroups:function(a){return d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.leaveGroups(a))},addGroupParticipants:function(a,b){return d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.addGroupParticipants(a,b))},removeGroupParticipants:function(a,b){return d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.removeGroupParticipants(a,b))},deleteGroups:function(a){return d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.deleteGroups(a))},getAbProp:function(a){return d("MAWAbProps").getAbProp(a)},syncAbProps:function(a){a=a!==!0;return d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.syncAbProps(a))},getAbProps:function(){return d("MAWAbProps").getAbProps()},overrideAbProp:function(a,b){d("MAWAbProps").overrideAbProp(a,b)},promoteGroupParticipants:function(a,b){return d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.promoteGroupParticipants(a,b))},demoteGroupParticipants:function(a,b){return d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.demoteGroupParticipants(a,b))},inflate:function(a){return d("WAGzip").inflate(a)},deflate:function(a){var b=d("WAGzip").createDeflate();b.push(a,!0);return b.result()},fromUnixTime:function(a){return d("WATimeUtils").toDate(a)},removeDevice:function(a,b){return d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.removeDevice(a,b))},setGroupSubject:function(a,b){return d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.setGroupSubject(a,b))},generateEncryptionKeys:function(){if(c("gkx")("334"))return d("MAWKeychainV2").setupEARKeychain().then(function(a){return d("MAWKeychainV2").getAllDatabaseEncryptionKeys()});else return d("MAWKeychain").setupEARKeychain().then(function(a){return d("MAWKeychain").getAllDatabaseEncryptionKeys()})},getEARKeychain:function(){if(c("gkx")("334"))return d("MAWKeychainV2").getEARKeychainForDebugging();else return d("MAWKeychain").getEARKeychainForDebugging()},encryptEARTweetNaCl:function(a,b,c){return d("MAWKeychainNaClCrypto").encryptTweetNaCl(a,b,c)},decryptEARTweetNaCl:function(a,b){return d("MAWKeychainNaClCrypto").decryptTweetNaCl(a,b)},encodeEAR:function(a,b){return d("MAWDbObjEncode").encodeDbObj(a,b)},decodeEAR:function(a,b){return d("MAWDbObjDecode").decodeDbObj(a,b)},getMsgsByMsgId:function(a){return r(d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY})(d("MAWDbMsgTxns").getMsgsByMsgIds)(a))},getUnrenderedMsgsByMsgId:function(a){return r(d("MAWIndexedDb").makeMsgrTransactor({unrenderedMessages:d("MAWTransactionMode").READONLY})(d("MAWDbUnrenderedMsgTxns").getUnrenderedMsgsByMsgIds)(a))},getGroupInfosByGroupJid:function(a){return r(d("MAWIndexedDb").makeMsgrTransactor({groupInfo:d("MAWTransactionMode").READONLY})(d("MAWDbGroupInfoTxns").getGroupInfos)(a))},getMeta:function(){return r(d("MAWIndexedDb").makeMsgrTransactor({meta:d("MAWTransactionMode").READONLY})(d("MAWDbMetaTxns").getAllMeta)())},getIdentityByDeviceJid:function(a){return r(d("MAWIndexedDb").makeMsgrTransactor({identity:d("MAWTransactionMode").READONLY})(d("MAWDbIdentityTxns").bulkGetIdentityRows)(a))},getPrekeyByPrekeyId:function(a){return r(d("MAWIndexedDb").makeMsgrTransactor({prekey:d("MAWTransactionMode").READONLY})(d("MAWDbPrekeyTxns").getPrekeys)(a))},getPrekeyGenerationByGenerationId:function(a){return r(d("MAWIndexedDb").makeMsgrTransactor({prekey:d("MAWTransactionMode").READONLY})(d("MAWDbPrekeyTxns").getPrekeyGenerations)(a))},getSessionsByDeviceJid:function(a){return r(d("MAWIndexedDb").makeMsgrTransactor({session:d("MAWTransactionMode").READONLY})(d("MAWDbSessionTxns").bulkGetSessions)(a))},getSignedPrekesByPrekeyId:function(a){return r(d("MAWIndexedDb").makeMsgrTransactor({signedPrekey:d("MAWTransactionMode").READONLY})(d("MAWDbSignedPrekeyTxns").getSignedPrekeys)(a))},getSenderKeySessionsBySenderKeySessionId:function(a){return r(d("MAWIndexedDb").makeMsgrTransactor({signedPrekey:d("MAWTransactionMode").READONLY})(d("MAWDbSenderKeySessionTxns").getSenderKeySessionsBySenderKeySessionId)(a))},getReceiptsByMsgId:function(a){return r(d("MAWIndexedDb").makeMsgrTransactor({receipts:d("MAWTransactionMode").READONLY})(d("MAWDbReceiptTxns").getReceipts)(a))},getPendingReceipts:function(a){return r(d("MAWIndexedDb").makeMsgrTransactor({pendingReceipts:d("MAWTransactionMode").READONLY})(d("MAWDbPendingReceiptTxns").getPendingReceipts)(a))},getThreadsByChatId:function(a){return r(d("MAWIndexedDb").makeMsgrTransactor({threads:d("MAWTransactionMode").READONLY})(d("MAWDbThreadTxns").getThreads)(a))},getContactsByContactJid:function(a){return r(d("MAWIndexedDb").makeMsgrTransactor({contacts:d("MAWTransactionMode").READONLY})(d("MAWDbContactsTxns").getContacts)(a))},getParticipantsByParticipantId:function(a){return r(d("MAWIndexedDb").makeMsgrTransactor({participants:d("MAWTransactionMode").READONLY})(d("MAWDbParticipantTxns").bulkGetParticipants)(a))},getGroupInvitesByParticipantId:function(a){return r(d("MAWIndexedDb").makeMsgrTransactor({groupInvites:d("MAWTransactionMode").READONLY})(d("MAWDbGroupInviteTxns").bulkGetGroupInvites)(a))},getPersonalSenderKeyStatusesByGroupJid:function(a){return r(d("MAWIndexedDb").makeMsgrTransactor({personalSenderKeyStatuses:d("MAWTransactionMode").READONLY})(d("MAWDbPersonalSenderKeyStatusTxns").bulkGetPersonalSenderKeyStatuses)(a))},getAppDatas:function(a){return r(d("MAWIndexedDb").makeMsgrTransactor({appData:d("MAWTransactionMode").READONLY})(d("MAWDbAppDataTxns").bulkGetAppData)(a))},getAppMetaByKey:function(a){return r(d("MAWIndexedDb").makeMsgrTransactor({appMeta:d("MAWTransactionMode").READONLY})(d("MAWDbMsgTypeVersionTxns").getAppMetaValue)(a))},getChunksByChunkId:function(a){return r(d("MAWIndexedDb").makeMsgrTransactor({chunk:d("MAWTransactionMode").READONLY})(d("MAWDbChunkTxns").bulkGetChunks)(a))},getMediaByMediaId:function(a){return r(d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READONLY})(d("MAWDbMediaTxns").bulkGetMedias)(a))},getReactionByReactToMsgId:function(a){return r(d("MAWIndexedDb").makeMsgrTransactor({reactions:d("MAWTransactionMode").READONLY})(d("MAWDbReactionsTxns").getReactionsFromMessages)(a))},dropExpiredMessagesFromUI:function(){var a=d("MAWEphemeralCleaner").getEphemeralCleaner_FOR_TESTING_ONLY();if(a)a.ui.update(d("WATimeUtils").futureUnixTime(5));else throw c("err")("Cannot delete expired msgs as cleaner is not initialized!")},dropExpiredMessagesFromDB:function(){var a=d("MAWEphemeralCleaner").getEphemeralCleaner_FOR_TESTING_ONLY();if(a)a.backend.update(d("WATimeUtils").futureUnixTime(5));else throw c("err")("Cannot delete expired msgs as cleaner is not initialized!")},uploadRetroactiveThreadsAndMessages:function(){return r(d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.uploadRetroactiveThreadsAndMessages()))},restoreMessagesFromEncryptedBackups:function(a,b,c,e,f){return r(d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.restoreMessagesFromEncryptedBackups(a,b,c,e,f)))},restoreThreadsFromEncryptedBackups:function(a,b){return r(d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.restoreThreadsFromEncryptedBackups(a,b)))},hmacPlaintextHash:function(a){return d("MAWHMACKey").genHMACPlaintextHash(a)},getHmacKeyFromGlobals:function(){return d("MAWGlobals").getHMACKey()},handleEchoMsgsRestore:function(a){return r(d("MAWGlobals").getDbImpls().handleEchoMsgsRestore(a))},sendAppData:function(a){return d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.sendAppData({contents:a}))},setEphemeralSettingsFromFrontend:function(a,b){return r(d("MAWSetEphemeralSettingsFromFrontendApi").setEphemeralSettingsFromFrontend({threadId:a,ephemeralExpirationInSec:b}))},setEphemeralSettingWithoutUpdate:function(a,b,c){c=c==null?d("WATimeUtils").unixTime():d("WATimeUtils").futureUnixTime(c);return r(d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READWRITE,groupInfo:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READWRITE})(d("MAWEphemeralSettingsTxns").handleAndWriteOutgoingUserEphemeralSettingChange)(a,b,c))},generateICDCInfo:function(a,c){var e,f,g,h,i,j,k,l;return b("regeneratorRuntime").async(function(n){while(1)switch(n.prev=n.next){case 0:a===void 0&&(a=1);c===void 0&&(c=d("WATimeUtils").unixTime());n.next=4;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().getContactAndIdentitiesForUser(d("MAWGlobals").getMyUserJid()));case 4:e=n.sent;if(e.success){n.next=8;break}d("WALogger").LOG(m(),e.error);return n.abrupt("return");case 8:f=e.value,g=f.contact,h=f.identities;i=d("MAWGlobals").getCryptoManager().regInfo;j=d("WAIdentityUtils").removeKeyTypeIfNeeded(i.staticKeyPair.publicKey);k=h.map(function(a){return d("WAIdentityUtils").removeKeyTypeIfNeeded(a.identity)});l={sequence:a,timestamp:c,devices:k,signingDeviceIndex:k.findIndex(function(a){return d("WACryptoUtils").uint8ArraysEqual(d("WAIdentityUtils").removeKeyTypeIfNeeded(a),j)}),dirty:!1};n.next=15;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().setDevices([{jid:d("MAWGlobals").getMyUserJid(),devices:g.devices.map(d("WAJids").extractDeviceId),dhash:g.dhash,icdcInfo:l,lastSyncTs:d("WATimeUtils").unixTime()}]));case 15:case"end":return n.stop()}},null,this)},clearICDCInfo:function(a){var c,e;return b("regeneratorRuntime").async(function(f){while(1)switch(f.prev=f.next){case 0:f.next=2;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().getContactAndIdentitiesForUser(a));case 2:c=f.sent;if(c.success){f.next=8;break}d("WALogger").LOG(l(),c.error);return f.abrupt("return");case 8:if(!(c.value==null)){f.next=11;break}d("WALogger").LOG(k());return f.abrupt("return");case 11:e=c.value.contact;f.next=14;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().setDevices([{jid:a,devices:e.devices.map(d("WAJids").extractDeviceId),dhash:e.dhash,icdcInfo:void 0,lastSyncTs:d("WATimeUtils").unixTime()}]));case 14:case"end":return f.stop()}},null,this)},setICDCData:function(a,c){var e,f,g,k,l,m,n,o,p;return b("regeneratorRuntime").async(function(q){while(1)switch(q.prev=q.next){case 0:q.next=2;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().getContactAndIdentitiesForUser(a));case 2:f=q.sent;if(f.success){q.next=8;break}d("WALogger").LOG(j(),f.error);return q.abrupt("return");case 8:if(!(f.value==null)){q.next=11;break}d("WALogger").LOG(i());return q.abrupt("return");case 11:g=f.value.contact;k=g.icdcInfo;if(!(k==null)){q.next=16;break}d("WALogger").LOG(h());return q.abrupt("return");case 16:l=k.sequence;c.sequenceInc!=null&&(l=k.sequence+c.sequenceInc);m=d("WAJids").interpretAsDeviceId(999);n=g.devices.map(d("WAJids").extractDeviceId);if(!(c.additionDevices==="inject")){q.next=29;break}n.push(m);o=d("WASignalOther").makeBytes(33);o[0]=5;f.value.identities.push({deviceJid:d("WAJids").toDeviceJid(a,m),identity:o});q.next=27;return b("regeneratorRuntime").awrap(d("WADeviceUpdateUtils").updateDevicesForUser(a,f.value.identities.map(function(a){var b=a.deviceJid;a=a.identity;return{id:b,identity:a}})));case 27:q.next=33;break;case 29:if(!(c.additionDevices==="clear")){q.next=33;break}n=n.filter(function(a){return a!==m});q.next=33;return b("regeneratorRuntime").awrap(d("WADeviceUpdateUtils").updateDevicesForUser(a,f.value.identities.filter(function(b){return b.deviceJid!==d("WAJids").toDeviceJid(a,m)}).map(function(a){var b=a.deviceJid;a=a.identity;return{id:b,identity:a}})));case 33:p=babelHelpers["extends"]({},k,{sequence:l});q.next=36;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().setDevices([{jid:a,devices:n,dhash:g.dhash,icdcInfo:p,lastSyncTs:d("WATimeUtils").unixTime(),resetICDCError:(e=c.resetICDCError)!=null?e:!1}]));case 36:case"end":return q.stop()}},null,this)},estimateStorage:function(){return r(d("MAWEstimateIDBUsage").estimateIndexedDbUsage(!0,.05,!1))}});function r(a){return a.then(function(a){return a})}},34);
__d("MAWDebugSendReaction",["MAWGlobals","MAWJobDefinitions","WADevToolsDebugFns"],function(a,b,c,d,e,f,g){"use strict";a=d("WADevToolsDebugFns").defineDebugFunction("sendReaction",{desc:"Sends reaction to a message",serializedArgs:[{name:"chatJid",type:"string",placeholder:"ChatJid",desc:"ChatJid of the thread containing the message to react to"},{name:"reactTo",type:"object",placeholder:"ProtocolMsgId",desc:"ProtocolMsgId of the message to react to"},{name:"author",type:"string",placeholder:"FBID",desc:"FBID of the author of the message to react to"},{name:"reaction",type:"string",placeholder:"\ud83d\ude00",desc:"Reaction emoji to use"}],execute:function(a,b,c,e){return d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.sendReactionMsg(a,b,c,e))}});g.sendReaction=a},98);
__d("MAWDebugDefineFunctions",["MAWDebugSendReaction"],function(a,b,c,d,e,f,g){"use strict";function a(){return{sendReaction:d("MAWDebugSendReaction").sendReaction}}g.getAllDebugFunctions=a},98);
__d("MAWDbHistorySyncQRCodeData",[],function(a,b,c,d,e,f){"use strict";a="qrCodeRowId";f.qrCodeRowId=a},66);
__d("MAWDbReaction",["MAWAckLevel.re","MAWDbMsg","MAWGlobals","WAJids"],function(a,b,c,d,e,f,g){function a(a,b){return d("MAWDbMsg").craftMsgId(a,b)}function b(a,b,c){var e=d("MAWGlobals").getMyUserJid();return a.find(function(a){return a.threadJid===b&&d("WAJids").authorToUserId(a.author,e)===d("WAJids").authorToUserId(c,e)})}function c(a){return a}function e(a,b,c,e,f,g,h,i,j,k,l,m){m===void 0&&(m=d("MAWAckLevel.re").ACK.clock);m={ack:m,author:k,reactionId:c,externalId:b,reactToAuthor:h,reactToExternalId:e,reactToMsgId:i,reaction:f,groupingKey:g,threadJid:a,ts:j};return l!=null?babelHelpers["extends"]({},m,{rowId:l}):m}g.craftReactionId=a;g.findMatchingReaction=b;g.reactionIdToMsgId=c;g.formatReaction=e},98);
__d("MAWDbTasks",[],function(a,b,c,d,e,f){a={deleteExpiredKeys:"deleteExpiredKeys",generatePrekeys:"generatePrekeys",rotateCAT:"rotateCAT",rotateKey:"rotateKey",queryGroups:"queryGroups",syncAbProps:"syncAbProps",deleteOrphanedReactions:"deleteOrphanedReactions"};f.Tasks=a},66);
__d("MAWConvertFutureproofMsgTxns",["MAWBridgeTypes","MAWDbMsg","MAWDbThreadTxns","MAWDexieTable","MAWHandleUnstoredMediaTxns","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWThreadEvent","MAWThreadSnippetBuildTxns","WAJids","err"],function(a,b,c,d,e,f,g){function a(a,b,e,f,g){var h=babelHelpers["extends"]({},b,{ts:e.ts,thread:e.thread,threadJid:g.jid,msgId:e.msgId,rowId:e.rowId});return a.messages.put(h).then(function(){return d("MAWDbThreadTxns").needsRetroactiveReadReceiptInThread(a,h)}).then(function(b){if(b){h.altIndex=d("MAWDbMsg").craftToBeReadAltIndex(h.thread);return a.messages.put(h)}}).then(function(){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,h)}).then(function(b){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeTypes").createBridgeMsg(h,void 0,b)});d("MAWIndexedDb").afterTransactionThreadEvent({chatJid:g.jid,msgId:h.msgId},d("MAWThreadEvent").PLACEHOLDER_CONVERT_SUBSCRIPTION);b=h.msgId===g.newestMsg?d("MAWThreadSnippetBuildTxns").buildThreadSnippet(a,h,g).then(function(a){var b=a.snippetType,c=a.snippetParams;a=a.snippetSenderContactId;d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypes").createBridgeUpdatedThread({threadId:g.chatId,snippetType:b,snippetParams:c,snippetSenderContactId:a})})}):d("MAWDexieTable").dexieResolve();var e=f!=null?d("MAWHandleUnstoredMediaTxns").handleUnstoredDbMedia(a,f,h).then(function(a){if(d("WAJids").isAuthorSystem(h.author))throw c("err")("This cannot happen");return{protocolMsgId:{author:h.author,externalId:h.externalId,chat:g.jid},plaintextHash:a.plaintextHash}}):d("MAWDexieTable").dexieResolve(null);return d("MAWDexieTable").dexieAll([b,e]).then(function(a){a[0];a=a[1];return a})})}g.convertFutureproofMsg=a},98);
__d("MAWGetMsgQuoteTxn",["MAWDbMsgTxns","MAWDexieTable","WAJids","WAMsgType","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";var h=function(a){return a==null||a===d("WAJids").AUTHOR_SYSTEM?null:d("WAJids").authorAsUserJid(a)};function i(a,b,c){var e=b.quote;b=(e==null?void 0:e.content)||{};var f=b.externalId;b=b.author;if(b==null)return d("MAWDexieTable").dexieResolve(null);b=d("WAJids").isAuthorMe(b)?d("WAJids").AUTHOR_ME:h(b);if(e==null||b==null)return d("MAWDexieTable").dexieResolve(null);f={externalId:f,chat:c,author:b};return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,f).then(function(b){if(b==null||!d("WAMsgType").isQuotedMsgType(b.type))return{quoteExternalId:e.content.externalId,quote:e};var c=b.ts,a=b.externalId,f=b.author,g=b.type,h=b.msgContent,i=b.msgId,j=b.mediaId,k=b.specialTextSize,l=b.xmaMessageType;g={type:g,externalId:a,author:f,msgContent:h,ts:c,msgId:i,mediaId:j,specialTextSize:k,xmaMessageType:l};b.messageExpirationTs!=null&&b.messageExpirationTs<d("WATimeUtils").unixTime()&&(g=babelHelpers["extends"]({},g,{type:d("WAMsgType").MSG_TYPE.EXPIRED_EPHEMERAL,msgContent:void 0,mediaId:void 0}));return{quoteExternalId:b.externalId,quote:babelHelpers["extends"]({},e,{content:g})}})}function a(a,b,c){return i(a,b,c).then(function(a){return babelHelpers["extends"]({},b,{quoteExternalId:a==null?void 0:a.quoteExternalId,quote:a==null?void 0:a.quote})})}g.getMsgQuoteInfo=i;g.enhanceMsgWithQuoteInfo=a},98);
__d("MAWGroupManagementUtils",["WAGlobals"],function(a,b,c,d,e,f,g){"use strict";function a(a,b){a=a.map(function(a){return a.user}).filter(function(a){return(b===d("WAGlobals").getMyUserJid()||b==="@me")&&a===d("WAGlobals").getMyUserJid()}).length>0;return a}function b(a,b){a=a.map(function(a){return a.user}).filter(function(a){return(a===d("WAGlobals").getMyUserJid()||a==="@me")&&a!==b}).length>0;return a}function c(a){a=a.map(function(a){return a.user}).filter(function(a){return a===d("WAGlobals").getMyUserJid()||a==="@me"}).length>0;return a}g.mustArchiveThreadForMemberRemovals=a;g.mustUnsubscribeFromThreadForMemberRemovals=b;g.mustSubscribeToThreadForMemberAddition=c},98);
__d("MAWParticipantManagementTxns",["MAWDbParticipantTxns","MAWDbThreadTxns","MAWDexieTable","MAWGlobals"],function(a,b,c,d,e,f,g){"use strict";function a(a,b,c){return d("MAWDbParticipantTxns").getParticipantsInThread(a,b).then(function(e){if(c.length===0&&e.length===0)return{participants:e,removedJids:[],addedJids:[],typeUpdateJids:[]};var f=new Map();e.forEach(function(a){f.set(a.userJid,a)});var g=new Set(c.map(function(a){return a.userJid})),h=[],i=[],j=[],k=[];f.forEach(function(a,b){g.has(b)||(a.type!=="invitedParticipant"?h.push(b):(k.push({type:a.type,userJid:a.userJid}),j.push(babelHelpers["extends"]({},a))))});c.forEach(function(a){var b=f.get(a.userJid);b==null?(i.push(a),a.type=="admin"&&k.push({type:a.type,userJid:a.userJid})):(b.type!=a.type&&k.push({type:a.type,userJid:a.userJid}),j.push(babelHelpers["extends"]({},b,a)))});e=h.indexOf(d("MAWGlobals").getMyUserJid())>=0;e=[d("MAWDbParticipantTxns").bulkAddParticipants(a,b,i),d("MAWDbParticipantTxns").bulkUpdateParticipants(a,j),d("MAWDbParticipantTxns").bulkDeleteParticipantsInThread(a,b,h),e?d("MAWDbThreadTxns").archiveThreads(a,[b],!0):d("MAWDexieTable").dexieResolve()];return d("MAWDexieTable").dexieAll(e).then(function(a){var b=a[0];a=a[1];return{participants:[].concat(b,a),removedJids:h,addedJids:i.map(function(a){return a.userJid}),typeUpdateJids:k}})})}g.syncParticipantList=a},98);
__d("MAWGroupManagementTxns",["MAWAdminMsgBuildTxns","MAWDbGroupInfoTxns","MAWDbParticipantTxns","MAWDbPersonalSenderKeyStatusTxns","MAWDbSenderKeySessionTxns","MAWDbThreadTxns","MAWDexieTable","MAWFolderTypes","MAWGetOrCreateThreadTxns","MAWGlobals","MAWGroupManagementUtils","MAWLoadMsgsTxns","MAWParticipantManagementTxns","MAWThreadManagementTxns","WAResultOrError","WATimeUtils"],function(a,b,c,d,e,f,g){function a(a,b,c,e,f,g,i){return h(a,b,c,e,!0,f,g,i).then(function(b){if(b.success){if(d("MAWGroupManagementUtils").mustSubscribeToThreadForMemberAddition(f))return d("MAWDbThreadTxns").subscribeToThreads(a,[e]).then(function(){});return}else return b.error})}function b(a,b,c,e,f,g,i){return h(a,b,c,e,!1,f,g,i).then(function(b){if(b.success){if(d("MAWGroupManagementUtils").mustArchiveThreadForMemberRemovals(f,g))return d("MAWDbThreadTxns").archiveThreads(a,[e],!0).then(function(){});if(d("MAWGroupManagementUtils").mustUnsubscribeFromThreadForMemberRemovals(f,g))return d("MAWDbThreadTxns").unsubscribeFromThreads(a,[e]).then(function(){});return}else return b.error})}function c(a,b,c){return d("MAWDexieTable").dexieAll([d("MAWDbSenderKeySessionTxns").deleteSenderKeysByGroupJid(a,b),d("MAWThreadManagementTxns").deleteAllThreadData(a,c),d("MAWDbGroupInfoTxns").deleteGroupInfo(a,b),d("MAWDbPersonalSenderKeyStatusTxns").bulkDeletePersonalSenderKeyStatus(a,[b])]).then(function(){})}function h(a,b,c,e,f,g,h,i){if(b!=null&&b.previous!=null&&c.participantVersion!==b.previous)return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError("mismatch"));var j=g.map(function(a){return a.user}),k=g.map(function(a){return{type:a.type,userJid:a.user,addressable:a.addressable}});g=g.map(function(a){return a.user});return d("MAWDexieTable").dexieAll([f?d("MAWDbParticipantTxns").bulkAddParticipants(a,e,k):d("MAWDbParticipantTxns").bulkDeleteParticipantsInThread(a,e,g),b==null?d("MAWDexieTable").dexieResolve():d("MAWAdminMsgBuildTxns").writeAddOrRemoveParticipantAdminMsg(a,j,h,e,f,i),b==null?d("MAWDexieTable").dexieResolve():d("MAWDbGroupInfoTxns").updateGroupInfo(a,babelHelpers["extends"]({},c,{participantVersion:b.current}))]).then(function(){return d("WAResultOrError").makeSuccess()})}e=function(a,b,c,e,f,g,h){h===void 0&&(h=!1);f=c==="added"?d("WATimeUtils").unixTime():b.creationTs;return d("MAWGetOrCreateThreadTxns").getOrCreateThread(a,b.jid,d("MAWFolderTypes").FOLDER_ID.INBOX,g==null?void 0:g.clientThreadKey,f,h).then(function(f){var g=f.created,h=f.thread;f=b.participants.map(function(a){return a.error?a.error.errorCode===403?{userJid:a.error.user,type:"invitedParticipant",addressable:!0}:null:{userJid:a.value.user,type:a.value.type,addressable:a.value.addressable}}).filter(Boolean);var i=g?d("MAWDbParticipantTxns").bulkAddParticipants:d("MAWParticipantManagementTxns").syncParticipantList;i=i(a,h.chatId,f);f=d("MAWGlobals").getMyUserJid();f=c==="added"&&!g&&b.creator!==f?d("MAWAdminMsgBuildTxns").writeAddOrRemoveParticipantAdminMsg(a,[f],b.inviter,h.chatId,!0,e):d("MAWDexieTable").dexieResolve();b.participants;b.description;var j=babelHelpers.objectWithoutPropertiesLoose(b,["participants","description"]);return d("MAWDexieTable").dexieAll([i,d("MAWDbGroupInfoTxns").putGroupInfo(a,h.chatId,j),d("MAWDbPersonalSenderKeyStatusTxns").putNewPersonalSenderKeyStatus(a,b.jid),h.newestMsg!=null?d("MAWLoadMsgsTxns").loadMsgsAndMediaFromOffset(a,h.chatId,h.newestMsg,10,!0):d("MAWDexieTable").dexieResolve(),f]).then(function(b){b[0];b=b[1];return g&&c==="added"?d("MAWAdminMsgBuildTxns").writeGroupNameChangeInfo(a,b,h):d("MAWDexieTable").dexieResolve()}).then(function(){return h.archived===!0?d("MAWDbThreadTxns").unarchiveThreads(a,[h.chatId]):d("MAWDbThreadTxns").subscribeToThreads(a,[h.chatId])}).then(function(a){return h.jid})})};g.addParticipantsAndUpdateGroupInfo=a;g.removeParticipantsAndUpdateGroupInfo=b;g.deleteGroup=c;g.createGroupInternal=e},98);
__d("MAWEphemeralMsgTxns",["MAWBridgeTypes","MAWDbMsg","MAWDbMsgTxns","MAWDbThreadTxns","MAWDexieTable","MAWEphemeralCleaner","MAWEphemeralConsts.re","MAWEphemeralSettingsTxns","MAWGating.re","MAWIndexedDb","MAWLocalizationType","MAWThreadSnippetBuildTxns","WAGetHashFromProtocolMsgId","WAJids","WALogger","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["trying to update ephemeral timestamp to a later ts then previously set"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["EphemeralCounter: Showing UI counter for ",""]);i=function(){return a};return a}function j(a,b,c){return c.size===0?d("MAWDexieTable").dexieResolve():d("MAWDbThreadTxns").getThread(a,b).then(function(e){if(!e.success)return;var f=e.value,g=f.oldestMsg,h=f.newestMsg;if(g==null||h==null)return;e=function(a){return!c.has(a.msgId)&&a.ephemeralMsgDisappeared!==!0};var i=c.has(g)?a.messages.where("msgId").between(g,h,!1,!0).filter(e).limit(1).toArray().then(function(a){return{needsUpdate:!0,value:(a=a[0])!=null?a:null}}):d("MAWDexieTable").dexieResolve({needsUpdate:!1});e=c.has(h)?a.messages.where("msgId").between(g,h,!0,!1).filter(e).reverse().limit(1).toArray().then(function(a){return{needsUpdate:!0,value:(a=a[0])!=null?a:null}}):d("MAWDexieTable").dexieResolve({needsUpdate:!1});return d("MAWDexieTable").dexieAll([i,e]).then(function(c){var e=c[0],i=c[1];if(!e.needsUpdate&&!i.needsUpdate)return;var j=babelHelpers["extends"]({},f,{oldestMsg:e.needsUpdate?(e=(c=e.value)==null?void 0:c.msgId)!=null?e:null:g,newestMsg:i.needsUpdate?(e=(c=i.value)==null?void 0:c.msgId)!=null?e:null:h});return a.threads.put(j).then(function(){if(i.needsUpdate){var c=i.value;if(c==null)d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypes").createBridgeUpdatedThread({threadId:b,snippetType:d("MAWLocalizationType").LOCALIZATION_TYPE.EMPTY_SNIPPET,snippetParams:[],snippetSenderContactId:"0"})});else return d("MAWThreadSnippetBuildTxns").buildThreadSnippet(a,c,j).then(function(a){var c=a.snippetType,e=a.snippetParams;a=a.snippetSenderContactId;d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypes").createBridgeUpdatedThread({threadId:b,snippetType:c,snippetParams:e,snippetSenderContactId:a})})})}})})})}function a(a,b){var c={};b.map(function(a){var b=a.msgId;a=a.ts;b=d("WAGetHashFromProtocolMsgId").getHashFromProtocolMsgId(b);c[b]=a});return d("MAWDbMsgTxns").getMsgsByProtocolMsgId(a,b.map(function(a){return babelHelpers["extends"]({},a.msgId)})).then(function(b){var e=b.msgs,f=b.threadIdToJid;b=e.map(function(a){var b=f.get(a.thread),e=a.author;if(b==null||d("WAJids").isAuthorSystem(e))return null;e=d("WAGetHashFromProtocolMsgId").getHashFromProtocolMsgId({externalId:a.externalId,author:e,chat:b});b=c[e];e=(e=a.ephemeralSetting)==null?void 0:e.ephemeralExpirationInSec;if(e==null||e===0)return null;b=d("WATimeUtils").castToUnixTime(b+e);e=d("WATimeUtils").castToUnixTime(b+d("MAWEphemeralConsts.re").EPHEMERAL_REPORTING_WINDOW_IN_SECONDS);return{msgId:a.msgId,messageExpirationTs:b,messageDeleteTs:e}}).filter(Boolean);return k(a,b)}).then(function(a){var b=a[0],c=a[1];a=a[2];a.length>0&&(d("WALogger").DEV(i(),a.map(function(a){return a.msgId})),d("MAWIndexedDb").afterTransaction({tag:"MsgsStartCountdown",value:d("MAWBridgeTypes").createBridgeMsgsStartCountdown(a)}));b!=null&&c!=null&&d("MAWEphemeralCleaner").addNewEphemeralTimestamp(b,c)})}function k(a,b){var c=b.map(function(a){return a.msgId}),e=new Map();b.forEach(function(a){return e.set(a.msgId,{messageExpirationTs:a.messageExpirationTs,messageDeleteTs:a.messageDeleteTs})});var f=null,g=null,i=[];return a.messages.where("msgId").anyOf(c).toArray().then(function(b){if(b.length===0)return;b.forEach(function(a){var b=a.messageExpirationTs,c=a.messageDeleteTs,j=e.get(a.msgId),k=j==null?void 0:j.messageExpirationTs;j=j==null?void 0:j.messageDeleteTs;if(k==null||j==null)return;if(b!=null&&k>b||c!=null&&k>c){d("WALogger").ERROR(h());return}if(a.ephemeralCounterStarted===!0)return;f==null?f=k:k<f&&(f=k);g==null?g=j:j<g&&(g=j);b=babelHelpers["extends"]({},a,{messageExpirationTs:k,messageDeleteTs:j,ephemeralCounterStarted:!0});i.push(b)});return a.messages.bulkPut(i)}).then(function(){return[f,g,i]})}function b(a,b){if(b.size===0)return d("MAWDexieTable").dexieResolve();var c=[];b.forEach(function(b,d){c.push(j(a,d,b))});return d("MAWDexieTable").dexieAll(c).then(function(){})}function e(a,b,c){if(!d("MAWGating.re").isEphemeralMessagesEnabled()||b==null||b.ephemeralSetting==null||b.ephemeralSetting.ephemeralExpirationInSec===0)return d("MAWDexieTable").dexieResolve();c=d("WATimeUtils").castToUnixTime(c+d("MAWEphemeralConsts.re").EPHEMERAL_MAX_DELETION_WINDOW_FOR_UNSEEN_MESSAGE);b=babelHelpers["extends"]({},b,{messageExpirationTs:c,messageDeleteTs:c});return a.messages.put(b).then(function(){})}function f(a,b,e,f,g,h,i){if(i!=null)return d("MAWDexieTable").dexieResolve(i);i=d("MAWDexieTable").dexieResolve();if(c("MAWGating.re").isEphemeralMessagesEnabled())if(b.ephemeralSetting==null)d("WAJids").switchOnMsgrChatJidType(f,{group:function(){},user:function(){d("MAWDbMsg").isContentMsg(b)&&(i=d("MAWEphemeralSettingsTxns").getOutOfSyncEphemeralSettingForIncomingNonEphemeralMsg(a,f).then(function(a){var b;if((a==null?void 0:a.success)===!0&&(a==null?void 0:(b=a.value)==null?void 0:b.outOfSyncEphemeralSetting)!=null)return a.value.outOfSyncEphemeralSetting;else return null}))}});else if(b.messageExpirationTs!=null&&b.messageDeleteTs!=null){var j=b.ephemeralSetting,k=b.messageExpirationTs,l=b.messageDeleteTs;d("MAWEphemeralCleaner").addNewEphemeralTimestamp(k,l);i=d("MAWEphemeralSettingsTxns").handleAndWriteIncomingEphemeralSetting(a,e,g,j,f,h,null).then(function(a){var b;if((a==null?void 0:a.success)===!0&&(a==null?void 0:(b=a.value)==null?void 0:b.outOfSyncEphemeralSetting)!=null){return a==null?void 0:(b=a.value)==null?void 0:b.outOfSyncEphemeralSetting}else return null})}return i.then(function(b){b==null&&d("MAWEphemeralSettingsTxns").maybeResetEphemeralSyncResponseBackoffInfo(a,e);return b})}g.bulkMarkEphemeralMessageAsRead=a;g.bulkUpdateEphemeralMessageTimestamps=k;g.updateThreadsOnMessagesExpiredFromUi=b;g.maybeUpdateEphemeralMessageWhenMarkedSent=e;g.maybeUpdateEphemeralSettingOrCheckOutOfSyncAfterWritingIncomingMsg=f},98);
__d("MAWIncomingReceiptUtils",["MAWDbParticipant","WALogger","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["User "," is in affectedUserJids in receipt-writing results, but they have no corresponding read/delivery receipt entry in the DB"]);h=function(){return a};return a}function a(a){var b=new Map();a.forEach(function(a){if(a.type!=="updated"||a.msgRenderType==="unrendered")return;a.affectedUserJids.forEach(function(c){var e=a.receipt.statusTsPerUser.get(c);if(e==null){d("WALogger").WARN(h(),c);return}c=d("MAWDbParticipant").craftParticipantId(a.threadId,c);var f=b.get(c),g=e.deliveredTs!=null,i=e.readTs!=null;g=g?a.msgTs:0;i=i?a.msgTs:0;e=(e=e.readTs)!=null?e:0;if(f!=null){var j=f.lastDeliveredMsgTs,k=f.lastReadMsgTs;f=f.lastReadActionTs;g=Math.max(g,j);i=Math.max(i,k);e=Math.max(e,f)}b.set(c,{lastDeliveredMsgTs:d("WATimeUtils").castToUnixTime(g),lastReadMsgTs:d("WATimeUtils").castToUnixTime(i),lastReadActionTs:d("WATimeUtils").castToUnixTime(e)})})});return b}g.getMaxTimestampsPerParticipant=a},98);
__d("MAWAckAndTimestampUpdatesForReceiptsTxns",["MAWBridgeTypes","MAWDbMsgTxns","MAWDbParticipantTxns","MAWDbUnrenderedMsgTxns","MAWDexieTable","MAWEphemeralCleaner","MAWEphemeralMsgTxns","MAWIncomingReceiptUtils","MAWIndexedDb","WALogger"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["EphemeralCounter: Showing UI counter for ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Updating timestamps for "," participants"]);i=function(){return a};return a}function a(a,b,c,e){b=d("MAWIncomingReceiptUtils").getMaxTimestampsPerParticipant(b);d("WALogger").LOG(i(),b.size);var f=[];b.forEach(function(a,b){f.push({participantId:b,deliveredWatermarkTs:a.lastDeliveredMsgTs,lastReadWatermarkTs:a.lastReadMsgTs,lastReadActionTs:a.lastReadActionTs})});b=c.regular.length>0?d("MAWDbMsgTxns").bulkUpdateSystemAck(a,c.regular):d("MAWDexieTable").dexieResolve();c=c.unrendered.length>0?d("MAWDbUnrenderedMsgTxns").bulkUpdateSystemAckForUnrenderedMsgs(a,c.unrendered):d("MAWDexieTable").dexieResolve();b=d("MAWDexieTable").dexieAll([b,c]);return d("MAWDexieTable").dexieAll([b,f.length>0?d("MAWDbParticipantTxns").bulkUpdateParticipantTimestamps(a,f):d("MAWDexieTable").dexieResolve(),e.length>0?d("MAWEphemeralMsgTxns").bulkUpdateEphemeralMessageTimestamps(a,e):d("MAWDexieTable").dexieResolve([])]).then(function(a){a=a[2];var b=a[0],c=a[1];a=a[2];b!=null&&c!=null&&a.length>0&&(d("MAWEphemeralCleaner").addNewEphemeralTimestamp(b,c),d("WALogger").DEV(h(),a.map(function(a){return a.msgId})),d("MAWIndexedDb").afterTransaction({tag:"MsgsStartCountdown",value:d("MAWBridgeTypes").createBridgeMsgsStartCountdown(a)}))})}g.handleAckAndTimestampUpdatesForReceipts=a},98);
__d("MAWIncomingReceiptDataFormatTxns",["MAWDbMsgTxns","MAWDbUnrenderedMsgTxns","MAWDexieTable","WALogger","WAMsgType"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to map the threadId of a message to its threadJid during receipt-writing"]);h=function(){return a};return a}function i(a){var b=a.chat,c=a.externalId;a=a.author;return b+"_"+c+"_"+a}function a(a,b){var c=new Map(),e=new Set();b.forEach(function(a){a=a.msgs;a.forEach(function(a){return e.add(babelHelpers["extends"]({},a))})});a=d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").getMsgsByProtocolMsgId(a,Array.from(e)),d("MAWDbUnrenderedMsgTxns").getUnrenderedMsgsByProtocolMsgId(a,Array.from(e))]).then(function(a){var b=a[0];a=a[1];var c=[];b.msgs.forEach(function(a){return c.push({renderType:"regular",msg:a})});a.msgs.forEach(function(a){return c.push({renderType:"unrendered",msg:a})});b=Array.from(b.threadIdToJid.entries()).concat(Array.from(a.threadIdToJid.entries()));a=new Map(b);return{msgs:c,threadIdToJid:a}});return a.then(function(a){var e=a.msgs,f=a.threadIdToJid;b.forEach(function(a){var b=a.msgs,d=a.type,e=a.receivers;b.forEach(function(a){var b=i(a),f=c.get(b)||{deliveryReceipts:[],readReceipts:[],senderReceipts:[],protocolMsgId:a};e.forEach(function(a){d==="read"?f.readReceipts.push(a):d==="delivered"?f.deliveryReceipts.push(a):d==="sender"?f.senderReceipts.push(a):d==="inactive"&&f.deliveryReceipts.push(a)});c.set(b,f)})});var g=new Map(),j=new Map(),k=[];e.forEach(function(a){var b=a.msg,e=b.externalId,k=b.thread,l=b.author,m=b.type;b=b.msgId;k=f.get(k);if(k==null){d("WALogger").ERROR(h());return}if(m!==d("WAMsgType").MSG_TYPE.CIPHERTEXT){m=i({externalId:e,chat:k,author:l});e=c.get(m);if(e!=null){e.protocolMsgId;k=babelHelpers.objectWithoutPropertiesLoose(e,["protocolMsgId"]);l=babelHelpers["extends"]({msgId:b},k);j.set(b,l);c["delete"](m)}}g.set(b,a)});c.forEach(function(a){var b=a.deliveryReceipts,c=a.readReceipts;a=a.protocolMsgId;if(b.length===0&&c.length===0)return;var d=a.chat,e=a.author;a=a.externalId;k.push({thread:d,author:e,externalId:a,deliveryReceipts:b,readReceipts:c})});return{msgIdToDbMsgMap:g,receiptsToWriteMap:j,pendingReceiptsToWrite:k}})}g.prepareDataForReceiptsToWrite=a},98);
__d("MAWIncomingReceiptDataFormatUtils",["MAWAckLevel.re","MAWDbMsg"],function(a,b,c,d,e,f,g){"use strict";function a(a,b){var c=[],e=[];a.forEach(function(a){if(a.type!=="updated")return;var f=null,g=a.receipt.msgId,h=a.receipt.statusTsPerUser,i=b.get(g);if(i==null)return;var j=i.msg;i=i.renderType;a.affectedUserJids.forEach(function(a){var b,c=null;((b=h.get(a))==null?void 0:b.readTs)!=null?c=d("MAWAckLevel.re").ACK.read:((b=h.get(a))==null?void 0:b.deliveredTs)!=null&&(c=d("MAWAckLevel.re").ACK.received);f=f==null||c!=null&&c>f?c:f});f!=null&&f>j.ack&&(i==="regular"?c.push({ack:f,msgId:g,reportingMeta:null}):(i,e.push({ack:f,msgId:g})))});return{regular:c,unrendered:e}}function b(a,b,c){return a.map(function(a){var e=b.get(a.receipt.msgId);if(e==null)return null;var f=e.msg,g=c.get(f.msgId);return g==null||g.deliveryReceipts.length===0&&g.readReceipts.length===0?null:babelHelpers["extends"]({},a,{externalId:f.externalId,threadId:f.thread,msgTs:d("MAWDbMsg").getCanonicalTsFromMsg(f),msgRenderType:e.renderType})}).filter(Boolean)}g.createUpdateSystemAckParams=a;g.formatWriteReceiptResultsWithExtras=b},98);
__d("MAWReceiptTrace",["MAWBridgeTypes","MAWIndexedDb"],function(a,b,c,d,e,f,g){"use strict";function a(a,b){if(a==="delivered"){a=b.reduce(function(a,b){return b.type==="updated"&&b.externalId!=void 0?[].concat(a,[b.externalId]):a},[]);a.length>0&&d("MAWIndexedDb").afterTransaction({tag:"UpdateTrace",value:d("MAWBridgeTypes").createBridgeUpdateTraceData(a,"ReceivedReceipt")})}}g.flushTrace=a},98);
__d("MAWIncomingReceiptTxns",["MAWAckAndTimestampUpdatesForReceiptsTxns","MAWDbPendingReceiptTxns","MAWDbReceiptTxns","MAWDexieTable","MAWEphemeralConsts.re","MAWIncomingReceiptDataFormatTxns","MAWIncomingReceiptDataFormatUtils","MAWReceiptTrace","WAGlobals","WAJids","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";function a(a,b){return b.length===0?d("MAWDexieTable").dexieResolve():d("MAWIncomingReceiptDataFormatTxns").prepareDataForReceiptsToWrite(a,b).then(function(b){var c=b.msgIdToDbMsgMap,e=b.receiptsToWriteMap;b=b.pendingReceiptsToWrite;var f=[];e.forEach(function(a){f.push(a)});return d("MAWDexieTable").dexieAll([d("MAWDbReceiptTxns").bulkWriteReceiptsForDevices(a,f),d("MAWDbPendingReceiptTxns").bulkAddPendingReceipts(a,b)]).then(function(b){b=b[0];var f=d("MAWIncomingReceiptDataFormatUtils").createUpdateSystemAckParams(b,c),g=h(b,c);b=d("MAWIncomingReceiptDataFormatUtils").formatWriteReceiptResultsWithExtras(b,c,e);var i=b.filter(function(a){a=((a=e.get(a.receipt.msgId))==null?void 0:a.deliveryReceipts)||[];return a.length>0});i.length>0&&d("MAWReceiptTrace").flushTrace("delivered",i);return d("MAWAckAndTimestampUpdatesForReceiptsTxns").handleAckAndTimestampUpdatesForReceipts(a,b,f,g)})})}function h(a,b){var c=[];a.forEach(function(a){if(a.type!=="updated")return;var e=a.receipt.msgId,f=a.receipt.statusTsPerUser,g=b.get(e);if(g==null)return;if(g.renderType==="unrendered")return;g=g.msg;var h=g.ephemeralSetting;g=g.author;var i=h==null?void 0:h.ephemeralExpirationInSec;if(i==null||i===0)return;if(g!==d("WAJids").AUTHOR_ME)return;a.affectedUserJids.forEach(function(a){if(a!==d("WAGlobals").getMyUserJid()){a=(a=f.get(a))==null?void 0:a.readTs;if(a!=null){a=d("WATimeUtils").castToUnixTime(a+i);var b=d("WATimeUtils").castToUnixTime(a+d("MAWEphemeralConsts.re").EPHEMERAL_REPORTING_WINDOW_IN_SECONDS);c.push({msgId:e,messageExpirationTs:a,messageDeleteTs:b})}}})});return c}g.bulkHandleIncomingReceipts=a;g.createUpdateEphemeralTimestampsParams=h},98);
__d("MAWMarkThreadAsReadTxns",["MAWBridgeTypes","MAWIndexedDb","MAWMessageRequestUtils","WAJids","err"],function(a,b,c,d,e,f,g){"use strict";function a(a,b,c){return h(a,[{threadId:b,upToMsgId:c}]).then(function(a){a=a.get(b);return a==null?{type:"missing",shouldSendReadReceipts:!1}:a})}function h(a,b){var e=[],f=new Map();b.map(function(a){e.push(a.threadId),f.set(a.threadId,a.upToMsgId)});var g=new Map(),h=new Map();return a.threads.bulkGet(e).then(function(b){var i=[];b.forEach(function(a){a!=null&&d("WAJids").switchOnMsgrChatJidType(a.jid,{group:function(a){return null},user:function(a){return i.push(a)}})});return a.contacts.bulkGet(i).then(function(i){var j=[];i.forEach(function(a){a!=null&&g.set(a.contactJid,a)});b.forEach(function(a,b){if(a==null){h.set(e[b],{type:"missing",shouldSendReadReceipts:!1});return}var i=g.get(a.jid),k=i!=null&&i.isBlocked!=null&&i.isBlocked,l=i!=null&&i.isRestricted!=null&&i.isRestricted;i=!(d("MAWMessageRequestUtils").isMessageRequestOrSpamThread(a,i)||k||l);k=a.oldestMsg;if(k==null){h.set(e[b],{type:"success",shouldSendReadReceipts:i});return}l=f.get(a.chatId);if(l==null)throw c("err")("This is for flow error check");if(a.lastReadMsg!=null&&a.lastReadMsg>=l){h.set(e[b],{type:"success",shouldSendReadReceipts:i});return}j.push({thread:a,shouldSendReadReceipts:i})});var k=[],l=[];j.map(function(a){var b=a.thread,c=f.get(b.chatId);a=a.shouldSendReadReceipts;var d=b.newestMsgTs;b=babelHelpers["extends"]({},b,{lastReadMsg:c,lastReadMsgTs:d});k.push(b);l.push(a)});return a.threads.bulkPut(k).then(function(){k.forEach(function(a,b){a.lastReadMsgTs!=null&&d("MAWIndexedDb").afterTransaction({tag:"ThreadTimestampsUpdated",value:d("MAWBridgeTypes").createBridgeThreadTimestampsUpdated(a.chatId,a.lastReadMsgTs,a.lastReadMsgTs)}),h.set(a.chatId,{type:"success",shouldSendReadReceipts:l[b]})});return h})})})}g.markThreadAsReadUpToMsgId=a;g.bulkMarkThreadAsReadUpToMsgId=h},98);
__d("MAWRecipientDevicesTxns",["MAWDbContactsTxns","MAWDbIdentityTxns","MAWDbParticipantTxns","MAWGlobals","WAIdentityUtils","WAJids","WAResultOrError"],function(a,b,c,d,e,f,g){"use strict";function a(a,b){return d("MAWDbParticipantTxns").getParticipantsInThread(a,b).then(function(b){if(b.length===0)return d("WAResultOrError").makeError("missing_participants");b=b.map(function(a){return a.userJid});return h(a,b).then(d("WAResultOrError").makeSuccess)})}function h(a,b){return a.contacts.bulkGet(b).then(function(a){var b=[];a.forEach(function(a){if(a==null)return;a.devices.forEach(function(a){if(a===d("MAWGlobals").getMyDeviceJid())return;b.push(a)})});return b})}function b(a,b){return a.receipts.get(b).then(function(b){if(b==null)return d("WAResultOrError").makeError("missing_receipt");b=b.statusTsPerUser;b=Array.from(b.keys());return a.contacts.bulkGet(b).then(function(a){var b=[];a.forEach(function(a){if(a==null)return;a.devices.forEach(function(a){if(a===d("MAWGlobals").getMyDeviceJid())return;b.push(a)})});return d("WAResultOrError").makeSuccess(b)})})}function c(a,b){return d("MAWDbParticipantTxns").getParticipantsInThread(a,b).then(function(b){if(b.length===0)return d("WAResultOrError").makeError("missing_participants");b=b.map(function(a){return a.userJid});return d("MAWDbContactsTxns").getContacts(a,b).then(function(b){var c=[],e=b.flatMap(function(a){return a.devices});b.forEach(function(a){a.lastSyncTs!=null&&c.push({user:a.contactJid,lastSyncTs:a.lastSyncTs})});return d("MAWDbIdentityTxns").getIdentitiesForDevices(a,e).then(function(a){var e=[],f=new Map();a.forEach(function(a,b){f.set(d("WAIdentityUtils").removeKeyTypeIfNeeded(a.pubKey).toString(),b)});b.forEach(function(a){var b=a.icdcInfo;if(b==null)return;var c=b.signingDeviceIndex,g=b.devices;if(c>=g.length)return;g=g.map(function(a){var b=f.get(a.toString());if(b==null)return;return{id:d("WAJids").extractDeviceId(b),identity:a}}).filter(Boolean);e.push({user:a.contactJid,sequence:b.sequence,timestamp:b.timestamp,signingDeviceIndex:c,devices:g})});return d("WAResultOrError").makeSuccess({contactsSyncInfo:c,icdcInfoList:e})})})})}g.getRecipientDevicesByThread=a;g.getRecipientDevicesByUserJids=h;g.getRecipientDevicesByMsgId=b;g.getICDCInfoForUsersInThread=c},98);
__d("MAWMsgReceiptPreparationTxns",["MAWDbIdentityTxns","MAWDbParticipantTxns","MAWDexieTable","MAWRecipientDevicesTxns","WAResultOrError"],function(a,b,c,d,e,f,g){function a(a,b,c,e,f){e===void 0&&(e=!0);f===void 0&&(f=!1);return a.receipts.get(b).then(function(g){return g!=null&&!f?g:a.threads.get({jid:c}).then(function(c){if(c==null)return;return d("MAWDbParticipantTxns").getParticipantsInThread(a,c.chatId).then(function(c){var g=c.map(function(a){return a.userJid});c=f?d("MAWRecipientDevicesTxns").getRecipientDevicesByMsgId(a,b):d("MAWRecipientDevicesTxns").getRecipientDevicesByUserJids(a,g).then(d("WAResultOrError").makeSuccess);return c.then(function(a){return a.success?a.value:[]}).then(function(c){var f=new Set(c);c=e?d("MAWDbIdentityTxns").getIdentitiesForDevices(a,c):d("MAWDexieTable").dexieResolve();return c.then(function(c){var d=new Map();g.forEach(function(a){return d.set(a,{})});var e={msgId:b,statusTsPerUser:d,permittedIdentitiesPerDevice:c,recipientDevices:f};return a.receipts.put(e).then(function(){return e})})})})})})}g.prepareReceiptForMsg=a},98);
__d("MAWMsgRecipientsTxns",["MAWDbContactsTxns","MAWDbIdentityTxns","MAWGlobals","WAJids"],function(a,b,c,d,e,f,g){"use strict";function a(a,b){return a.receipts.get(b).then(function(a){if(a==null||a.permittedIdentitiesPerDevice==null)return[];a=a.permittedIdentitiesPerDevice;var b=new Map();a.forEach(function(a,c){a=a.pubKey;var e=d("WAJids").extractUserJid(c);c={jid:c,identity:a};a=b.get(e)||[];a.push(c);b.set(e,a)});var c=[];b.forEach(function(a,b){c.push({user:b,devicesInfo:a})});return c})}function b(a,b){return a.receipts.get(b).then(function(b){if(b==null)return[];var c=[];b.statusTsPerUser.forEach(function(a,b){return c.push(b)});return d("MAWDbContactsTxns").getContacts(a,c).then(function(b){var c=[];b.forEach(function(a){a.devices.forEach(function(a){if(a===d("MAWGlobals").getMyDeviceJid())return;c.push(a)})});return d("MAWDbIdentityTxns").bulkGetIdentities(a,c).then(function(a){var b=new Map();a.forEach(function(a){var c=a.id;a=a.identity;var e=d("WAJids").extractUserJid(c);c={jid:c,identity:a};a=b.get(e)||[];a.push(c);b.set(e,a)});var c=[];b.forEach(function(a,b){c.push({user:b,devicesInfo:a})});return c})})})}g.getMsgRecipients=a;g.getRevokedMsgRecipients=b},98);
__d("MAWPendingReceiptProcessingTxns",["MAWBridgeTypes","MAWDbParticipant","MAWDbParticipantTxns","MAWDbPendingReceipt","MAWDbReceiptTxns","MAWDexieTable","MAWEphemeralCleaner","MAWEphemeralMsgTxns","MAWIncomingReceiptTxns","MAWIndexedDb","MAWMarkThreadAsReadTxns","WAJids","WALogger","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Processing pending receipts for "," from ",""]);h=function(){return a};return a}function a(a,b,c){var e=d("MAWDbPendingReceipt").craftPendingReceiptId(b,c.externalId,c.author);return a.pendingReceipts.get(e).then(function(b){if(b==null)return;d("WALogger").LOG(h(),c.externalId,c.author);if(b.author===d("WAJids").AUTHOR_ME){var f=d("MAWDexieTable").dexieResolve();b.deliveryReceipts.length>0&&(f=f.then(function(){return d("MAWDbReceiptTxns").writeReceiptsForDevices(a,c.msgId,"delivered",b.deliveryReceipts)}));b.readReceipts.length>0&&(f=f.then(function(){return d("MAWDbReceiptTxns").writeReceiptsForDevices(a,c.msgId,"read",b.readReceipts)}));return f.then(function(b){var f=[],g=d("MAWDexieTable").dexieResolve();b!=null&&b.type!=="missing"&&(b.receipt.statusTsPerUser.forEach(function(b,e){var g=b.deliveredTs!=null?c.ts:d("WATimeUtils").castToUnixTime(0),h=b.readTs!=null?c.ts:d("WATimeUtils").castToUnixTime(0);b=(b=b.readTs)!=null?b:d("WATimeUtils").castToUnixTime(0);f.push(d("MAWDbParticipantTxns").updateParticipantTimestamps(a,d("MAWDbParticipant").craftParticipantId(c.thread,e),g,h,b))}),g=d("MAWEphemeralMsgTxns").bulkUpdateEphemeralMessageTimestamps(a,d("MAWIncomingReceiptTxns").createUpdateEphemeralTimestampsParams([b],new Map([[c.msgId,{renderType:"regular",msg:c}]]))));return d("MAWDexieTable").dexieAll([g].concat(f)).then(function(b){b=b[0];if(b!=null){var c=b[0],f=b[1];b=b[2];c!=null&&f!=null&&d("MAWEphemeralCleaner").addNewEphemeralTimestamp(c,f);d("MAWIndexedDb").afterTransaction({tag:"MsgsStartCountdown",value:d("MAWBridgeTypes").createBridgeMsgsStartCountdown(b)})}a.pendingReceipts["delete"](e)})})}else{f=i(b);f=f!=null?d("MAWEphemeralMsgTxns").bulkMarkEphemeralMessageAsRead(a,[f]):d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([d("MAWMarkThreadAsReadTxns").markThreadAsReadUpToMsgId(a,c.thread,c.msgId),f]).then(function(){return a.pendingReceipts["delete"](e)})}})}function i(a){var b=a.thread,c=a.author,e=a.externalId;a=a.readReceipts;if(!d("WAJids").isAuthorMe(c)&&!d("WAJids").isAuthorSystem(c)){b={chat:b,author:c,externalId:e};c=a.length>0?a.reduce(function(a,b){return b.ts<a?b.ts:a},a[0].ts):null;if(c!=null)return{msgId:b,ts:c}}return null}g.processPendingReceipts=a},98);
__d("MAWLowLevelApiTypes",[],function(a,b,c,d,e,f){"use strict";a={MISSING_GROUP:"missing_group",EXISTING_GROUP_INVITE:"existing_group_invite"};f.WRITE_GROUP_INVITE_ERROR=a},66);
__d("MAWWriteGroupInviteTxns",["MAWDbGroupInviteTxns","MAWDbThreadTxns","MAWLowLevelApiTypes","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";function a(a,b,c){return d("MAWDbThreadTxns").getThreadByJid(a,c).then(function(c){return!c.success?d("MAWLowLevelApiTypes").WRITE_GROUP_INVITE_ERROR.MISSING_GROUP:d("MAWDbGroupInviteTxns").maybeGetGroupInvite(a,b.inviterJid,b.invitedParticipantId).then(function(c){return c&&!d("WATimeUtils").isInFuture(c.inviteExpirationTs)?d("MAWLowLevelApiTypes").WRITE_GROUP_INVITE_ERROR.EXISTING_GROUP_INVITE:d("MAWDbGroupInviteTxns").putGroupInvite(a,b)})})}g.writeGroupInvite=a},98);
__d("MAWWriteMetaSyncsTxns",["MAWDbPendingStanza","MAWDbPendingStanzaTxns","MAWDbThreadTxns","MAWDexieTable","MAWThreadManagementTxns","MAWWriteMsgTxns","WAAssertUnreachable","WALogger","WAStanzaUtils","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Received action: "," msgs: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Received chatRead: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["No message found for deletion through handle meta sync action."]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Received chatDelete: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Received chatArchive: ",""]);l=function(){return a};return a}var m=30*d("WATimeUtils").DAY_SECONDS;function n(a,b){var c=[];if(b!=null)for(var b=b.messages,e=Array.isArray(b),f=0,b=e?b:b[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var g;if(e){if(f>=b.length)break;g=b[f++]}else{f=b.next();if(f.done)break;g=f.value}g=g;g.key!=null&&g.key.id!=null&&c.push(d("WAStanzaUtils").toStanzaId(g.key.id))}return a.messages.where("externalId").anyOf(c).toArray().then(function(a){var b=new Map();for(var a=a,c=Array.isArray(a),d=0,a=c?a:a[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var e;if(c){if(d>=a.length)break;e=a[d++]}else{d=a.next();if(d.done)break;e=d.value}e=e;var f=e.thread;if(!b.has(f))b.set(f,[e]);else{(f=b.get(f))==null?void 0:f.push(e)}}return b})}function o(a,b,c){d("WALogger").LOG(l(),c);return d("MAWDexieTable").dexieResolve()}function p(a,b,c){d("WALogger").LOG(k(),c);b=c.messageRange;b=b!=null?d("MAWDbPendingStanzaTxns").putPendingStanza(a,{type:d("MAWDbPendingStanza").PENDING_TYPE.DELETE_THREAD,content:{metaSyncMessageRange:b}},m,c.chatJid,d("MAWDbPendingStanza").PENDING_TYPE.DELETE_THREAD):d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([d("MAWDbThreadTxns").getThreadByJid(a,c.chatJid),b]).then(function(b){b=b[0];if(b.success)return d("MAWThreadManagementTxns").metaSyncChatDeleteThread(a,b.value,c.messageRange);else d("WALogger").ERROR(j())})}function q(a,b,c){d("WALogger").LOG(i(),c);return d("MAWDexieTable").dexieResolve()}function a(a,b){if(b.chatAction)return r(a,b.chatAction);else if(b.messageAction)return s(a,b.messageAction);return d("MAWDexieTable").dexieResolve()}function r(a,b){return n(a,b.messageRange).then(function(c){d("WALogger").LOG(h(),b,c);switch(b.type){case"chat_archive":return o(a,c,b);case"chat_delete":return p(a,c,b);default:b.type;return q(a,c,b)}})}function s(a,b){switch(b.type){case"delete_for_me":return d("MAWWriteMsgTxns").handleDeleteForMe(a,b).then(function(){});default:return c("WAAssertUnreachable")(b.type)}}g.PENDING_DELETE_THREAD_EXPIRATION_IN_SEC=m;g.getMessages=n;g.handleChatArchive=o;g.handleChatDelete=p;g.handleChatRead=q;g.handleMetaSyncAction=a},98);
__d("MAWWriteReactionTxns",["MAWAuthor","MAWBridgeTypes","MAWDbReaction","MAWDbReactionsTxns","MAWDexieTable","MAWIndexedDb","WAJids","WAResultOrError","err"],function(a,b,c,d,e,f,g){"use strict";function h(a,b){var c=a.reactToMsgId,e=a.reaction,f=a.ts;a=a.author;if(c==null)return;e=e==null?{tag:"DeleteReaction",value:d("MAWBridgeTypes").createBridgeDeleteReaction({reactToMsgId:c,author:a,chatId:b})}:{tag:"UpsertReaction",value:d("MAWBridgeTypes").createBridgeUpsertReaction({reaction:e||"",reactToMsgId:c,ts:f,author:a,chatId:b})};d("MAWIndexedDb").afterTransaction(e)}function i(a,b,c){var e=b.reactToExternalId,f=b.author,g=b.reactToAuthor,i=b.externalId,j=b.reaction,k=b.ts,l=b.groupingKey;return d("MAWDexieTable").dexieAll([a.threads.where("jid").equals(c).first(),a.messages.where("externalId").equals(e).toArray(),a.reactions.where("reactToExternalId").equals(e).toArray()]).then(function(b){var c=b[0],m=b[1];b=b[2];if(!c)return"missing_thread";var n=d("MAWDbReaction").craftReactionId(c.chatId,c.nextInChatMsgId);b=d("MAWDbReaction").findMatchingReaction(b,c.jid,f);var o=d("MAWAuthor").getAuthorUserJid(g);m=m.find(function(a){return a.thread===c.chatId&&o===d("MAWAuthor").getAuthorUserJid(a.author)});var p=d("MAWDbReaction").formatReaction(c.jid,i,n,e,j,l,g,m==null?void 0:m.msgId,k,(n=f)!=null?n:d("WAJids").AUTHOR_ME,b==null?void 0:b.rowId);m=(b==null?void 0:b.reactionId)!=null?a.receipts.where("msgId").equals(b==null?void 0:b.reactionId)["delete"]():d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([d("MAWDbReactionsTxns").putReaction(a,c,p),m]).then(function(a){a=a[0];a=babelHelpers["extends"]({},p,{rowId:a});h(a,c.chatId);return a})})}function a(a,b,e,f,g){return i(a,b,e).then(function(a){if(typeof a==="string")return d("WAResultOrError").makeError(a);var b=a.author;if(d("WAJids").isAuthorSystem(b))throw c("err")("This cannot happen because a reaction cannot have SYSTEM author");return d("WAResultOrError").makeSuccess({icdcResults:g,protocolMsgId:{author:b,externalId:a.externalId,chat:e},plaintextHashs:null,unknownDevice:f})})}g.writeReaction=i;g.writeIncomingReactionMsg=a},98);
__d("MAWRestoreMsgsTxns",["MAWBridgeTypes","MAWDbMsg","MAWDbMsgTxns","MAWDbThread","MAWDexieTable","MAWFolderTypes","MAWIndexedDb","MAWThreadSnippetBuildTxns","MAWWriteMsgTxns","WADualSendMsgUtils","WAJids","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";function h(a,b){return b.oldestMsg==null?d("MAWDexieTable").dexieResolve():d("MAWDbMsgTxns").maybeGetMsg(a,b.oldestMsg)}function a(a,b,c){return h(a,c).then(function(e){var f=c.newestMsgTs||d("WATimeUtils").castToUnixTime(0),g=c.newestMsg,h=c.oldestMsg,i=(e=e==null?void 0:e.ts)!=null?e:d("WATimeUtils").castToUnixTime(0),j=c.lastReadMsg,k=c.lastReadMsgTs,l=!1,m=(e=c.nextInChatMsgId)!=null?e:1;b.sort(function(a,b){return((a=a.sortOrderMs)!=null?a:0)-((a=b.sortOrderMs)!=null?a:0)});e=b.map(function(b){return d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,b.externalId,c.chatId,b.author).then(function(e){if(e==null){var n=b.ts;f=n>f?n:f;var o=d("MAWDbMsg").craftMsgId(c.chatId,m);m+=1;(h==null||n<i)&&(l=!0,h=o,i=n);f===n&&(g=o);b.author===d("WAJids").AUTHOR_ME&&(k==null||n>k)&&(j=o,k=n);var p=babelHelpers["extends"]({},b,{msgId:o,sortOrderMs:d("MAWDbMsg").getSortOrderWithFallback(b)});return a.messages.add(p).then(function(a){a=babelHelpers["extends"]({},p,{rowId:a});a.altIndex!==d("MAWDbMsg").SPAM_ALT_INDEX&&a.altIndex!==d("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX&&(d("MAWIndexedDb").afterTransaction({tag:"StartTrace",value:d("MAWBridgeTypes").createBridgeStartTraceData(a,c.jid)}),d("WADualSendMsgUtils").isDualSendJid(c.jid)||d("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:d("MAWBridgeTypes").createBridgeMsg(a)}));return{dbMsg:a,wasMsgAlreadyInStore:!1,threadJId:c.jid}})}else return{dbMsg:e,wasMsgAlreadyInStore:!0,threadJId:c.jid}})});return d("MAWDexieTable").dexieAll(e).then(function(b){var e=b.reduce(function(a,b){b.wasMsgAlreadyInStore||a.push(b);return a},[]);if(e.length===0)return{restoredMessages:b,chatId:c.chatId};b=e[e.length-1];var i=babelHelpers["extends"]({},c,{threadOrder:d("MAWDbThread").craftThreadOrder(f,c.jid),newestMsg:g,oldestMsg:h,nextInChatMsgId:m,lastReadMsg:j,lastReadMsgTs:k,newestMsgTs:f}),n=d("MAWWriteMsgTxns").shouldThreadBeUnarchived(i);n&&(i=babelHelpers["extends"]({},i,{archived:!1,folder:d("MAWFolderTypes").FOLDER_ID.INBOX}));return d("MAWDexieTable").dexieAll([a.threads.put(i),d("MAWThreadSnippetBuildTxns").buildThreadSnippet(a,b.dbMsg,c)]).then(function(b){var g=b[0];b=b[1];var h=b.snippetType,j=b.snippetParams,m=b.snippetSenderContactId;return a.threads.get({jid:c.jid}).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"ThreadBumped",value:d("MAWBridgeTypes").createBridgeBumpedThread(g,d("WADualSendMsgUtils").isDualSendJid(c.jid),f,k,h,j,m,!0)});if(c.oldestMsg==null||l){a=e.map(function(a){return a.dbMsg}).reverse();d("MAWIndexedDb").afterTransaction({tag:"MsgsLoaded",value:d("MAWBridgeTypes").createBridgeMsgsLoadedInfo(g,a,c.oldestMsg==null,!1)})}n&&d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypes").createBridgeUpdatedThread({threadId:i.chatId,folder:d("MAWFolderTypes").FOLDER_ID.INBOX,cannotReplyReason:i.cannotReplyReason})});return{restoredMessages:e,chatId:c.chatId}})})})})}g.restoreMsgsForThread=a},98);
__d("MAWUploadMessageTxns",["EchoCommonUtils","EchoDecodingUtils","EchoEncodingUtils","EchoMessage","FBLogger","MAWDbContactsTxns","MAWDbMediaTxns","MAWDbMsg","MAWDbReactionsTxns","MAWDexieTable","MAWJidUtils","MAWJids","MAWMsgType","MAWVault","WAGlobals","WAJids","WAMsgType","err"],function(a,b,c,d,e,f,g){"use strict";function h(a,b){return a.threads.get(b).then(function(a){if(a==null)throw c("err")("constructEchoMessage: thread not present");return a.jid})}function i(a,b,c){return a.receipts.get(b.msgId).then(function(e){var f=[];e!=null&&e.statusTsPerUser.forEach(function(e,g){f.push(d("MAWDbContactsTxns").maybeGetContactName(a,g).then(function(a){var f=d("EchoMessage").MessageReceiptStatus.UNKNOWN,h;g===c?(f=d("EchoMessage").MessageReceiptStatus.READ,h=b.ts):e.readTs!=null?(f=d("EchoMessage").MessageReceiptStatus.READ,h=e.readTs):e.deliveredTs!=null&&(f=d("EchoMessage").MessageReceiptStatus.DELIVERED,h=e.deliveredTs);a={address:d("EchoCommonUtils").craftEchoAddress(a,d("MAWJids").userIdFromJid(g),"AdvancedCrypto"),status:f};h!=null&&(a.timestampMs=h*1e3);return a}))});return d("MAWDexieTable").dexieAll(f)})}function a(a,b){if(b.type!==d("WAMsgType").MSG_TYPE.TEXT&&!d("MAWMsgType").isMAWSupportedMediaType(b.type))throw c("err")('constructEchoMessage: "'+String(b.type)+'" NYI');var e=h(a,b.thread),f=d("WAJids").authorToUserId(b.author,d("MAWJids").userIdFromJid(d("WAGlobals").getMyUserJid())),g=d("MAWJids").toUserJid(f),l=d("MAWDbContactsTxns").maybeGetContactName(a,g);g=i(a,b,g);var m=j(a,b);a=k(a,b);return d("MAWDexieTable").dexieAll([e,l,g,m,a]).then(function(a){var e=a[0],g=a[1],h=a[2],i=a[3];a=a[4];e=d("MAWJidUtils").threadIdForChatJid(e);var j=b.serverTs;j={messageId:b.externalId,threadId:e,sortOrderMs:d("MAWDbMsg").getSortOrderWithFallback(b),displayTimestampMs:b.ts*1e3,authoritativeTimestampMs:j!=null?j*1e3:void 0,from:d("EchoCommonUtils").craftEchoAddress(g,f,"AdvancedCrypto"),textSize:d("EchoMessage").MessageTextSize.NONE,contentType:d("EchoMessage").EchoMessageContentType.TEXT,receiptStatusList:h,isForwarded:b.isForwarded,xOfflineThreadingId:b.externalId,xThreadId:e,version:d("EchoMessage").ECHO_MESSAGE_MIGRATION_DOCUMENT_VERSION,contentSubtype:d("EchoMessage").EchoMessageContentSubtype.NONE,xMessagePlaceholderType:d("EchoMessage").EchoMessagePlaceholderType.NO_PLACEHOLDER};b.type===d("WAMsgType").MSG_TYPE.TEXT&&(j=babelHelpers["extends"]({},j,{text:d("MAWVault").unvault(b.msgContent.content)}));g=b.quote;if(g!=null){h=g.content;if(h!=null){e=d("EchoDecodingUtils").echoDecodeAddress(h.author);if(e.success){g=e.result;g!=null&&h.ts!=null&&(j.quoteData={quoteMessageId:h.externalId,quoteMessageSender:g,quoteSortOrderInMs:h.ts})}}}if(d("MAWMsgType").isMAWSupportedMediaType(b.type))if(i!=null)j=babelHelpers["extends"]({},j,{contentType:d("EchoMessage").EchoMessageContentType.MEDIA,mediaData:i});else{c("FBLogger")("labyrinth_web").warn("constructEchoMessage: media data is null for media type of message");throw c("err")("constructEchoMessage: media data is null for media type of message")}return babelHelpers["extends"]({},j,a)})}function j(a,b){if(!d("MAWMsgType").isMAWSupportedMediaType(b.type))return d("MAWDexieTable").dexieResolve();if(b.mediaId==null){c("FBLogger")("labyrinth_web","mediaId_for_message_missing").mustfix("No media id found in a media msg");return d("MAWDexieTable").dexieResolve()}return d("MAWDbMediaTxns").maybeGetMediaFromMediaId(a,b.mediaId).then(function(a){if(!a){c("FBLogger")("labyrinth_web","db_media_missing_for_media_id").mustfix("no media db entry for media id");return d("MAWDexieTable").dexieResolve()}return d("EchoEncodingUtils").constructMediaMetadata(b.msgId,a)})}function k(a,b){return d("MAWDbReactionsTxns").getReactionsFromMessage(a,b.msgId).then(function(a){if(a!=null&&a.length>0){var b=d("WAJids").extractUserId(d("WAGlobals").getMyUserJid()),c=a.map(function(a){var c=d("WAJids").authorToUserId(a.author,b);return d("EchoCommonUtils").craftEchoAddress(a.reaction,c,"AdvancedCrypto")}),e=a.map(function(a){var c=d("WAJids").authorToUserId(a.author,b);return d("EchoCommonUtils").craftEchoAddress(a.ts.toString(),c,"AdvancedCrypto")});a=a.map(function(a){var c=d("WAJids").authorToUserId(a.author,b);return d("EchoCommonUtils").craftEchoAddress(a.externalId.toString(),c,"AdvancedCrypto")});return{reactions:c,reactionAuthoritativeTimestampMs:e,reactionXOfflineThreadingIds:a}}})}g.constructEchoMessage=a},98);
__d("MAWThreadTypes",["MAWTransactionMode"],function(a,b,c,d,e,f,g){a={threads:d("MAWTransactionMode").READWRITE,participants:d("MAWTransactionMode").READWRITE,groupInfo:d("MAWTransactionMode").READWRITE,messages:d("MAWTransactionMode").READWRITE,media:d("MAWTransactionMode").READWRITE,chunk:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READONLY,unrenderedMessages:d("MAWTransactionMode").READWRITE,pendingStanzas:d("MAWTransactionMode").READWRITE,receipts:d("MAWTransactionMode").READWRITE,reactions:d("MAWTransactionMode").READWRITE,senderKeySessions:d("MAWTransactionMode").READWRITE,personalSenderKeyStatuses:d("MAWTransactionMode").READWRITE,xma:d("MAWTransactionMode").READWRITE};g.ThreadRelatedTablesPermissions=a},98);
__d("MAWDbDualSendTxns",["MAWDexieTable","MAWThreadManagementTxns","WALogger"],function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["\n          'More than 1 dual send entry in database',\n          'messenger_web_product',\n        "]);h=function(){return a};return a}function i(a){return a.isDualSend.toArray().then(function(a){if(a.length>=1){a.length>1&&d("WALogger").ERROR(h());return a[0]}else return null})}function a(a){return a.threads.toArray().then(function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){return d("MAWThreadManagementTxns").deleteAllThreadData(a,b)})).then(function(a){})})}function b(a,b){return i(a).then(function(c){return c!=null?a.isDualSend.put(babelHelpers["extends"]({},c,{isEnabled:b})):a.isDualSend.add({isEnabled:b})})}function c(a,b){return a.dualSendMedia.get({id:b})}function e(a,b,c){return a.dualSendMedia.add({file:b,id:c})}function f(a){return a.dualSendMedia.clear()}g.getIsDualSendInstallation=i;g.deleteAllThreadsBecauseUserWasInDualSend=a;g.markAsDualSend=b;g.getDualSendMediaRowByFileType=c;g.addFileToDualSendMediaTable=e;g.deleteDualSendMediaTable=f},98);
__d("MAWProtoMsgToDbMsg",["MAWAckLevel.re","MAWDbMedia","MAWDbMsg","WAAssertUnreachable","WAHex","WALogger","WALongInt","WAMediaUtils","WAMsgType","WASortedLists","WATimeUtils","err"],function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["cannot compose mediaEntry with the media message"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["protobuf msg with too large size ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["protobuf msg with bad size ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["protobuf msg with no plaintext hash"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["We dont support this message type yet"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["interpretProto msg came with tags "," and ",""]);m=function(){return a};return a}var n={};function a(a){var b=p(a.proto);if(!b)return{unstoredDbMsg:null,unstoredDbMedia:null,unstoredDbReaction:null};var e={externalId:a.externalId,ts:a.ts,serverTs:a.ts,author:a.author,ack:d("MAWAckLevel.re").ACK.received,forwardingScore:0};switch(b.type){case"conversation":return{unstoredDbMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.TEXT,msgContent:{content:b.value}},e,{altIndex:d("MAWDbMsg").UNDEFINED_ALT_INDEX}),unstoredDbMedia:null,unstoredDbReaction:null};case"imageMessage":var f=b.value;f=q(f,e.ts);return{unstoredDbMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.IMAGE},e,{altIndex:d("MAWDbMsg").UNDEFINED_ALT_INDEX}),unstoredDbMedia:f,unstoredDbReaction:null};case"videoMessage":f=b.value;f=r(f,e.ts);return{unstoredDbMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.VIDEO},e,{altIndex:d("MAWDbMsg").UNDEFINED_ALT_INDEX}),unstoredDbMedia:f,unstoredDbReaction:null};case"audioMessage":f=b.value;f=s(f,e.ts);return{unstoredDbMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.PTT},e,{altIndex:d("MAWDbMsg").UNDEFINED_ALT_INDEX}),unstoredDbMedia:f,unstoredDbReaction:null};case"futureproof":return{unstoredDbMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.FUTUREPROOF,msgContent:{protobuf:d("WAHex").bytesToBuffer(a.bytes),subtype:n[b.type]||null},altIndex:d("MAWDbMsg").FUTUREPROOF_ALT_INDEX},e),unstoredDbMedia:null,unstoredDbReaction:null};case"reactionMessage":throw new(c("err"))("Reaction not support yet");default:return c("WAAssertUnreachable")(b.type)}}var o=["conversation","imageMessage","videoMessage","audioMessage"];function p(a){var b=null;for(var e=0;e<o.length;e++)if(a[o[e]]!=null){if(b){d("WALogger").ERROR(m(),b,o[e]);return null}b=o[e]}if(b==null){d("WALogger").ERROR(l());return{type:"futureproof"}}switch(b){case"audioMessage":return a.audioMessage!=null?{type:"audioMessage",value:a.audioMessage}:null;case"videoMessage":return a.videoMessage!=null?{type:"videoMessage",value:a.videoMessage}:null;case"imageMessage":return a.imageMessage!=null?{type:"imageMessage",value:a.imageMessage}:null;case"conversation":return a.conversation!=null?{type:"conversation",value:a.conversation}:null;default:c("WAAssertUnreachable")(b)}}function q(a,b){var c=u(a,"image");if(!c)return null;c=t(c,b);b=babelHelpers["extends"]({},c,{mediaType:d("MAWDbMedia").MEDIA_TYPE.IMAGE,validatedVideoInfo:null,validatedImageInfo:{width:a.width,height:a.height,jpegThumbnail:a.jpegThumbnail},validatedAudioInfo:null});return b}function r(a,b){var c=u(a,"video");if(!c)return null;c=t(c,b);b=babelHelpers["extends"]({},c,{mediaType:d("MAWDbMedia").MEDIA_TYPE.VIDEO,validatedVideoInfo:{duration:a.seconds!=null&&a.seconds>1?a.seconds:1,width:a.width,height:a.height,mimetype:a.mimetype,jpegThumbnail:a.jpegThumbnail},validatedImageInfo:null,validatedAudioInfo:null});return b}function s(a,b){var c=u(a,"ptt");if(!c)return null;c=t(c,b);b=babelHelpers["extends"]({},c,{mediaType:d("MAWDbMedia").MEDIA_TYPE.PTT,validatedVideoInfo:null,validatedImageInfo:null,validatedAudioInfo:{duration:a.seconds!=null&&a.seconds>1?a.seconds:1,mimetype:a.mimetype,played:!1}});return b}function t(a,b){return{plaintextHash:a.plaintextHash,size:a.size,msgIds:d("WASortedLists").emptySet(),mediaEntry:a.mediaEntry,ts:b}}function u(a,b){var c=a.fileSha256;if(!c){d("WALogger").ERROR(k());return null}var e=a.fileLength;if(e===null||e===void 0||e===0){d("WALogger").ERROR(j(),e);return null}try{e=d("WALongInt").numberOrThrowIfTooLarge(e)}catch(a){d("WALogger").ERROR(i(),e);return null}if(a.fileSha256==null||a.fileEncSha256==null||a.mediaKey==null||a.directPath==null||a.mediaKeyTimestamp==null){d("WALogger").ERROR(h());return null}a=d("WAMediaUtils").rawDataToMediaEntry(a.fileSha256,a.fileEncSha256,a.mediaKey,a.directPath,d("WATimeUtils").castLongIntToUnixTime(a.mediaKeyTimestamp),b);return{size:e,plaintextHash:d("WAMediaUtils").toPlaintextHash(new Uint8Array(c)),mediaEntry:a}}g.FUTUREPROOF_TYPES=n;g.protoMsgToDbMsg=a},98);
__d("MAWProtoV3Armadillo",["MAWEphemeralUtil","MAWGating.re","MAWXMAUtils","WAArmadilloApplication.pb","decodeProtobuf","err"],function(a,b,c,d,e,f,g){function a(a,b,e,f,g){b=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAArmadilloApplication.pb").ArmadilloSpec,b);b=(b=b.payload)==null?void 0:b.content;if(!b)return{unstoredDbMsg:null,unstoredDbMedia:null,unstoredDbReaction:null};var i=h(b);try{switch(i){case"screenshotAction":var j=b[i];if(j==null)throw c("err")("screenshotAction has no content");j=j.screenshotType;if(j==null)throw c("err")("Missing screenshot type in payload");return d("MAWEphemeralUtil").buildUnstoredDbEphemeralScreenshotActionMsgWithoutContentPlaceholder(e.serverTs,j);case"extendedContentMessage":if(!c("MAWGating.re").isXMAFeedPostShareEnabled())return{unstoredDbMsg:null,unstoredDbMedia:null,unstoredDbReaction:null};j=b[i];if(j==null)throw c("err")("extendedContentMessage has no content");return d("MAWXMAUtils").DEPRECATEDbuildUnstoredDbExtendedContentMsg(a,j,e,f,g);default:return{unstoredDbMsg:null,unstoredDbMedia:null,unstoredDbReaction:null}}}catch(a){return{unstoredDbMsg:null,unstoredDbMedia:null,unstoredDbReaction:null}}}function h(a){var b=Object.keys(a).filter(function(a){return a!=="$$unknownFieldCount"});if(b.length!==1)throw c("err")(JSON.stringify(a)+" armadillo payload content should only have one field");a=b[0];return a}g.parseArmadilloMessage=a},98);
__d("MAWProtoV3MsgToDbMsg",["MAWAckLevel.re","MAWDbMsg","MAWGating.re","MAWProtoV3Armadillo","MAWProtoV3ConsumerMessage","WAAssertUnreachable","WAHex","WAMsgType","err"],function(a,b,c,d,e,f,g){function a(a,b,e,f,g){f={externalId:e,ts:g,serverTs:g,author:f,ack:d("MAWAckLevel.re").ACK.received,forwardingScore:a.type!=="futureProof"?(g=a==null?void 0:(e=a.metadata)==null?void 0:e.forwardingScore)!=null?g:0:0};e=a.type!=="futureProof"&&((e=a.metadata)==null?void 0:(g=e.chatEphemeralSetting)==null?void 0:g.ephemeralExpiration)!=null&&((e=a.metadata)==null?void 0:(g=e.chatEphemeralSetting)==null?void 0:g.ephemeralExpiration)>0;if(a.type==="futureProof"||e&&!d("MAWGating.re").isEphemeralMessagesEnabled())return{unstoredDbMsg:babelHelpers["extends"]({type:d("WAMsgType").FUTUREPROOF,msgContent:{subtype:null,protobuf:d("WAHex").bytesToBuffer(a.protobuf)}},f,{altIndex:d("MAWDbMsg").FUTUREPROOF_ALT_INDEX}),unstoredDbMedia:null,unstoredDbReaction:null};else if(a.type==="subprotocol")switch(a.subprotocolType){case"consumerMessage":return d("MAWProtoV3ConsumerMessage").parseConsumerMessage(b,a.subprotocol,f,a.protobuf,a.metadata);case"armadillo":return d("MAWProtoV3Armadillo").parseArmadilloMessage(b,a.subprotocol,f,a.protobuf,a.metadata);case"businessMessage":throw c("err")("unsupported subprotocolType: "+a.subprotocolType);case"paymentMessage":throw c("err")("unsupported subprotocolType: "+a.subprotocolType);case"multiDevice":throw c("err")("unsupported subprotocolType: "+a.subprotocolType);case"voip":throw c("err")("unsupported subprotocolType: "+a.subprotocolType);default:return c("WAAssertUnreachable")(a.subprotocolType)}else return c("WAAssertUnreachable")(a.type)}g.protoV3MsgToDbMsg=a},98);
__d("MAWUnstoredQuotedMsgUtils",["WAErr","WAJids","WAMsgType"],function(a,b,c,d,e,f,g){"use strict";function h(a){if(a==null)return;var b=a.content;a=a.remoteJid;var e;switch(b.type){case d("WAMsgType").MSG_TYPE.TEXT:e=j(b);break;case d("WAMsgType").MSG_TYPE.IMAGE:e=k(b);break;case d("WAMsgType").MSG_TYPE.VIDEO:e=l(b);break;case d("WAMsgType").MSG_TYPE.PTT:e=m(b);break;case d("WAMsgType").MSG_TYPE.GIF:e=n(b);break;case d("WAMsgType").MSG_TYPE.STICKER:e=o(b);break;case d("WAMsgType").MSG_TYPE.UNAVAILABLE:e=p(b);break;case d("WAMsgType").MSG_TYPE.EXPIRED_EPHEMERAL:e=q(b);break;default:b.type;throw c("WAErr")("For flow")}return{remoteJid:a,content:e}}function i(a){if(d("WAJids").isAuthorSystem(a.author))throw c("WAErr")("A system message cannot be quoted");return{ts:a.ts,externalId:a.externalId,author:a.author}}function j(a){return babelHelpers["extends"]({},i(a),{msgContent:a.msgContent,type:d("WAMsgType").MSG_TYPE.TEXT})}function k(a){return babelHelpers["extends"]({},i(a),{type:d("WAMsgType").MSG_TYPE.IMAGE})}function l(a){return babelHelpers["extends"]({},i(a),{type:d("WAMsgType").MSG_TYPE.VIDEO})}function m(a){return babelHelpers["extends"]({},i(a),{type:d("WAMsgType").MSG_TYPE.PTT})}function n(a){return babelHelpers["extends"]({},i(a),{type:d("WAMsgType").MSG_TYPE.GIF})}function o(a){return babelHelpers["extends"]({},i(a),{type:d("WAMsgType").MSG_TYPE.STICKER})}function p(a){return babelHelpers["extends"]({},i(a),{type:d("WAMsgType").MSG_TYPE.UNAVAILABLE})}function q(a){return babelHelpers["extends"]({},i(a),{type:d("WAMsgType").MSG_TYPE.EXPIRED_EPHEMERAL})}function a(a){return{quote:h(a.quote)}}g.getWithQuoteMsg=a},98);
__d("MAWUnstoredTypedMsgUtils",["MAWDbMsg","MAWUnstoredQuotedMsgUtils","WAJids","WAMsgType"],function(a,b,c,d,e,f,g){"use strict";function h(a){return{ts:a.ts,externalId:a.id.externalId,author:a.id.author,ack:a.ack,reportingMeta:a.reportingMeta,serverTs:a.serverTs}}function i(a){return{isForwarded:a.isForwarded,forwardingScore:0}}function j(a){return{ephemeralSetting:k(a.ephemeralSetting),messageExpirationTs:a.expirationTs,messageDeleteTs:a.deleteTs}}function k(a){if(a==null)return;return{ephemeralExpirationInSec:a.expirationTs,ephemeralLastUpdatedOrSetTimestamp:a.updatedTs}}function a(a,b){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{xmaMessageType:b.targetType,altIndex:d("MAWDbMsg").UNDEFINED_ALT_INDEX,type:d("WAMsgType").MSG_TYPE.XMA})}function b(a){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{msgContent:a.msgContent,altIndex:d("MAWDbMsg").UNDEFINED_ALT_INDEX,type:d("WAMsgType").MSG_TYPE.TEXT,specialTextSize:a.specialTextSize})}function c(a){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:d("MAWDbMsg").UNDEFINED_ALT_INDEX,type:d("WAMsgType").MSG_TYPE.IMAGE})}function e(a){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:d("MAWDbMsg").UNDEFINED_ALT_INDEX,type:d("WAMsgType").MSG_TYPE.VIDEO})}function f(a){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:d("MAWDbMsg").UNDEFINED_ALT_INDEX,type:d("WAMsgType").MSG_TYPE.PTT})}function l(a){return{adminMsgContent:a.adminMsgContent,adminType:a.adminType}}function m(a){return babelHelpers["extends"]({},h(a),{author:d("WAJids").AUTHOR_SYSTEM,type:d("WAMsgType").MSG_TYPE.ADMIN,msgContent:l(a.msgContent),altIndex:d("MAWDbMsg").UNDEFINED_ALT_INDEX})}function n(a){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{type:d("WAMsgType").MSG_TYPE.GIF,altIndex:d("MAWDbMsg").UNDEFINED_ALT_INDEX})}function o(a){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{type:d("WAMsgType").MSG_TYPE.STICKER,altIndex:d("MAWDbMsg").UNDEFINED_ALT_INDEX})}function p(a){return babelHelpers["extends"]({},h(a),{type:d("WAMsgType").MSG_TYPE.FUTUREPROOF,altIndex:d("MAWDbMsg").FUTUREPROOF_ALT_INDEX,msgContent:a.msgContent})}function q(a){return babelHelpers["extends"]({},h(a),{type:d("WAMsgType").MSG_TYPE.REVOKED,altIndex:d("MAWDbMsg").UNDEFINED_ALT_INDEX,revokedExternalId:a.revokedExternalId})}function r(a){return{adminMsgContent:a.adminMsgContent,adminType:a.adminType}}function s(a){return babelHelpers["extends"]({},h(a),{type:d("WAMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN,altIndex:d("MAWDbMsg").UNDEFINED_ALT_INDEX,msgContent:r(a.msgContent)})}function t(a){return{adminMsgContent:a.adminMsgContent,adminType:a.adminType,screenshotActionType:a.screenshotActionType}}function u(a){return babelHelpers["extends"]({},h(a),{type:d("WAMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION,altIndex:d("MAWDbMsg").UNDEFINED_ALT_INDEX,msgContent:t(a.msgContent)})}function v(a){return{authorName:a.authorName,adminType:a.adminType}}function w(a){return babelHelpers["extends"]({},h(a),{type:d("WAMsgType").MSG_TYPE.ICDC_ALERT,altIndex:d("MAWDbMsg").UNDEFINED_ALT_INDEX,msgContent:v(a.msgContent)})}g.getXMAMsg=a;g.getTextMsg=b;g.getImageMsg=c;g.getVideoMsg=e;g.getPttMsg=f;g.getAdminMsg=m;g.getGifMsg=n;g.getStickerMsg=o;g.getFutureproofMsg=p;g.getRevokedMsg=q;g.getEphemeralSettingAdminMsg=s;g.getEphemeralScreenshotActionMsg=u;g.getICDCAlertMsg=w},98);
__d("MAWUnstoredMsgUtils",["MAWUnstoredTypedMsgUtils","WAMsgType","err"],function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.unstoredMsg;a=a.unstoredXMA;if(b==null)return null;switch(b.type){case d("WAMsgType").MSG_TYPE.TEXT:return d("MAWUnstoredTypedMsgUtils").getTextMsg(b);case d("WAMsgType").MSG_TYPE.IMAGE:return d("MAWUnstoredTypedMsgUtils").getImageMsg(b);case d("WAMsgType").MSG_TYPE.VIDEO:return d("MAWUnstoredTypedMsgUtils").getVideoMsg(b);case d("WAMsgType").MSG_TYPE.PTT:return d("MAWUnstoredTypedMsgUtils").getPttMsg(b);case d("WAMsgType").MSG_TYPE.ADMIN:return d("MAWUnstoredTypedMsgUtils").getAdminMsg(b);case d("WAMsgType").MSG_TYPE.FUTUREPROOF:return d("MAWUnstoredTypedMsgUtils").getFutureproofMsg(b);case d("WAMsgType").MSG_TYPE.REVOKED:return d("MAWUnstoredTypedMsgUtils").getRevokedMsg(b);case d("WAMsgType").MSG_TYPE.GIF:return d("MAWUnstoredTypedMsgUtils").getGifMsg(b);case d("WAMsgType").MSG_TYPE.STICKER:return d("MAWUnstoredTypedMsgUtils").getStickerMsg(b);case d("WAMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:return d("MAWUnstoredTypedMsgUtils").getEphemeralSettingAdminMsg(b);case d("WAMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:return d("MAWUnstoredTypedMsgUtils").getEphemeralScreenshotActionMsg(b);case d("WAMsgType").MSG_TYPE.ICDC_ALERT:return d("MAWUnstoredTypedMsgUtils").getICDCAlertMsg(b);case d("WAMsgType").MSG_TYPE.XMA:if((a==null?void 0:a.xma)==null)throw c("err")("XMA content cannot be parsed without XMA payload");return d("MAWUnstoredTypedMsgUtils").getXMAMsg(b,a==null?void 0:a.xma);case d("WAMsgType").MSG_TYPE.REACTION:return null;default:b.type;return null}}function b(a){return a==null?null:d("MAWUnstoredTypedMsgUtils").getTextMsg(a)}function e(a){a=a.unstoredMsg;if(!a||a.type!==d("WAMsgType").MSG_TYPE.REACTION)return null;a=a;return{ack:a.ack,author:a.id.author,externalId:a.id.externalId,reactToExternalId:a.reactToExternalId,reactToAuthor:a.reactToAuthor,threadJid:a.id.chat,reaction:a.reaction,groupingKey:a.groupingKey,ts:a.ts}}g.getUnstoredMsg=a;g.getUnstoredAssociatedMsg=b;g.getUnstoredReaction=e},98);
__d("MAWUnstoredMediaUtils",["MAWUnstoredMsgUtils","WASortedLists"],function(a,b,c,d,e,f,g){"use strict";function h(a){return a==null?null:{mediaEntry:a.mediaEntry,mediaType:a.mediaType,plaintextHash:a.plaintextHash,size:a.size,msgIds:d("WASortedLists").emptySet(),ts:a.ts,validatedVideoInfo:a.validatedVideoInfo,validatedImageInfo:a.validatedImageInfo,validatedAudioInfo:a.validatedAudioInfo}}function a(a){a=a.unstoredXMA;if(a==null)return;var b=a.xma,c=a.unstoredFavicon,e=a.unstoredHeaderMedia,f=a.unstoredPreviews;a=a.unstoredAssociatedMsg;return{unstoredDbXMA:{targetType:b.targetType,targetUsername:b.targetUsername,targetId:b.targetId,targetExpiringAtSec:b.targetExpiringAtSec,xmaLayoutType:b.xmaLayoutType,ctas:b.ctas,defaultCTA:b.defaultCTA,titleText:b.titleText,subtitleText:b.subtitleText,maxTitleNumOfLines:b.maxTitleNumOfLines,maxSubtitleNumOfLines:b.maxSubtitleNumOfLines,headerTitle:b.headerTitle,overlayIconGlyph:b.overlayIconGlyph,overlayTitle:b.overlayTitle,overlayDescription:b.overlayDescription,isTombstoned:b.isTombstoned,externalId:b.externalId,author:b.author,threadJid:b.threadJid},unstoredAssociatedMsg:(b=d("MAWUnstoredMsgUtils").getUnstoredAssociatedMsg(a))!=null?b:void 0,unstoredHeaderMedia:(a=h(e))!=null?a:void 0,unstoredFavicon:(b=h(c))!=null?b:void 0,unstoredPreviews:f?f.map(function(a){return h(a)}).filter(Boolean):void 0}}g.getUnstoredMedia=h;g.getUnstoredXMA=a},98);
__d("MAWUnstoredContentToUnstoredDbContentUtils",["MAWUnstoredMediaUtils","MAWUnstoredMsgUtils"],function(a,b,c,d,e,f,g){"use strict";function a(a){var b=d("MAWUnstoredMsgUtils").getUnstoredMsg(a),c=d("MAWUnstoredMediaUtils").getUnstoredMedia(a.unstoredMedia),e=d("MAWUnstoredMsgUtils").getUnstoredReaction(a);a=d("MAWUnstoredMediaUtils").getUnstoredXMA(a);return{unstoredDbMsg:b,unstoredDbMedia:c,unstoredDbReaction:e,unstoredXMA:a}}g.unstoredContentToUnstoredDbContent=a},98);
__d("MAWDeviceInfo",["UserAgentData"],function(a,b,c,d,e,f,g){"use strict";a=function(){function a(){}var b=a.prototype;b.get=function(){var a;return{osVersion:(a=c("UserAgentData").platformVersion)!=null?a:"",osBuild:(a=c("UserAgentData").platformVersion)!=null?a:"",hardware:c("UserAgentData").platformName,manufacturer:c("UserAgentData").platformName,device:[c("UserAgentData").browserName].join(" "),lg:"en",lc:"en",mcc:"000",mnc:"000",sim_mnc:"000",sim_mcc:"000"}};return a}();b=new a();g.deviceInfo=b},98);
__d("MAWClientPayload",["MAWAppVersion","MAWDeviceInfo","MAWGlobals","WAArrayBufferUtils","WAJids","WALongInt","WAWa5.pb","encodeProtobuf"],function(a,b,c,d,e,f,g){"use strict";function a(){var a=d("MAWGlobals").getMyDeviceJid();a=d("WAJids").extractDeviceIDParts(a);var b=a.userId;a=a.deviceID;a=babelHelpers["extends"]({},h(),{device:a,fbCat:d("MAWGlobals").getFbCat(),fbUserAgent:d("WAArrayBufferUtils").stringToArrayBuffer(navigator.userAgent),product:d("WAWa5.pb").ClientPayloadProduct.MESSENGER,username:d("WALongInt").decimalStringToLongInt(b)});b=d("encodeProtobuf").encodeProtobuf(d("WAWa5.pb").ClientPayloadSpec,a).readByteArray();return b}function h(){return{passive:!1,connectType:d("WAWa5.pb").ClientPayloadConnectType.WIFI_UNKNOWN,connectReason:d("WAWa5.pb").ClientPayloadConnectReason.USER_ACTIVATED,userAgent:i()}}function i(){var a=d("MAWDeviceInfo").deviceInfo.get(),b=d("MAWAppVersion").getAppVersionParts();return{appVersion:b,platform:d("WAWa5.pb").ClientPayload$UserAgentPlatform.WEB,releaseChannel:d("WAWa5.pb").ClientPayload$UserAgentReleaseChannel.DEBUG,mcc:a.mcc,mnc:a.mnc,osVersion:a.osVersion,manufacturer:a.manufacturer,device:a.device,osBuildNumber:a.osBuild,localeLanguageIso6391:a.lg,localeCountryIso31661Alpha2:a.lc}}g.getClientPayload=a},98);
__d("MAWChatSocketPlatformDetails",["MAWClientPayload","MAWGlobals","URI","WABase64","WACryptoCurve25519","WACryptoCurve25519Dependencies","WAErrors","WAGlobals","WAHex","WAInfoStore","WALogger","WALongInt","WASignalCertificateSignatures","WATreasureHunt","WAWa5.pb","WAWapDict","WAWebSocketTransport","decodeProtobuf","encodeProtobuf","err","regeneratorRuntime"],function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["openSocketWithLoop (round ",") failed: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["openSocketWithLoop (round ",") to "," succeeded"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["openSocketWithLoop (round ",") connecting to ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["openSocketWithLoop"]);k=function(){return a};return a}var l="wss://web-chat-e2ee.facebook.com/ws/chat";function m(a){return d("encodeProtobuf").encodeProtobuf(d("WAWa5.pb").HandshakeMessageSpec,{clientHello:a}).readByteArray()}function n(a){return d("encodeProtobuf").encodeProtobuf(d("WAWa5.pb").HandshakeMessageSpec,{clientFinish:a}).readByteArray()}function o(a){return d("decodeProtobuf").decodeProtobuf(d("WAWa5.pb").HandshakeMessageSpec,a).serverHello}function p(a){return d("decodeProtobuf").decodeProtobuf(d("WAWa5.pb").NoiseCertificateSpec,a)}function q(a){var b=a.certificate;a=a.serverStatic;b=p(b);var e=b.details;b=b.signature;if(!e)throw new(c("err"))("noiseFullHandshake cert missing details");if(!b)throw new(c("err"))("noiseFullHandshake cert missing signature");var f={details:e,signature:b};return d("WASignalCertificateSignatures").verifyCertificate({cert:f,serverStatic:a}).then(function(){var a=d("decodeProtobuf").decodeProtobuf(d("WAWa5.pb").NoiseCertificate$DetailsSpec,f.details);d("WALongInt").maybeNumberOrThrowIfTooLarge(a.expires)})}function r(){return null}function s(){d("WALogger").LOG(k());function a(a){var e=new(c("URI"))(l).toString(),f=function(){var a,c,f,g;return b("regeneratorRuntime").async(function(h){while(1)switch(h.prev=h.next){case 0:if(!d("WAGlobals").getConfig().transactions.getRoutingInfo){h.next=6;break}h.next=3;return b("regeneratorRuntime").awrap(d("WAGlobals").getTransactions().getRoutingInfo());case 3:h.t0=h.sent;h.next=9;break;case 6:h.next=8;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().getRoutingInfo());case 8:h.t0=h.sent;case 9:a=h.t0;c=a.edgeInfo;f=void 0;c&&(f="?ED="+d("WABase64").encodeB64UrlSafe(c));g=""+e+(f!=null?f:"");return h.abrupt("return",d("WAWebSocketTransport").openWebSocket(g));case 15:case"end":return h.stop()}},null,this)};d("WALogger").LOG(j(),a,e);return f().then(function(b){d("WALogger").LOG(i(),a,e);return b})["catch"](function(b){d("WALogger").WARN(h(),a,b).devConsole(b);throw b})}return d("WATreasureHunt").treasureHunt(a,3,15e3,function(a){return void a.close()})["catch"](function(a){if(!navigator.onLine)throw new(d("WAErrors").Offline)("offline when openSocketWithLoop treasureHunt failed");throw a})}function a(){var a,c,e;return b("regeneratorRuntime").async(function(f){while(1)switch(f.prev=f.next){case 0:if(!d("WAGlobals").getConfig().transactions.getRoutingInfo){f.next=6;break}f.next=3;return b("regeneratorRuntime").awrap(d("WAGlobals").getTransactions().getRoutingInfo());case 3:f.t0=f.sent;f.next=9;break;case 6:f.next=8;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().getRoutingInfo());case 8:f.t0=f.sent;case 9:a=f.t0;c=a.edgeInfo==null?null:d("WAHex").bytesToBuffer(a.edgeInfo);e=new Uint8Array([87,65,5,d("WAWapDict").DICT_VERSION]);return f.abrupt("return",{edgeInfo:c,getClientPayload:d("MAWClientPayload").getClientPayload,protoHeader:e,encodeHandshakeHello:m,decodeServerHello:o,encodeHandshakeFinish:n,processCertificate:q,serverInfoIfKnown:r,staticKeyPair:new(d("WACryptoCurve25519").Curve25519)(d("WACryptoCurve25519Dependencies").CURVE25519_SIGNAL_DEPENDENCIES,d("WAInfoStore").WA_INFO.get().staticKeyPair),openSocket:s,curveSignalDependencies:d("WACryptoCurve25519Dependencies").CURVE25519_SIGNAL_DEPENDENCIES});case 13:case"end":return f.stop()}},null,this)}g.getChatSocketPlatformDetails=a},98);
__d("MAWCommsConfig",["MAWChatSocketPlatformDetails","WAComms","WADevToolsStanzaViewer","WALogger","WAOpenChatSocket","regeneratorRuntime"],function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["comms change: ",""]);h=function(){return a};return a}function i(a){d("WALogger").LOG(h(),a),a==="connected"&&d("WAComms").startHandlingRequests()}function a(a){var c,e;return b("regeneratorRuntime").async(function(f){while(1)switch(f.prev=f.next){case 0:c=a.onOptimisticConnectionChange;f.next=3;return b("regeneratorRuntime").awrap(d("MAWChatSocketPlatformDetails").getChatSocketPlatformDetails());case 3:e=f.sent;return f.abrupt("return",{openChatSocket:function(a){return d("WAOpenChatSocket").openChatSocket(e,a)},healthCheckInterval:20,deadSocketTime:2e4,maxSocketLoopWaitTime:6e4,shouldCloseStaleSocket:!1,shouldBlockReceivingUntilSuccess:!1,handlers:{onConnectionChange:i,onOptimisticConnectionChange:c,onCastStanza:function(a){},onHandleStanza:function(a){}}});case 5:case"end":return f.stop()}},null,this)}g.onConnectionChange=i;g.getCommsConfig=a},98);
__d("MAWDefinePersistedJob",["MAWGlobals","Promise","WAJobBuilder"],function(a,b,c,d,e,f,g){"use strict";c={definePersistedJob:function(){return d("WAJobBuilder").definePersistedJob()}};function a(a){var c=d("MAWGlobals").getJobManager();Object.keys(a).forEach(function(d){var e=a[d];c.addPersistedJobImplementation(d,function(){return b("Promise").resolve(e)})})}g.persistedJobsApi=c;g.setMsgrJobImplementations=a},98);
__d("MAWMailboxUpload",["EchoMessage","EchoThread","FBLogger","MAWBridgeTypes","MAWDataSyncQueue","MAWDbMsg","MAWDbMsgTxns","MAWDbThreadTxns","MAWDexieTable","MAWGating.re","MAWIndexedDb","MAWTransactionMode","MAWUploadMessageTxns","MAWUploadThreadTxns","Promise","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";function h(a,b){if(b==null||b.serverTs==null)return;d("MAWUploadMessageTxns").constructEchoMessage(a,b).then(function(a){if(a.xOfflineThreadingId==null){c("FBLogger")("labyrinth_web").mustfix("xOfflineThreadingId should not be empty in the EchoMessage");return}d("MAWIndexedDb").afterTransaction({tag:"UploadMessage",value:d("MAWBridgeTypes").createBridgeUploadMessage(a.xOfflineThreadingId,a.threadId,d("MAWDbMsg").getSortOrderWithFallback(b),d("EchoMessage").encodeEchoMessage(a),1)})})["catch"](function(a){a instanceof Error?c("FBLogger")("labyrinth_web").catching(a).mustfix("Error constructing EchoMessage"):c("FBLogger")("labyrinth_web").mustfix("Unknown error constructing EchoMessage: err: ${err}")})["finally"](function(){})}function i(a,b){if(b==null)return;d("MAWUploadThreadTxns").constructEchoThread(a,b).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"UploadThread",value:d("MAWBridgeTypes").createBridgeUploadThread(a.threadId,d("MAWUploadThreadTxns").getFolderTypeAsText(b.folder),"AdvancedCrypto",d("WATimeUtils").castToUnixTime(a.displayTimestamp),d("EchoThread").encodeEchoThread(a),1)})})["catch"](function(a){a instanceof Error?c("FBLogger")("labyrinth_web").catching(a).mustfix("Error constructing EchoThread"):c("FBLogger")("labyrinth_web").mustfix("Unknown error constructing EchoThread")})}var j=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY,participants:d("MAWTransactionMode").READONLY,receipts:d("MAWTransactionMode").READONLY,contacts:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READONLY})(function(a,b){switch(b.tableName){case"messages":return a.messages.get(b.key).then(function(b){h(a,b)});case"threads":return a.threads.get(b.key).then(function(b){i(a,b)});case"reactions":return a.reactions.get(b.key).then(function(b){if(b==null)return;return d("MAWDbThreadTxns").getThreadByJid(a,b.threadJid).then(function(c){c=c.success?c.value:null;if(c==null||c.chatId==null)return;return d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,b.reactToExternalId,c.chatId,b.reactToAuthor)}).then(function(b){h(a,b)})});default:return d("MAWDexieTable").dexieResolve()}}),k=new Set(["messages","reactions","threads"]),l=function(a,c){return!k.has(c.tableName)?b("Promise").resolve():j(c)};a=function(){if(!d("MAWGating.re").isMailboxUploadEnabled())return;d("MAWDataSyncQueue").registerDataSyncCallback(l)};g.encodeAndSendEchoMessage=h;g.encodeAndSendEchoThread=i;g.initMailboxUpload=a},98);
__d("MAWBackupMessageWithMedia",["FBLogger","MAWDbMsgTxns","MAWGlobals","MAWIndexedDb","MAWMailboxUpload","MAWTransactionMode","err","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";function h(a){return d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY,participants:d("MAWTransactionMode").READONLY,receipts:d("MAWTransactionMode").READONLY,contacts:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READONLY})(function(b){return d("MAWDbMsgTxns").getMsgsByMsgIds(b,a).then(function(a){a!=null&&a.map(function(a){a!=null&&d("MAWMailboxUpload").encodeAndSendEchoMessage(b,a)})})})()}a=d("MAWGlobals").getPersistedJobsApi().definePersistedJob().finalStep("backup",function(a){var e,f,g,i;return b("regeneratorRuntime").async(function(j){while(1)switch(j.prev=j.next){case 0:e=a.deliveryObjectId,f=a.backupEntFbid;j.next=3;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().getMediaByObjectId(e));case 3:g=j.sent;if(g.success){j.next=7;break}c("FBLogger")("labyrinth_web","media_entry_missing").mustfix("No media entry found for fbid: "+f);throw c("err")("No media entry found");case 7:i=g.value.msgIds;if(!(i==null||i.length===0)){j.next=11;break}c("FBLogger")("labyrinth_web","no_message_for_media").warn("No affected messages for media");throw c("err")("No affected messages for media");case 11:h(i);case 12:case"end":return j.stop()}},null,this)}).end();g.backupMessageWithMedia=a},98);
__d("MAWDeleteMsgsForMe",["WAGlobals","WAJobDefinitions","WALogger","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["deleteMsgsForMe: ",""]);h=function(){return a};return a}a=d("WAGlobals").getPersistedJobsApi().definePersistedJob().finalStep("saveAndPassOff",function(a){var c,e,f;return b("regeneratorRuntime").async(function(b){while(1)switch(b.prev=b.next){case 0:c=a.msgIds;d("WALogger").DEV(h(),c);e=c.map(function(a){return{messageAction:{type:"delete_for_me",protocolMsgId:a}}});f={type:"meta_sync",actions:e};return b.abrupt("return",d("WAGlobals").getJobManager().waitUntilCompleted(d("WAJobDefinitions").jobSerializers.sendAppData({contents:f})));case 5:case"end":return b.stop()}},null,this)}).end();g.deleteMsgsForMe=a},98);
__d("MAWDeleteThread",["MAWDbThread","MAWGlobals","WAGlobals","WAJobDefinitions","WALogger","WATimeUtils","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["deleteThread job: ",""]);h=function(){return a};return a}a=d("WAGlobals").getPersistedJobsApi().definePersistedJob().finalStep("saveAndPassOff",function(a){var c,e,f,g,i,j;return b("regeneratorRuntime").async(function(k){while(1)switch(k.prev=k.next){case 0:c=a.chatId;d("WALogger").DEV(h(),c);e=d("MAWDbThread").unsafeCoerceToChatId(c);k.next=5;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().getThreadInfoForDeletion(e));case 5:f=k.sent;g=f.newestMsgTs!=null?d("WATimeUtils").futureUnixTime(1,f.newestMsgTs):void 0;i={chatAction:{type:"chat_delete",chatJid:f.chatJid,messageRange:{messages:[],lastMessageTimestamp:g}}};j={type:"meta_sync",actions:[i]};return k.abrupt("return",d("WAGlobals").getJobManager().waitUntilCompleted(d("WAJobDefinitions").jobSerializers.sendAppData({contents:j})));case 10:case"end":return k.stop()}},null,this)}).end();g.deleteThread=a},98);
__d("MAWDownloadAndHandleMedia",["MAWAckLevel.re","MAWDbMsgTxns","MAWGlobals","MAWIndexedDb","MAWQplProxy","MAWTransactionMode","WADownloadMedia","WALogger","err","qpl","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media for msg ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["DownloadAndHandleMedia: "," hash with "," msgId"]);i=function(){return a};return a}a=d("MAWGlobals").getPersistedJobsApi().definePersistedJob().finalStep("downloadAndHandleMedia",function(a){var e,f,g,j,k;return b("regeneratorRuntime").async(function(l){while(1)switch(l.prev=l.next){case 0:e=a.protocolMsgId,f=a.hash;d("WALogger").DEV(i(),f,e);g=d("MAWQplProxy").startQplUserFlow(c("qpl")._(25312150,"83"));l.next=5;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().getMsgIdByProtocolMsgId(e));case 5:j=l.sent;if(j){l.next=9;break}g.endFail("missingMsgIdInDb");throw c("err")("Missing msgId in Db");case 9:l.next=11;return b("regeneratorRuntime").awrap(d("WADownloadMedia").downloadMedia(e,f));case 11:k=l.sent;if(k.success){l.next=19;break}g.endFail(k.error);d("WALogger").LOG(h(),j);l.next=17;return b("regeneratorRuntime").awrap(d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READWRITE})(d("MAWDbMsgTxns").updateSystemAck)(j,d("MAWAckLevel.re").ACK.failed));case 17:l.next=20;break;case 19:g.endSuccess();case 20:case"end":return l.stop()}},null,this)}).end();g.downloadAndHandleMedia=a},98);
__d("MAWMediaUtils",["MAWDbMedia","MAWHMACKey","WAMediaUtils","err","regeneratorRuntime"],function(a,b,c,d,e,f,g){function a(a){if(a==="image/gif")return{mediaType:d("MAWDbMedia").MEDIA_TYPE.GIF,serverMediaType:"gif"};if(a==="image/webp")return{mediaType:d("MAWDbMedia").MEDIA_TYPE.STICKER,serverMediaType:"sticker"};var b=a.split("/")[0];switch(b){case"image":return{mediaType:d("MAWDbMedia").MEDIA_TYPE.IMAGE,serverMediaType:"image"};case"video":return{mediaType:d("MAWDbMedia").MEDIA_TYPE.VIDEO,serverMediaType:"video"};case"audio":return{mediaType:d("MAWDbMedia").MEDIA_TYPE.PTT,serverMediaType:"ptt"};default:throw c("err")("get a wrong media file with type "+a)}}function e(a,b){b===void 0&&(b="media");switch(a){case d("MAWDbMedia").MEDIA_TYPE.IMAGE:return b==="xma-media"?"xma-image":"image";case d("MAWDbMedia").MEDIA_TYPE.VIDEO:return"video";case d("MAWDbMedia").MEDIA_TYPE.PTT:return"ptt";case d("MAWDbMedia").MEDIA_TYPE.GIF:return"gif";case d("MAWDbMedia").MEDIA_TYPE.STICKER:return"sticker";default:throw c("err")("get a wrong media file with type "+a)}}function h(a){try{return d("WAMediaUtils").blobToArrayBuffer(a).then(function(a){return self.crypto.subtle.digest("SHA-256",a)}).then(function(a){return new Uint8Array(a)})}catch(a){throw c("err")("Got "+a+" when convert the blob to Uint8Array")}}function f(a){var c,e,f;return b("regeneratorRuntime").async(function(g){while(1)switch(g.prev=g.next){case 0:g.next=2;return b("regeneratorRuntime").awrap(h(a));case 2:c=g.sent;e=d("WAMediaUtils").toPlaintextHash(c);f=d("MAWHMACKey").genHMACPlaintextHash(e);return g.abrupt("return",[e,f]);case 6:case"end":return g.stop()}},null,this)}g.getMediaTypeAndServerMediaTypeFromBlob=a;g.getServerMediaTypeFromMediaType=e;g.hashBlob=h;g.genBlobHashes=f},98);
__d("MAWHandleEchoMediaMsgsRestore",["MAWAsConsumerApplication","MAWBridgeTypes","MAWDbChunkTxns","MAWDbMediaTxns","MAWHMACKey","MAWIndexedDb","MAWJids","MAWMediaApiTypes","MAWMediaManagementTxns","MAWMediaUtils","MAWTransactionMode","Promise","WABase64","WADownloadMedia","WAJids","WALogger","WAMediaUtils","WATimeUtils","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["media download failed with error: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["blob is missing from chunk table for the downloaded file"]);i=function(){return a};return a}function j(a){a=r(a);return a.then(function(a){a=a==null?void 0:a.blobData;return a!=null})}function a(a){var c,e,f,g,h,i,o,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F;return b("regeneratorRuntime").async(function(G){while(1)switch(G.prev=G.next){case 0:c=k(a.mediaData.plaintextHash);e=a.mediaData,f=e.mediaKeyTimestamp,g=e.directPath,h=e.mediaContentType,i=e.size;o=d("WAMediaUtils").stringToPlaintextHash(c);q=d("MAWHMACKey").genHMACPlaintextHash(o);r=d("MAWMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(h);s=r.mediaType;t=r.serverMediaType;u=a.mediaData.width;v=a.mediaData.height;w=a.mediaData.previewContentWidth;x=a.mediaData.previewContentHeight;y=a.mediaData.mediaPlayableDuration;z=d("WAMediaUtils").stringToDeliveryObjectId(a.mediaData.attachmentObjectId);A=d("WAMediaUtils").stringToBackupEntFbid(a.mediaData.backupEntFbid);B=l({width:u,height:v,previewContentWidth:w,previewContentHeight:x,mediaPlayableDuration:y,mediaType:s});C=m(c,a.mediaData.hashedPlaintextHash,a.mediaData.mediaKey,g,f,t);G.next=18;return b("regeneratorRuntime").awrap(p(q,o,a.msgId,i,C,B,s,z,A));case 18:G.next=20;return b("regeneratorRuntime").awrap(j(q));case 20:D=G.sent;if(!D){G.next=25;break}return G.abrupt("return",b("Promise").resolve());case 25:E=d("WAJids").extractUserId(d("MAWJids").toUserJid(a.threadJId));F={attachmentFbId:a.mediaData.backupEntFbid,attachmentObjectId:d("WAMediaUtils").stringToDeliveryObjectId(a.mediaData.attachmentObjectId),messageTimeStamp:a.messageTimestamp,messageId:a.externalId,threadId:E,productType:d("MAWMediaApiTypes").MSGR_PRODUCT_TYPE,mediaType:t};G.next=29;return b("regeneratorRuntime").awrap(n({plaintextHash:o,hashedPlaintextHash:q,mediaType:s,threadJId:a.threadJId,externalId:a.externalId,author:a.author,width:u,height:v,previewContentWidth:w,previewContentHeight:x,mediaPlayableDuration:y},F));case 29:case"end":return G.stop()}},null,this)}function k(a){if(a.endsWith("=")){var b="";for(var c=0;c<a.length;c++){var d=a.charAt(c);if(d==="=")return b;b+=d}}return a}function l(a){var b=a.mediaType,c=a.width,e=a.height,f=a.jpegThumbnail,g=a.previewContentHeight,h=a.previewContentWidth;a=a.mediaPlayableDuration;return{validatedVideoInfo:b==="Video"?{width:c,height:e,mimetype:d("MAWAsConsumerApplication").VIDEO_MIME_TYPE,jpegThumbnail:f,jpegThumbnailHeight:g,jpegThumbnailWidth:h}:null,validatedImageInfo:b==="Image"?{width:c,height:e,jpegThumbnail:f,jpegThumbnailHeight:g,jpegThumbnailWidth:h}:b==="Gif"||b==="Sticker"?{width:c,height:e,jpegThumbnailHeight:e,jpegThumbnailWidth:c}:null,validatedAudioInfo:b==="Ptt"&&a!=null?{duration:a,mimetype:d("MAWAsConsumerApplication").AUDIO_MIME_TYPE,played:!1}:null}}function m(a,b,c,e,f,g){a=d("WABase64").decodeB64UrlSafe(a);b=d("WABase64").decodeB64UrlSafe(b,!0);c=d("WABase64").decodeB64UrlSafe(c,!0);return d("WAMediaUtils").rawDataToMediaEntry(a,b,c,e,d("WATimeUtils").castToUnixTime(f),g)}var n=function(a,c){var e,f,g,j,k,m,n,p,s,t,u,v,w,x,y;return b("regeneratorRuntime").async(function(z){while(1)switch(z.prev=z.next){case 0:e=a.plaintextHash,f=a.hashedPlaintextHash,g=a.mediaType,j=a.threadJId,k=a.externalId,m=a.author,n=a.width,p=a.height,s=a.previewContentWidth,t=a.previewContentHeight,u=a.mediaPlayableDuration;z.next=3;return b("regeneratorRuntime").awrap(d("WADownloadMedia").downloadMedia({chat:j,author:m,externalId:k},e));case 3:v=z.sent;if(!v.success){z.next=18;break}z.next=7;return b("regeneratorRuntime").awrap(r(f));case 7:w=z.sent;x=w==null?void 0:w.blobData;if(!(x!=null)){z.next=15;break}y=l({width:n,height:p,previewContentWidth:s,previewContentHeight:t,mediaPlayableDuration:u,mediaType:g,jpegThumbnail:x});z.next=13;return b("regeneratorRuntime").awrap(q(f,y));case 13:z.next=16;break;case 15:d("WALogger").LOG(i());case 16:z.next=22;break;case 18:d("WALogger").LOG(h(),v.error);if(!(v.error==="signature-expired-and-resign-failed"&&c)){z.next=22;break}z.next=22;return b("regeneratorRuntime").awrap(o(k,c));case 22:case"end":return z.stop()}},null,this)},o=d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READONLY})(function(a,b,c){var e=d("WAMediaUtils").stringToDeliveryObjectId(c.attachmentObjectId);return d("MAWDbMediaTxns").maybeGetMediaFromObjectId(a,e).then(function(a){a&&d("MAWIndexedDb").afterTransaction({tag:"ResignAttachmentCDNUrl",value:d("MAWBridgeTypes").createBridgeResignAttachmentCDNUrl(c.attachmentObjectId,c.attachmentFbId,c.messageTimeStamp,b,c.threadId,d("MAWMediaApiTypes").MSGR_PRODUCT_TYPE,c.mediaType)})})}),p=d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READWRITE,messages:d("MAWTransactionMode").READWRITE})(function(a,b,c,e,f,g,h,i,j,k){return d("MAWMediaManagementTxns").linkMedia(a,e,c,i,f,g,h,b,j,k)}),q=d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READWRITE,messages:d("MAWTransactionMode").READWRITE})(function(a,b,c){return d("MAWMediaManagementTxns").updateMediaEntryWithValidatedMediaInfo(a,b,c)}),r=d("MAWIndexedDb").makeMsgrTransactor({chunk:d("MAWTransactionMode").READONLY})(function(a,b){return d("MAWDbChunkTxns").maybeGetChunkFromHash(a,b)});g.downloadMediaAndWriteToMediaStore=a;g.getMediaEntry=m;g.handleDownloadMedia=n},98);
__d("MAWHandleMediaDownloadAndRestoreApi",["FBLogger","MAWDbMediaTxns","MAWDbMsgTxns","MAWIndexedDb","MAWMediaManagementTxns","MAWTransactionMode","WAJids","WAMediaUtils"],function(a,b,c,d,e,f,g){"use strict";a=function(a,b){var e=d("WAMediaUtils").stringToDeliveryObjectId(a);return d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READWRITE,messages:d("MAWTransactionMode").READONLY})(function(a){return d("MAWDbMediaTxns").maybeGetMediaFromObjectId(a,e).then(function(e){if(e!=null){var f=e.msgIds.pop();return d("MAWDbMsgTxns").maybeGetMsg(a,f).then(function(g){if(g!=null){var j=e==null?void 0:e.mediaEntries;if(j!=null){j=j.get(f);if(j!=null){var k=e.hashedPlaintextHash;h(a,j,b,k,f);j=g.threadJid;var l=g.author,m=e.mediaType;if(j!=null&&d("WAJids").isAuthorMe(l))return i(e,m,g.externalId,k,j,l);else c("FBLogger")("labyrinth_web").mustfix("mandatory data for media download is missing in the access check restore flow")}else c("FBLogger")("labyrinth_web").mustfix("encoded data entry missing from the db for the given message")}else c("FBLogger")("labyrinth_web").mustfix("encoded data entries missing from the db")}else c("FBLogger")("labyrinth_web").mustfix("message entry missing from the db")})}else c("FBLogger")("labyrinth_web").mustfix("media entry missing from the db");return null})})()};function h(a,b,c,e,f){b=d("WAMediaUtils").decodeMediaEntryData(b);b=d("WAMediaUtils").encodeMediaEntryWithUpdatedPath(b,c);d("MAWMediaManagementTxns").updateMediaWithEncodedMediaEntryData(a,e,f,b)}function i(a,b,c,d,e,f){var g=a.plaintextHash;if(b==="Video"){var h,i,j,k,l;h=(h=a.validatedVideoInfo)==null?void 0:h.width;i=(i=a.validatedVideoInfo)==null?void 0:i.height;j=(j=a.validatedVideoInfo)==null?void 0:j.jpegThumbnailWidth;k=(k=a.validatedVideoInfo)==null?void 0:k.jpegThumbnailHeight;l=(l=a.validatedVideoInfo)==null?void 0:l.duration;return{plaintextHash:g,hashedPlaintextHash:d,mediaType:b,threadJId:e,externalId:c,author:f,width:h,height:i,previewContentWidth:j,previewContentHeight:k,mediaPlayableDuration:l}}else if(b==="Image"||b==="Sticker"||b==="Gif"){i=(h=a.validatedImageInfo)==null?void 0:h.width;k=(j=a.validatedImageInfo)==null?void 0:j.height;h=(l=a.validatedImageInfo)==null?void 0:l.jpegThumbnailWidth;l=(j=a.validatedImageInfo)==null?void 0:j.jpegThumbnailHeight;return{plaintextHash:g,hashedPlaintextHash:d,mediaType:b,threadJId:e,externalId:c,author:f,width:i,height:k,previewContentWidth:h,previewContentHeight:l}}else if(b==="Ptt"){i=(j=a.validatedAudioInfo)==null?void 0:j.duration;return{plaintextHash:g,hashedPlaintextHash:d,mediaType:b,threadJId:e,externalId:c,author:f,mediaPlayableDuration:i}}}g.writeCdnUrlAndBakeDownloadPayload=a},98);
__d("MAWDownloadAndRestoreMedia",["MAWGlobals","MAWHandleEchoMediaMsgsRestore","MAWHandleMediaDownloadAndRestoreApi","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWGlobals").getPersistedJobsApi().definePersistedJob().finalStep("downloadAndRestoreMedia",function(a){var c,e,f;return b("regeneratorRuntime").async(function(g){while(1)switch(g.prev=g.next){case 0:c=a.deliveryObjectId,e=a.restorationCdnUrl;g.next=3;return b("regeneratorRuntime").awrap(d("MAWHandleMediaDownloadAndRestoreApi").writeCdnUrlAndBakeDownloadPayload(c,e));case 3:f=g.sent;if(!f){g.next=7;break}g.next=7;return b("regeneratorRuntime").awrap(d("MAWHandleEchoMediaMsgsRestore").handleDownloadMedia(f));case 7:case"end":return g.stop()}},null,this)}).end();g.downloadAndRestoreMedia=a},98);
__d("MAWGetSpams",["MAWGlobals","WAComms","WALogger","WAPersistedJobManager","WATimeUtils","WAWap","WAWapParser","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["getSpams result: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["getSpams called"]);i=function(){return a};return a}var j=new(d("WAWapParser").WapParser)("getSpamsResponse",function(a){a.assertTag("iq"),a.assertFromServer(),a.assertAttr("type","result")});a=d("MAWGlobals").getPersistedJobsApi().definePersistedJob().finalStep("getSpams",function(){var a,c,e;return b("regeneratorRuntime").async(function(f){while(1)switch(f.prev=f.next){case 0:d("WALogger").LOG(i());a=d("WAWap").wap("iq",{to:d("WAWap").S_WHATSAPP_NET,xmlns:"fbid:thread",type:"get",id:d("WAWap").generateId()},d("WAWap").wap("spam_request",null));f.next=4;return b("regeneratorRuntime").awrap(d("WAComms").sendIq(a,j));case 4:c=f.sent;d("WALogger").LOG(h(),c);if(c.success){f.next=11;break}e=c.errorCode.toString().startsWith("5");if(!e){f.next=10;break}throw new(d("WAPersistedJobManager").RetryOnBackoff)({algo:{type:"exponential",first:d("WATimeUtils").HOUR_MILLISECONDS/60},jitter:.1});case 10:return f.abrupt("return",!1);case 11:return f.abrupt("return",!0);case 12:case"end":return f.stop()}},null,this)}).end();g.getSpams=a},98);
__d("MAWMediaTypeAttribute",["WAAssertUnreachable","WAMsgType","WAWap"],function(a,b,c,d,e,f,g){function a(a){if(a==null)return d("WAWap").DROP_ATTR;switch(a.type){case d("WAMsgType").MSG_TYPE.IMAGE:return"image";case d("WAMsgType").MSG_TYPE.VIDEO:return"video";case d("WAMsgType").MSG_TYPE.PTT:return"ptt";case d("WAMsgType").MSG_TYPE.GIF:return"gif";case d("WAMsgType").MSG_TYPE.STICKER:return"sticker";case d("WAMsgType").MSG_TYPE.XMA:return"xma-image";case d("WAMsgType").MSG_TYPE.TEXT:case d("WAMsgType").MSG_TYPE.FUTUREPROOF:case d("WAMsgType").MSG_TYPE.CIPHERTEXT:case d("WAMsgType").MSG_TYPE.UNAVAILABLE:case d("WAMsgType").MSG_TYPE.EXPIRED_EPHEMERAL:case d("WAMsgType").MSG_TYPE.REVOKED:case d("WAMsgType").MSG_TYPE.ADMIN:case d("WAMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:case d("WAMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:case d("WAMsgType").MSG_TYPE.ICDC_ALERT:case d("WAMsgType").MSG_TYPE.GROUP_INVITE:return d("WAWap").DROP_ATTR;default:return c("WAAssertUnreachable")(a.type)}}function b(a){switch(a.type){case d("WAMsgType").MSG_TYPE.IMAGE:return"image";case d("WAMsgType").MSG_TYPE.VIDEO:return"video";case d("WAMsgType").MSG_TYPE.PTT:return"ptt";case d("WAMsgType").MSG_TYPE.GIF:return"gif";case d("WAMsgType").MSG_TYPE.STICKER:return"sticker";case d("WAMsgType").MSG_TYPE.XMA:return"xma-image";case d("WAMsgType").MSG_TYPE.TEXT:case d("WAMsgType").MSG_TYPE.FUTUREPROOF:case d("WAMsgType").MSG_TYPE.CIPHERTEXT:case d("WAMsgType").MSG_TYPE.UNAVAILABLE:case d("WAMsgType").MSG_TYPE.EXPIRED_EPHEMERAL:case d("WAMsgType").MSG_TYPE.ADMIN:case d("WAMsgType").MSG_TYPE.REVOKED:case d("WAMsgType").MSG_TYPE.DELETE_FOR_ME:case d("WAMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:case d("WAMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE:case d("WAMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:case d("WAMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE:case d("WAMsgType").MSG_TYPE.ICDC_ALERT:case d("WAMsgType").MSG_TYPE.GROUP_INVITE:return null;default:return c("WAAssertUnreachable")(a.type)}}g.getMediaTypeAttribute=a;g.getMediaType=b},98);
__d("MAWSpamReportUtils",["MAWAsMessageApplication","MAWGlobals","MAWMediaTypeAttribute","MAWMediaUtils","WAJids","WAMsgApplication.pb","WAMsgType","WAWap","encodeProtobuf","err"],function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f){var g=a.ts.toString(),h=a.type===d("WAMsgType").MSG_TYPE.REVOKED?d("WAWap").CUSTOM_STRING("1"):d("WAWap").CUSTOM_STRING("0"),i=d("WAWap").DROP_ATTR,j,k,l,m=d("WAWap").DROP_ATTR;if(a.type===d("WAMsgType").MSG_TYPE.FUTUREPROOF)j=new Uint8Array(a.msgContent.protobuf),k=d("WAWap").DROP_ATTR,l=d("WAWap").CUSTOM_STRING("3");else if(a.type===d("WAMsgType").MSG_TYPE.CIPHERTEXT)j=null,k=d("WAWap").DROP_ATTR,l=d("WAWap").DROP_ATTR;else if(a.type===d("WAMsgType").MSG_TYPE.REVOKED||a.type===d("WAMsgType").MSG_TYPE.DELETE_FOR_ME){var n=d("MAWAsMessageApplication").deletedMsgAsMessageApplicationForSpamReporting(a);if(n==null)return null;j=d("encodeProtobuf").encodeProtobuf(d("WAMsgApplication.pb").MessageApplicationSpec,n).readByteArray();k="text";l=d("WAWap").CUSTOM_STRING("3");m=a.type===d("WAMsgType").MSG_TYPE.REVOKED?d("WAWap").CUSTOM_STRING("7"):d("WAWap").DROP_ATTR;b!=null&&(i=d("MAWMediaUtils").getServerMediaTypeFromMediaType(b.mediaType));g=a.originalTs!=null?a.originalTs.toString():g}else{n=d("MAWAsMessageApplication").asMessageApplication(a,b);j=d("encodeProtobuf").encodeProtobuf(d("WAMsgApplication.pb").MessageApplicationSpec,n).readByteArray();k="text";l=d("WAWap").CUSTOM_STRING("3");i=d("MAWMediaTypeAttribute").getMediaTypeAttribute(a)}b=null;if(((n=a.reportingMeta)==null?void 0:n.frankingTag)!=null&&((n=a.reportingMeta)==null?void 0:n.reportingTag)!=null){b=d("WAWap").wap("franking",null,d("WAWap").wap("franking_tag",null,(n=a.reportingMeta)==null?void 0:n.frankingTag),d("WAWap").wap("reporting_tag",null,(n=a.reportingMeta)==null?void 0:n.reportingTag))}return d("WAWap").wap("message",{t:d("WAWap").CUSTOM_STRING(g),type:k,unsent:h,id:d("WAWap").CUSTOM_STRING(a.externalId),to:c!=null?d("WAWap").USER_JID(c):d("WAWap").DROP_ATTR,from:e!=null?d("WAWap").GROUP_JID(e):f!=null?d("WAWap").USER_JID(f):d("WAWap").DROP_ATTR,edit:m,participant:f?d("WAWap").USER_JID(f):d("WAWap").DROP_ATTR},d("WAWap").wap("raw",{v:l,mediatype:i},j),b)}function b(a){var b;a.author===d("WAJids").AUTHOR_ME?b=d("MAWGlobals").getMyUserJid():b=d("WAJids").authorAsUserJid(a.author);if(b==null)throw c("err")("Impossible message author");return b}function e(a,b){a.author===d("WAJids").AUTHOR_ME?a=b:a=d("MAWGlobals").getMyUserJid();if(a==null)throw c("err")("Impossible message recipient");return a}g.formatMsgForSpamReport=a;g.getAuthorAsJidForSpam=b;g.getRecipientAsJidForSpam=e},98);
__d("MAWReportUserSpam",["MAWGlobals","MAWSpamReportUtils","WAComms","WAGlobals","WAJids","WAResultOrError","WAWap","err","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";var h=30;a=d("MAWGlobals").getPersistedJobsApi().definePersistedJob().finalStep("reportUserSpam",function(a){var e,f,g,i,j,k,l,m,n,o,p,q;return b("regeneratorRuntime").async(function(r){while(1)switch(r.prev=r.next){case 0:e=a.spamFlow,f=a.chatJid,g=a.userJid,i=a.frxTags,j=a.context,k=a.frxParams;r.next=3;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().getLastMsgsInChatForSpamReport(f,h));case 3:l=r.sent;m=null;if(!(i!=null)){r.next=9;break}if(!(i.length===0)){r.next=8;break}throw c("err")("spam reasons should not be an empty array");case 8:m=d("WAWap").wap("tagset",null,i.map(function(a){return d("WAWap").wap("tag",{value:d("WAWap").CUSTOM_STRING(a)})}));case 9:n=null;k!=null&&k!==""&&(n=d("WAWap").wap("parameters",null,k));o=null;j!=null&&(o=d("WAWap").wap("context",null,j));p=null;(m!=null||o!=null||n!=null)&&(p=d("WAWap").wap("frx",null,m,o,n));r.next=17;return b("regeneratorRuntime").awrap(d("WAJids").switchOnMsgrChatJidType(f,{user:function(){return d("WAWap").wap("iq",{to:d("WAWap").S_WHATSAPP_NET,xmlns:"spam",type:"set",id:d("WAWap").generateId()},d("WAWap").wap("spam_list",{spam_flow:d("WAWap").CUSTOM_STRING(e),jid:d("WAWap").USER_JID(g),reportee:d("WAWap").USER_JID(g)},l.map(function(a){return d("MAWSpamReportUtils").formatMsgForSpamReport(a.msg,a.mediaInfo,d("MAWSpamReportUtils").getRecipientAsJidForSpam(a.msg,g),null,d("MAWSpamReportUtils").getAuthorAsJidForSpam(a.msg))}).filter(function(a){return a!=null})),p)},group:function(a){var c,f,h,i,j;return b("regeneratorRuntime").async(function(k){while(1)switch(k.prev=k.next){case 0:c=d("WAWap").DROP_ATTR;f=d("WAWap").DROP_ATTR;if(!d("WAGlobals").getConfig().transactions.getGroupInfo){k.next=10;break}k.next=5;return b("regeneratorRuntime").awrap(d("WAGlobals").getTransactions().getGroupInfo(a));case 5:h=k.sent;h!=null&&h.subject!=null&&h.subject.content!=null&&(c=d("WAWap").CUSTOM_STRING(h.subject.content));h!=null&&h.inviter!=null&&(f=d("WAWap").USER_JID(h.inviter));k.next=18;break;case 10:k.next=12;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().getGroupSubjectByJid(a));case 12:i=k.sent;i.success&&(c=d("WAWap").CUSTOM_STRING(i.value));k.next=16;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().getInviterByGroupJid(a));case 16:j=k.sent,j.success&&(f=d("WAWap").USER_JID(j.value));case 18:return k.abrupt("return",d("WAWap").wap("iq",{to:d("WAWap").S_WHATSAPP_NET,type:"set",xmlns:"spam",id:d("WAWap").generateId()},d("WAWap").wap("spam_list",{jid:d("WAWap").GROUP_JID(a),reportee:d("WAWap").USER_JID(g),source:f,spam_flow:d("WAWap").CUSTOM_STRING(e),subject:c},l.map(function(b){return d("MAWSpamReportUtils").formatMsgForSpamReport(b.msg,b.mediaInfo,null,a,d("MAWSpamReportUtils").getAuthorAsJidForSpam(b.msg))})),p));case 19:case"end":return k.stop()}},null,this)}}));case 17:q=r.sent;d("WAComms").castStanza(q);return r.abrupt("return",d("WAResultOrError").makeSuccess());case 20:case"end":return r.stop()}},null,this)}).end();g.reportUserSpam=a},98);
__d("MAWResendWrittenAppData",["MAWGlobals","MAWJobDefinitions","MAWSendAppDataUtils","WALogger","WATimeUtils","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenAppData(","): too old, dropping"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["resendWrittenAppData not sending message: ",""]);i=function(){return a};return a}a=d("MAWGlobals").getPersistedJobsApi().definePersistedJob().finalStep("resendWrittenAppData",{code:function(a){var c,e,f;return b("regeneratorRuntime").async(function(g){while(1)switch(g.prev=g.next){case 0:c=a.appDataExternalId;g.next=3;return b("regeneratorRuntime").awrap(d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.getDevices(new Set([d("MAWGlobals").getMyUserJid()]))));case 3:g.next=5;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().getAppDataForResend(c));case 5:e=g.sent;if(!(e.type!=="not_sent")){g.next=9;break}d("WALogger").LOG(i(),e.type);return g.abrupt("return");case 9:g.next=11;return b("regeneratorRuntime").awrap(d("MAWSendAppDataUtils").sendAppData(e.appData,c,e.permittedIdentitiesPerDevice,null,!0));case 11:f=g.sent;if(!(f.type==="error")){g.next=15;break}g.next=15;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().markAppDataSendFailed(c));case 15:case"end":return g.stop()}},null,this)},stopRetryIf:{timePassedSeconds:d("WATimeUtils").DAY_SECONDS,onStopRetry:function(a){var c;return b("regeneratorRuntime").async(function(e){while(1)switch(e.prev=e.next){case 0:c=a.appDataExternalId;d("WALogger").LOG(h(),c);e.next=4;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().markAppDataDropped(c));case 4:case"end":return e.stop()}},null,this)}}}).end();g.resendWrittenAppData=a},98);
__d("MAWRestoreMessagesFromEncryptedBackups",["MAWGlobals","WALogger"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Job restoreMessagesFromEncryptedBackups ",", ",""]);h=function(){return a};return a}a=d("MAWGlobals").getPersistedJobsApi().definePersistedJob().finalStep("decodeAndRestoreMessages",function(a){var b=a.threadId;a=a.messages;d("WALogger").DEV(h(),b,a);return d("MAWGlobals").getDbImpls().handleEchoMsgsRestore(new Map([[b,a]]))}).end();g.restoreMessagesFromEncryptedBackups=a},98);
__d("MAWRestoreThreadsFromEncryptedBackups",["WAGlobals","WALogger"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Job restoreThreadsFromEncryptedBackups ",""]);h=function(){return a};return a}a=d("WAGlobals").getPersistedJobsApi().definePersistedJob().finalStep("decodeAndRestoreThreads",function(a){a=a.threads;d("WALogger").DEV(h(),a);return d("WAGlobals").getDbImpls().handleEchoThreadsRestore(a)}).end();g.restoreThreadsFromEncryptedBackups=a},98);
__d("MAWSendGroupInviteMsg",["MAWGlobals","MAWJobDefinitions","WAExternalIdFromRandomHex","WALogger","WAMsgType","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["sendGroupInviteMsg cannot send to a non-existent thread"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["sendGroupInviteMsg already sent message"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["sendGroupInviteMsg for group "," to invited user ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["sendGroupInviteMsg failed to store a new group invite"]);k=function(){return a};return a}a=d("MAWGlobals").getPersistedJobsApi().definePersistedJob().finalStep("saveAndPassOff",function(a,c,e){var f,g,l,m;return b("regeneratorRuntime").async(function(n){while(1)switch(n.prev=n.next){case 0:f=a.args,g=a.key;n.next=3;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().writeGroupInvite(f.groupJid,{inviterUserJid:f.inviterUserJid,invitedParticipantUserJid:f.invitedParticipantUserJid,inviteCode:f.inviteCode,expiration:f.expiration}));case 3:l=n.sent;if(l.success){n.next=7;break}d("WALogger").LOG(k());return n.abrupt("return");case 7:n.next=9;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().writeOutgoingMsg(d("WAExternalIdFromRandomHex").externalIdFromRandomHex(g),f.groupJid,e.jobStartTime,babelHelpers["extends"]({},f,{groupName:(c=l.value)!=null?c:void 0}),d("WAMsgType").MSG_TYPE.GROUP_INVITE));case 9:m=n.sent;d("WALogger").DEV(j(),a.args.groupJid,a.args.invitedParticipantUserJid);if(!(m.type==="already_sent")){n.next=16;break}d("WALogger").LOG(i());return n.abrupt("return");case 16:if(!(m.type==="missing_thread")){n.next=19;break}d("WALogger").LOG(h());return n.abrupt("return");case 19:n.next=21;return b("regeneratorRuntime").awrap(d("MAWGlobals").getJobManager().waitUntilPersisted(d("MAWJobDefinitions").jobSerializers.sendWrittenMsg(m.protocolMsgId,"message")));case 21:case"end":return n.stop()}},null,this)}).end();g.sendGroupInviteMsg=a},98);
__d("MAWOptimisticUploadManager",[],function(a,b,c,d,e,f){var g=new Map();function a(){return g}function b(){g.clear()}f.getOptimisticUploadManager=a;f.clearOptimisticUploadManager=b},66);
__d("MAWSendMediaMsg",["FBLogger","MAWAckLevel.re","MAWAsConsumerApplication","MAWBridge","MAWBridgeTypes","MAWCastToMsgrServerMediaType","MAWDbChunkTxns","MAWDbMedia","MAWDbMediaTxns","MAWDbMsgTxns","MAWDexieTable","MAWGating.re","MAWGlobals","MAWHMACKey","MAWIndexedDb","MAWJidUtils","MAWJobDefinitions","MAWMediaApiTypes","MAWMediaManagementTxns","MAWMediaUtils","MAWOptimisticUploadManager","MAWTransactionMode","Promise","WAExternalIdFromRandomHex","WALogger","WAMediaUtils","WAMsgType","WASortedLists","err","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to upload media: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to send media: "," - missing thread"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["MAWSendMediaMsg - begin writing "," media msg"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Chat ",": "," is received in job"]);k=function(){return a};return a}function l(a,e){var f,g,h,l,m,n,o,p,q;return b("regeneratorRuntime").async(function(r){while(1)switch(r.prev=r.next){case 0:f=a.chatJid,g=a.key,h=a.file,l=a.args;d("WALogger").LOG(k(),f,h.name);m=d("MAWMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(h.type),n=m.mediaType,o=m.serverMediaType;r.t0=n;r.next=r.t0===d("MAWDbMedia").MEDIA_TYPE.IMAGE?6:r.t0===d("MAWDbMedia").MEDIA_TYPE.VIDEO?8:r.t0===d("MAWDbMedia").MEDIA_TYPE.PTT?10:r.t0===d("MAWDbMedia").MEDIA_TYPE.GIF?12:r.t0===d("MAWDbMedia").MEDIA_TYPE.STICKER?14:16;break;case 6:p=d("WAMsgType").MSG_TYPE.IMAGE;return r.abrupt("break",18);case 8:p=d("WAMsgType").MSG_TYPE.VIDEO;return r.abrupt("break",18);case 10:p=d("WAMsgType").MSG_TYPE.PTT;return r.abrupt("break",18);case 12:p=d("WAMsgType").MSG_TYPE.GIF;return r.abrupt("break",18);case 14:p=d("WAMsgType").MSG_TYPE.STICKER;return r.abrupt("break",18);case 16:c("FBLogger")("labyrinth_web","unsupported_media").mustfix("unsupported media type");throw c("err")("Expected media msg type");case 18:d("WALogger").LOG(j(),p);r.next=21;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().writeOutgoingMsg(d("WAExternalIdFromRandomHex").externalIdFromRandomHex(g),f,e,l,p));case 21:q=r.sent;if(!(q.type==="missing_thread")){r.next=25;break}d("WALogger").LOG(i(),h.name);throw c("err")("Failed to write msg to DB");case 25:return r.abrupt("return",[q,{mediaType:n,serverMediaType:o}]);case 26:case"end":return r.stop()}},null,this)}function m(a,e,f,g,i){var j,k,l,m,q,r,s,t,u,v,w,x,y,z,A;return b("regeneratorRuntime").async(function(B){while(1)switch(B.prev=B.next){case 0:k=e.mediaType,l=e.serverMediaType;m=i.chatJid,q=i.file,r=i.args,i.key;s=d("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(l);if(s){B.next=6;break}c("FBLogger")("labyrinth_web","unsupported_media").mustfix("unsupported media type");throw c("err")("Media type unsupported: "+((t=l)!=null?t:""));case 6:B.next=8;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().getMsgIdByProtocolMsgId(a.protocolMsgId));case 8:u=B.sent;if(!(u==null)){B.next=11;break}throw c("err")("Message missing in db");case 11:v={validatedVideoInfo:k==="Video"?{width:r.width,height:r.height,mimetype:d("MAWAsConsumerApplication").VIDEO_MIME_TYPE,jpegThumbnail:r.jpegThumbnail,jpegThumbnailHeight:r.jpegThumbnailHeight,jpegThumbnailWidth:r.jpegThumbnailWidth,duration:r.duration}:null,validatedImageInfo:k==="Image"?{width:r.width,height:r.height,jpegThumbnail:r.jpegThumbnail,jpegThumbnailHeight:r.jpegThumbnailHeight,jpegThumbnailWidth:r.jpegThumbnailWidth}:k==="Gif"||k==="Sticker"?{width:r.width,height:r.height,jpegThumbnailHeight:r.height,jpegThumbnailWidth:r.width}:null,validatedAudioInfo:k==="Ptt"&&r.duration!=null?{duration:r.duration,mimetype:d("MAWAsConsumerApplication").AUDIO_MIME_TYPE,played:!1}:null};B.next=14;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().getThreadIdByJid(m));case 14:w=B.sent;if(!(w==null)){B.next=17;break}throw c("err")("Missing thread with jid: "+m);case 17:B.next=19;return b("regeneratorRuntime").awrap(o(w,u,q,f,g,void 0,void 0,k,v));case 19:x=d("MAWOptimisticUploadManager").getOptimisticUploadManager();y=x.get(f);z=y==null?void 0:y.optimisticUploadPromise;if(!(z!=null)){B.next=28;break}B.next=25;return b("regeneratorRuntime").awrap(z);case 25:B.t0=B.sent;B.next=31;break;case 28:B.next=30;return b("regeneratorRuntime").awrap(d("MAWBridge").getBridge().sendAndReceive("backend","uploadMedia",{chatJid:m,protocolMsgId:a.protocolMsgId,hash:f,type:l,size:q.size}));case 30:B.t0=B.sent;case 31:A=B.t0;if(A.success){B.next=35;break}d("WALogger").LOG(h(),q.name);return B.abrupt("return",n(u,d("MAWAckLevel.re").ACK.failed));case 35:B.next=37;return b("regeneratorRuntime").awrap(p(f,u,m,a.protocolMsgId.externalId,(j=A.value)==null?void 0:j.objectId,l));case 37:B.next=39;return b("regeneratorRuntime").awrap(d("MAWGlobals").getJobManager().waitUntilPersisted(d("MAWJobDefinitions").jobSerializers.sendWrittenMsg(a.protocolMsgId)));case 39:x["delete"](f);case 40:case"end":return B.stop()}},null,this)}a=d("MAWGlobals").getPersistedJobsApi().definePersistedJob().finalStep("sendMediaMsg",function(a,c,e){var f,g,h,i,j;return b("regeneratorRuntime").async(function(k){while(1)switch(k.prev=k.next){case 0:k.next=2;return b("regeneratorRuntime").awrap(l(a,e.jobStartTime));case 2:c=k.sent;f=c[0];g=c[1];k.next=7;return b("regeneratorRuntime").awrap(d("MAWMediaUtils").genBlobHashes(a.file));case 7:h=k.sent;i=h[0];j=h[1];k.next=12;return b("regeneratorRuntime").awrap(m(f,g,i,j,a));case 12:case"end":return k.stop()}},null,this)}).end();var n=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READWRITE,chunk:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READONLY})(function(a,b,c){return d("MAWDbMsgTxns").updateSystemAck(a,b,c).then(function(){})});function o(a,c,e,f,g,h,i,j,k){var l;return b("regeneratorRuntime").async(function(m){while(1)switch(m.prev=m.next){case 0:m.next=2;return b("regeneratorRuntime").awrap(d("WAMediaUtils").blobToArrayBuffer(e));case 2:l=m.sent;return m.abrupt("return",d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READWRITE,chunk:d("MAWTransactionMode").READWRITE,messages:d("MAWTransactionMode").READWRITE,unrenderedMessages:d("MAWTransactionMode").READWRITE})(function(b){return d("MAWDexieTable").dexieAll([d("MAWMediaManagementTxns").attachHashToMediaMsg(b,c,f,g,h,i,j,e.size,k,!1),d("MAWDbChunkTxns").getOrCreateMediaChunk(b,f,g,l,e.type)]).then(function(b){b=b[0];d("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:d("MAWBridgeTypes").createBridgeMedia(a,b,!0)})})})());case 4:case"end":return m.stop()}},null,this)}function p(a,e,f,g,h,i){var j=d("MAWOptimisticUploadManager").getOptimisticUploadManager(),k=j.get(a),l=k==null?void 0:k.mediaEntry;if(k==null)return b("Promise").resolve();j.set(a,babelHelpers["extends"]({},k,{msgId:e}));return l==null?b("Promise").resolve():d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READWRITE})(function(b){var j=d("MAWHMACKey").genHMACPlaintextHash(a);return d("MAWDbMediaTxns").maybeGetMediaFromHash(b,j).then(function(a){if(a){var j=babelHelpers["extends"]({},a,{msgIds:d("WASortedLists").addToSet(a.msgIds,e),mediaEntries:a.mediaEntries.set(e,l)});h!=null&&(j=babelHelpers["extends"]({},j,{objectId:d("WAMediaUtils").stringToDeliveryObjectId(h)}));return b.media.update(a.mediaId,j).then(function(){if(d("MAWGating.re").isAttachmentBackupEnabled()){var a=d("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(i);h!=null&&a!=null&&d("MAWIndexedDb").afterTransaction({tag:"UploadAttachment",value:d("MAWBridgeTypes").createBridgeUploadAttachment(h,a,g,d("MAWMediaApiTypes").MSGR_PRODUCT_TYPE,d("MAWJidUtils").threadIdForChatJid(f))})}})}else throw c("err")("media should already exist upon this point")})})()}g.writeToDb=l;g.saveAndPassOff=m;g.sendMediaMsg=a;g.maybePersistMediaEntry=p},98);
__d("MAWSendWrittenAppData",["MAWGlobals","MAWSendAppDataUtils","WALogger","WATimeUtils","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenAppData(","): too old, dropping"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenAppData not sending message: ",""]);i=function(){return a};return a}a=d("MAWGlobals").getPersistedJobsApi().definePersistedJob().finalStep("encryptAndSend",{code:function(a){var c,e,f;return b("regeneratorRuntime").async(function(g){while(1)switch(g.prev=g.next){case 0:c=a.appDataExternalId;g.next=3;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().getAppData(c));case 3:e=g.sent;if(!(e.type!=="not_sent")){g.next=7;break}d("WALogger").LOG(i(),e.type);return g.abrupt("return");case 7:g.next=9;return b("regeneratorRuntime").awrap(d("MAWSendAppDataUtils").sendAppData(e.appData,c,e.permittedIdentitiesPerDevice));case 9:f=g.sent;if(!(f.type==="success")){g.next=15;break}g.next=13;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().markAppDataSent(c));case 13:g.next=18;break;case 15:f.type;g.next=18;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().markAppDataSendFailed(c));case 18:case"end":return g.stop()}},null,this)},stopRetryIf:{timePassedSeconds:d("WATimeUtils").DAY_SECONDS,onStopRetry:function(a){var c;return b("regeneratorRuntime").async(function(e){while(1)switch(e.prev=e.next){case 0:c=a.appDataExternalId;d("WALogger").LOG(h(),c);e.next=4;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().markAppDataDropped(c));case 4:case"end":return e.stop()}},null,this)}}}).end();g.sendWrittenAppData=a},98);
__d("MAWMsgUtil",["MAWDbMsgTxns","MAWIndexedDb","MAWTransactionMode"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READWRITE,chunk:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READONLY})(function(a,b,c){return d("MAWDbMsgTxns").updateSystemAck(a,b,c).then(function(){})});g.updateSystemAckWithTxn=a},98);
__d("MAWSendXMAShareMsg",["MAWAckLevel.re","MAWBridge","MAWBridgeTypes","MAWDexieTable","MAWGlobals","MAWIndexedDb","MAWJobDefinitions","MAWMediaManagementTxns","MAWMediaUtils","MAWMsgUtil","MAWOptimisticUploadManager","MAWSendMediaMsg","MAWTransactionMode","MAWVault","MAWXMAManagementTxns","Promise","WAArmadilloApplication.pb","WAExternalIdFromRandomHex","WALogger","WAMediaUtils","WAMsgType","err","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to upload media xma"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["MAWSendXMAShareMsg - Missing thread with jid: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["MAWSendXMAShareMsg - Message missing in db"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to send xma - missing thread"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["MAWSendXMAShareMsg - Associated Message missing in db"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to send xma associated msg - missing thread"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["MAWSendXMAShareMsg - XMAMessageType is null"]);n=function(){return a};return a}a=d("MAWGlobals").getPersistedJobsApi().definePersistedJob().finalStep("sendXMAShareMsg",function(a,c,e){var f,g,o,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G;return b("regeneratorRuntime").async(function(H){while(1)switch(H.prev=H.next){case 0:g=Boolean(a.associatedMsgContent)&&a.associatedMsgContent!=null?d("MAWVault").vault(a.associatedMsgContent):void 0;o=void 0;r=d("WAExternalIdFromRandomHex").externalIdFromRandomHex(a.xmaMsgKey);s=a.args.xmaMessageType;if(!(s==null)){H.next=7;break}d("WALogger").ERROR(n());return H.abrupt("return");case 7:H.next=9;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().writeOutgoingMsg(r,a.chatJid,e.jobStartTime,a.args,d("WAMsgType").MSG_TYPE.XMA));case 9:t=H.sent;if(!(g!=null)){H.next=25;break}c=d("WAExternalIdFromRandomHex").externalIdFromRandomHex(a.associatedMsgContentKey);u=babelHelpers["extends"]({},a.args,{content:g});H.next=15;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().writeOutgoingMsg(c,a.chatJid,e.jobStartTime,u,d("WAMsgType").MSG_TYPE.TEXT));case 15:v=H.sent;if(!(v.type==="missing_thread")){H.next=19;break}d("WALogger").ERROR(m());return H.abrupt("return");case 19:H.next=21;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().getMsgIdByProtocolMsgId(v.protocolMsgId));case 21:o=H.sent;if(!(o==null)){H.next=25;break}d("WALogger").ERROR(l());return H.abrupt("return");case 25:if(!(t.type==="missing_thread")){H.next=28;break}d("WALogger").ERROR(k());return H.abrupt("return");case 28:H.next=30;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().getMsgIdByProtocolMsgId(t.protocolMsgId));case 30:w=H.sent;if(!(w==null)){H.next=34;break}d("WALogger").ERROR(j());return H.abrupt("return");case 34:H.next=36;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().getThreadIdByJid(a.chatJid));case 36:x=H.sent;if(!(x==null)){H.next=40;break}d("WALogger").ERROR(i(),a.chatJid);return H.abrupt("return");case 40:y=a.previewFile;z=a.headerFile;A=a.faviconFile;B=babelHelpers["extends"]({},a.xmaArgs,{overlayIconGlyph:(f=a.xmaArgs.overlayIconGlyph)!=null?f:d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_EXTENDED_CONTENT_MESSAGE_OVERLAYICONGLYPH.NONE});H.next=46;return b("regeneratorRuntime").awrap(q(y,z,A,w,a.args,s,o,x,t.protocolMsgId,B));case 46:C=H.sent;D=d("MAWOptimisticUploadManager").getOptimisticUploadManager();H.next=50;return b("regeneratorRuntime").awrap(p(C,a.chatJid,t.protocolMsgId,D));case 50:E=H.sent;F=E.filter(function(a){return!a.uploadResult.success}).length;if(!(F>0)){H.next=55;break}d("WALogger").ERROR(h());return H.abrupt("return",d("MAWMsgUtil").updateSystemAckWithTxn(w,d("MAWAckLevel.re").ACK.failed));case 55:G=E.map(function(b){var c=b.uploadResult;b=b.media;return d("MAWSendMediaMsg").maybePersistMediaEntry(b.plaintextHash,w,a.chatJid,t.protocolMsgId.externalId,c==null?void 0:(c=c.value)==null?void 0:c.objectId,d("MAWMediaUtils").getServerMediaTypeFromMediaType(b.mediaType,"xma-media"))});H.next=58;return b("regeneratorRuntime").awrap(b("Promise").all(G));case 58:H.next=60;return b("regeneratorRuntime").awrap(d("MAWGlobals").getJobManager().waitUntilPersisted(d("MAWJobDefinitions").jobSerializers.sendWrittenMsg(t.protocolMsgId)));case 60:E.forEach(function(a){D["delete"](a.media.plaintextHash)});case 61:case"end":return H.stop()}},null,this)}).end();function o(a,c,e,f,g,h){var i,j,k;return b("regeneratorRuntime").async(function(l){while(1)switch(l.prev=l.next){case 0:i=h.get(a);j=i==null?void 0:i.optimisticUploadPromise;if(!(j!=null)){l.next=8;break}l.next=5;return b("regeneratorRuntime").awrap(j);case 5:l.t0=l.sent;l.next=11;break;case 8:l.next=10;return b("regeneratorRuntime").awrap(d("MAWBridge").getBridge().sendAndReceive("backend","uploadMedia",{chatJid:c,protocolMsgId:e,hash:a,type:f,size:g}));case 10:l.t0=l.sent;case 11:k=l.t0;return l.abrupt("return",k);case 13:case"end":return l.stop()}},null,this)}function p(a,c,e,f){a=[a.previewDbMedia,a.faviconDbMedia,a.headerDbMedia].filter(Boolean);a=a.reduce(function(a,b){a.includes(b.plaintextHash)||a.push(b);return a},[]);a=a.map(function(a){var b=d("MAWMediaUtils").getServerMediaTypeFromMediaType(a.mediaType,"xma-media");return o(a.plaintextHash,c,e,b,a.size,f).then(function(b){return{uploadResult:b,media:a}})});return b("Promise").all(a)}function q(a,c,d,e,f,g,h,i,j,k){var l,m,n,o,p;return b("regeneratorRuntime").async(function(q){while(1)switch(q.prev=q.next){case 0:q.next=2;return b("regeneratorRuntime").awrap(b("Promise").all([r(a,f),r(c,f),r(d,f)]));case 2:l=q.sent;m=l[0];n=l[1];o=l[2];q.next=8;return b("regeneratorRuntime").awrap(s(e,m,n,o,g,h,i,j,k));case 8:p=q.sent;return q.abrupt("return",p);case 10:case"end":return q.stop()}},null,this)}function r(a,e){var f,g,h,i,j,k,l;return b("regeneratorRuntime").async(function(m){while(1)switch(m.prev=m.next){case 0:if(!(a==null)){m.next=2;break}return m.abrupt("return",a);case 2:f=d("MAWMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(a.type),g=f.mediaType,h=f.serverMediaType;m.next=5;return b("regeneratorRuntime").awrap(d("MAWMediaUtils").genBlobHashes(a));case 5:i=m.sent;j=i[0];k=i[1];if(!(g!=="Image")){m.next=10;break}throw c("err")("Expected Image when sending XMA share");case 10:m.next=12;return b("regeneratorRuntime").awrap(d("WAMediaUtils").blobToArrayBuffer(a));case 12:l=m.sent;return m.abrupt("return",{file:a,blobArrayBuffer:l,plaintextHash:j,hashedPlaintextHash:k,mediaType:g,serverMediaType:h,mediaInfo:{validatedVideoInfo:null,validatedImageInfo:{width:e.width,height:e.height,jpegThumbnail:e.jpegThumbnail,jpegThumbnailHeight:e.jpegThumbnailHeight,jpegThumbnailWidth:e.jpegThumbnailWidth},validatedAudioInfo:null}});case 14:case"end":return m.stop()}},null,this)}function s(a,b,c,e,f,g,h,i,j){return d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READWRITE,chunk:d("MAWTransactionMode").READWRITE,messages:d("MAWTransactionMode").READWRITE,unrenderedMessages:d("MAWTransactionMode").READWRITE,xma:d("MAWTransactionMode").READWRITE})(function(k){var l=d("MAWDexieTable").dexieResolve(),m=d("MAWDexieTable").dexieResolve(),n=d("MAWDexieTable").dexieResolve();b!=null&&(l=d("MAWMediaManagementTxns").attachHashAndSaveMedia(k,a,b.blobArrayBuffer,b.plaintextHash,b.hashedPlaintextHash,void 0,void 0,b.mediaType,b.mediaInfo,b.file,!0));c!=null&&(m=d("MAWMediaManagementTxns").attachHashAndSaveMedia(k,a,c.blobArrayBuffer,c.plaintextHash,c.hashedPlaintextHash,void 0,void 0,c.mediaType,c.mediaInfo,c.file,!0));e!=null&&(n=d("MAWMediaManagementTxns").attachHashAndSaveMedia(k,a,e.blobArrayBuffer,e.plaintextHash,e.hashedPlaintextHash,void 0,void 0,e.mediaType,e.mediaInfo,e.file,!0));return d("MAWDexieTable").dexieAll([l,m,n]).then(function(b){var c=b[0],e=b[1],l=b[2];return d("MAWXMAManagementTxns").saveXMA(k,c==null?void 0:c.mediaId,e==null?void 0:e.mediaId,l==null?void 0:l.mediaId,f,a,g,i,j).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:d("MAWBridgeTypes").createBridgeXMA(h,c,a)});return{previewDbMedia:c,headerDbMedia:e,faviconDbMedia:l}})})})()}g.sendXMAShareMsg=a},98);
__d("MAWUpdateBackupEntFbidForMedia",["MAWDbMediaTxns","MAWGlobals","MAWIndexedDb","MAWJobDefinitions","MAWTransactionMode","Promise","WALogger","WAMediaUtils","err","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Caught Error in updateBackupEntForFbid job for objectId ",": ",""]);h=function(){return a};return a}function i(a,e){if(a==null||a.length==0)return b("Promise").reject(c("err")("deliveryObjectId is empty"));return e==null||e.length==0?b("Promise").reject(c("err")("backupEntFbid is empty")):d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READWRITE})(function(b){return d("MAWDbMediaTxns").maybeGetMediaFromObjectId(b,a).then(function(a){if(a!=null){a=babelHelpers["extends"]({},a,{fbid:e});return b.media.update(a.mediaId,a).then(function(){})}else throw c("err")("media is null for deliveryObjectId provided")})["catch"](function(b){d("WALogger").ERROR(h(),a,b)})})()}a=d("MAWGlobals").getPersistedJobsApi().definePersistedJob().finalStep("writeToDb",function(a){var c,e;return b("regeneratorRuntime").async(function(f){while(1)switch(f.prev=f.next){case 0:c=a.deliveryObjectId,e=a.backupEntFbid;f.next=3;return b("regeneratorRuntime").awrap(i(d("WAMediaUtils").stringToDeliveryObjectId(c),d("WAMediaUtils").stringToBackupEntFbid(e)));case 3:f.next=5;return b("regeneratorRuntime").awrap(d("MAWGlobals").getJobManager().waitUntilPersisted(d("MAWJobDefinitions").jobSerializers.backupMessageWithMedia(c,e)));case 5:case"end":return f.stop()}},null,this)}).end();g.updateBackupEntFbid=i;g.updateBackupEntFbidForMedia=a},98);
__d("MAWUploadRetroactiveThreadsAndMessages",["MAWGlobals","WALogger"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["job finished - all messages and threads uploaded"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Initiating job: upload retroactive backups for ",""]);i=function(){return a};return a}a=d("MAWGlobals").getPersistedJobsApi().definePersistedJob().finalStep("uploadAllThreadsAndMessages",function(){d("WALogger").DEV(i(),d("MAWGlobals").getMyUserJid()),d("MAWGlobals").getDbImpls().uploadRetroactiveThreadsAndMessages(),d("WALogger").DEV(h())}).end();g.uploadRetroactiveThreadsAndMessages=a},98);
__d("MAWJobHandlers",["MAWBackupMessageWithMedia","MAWDeleteMsgsForMe","MAWDeleteThread","MAWDownloadAndHandleMedia","MAWDownloadAndRestoreMedia","MAWGetSpams","MAWReportUserSpam","MAWResendWrittenAppData","MAWRestoreMessagesFromEncryptedBackups","MAWRestoreThreadsFromEncryptedBackups","MAWSendGroupInviteMsg","MAWSendMediaMsg","MAWSendWrittenAppData","MAWSendXMAShareMsg","MAWUpdateBackupEntFbidForMedia","MAWUploadRetroactiveThreadsAndMessages","WAAddGroupParticipants","WAComputeAndUploadICDCInfo","WACreateGroup","WADeleteGroups","WADemoteGroupParticipants","WAForwardMsg","WAGenerateAndUploadPreKeys","WAGetCurrentUserDeviceList","WAGetDevices","WAHandleFutureproofMsg","WAHandleSpamMsg","WALeaveGroups","WAMarkThreadAsRead","WANotifyDeviceChange","WAPromoteGroupParticipants","WAQueryGroups","WARemoveCurrentDevice","WARemoveDevice","WARemoveGroupParticipants","WARequestPreKeyDigest","WARequestUploadMedia","WAReuploadMedia","WARevokeMsgs","WARotateSignedPreKey","WASendAppData","WASendEphemeralSettingMsg","WASendMsg","WASendPushNotificationConfig","WASendReactionMsg","WASendWrittenMsg","WASetGroupSubject","WASyncAbProps"],function(a,b,c,d,e,f,g){"use strict";function a(){return{addGroupParticipants:d("WAAddGroupParticipants").addGroupParticipants,downloadAndHandleMedia:d("MAWDownloadAndHandleMedia").downloadAndHandleMedia,generateAndUploadPreKeys:d("WAGenerateAndUploadPreKeys").generateAndUploadPreKeys,getCurrentUserDeviceList:d("WAGetCurrentUserDeviceList").getCurrentUserDeviceList,getDevices:d("WAGetDevices").getDevices,notifyDeviceChange:d("WANotifyDeviceChange").notifyDeviceChange,handleFutureproofMsg:d("WAHandleFutureproofMsg").handleFutureproofMsg,deleteThread:d("MAWDeleteThread").deleteThread,markThreadAsRead:d("WAMarkThreadAsRead").markThreadAsRead,removeDevice:d("WARemoveDevice").removeDevice,removeCurrentDevice:d("WARemoveCurrentDevice").removeCurrentDevice,requestPreKeyDigest:d("WARequestPreKeyDigest").requestPreKeyDigest,rotateSignedPreKey:d("WARotateSignedPreKey").rotateSignedPreKey,sendMediaMsg:d("MAWSendMediaMsg").sendMediaMsg,requestReuploadMedia:d("WARequestUploadMedia").requestReuploadMedia,reuploadMedia:d("WAReuploadMedia").reuploadMedia,sendMsg:d("WASendMsg").sendMsg,sendReactionMsg:d("WASendReactionMsg").sendReactionMsg,forwardMsg:d("WAForwardMsg").forwardMsg,sendWrittenMsg:d("WASendWrittenMsg").sendWrittenMsg,createGroup:d("WACreateGroup").createGroup,queryGroups:d("WAQueryGroups").queryGroups,leaveGroups:d("WALeaveGroups").leaveGroups,removeGroupParticipants:d("WARemoveGroupParticipants").removeGroupParticipants,promoteGroupParticipants:d("WAPromoteGroupParticipants").promoteGroupParticipants,demoteGroupParticipants:d("WADemoteGroupParticipants").demoteGroupParticipants,reportUserSpam:d("MAWReportUserSpam").reportUserSpam,deleteGroups:d("WADeleteGroups").deleteGroups,syncAbProps:d("WASyncAbProps").syncAbProps,setGroupSubject:d("WASetGroupSubject").setGroupSubject,revokeMsgs:d("WARevokeMsgs").revokeMsgs,deleteMsgsForMe:d("MAWDeleteMsgsForMe").deleteMsgsForMe,sendPushNotificationSetup:d("WASendPushNotificationConfig").sendPushNotificationSetup,sendAppData:d("WASendAppData").sendAppData,sendWrittenAppData:d("MAWSendWrittenAppData").sendWrittenAppData,resendWrittenAppData:d("MAWResendWrittenAppData").resendWrittenAppData,getSpams:d("MAWGetSpams").getSpams,handleSpamMsg:d("WAHandleSpamMsg").handleSpamMsg,restoreMessagesFromEncryptedBackups:d("MAWRestoreMessagesFromEncryptedBackups").restoreMessagesFromEncryptedBackups,restoreThreadsFromEncryptedBackups:d("MAWRestoreThreadsFromEncryptedBackups").restoreThreadsFromEncryptedBackups,sendEphemeralSettingMsg:d("WASendEphemeralSettingMsg").sendEphemeralSettingMsg,computeAndUploadICDCInfo:d("WAComputeAndUploadICDCInfo").computeAndUploadICDCInfo,uploadRetroactiveThreadsAndMessages:d("MAWUploadRetroactiveThreadsAndMessages").uploadRetroactiveThreadsAndMessages,updateBackupEntFbidForMedia:d("MAWUpdateBackupEntFbidForMedia").updateBackupEntFbidForMedia,downloadAndRestoreMedia:d("MAWDownloadAndRestoreMedia").downloadAndRestoreMedia,backupMessageWithMedia:d("MAWBackupMessageWithMedia").backupMessageWithMedia,sendXMAShareMsg:d("MAWSendXMAShareMsg").sendXMAShareMsg,sendGroupInviteMsg:d("MAWSendGroupInviteMsg").sendGroupInviteMsg}}g.getJobHandlers=a},98);
__d("MAWDexieCastToPromise",[],function(a,b,c,d,e,f){function g(h){return Promise.resolve(h)}f.dexieCastToPromise=g},66);
__d("MAWContactStore",["MAWDbIdentityTxns","MAWDexieCastToPromise","MAWDexieTable","MAWTransactionMode","WAResultOrError"],function(a,b,c,d,e,f,g){"use strict";var h=function(){function h(k){this.db=k}var j=h.prototype;j.getAll=async function(k){var l=this,m=await d("MAWDexieCastToPromise").dexieCastToPromise(this.db.contacts.bulkGet(k));return Promise.all(m.reduce(function(n,o){if(o!=null){var p=d("MAWDbIdentityTxns").bulkGetIdentities(l.db,o.devices).then(function(q){return i(o,q)});n.push(d("MAWDexieCastToPromise").dexieCastToPromise(p))}return n},[]))};j.get=function(k){var l=this;return d("MAWDexieCastToPromise").dexieCastToPromise(this.db.contacts.get(k).then(function(m){return m==null?d("WAResultOrError").makeError("missing"):d("MAWDbIdentityTxns").bulkGetIdentities(l.db,m.devices).then(function(n){return d("WAResultOrError").makeSuccess(i(m,n))})}))};j.set=function(k){var l=this;return d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWDexieTable").dexieAll(k.map(function(m){return l.db.contacts.get(m.contactJid).then(function(n){return l.db.contacts.put(babelHelpers.extends({},n,{contactJid:m.contactJid,devices:m.identities.map(function(o){return o.device}),dhash:m.dhash,icdcInfo:m.icdcInfo,lastSyncTs:m.lastSyncTs}))}).then(function(){return d("MAWDbIdentityTxns").bulkPutIdentities(l.db,m.identities.map(function(n){return{deviceJid:n.device,identity:n.identity}}))})})).then(function(){}))};j.update=function(k){var l=this;return d("MAWDexieCastToPromise").dexieCastToPromise(this.db.contacts.get(k.contactJid).then(function(m){if(m==null)return d("WAResultOrError").makeError("missing");m.contactJid=k.contactJid;m.devices=k.identities.map(function(n){return n.device});m.dhash=k.dhash;m.icdcInfo=k.icdcInfo;m.lastSyncTs=k.lastSyncTs;return l.db.contacts.put(m).then(function(){return d("WAResultOrError").makeSuccess()})}))};return h}();h.tableLocks={contacts:d("MAWTransactionMode").READWRITE,identity:d("MAWTransactionMode").READWRITE};function i(j,k){return{contactJid:j.contactJid,dhash:j.dhash,icdcInfo:j.icdcInfo,lastSyncTs:j.lastSyncTs,nameForSearch:j.nameForSearch,identities:k.map(function(l){return{device:l.id,identity:l.identity}})}}g.MAWContactsStore=h},98);
__d("MAWGroupInfoStore",["MAWBridgeTypes","MAWDbThreadTxns","MAWDexieCastToPromise","MAWDexieTable","MAWFolderTypes","MAWGetOrCreateThreadTxns","MAWIndexedDb","MAWLoadMsgsTxns","MAWLoadThreadsTxns","MAWThreadManagementTxns","MAWTransactionMode","WAResultOrError","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";function h(a){return a!=null&&typeof a==="object"&&a.groupStatus!=null&&typeof a.groupStatus==="string"?a.groupStatus:void 0}function i(a){return a!=null&&typeof a==="object"&&a.clientThreadKey!=null&&typeof a.clientThreadKey==="string"?a.clientThreadKey:void 0}function j(a){return a!=null&&typeof a==="object"&&a.folder!=null&&typeof a.folder==="number"?a.folder:void 0}function k(a){return a===null?babelHelpers["extends"]({},null):a}a=function(){function a(a){this.db=a}var b=a.prototype;b.get=function(a,b){var c=this;b=j(b);return d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWThreadManagementTxns").getOrRepairGroupThreadByJid(this.db,a,b).then(function(a){return a!=null?a:null}).then(function(a){return a==null?null:d("MAWLoadThreadsTxns").loadContentsForThreads(c.db,[a.thread],1).then(function(){return a.groupInfo}).then(function(a){return l(a)})}))};b.create=function(a,b){var c=this,e=h(b)==="added"?d("WATimeUtils").unixTime():a.creationTs;return d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWGetOrCreateThreadTxns").getOrCreateThread(this.db,a.jid,d("MAWFolderTypes").FOLDER_ID.INBOX,i(b),e).then(function(b){var e=b.created,f=b.thread,g=m(a,f.chatId);return c.db.groupInfo.put(g).then(function(){d("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:d("MAWBridgeTypes").createBridgeUpdatedGroupInfo(g)})}).then(function(){return f.newestMsg!=null?d("MAWLoadMsgsTxns").loadMsgsAndMediaFromOffset(c.db,f.chatId,f.newestMsg,10,!0):d("MAWDexieTable").dexieResolve()}).then(function(){return f.archived===!0?d("MAWDbThreadTxns").unarchiveThreads(c.db,[f.chatId]):d("MAWDexieTable").dexieResolve()}).then(function(){return{isNew:e}})}))};b["delete"]=function(a){var b=this;return d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWDexieTable").dexieAll([this.db.threads.get({jid:a}),this.db.groupInfo["delete"](a)]).then(function(a){a=a[0];if(a==null)return;return b.db.threads["delete"](a.chatId)}))};b.update=function(a){var b=this;return d("MAWDexieCastToPromise").dexieCastToPromise(this.db.threads.get({jid:a.jid}).then(function(c){if(c==null)return d("WAResultOrError").makeError("missing");var e=m(a,c.chatId);return b.db.groupInfo.put(e).then(function(){d("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:d("MAWBridgeTypes").createBridgeUpdatedGroupInfo(e)});return d("WAResultOrError").makeSuccess()})}))};return a}();a.tableLocks={groupInfo:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE,participants:d("MAWTransactionMode").READWRITE,chunk:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READONLY,contacts:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READONLY};function l(a){return babelHelpers["extends"]({jid:a.groupJid},k(a.creator!=null?{creator:a.creator}:null),{creationTs:a.creationTs},k(a.participantVersion!=null?{participantVersion:a.participantVersion}:null),{inviter:a.inviter,subject:babelHelpers["extends"]({content:a.name},k(a.nameOwner!=null?{user:a.nameOwner}:null),k(a.nameTs!=null?{ts:a.nameTs}:null))})}function m(a,b){var c=a.subject.content;c!=null&&c.length===0&&(c=void 0);return{groupJid:a.jid,threadId:b,creator:a.creator,creationTs:a.creationTs,name:c,nameOwner:a.subject.user,nameTs:a.subject.ts,participantVersion:a.participantVersion,inviter:a.inviter}}g.MAWGroupInfoStore=a},98);
__d("MAWMediaStore",["MAWDbMsgTxns","MAWDexieCastToPromise","MAWDexieTable","MAWTransactionMode","WALogger","WASortedLists"],function(a,b,c,d,e,f,g){"use strict";function h(){var j=babelHelpers.taggedTemplateLiteralLoose(["Successfully deleted: "," media rows, "," chunk rows."]);h=function(){return j};return j}var i=function(){function i(k){this.db=k}var j=i.prototype;j.bulkDelete=function(k){var l=this;return d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWDbMsgTxns").getMsgsByProtocolMsgId(this.db,k).then(function(m){var n=m.msgs,o=[];for(var p=n,q=Array.isArray(p),r=0,p=q?p:p[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var s;if(q){if(r>=p.length)break;s=p[r++]}else{r=p.next();if(r.done)break;s=r.value}var t=s,u=t.mediaId,v=t.msgId;u!=null&&o.push([u,v])}return o}).then(function(m){return l.db.media.bulkGet(m.map(function(n){return n[0]})).then(function(n){var o=[],p=[];n.forEach(function(s,t){if(s!=null){var u=m[t][1];s.msgIds=d("WASortedLists").filter(s.msgIds,function(v){return v!==u});s.mediaEntries.delete(u);s.msgIds.length===0&&s.mediaEntries.size===0&&(s.hashedPlaintextHash!=null&&o.push(s.hashedPlaintextHash),p.push(s.mediaId))}});var q=l.db.media.bulkDelete(p),r=l.db.chunk.where("hashedPlaintextHash").anyOf(o).delete();return d("MAWDexieTable").dexieAll([q,r]).then(function(){d("WALogger").LOG(h(),p.length,o.length)})})}))};return i}();i.tableLocks={media:d("MAWTransactionMode").READWRITE,messages:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READWRITE};g.MAWMediaStore=i},98);
__d("MAWGetExpiredMsgs",["WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";function a(a){var b=d("WATimeUtils").unixTime();return a.messages.where("messageDeleteTs").belowOrEqual(b).toArray().then(function(a){return a.map(function(a){var b=a.threadJid,c=a.author;a=a.externalId;return b==null?null:{chat:b,author:c,externalId:a}}).filter(Boolean)})}g.getExpiredMsgs=a},98);
__d("MAWMessageStore",["MAWAuthor","MAWBridgeTypes","MAWDbMsg","MAWDbMsgTxns","MAWDexieCastToPromise","MAWDexieTable","MAWFolderTypes","MAWGating.re","MAWGetExpiredMsgs","MAWIndexedDb","MAWThreadFetchAndEmitTxns","MAWTransactionMode","MAWWriteMsgTxns","WAJids","WALogger","WAMsgType","WAResultOrError","err"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Successfully deleted: "," reactions rows."]);h=function(){return a};return a}function i(a){if(a!=null&&typeof a==="object"&&a.optimisticMsg!=null){a=a.optimisticMsg;if(typeof a.msgId==="string"&&typeof a.ts==="number")return{msgId:a.msgId,ts:a.ts}}return void 0}function j(a){return a!=null&&typeof a==="object"&&a.openMessageOtid!=null&&typeof a.openMessageOtid==="string"?a.openMessageOtid:void 0}function k(a){if(a!=null&&typeof a==="object"&&a.folder!=null&&typeof a.folder==="number")if(a.folder===d("MAWFolderTypes").FOLDER_ID.INBOX)return d("MAWFolderTypes").FOLDER_ID.INBOX;else if(a.folder===d("MAWFolderTypes").FOLDER_ID.PENDING)return d("MAWFolderTypes").FOLDER_ID.PENDING;else if(a.folder===d("MAWFolderTypes").FOLDER_ID.OTHER)return d("MAWFolderTypes").FOLDER_ID.OTHER;else if(a.folder===d("MAWFolderTypes").FOLDER_ID.ARCHIVED)return d("MAWFolderTypes").FOLDER_ID.ARCHIVED;return null}a=function(){function a(a){this.db=a}var b=a.prototype;b.create=function(a,b){var e=this,f=i(b),g=j(b);b=k(b);return d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWThreadFetchAndEmitTxns").fetchAndEmitThread(this.db,a.id.chat,b).then(function(b){if(b==null)return d("WAResultOrError").makeError("missing_thread");b=b.thread;if(a.type===d("WAMsgType").MSG_TYPE.TEXT){var h=void 0;d("MAWGating.re").isEphemeralMessagesEnabled()&&a.ephemeralSetting!=null&&(h={ephemeralExpirationInSec:a.ephemeralSetting.expirationTs,ephemeralLastUpdatedOrSetTimestamp:a.ephemeralSetting.updatedTs});var i=d("MAWDbMsg").craftMsgId(b.chatId,b.nextInChatMsgId);i={author:a.id.author,externalId:a.id.externalId,thread:b.chatId,threadJid:b.jid,ack:a.ack,ts:a.ts,msgId:i,altIndex:d("MAWDbMsg").UNDEFINED_ALT_INDEX,type:d("WAMsgType").MSG_TYPE.TEXT,msgContent:{content:((i=a.msgContent)==null?void 0:i.content)||""},ephemeralSetting:h,forwardingScore:a.forwardingScore,isForwarded:a.forwardingScore>0};return d("MAWWriteMsgTxns").writeMsg(e.db,i,b,f,g).then(function(){return d("WAResultOrError").makeSuccess()})}else if(a.type===d("WAMsgType").MSG_TYPE.ICDC_ALERT){h=d("MAWDbMsg").craftMsgId(b.chatId,b.nextInChatMsgId);i={author:a.id.author,externalId:a.id.externalId,thread:b.chatId,threadJid:b.jid,ack:a.ack,ts:a.ts,msgId:h,altIndex:d("MAWDbMsg").UNDEFINED_ALT_INDEX,type:d("WAMsgType").MSG_TYPE.ICDC_ALERT,msgContent:{authorName:a.msgContent.authorName,adminType:a.msgContent.adminType}};return d("MAWWriteMsgTxns").writeMsg(e.db,i,b,f,g).then(function(){a.hasUnknownName&&!d("WAJids").isAuthorMe(a.id.author)&&!d("WAJids").isAuthorSystem(a.id.author)&&d("MAWIndexedDb").afterTransaction({tag:"SyncContacts",value:[d("WAJids").userIdFromJid(a.id.author)]});return d("WAResultOrError").makeSuccess()})}else if(a.type===d("WAMsgType").MSG_TYPE.ADMIN){h=d("MAWDbMsg").craftMsgId(b.chatId,b.nextInChatMsgId);i={author:d("WAJids").AUTHOR_SYSTEM,externalId:a.id.externalId,thread:b.chatId,threadJid:b.jid,ack:a.ack,ts:a.ts,msgId:h,altIndex:d("MAWDbMsg").UNDEFINED_ALT_INDEX,type:a.type,msgContent:a.msgContent};return d("MAWWriteMsgTxns").writeMsg(e.db,i,b).then(function(){return d("WAResultOrError").makeSuccess()})}throw c("err")("non renderable store not implemented yet")}))};b.get=function(a){return d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWDexieTable").dexieAll([this.db.threads.get({jid:a.chat}),this.db.messages.where("externalId").equals(a.externalId).toArray()]).then(function(b){var c=b[0];b=b[1];if(c==null)return d("MAWDexieTable").dexieResolve(null);b=b.find(function(b){return b.thread===c.chatId&&b.author===a.author});return b==null||b.type!=="Text"?d("MAWDexieTable").dexieResolve(null):d("MAWDexieTable").dexieResolve({id:a,type:b.type,ts:b.ts,ack:b.ack,msgContent:{content:b.msgContent.content},forwardingScore:(b=b.forwardingScore)!=null?b:0})}))};b.update=function(a){var b=this;return d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWDexieTable").dexieAll([this.db.threads.get({jid:a.id.chat}),this.db.messages.where("externalId").equals(a.id.externalId).toArray()]).then(function(c){var e=c[0];c=c[1];if(e==null)return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError("missing"));var f=c.find(function(b){return b.thread===e.chatId&&b.author===a.id.author});if(f==null||f.type!=="Text")return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError("missing"));f.ack=a.ack;f.ts=a.ts;f.serverTs=a.sentTs;c=void 0;d("MAWGating.re").isEphemeralMessagesEnabled()&&a.ephemeralSetting!=null&&(c={ephemeralExpirationInSec:a.ephemeralSetting.expirationTs,ephemeralLastUpdatedOrSetTimestamp:a.ephemeralSetting.updatedTs});f.ephemeralSetting=c;return b.db.messages.put(f).then(function(){var a=null;d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeTypes").createBridgeMsg(f,void 0,a)});return d("WAResultOrError").makeSuccess()})}))};b.deleteReactionsForMsg=function(a){var b=this;return d("MAWDexieCastToPromise").dexieCastToPromise(this.db.reactions.where("reactToExternalId").equals(a.externalId).filter(function(b){return d("MAWAuthor").getAuthorUserJid(b.reactToAuthor)===d("MAWAuthor").getAuthorUserJid(a.author)&&b.threadJid===a.chat}).toArray().then(function(a){return b.db.reactions.bulkDelete(a.map(function(a){return a.rowId}))}))};b.bulkGetExpiredMsgIds=function(){return d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWGetExpiredMsgs").getExpiredMsgs(this.db))};b.bulkDelete=function(a){var b=this,c=d("MAWDexieTable").dexieAll(a.map(function(a){var c=a.chat,e=a.author;a=a.externalId;var f=d("MAWAuthor").getAuthorUserJid(e);return b.db.reactions.where("reactToExternalId").equals(a).filter(function(a){return d("MAWAuthor").getAuthorUserJid(a.reactToAuthor)===f&&a.threadJid===c}).toArray()})).then(function(a){return a.flat()}).then(function(a){d("WALogger").LOG(h(),a.length);return b.db.reactions.bulkDelete(a.map(function(a){return a.rowId}))});return d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWDbMsgTxns").getMsgsByProtocolMsgId(this.db,a).then(function(a){a=a.msgs;var e=a.map(function(a){return a.rowId});return d("MAWDexieTable").dexieAll([b.db.messages.bulkDelete(e),c]).then(function(){return e.length})}))};b.bulkGetInGroup=function(a){return d("MAWDexieCastToPromise").dexieCastToPromise(this.db.messages.where("threadJid").equals(a).toArray()).then(function(b){return b==null||b.length===0?[]:b.map(function(b){return{chat:a,author:b.author,externalId:b.externalId}})})};return a}();a.tableLocks={messages:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READONLY,groupInfo:d("MAWTransactionMode").READWRITE,chunk:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READWRITE,participants:d("MAWTransactionMode").READWRITE,media:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READONLY};g.MAWMessageStore=a},98);
__d("MAWMetaInfoStore",["MAWBridge","MAWDexieCastToPromise","MAWTransactionMode","Promise","SignalDbTypes","err","objectEntries","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";a=function(a){return new(b("Promise"))(function(b){var d=a.edgeInfo;if(d==null)throw c("err")("EdgeInfo was null when trying to set");b()})};e=function(a){a=a.clockSkew;d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"ClockSkewUpdated",value:a}]})};var h=(f={},f[d("SignalDbTypes").MetaKeysEnum.edgeInfo]=a,f),i=(a={},a[d("SignalDbTypes").MetaKeysEnum.clockSkew]=e,a),j=function(a){return b("Promise").resolve()};function k(a){switch(a){case d("SignalDbTypes").MetaKeysEnum.cat:case d("SignalDbTypes").MetaKeysEnum.deviceUUID:case d("SignalDbTypes").MetaKeysEnum.fbid:case d("SignalDbTypes").MetaKeysEnum.deviceId:case d("SignalDbTypes").MetaKeysEnum.regId:case d("SignalDbTypes").MetaKeysEnum.identityKeyPair:case d("SignalDbTypes").MetaKeysEnum.lastSignedPrekeyId:case d("SignalDbTypes").MetaKeysEnum.lastPrekeyId:case d("SignalDbTypes").MetaKeysEnum.lastPrekeyGenerationId:case d("SignalDbTypes").MetaKeysEnum.edgeInfo:case d("SignalDbTypes").MetaKeysEnum.clockSkew:case d("SignalDbTypes").MetaKeysEnum.abProps:return!0;default:return!1}}f=function(){function a(a){this.db=a}var e=a.prototype;e.get=function(){return d("MAWDexieCastToPromise").dexieCastToPromise(this.db.meta.bulkGet([d("SignalDbTypes").MetaKeysEnum.deviceUUID,d("SignalDbTypes").MetaKeysEnum.regId,d("SignalDbTypes").MetaKeysEnum.identityKeyPair,d("SignalDbTypes").MetaKeysEnum.deviceId,d("SignalDbTypes").MetaKeysEnum.lastSignedPrekeyId,d("SignalDbTypes").MetaKeysEnum.lastPrekeyId,d("SignalDbTypes").MetaKeysEnum.lastPrekeyGenerationId,d("SignalDbTypes").MetaKeysEnum.edgeInfo,d("SignalDbTypes").MetaKeysEnum.clockSkew]).then(function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7];a=a[8];return{deviceUUID:b==null?void 0:(b=b.value)==null?void 0:b.deviceUUID,regId:c==null?void 0:(b=c.value)==null?void 0:b.regId,identityKeyPair:d==null?void 0:(c=d.value)==null?void 0:c.identityKeyPair,deviceId:e==null?void 0:(b=e.value)==null?void 0:b.deviceId,lastSignedPrekeyId:f==null?void 0:(d=f.value)==null?void 0:d.lastSignedPrekeyId,lastPrekeyId:g==null?void 0:(c=g.value)==null?void 0:c.lastPrekeyId,lastPrekeyGenerationId:h==null?void 0:(e=h.value)==null?void 0:e.lastPrekeyGenerationId,edgeInfo:i==null?void 0:(b=i.value)==null?void 0:b.edgeInfo,clockSkew:a==null?void 0:(f=a.value)==null?void 0:f.clockSkew}}))};e.patch=function(a){var e,f;return b("regeneratorRuntime").async(function(g){while(1)switch(g.prev=g.next){case 0:e=c("objectEntries")(a);f=e.map(function(a){var b,c=a[0];a=a[1];return{key:d("SignalDbTypes").MetaKeysEnum[c],value:(b={},b[c]=a,b)}});if(!e.some(function(a){a=a[0];return!k(a)})){g.next=4;break}throw c("err")("Invalid MetaInfoStore key specified");case 4:g.next=6;return b("regeneratorRuntime").awrap(b("Promise").all(f.map(function(a){var b=a.key;a=a.value;b=h[b]||j;return b(a)})));case 6:g.next=8;return b("regeneratorRuntime").awrap(d("MAWDexieCastToPromise").dexieCastToPromise(this.db.meta.bulkPut(f)));case 8:f.filter(function(a){return i[a.key]}).forEach(function(a){var b=i[a.key];b(a.value)});case 9:case"end":return g.stop()}},null,this)};return a}();f.tableLocks={meta:d("MAWTransactionMode").READWRITE};g.MAWMetaInfoStore=f},98);
__d("MAWParticipantsStore",["MAWBridgeTypes","MAWDbParticipant","MAWDbParticipantTxns","MAWDbThreadTxns","MAWDexieCastToPromise","MAWDexieTable","MAWGlobals","MAWIndexedDb","MAWTransactionMode","WAResultOrError","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";a=function(){function a(a){this.db=a}var b=a.prototype;b.bulkGetInGroup=function(a){var b=this;return d("MAWDexieCastToPromise").dexieCastToPromise(this.db.threads.get({jid:a}).then(function(a){return a==null?d("WAResultOrError").makeError("missing_group"):d("MAWDbParticipantTxns").getParticipantsInThread(b.db,a.chatId).then(function(b){return d("WAResultOrError").makeSuccess(b.map(function(b){return h(b,a.jid)}))})}))};b.bulkDeleteInGroup=function(a){var b=this;return d("MAWDexieCastToPromise").dexieCastToPromise(this.db.threads.get({jid:a}).then(function(a){if(a==null)return;return b.db.participants.where("threadId").equals(a.chatId)["delete"]().then(function(){d("MAWDbThreadTxns").archiveThreads(b.db,[a.chatId],!0)})}))};b.bulkCreate=function(a,b){var c=this;return d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWDexieTable").dexieAll([this.db.threads.get({jid:a})]).then(function(a){var e=a[0];if(e==null)return d("WAResultOrError").makeError("missing_group");var f=b.map(function(a){return i(a,e.chatId)});return c.db.participants.bulkPut(f).then(function(){f.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"ParticipantUpdated",value:d("MAWBridgeTypes").createBridgeParticipant(a)})})}).then(function(){return d("WAResultOrError").makeSuccess()})}))};b.bulkUpdate=function(a,b){var c=this;return d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWDexieTable").dexieAll([this.db.threads.get({jid:a})]).then(function(a){var e=a[0];if(e==null)return d("WAResultOrError").makeError("missing_group");var f=b.map(function(a){return i(a,e.chatId)});return c.db.participants.bulkPut(f).then(function(){f.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"ParticipantUpdated",value:d("MAWBridgeTypes").createBridgeParticipant(a)})});return d("WAResultOrError").makeSuccess()})}))};b.bulkDelete=function(a,b,c){var e=this;return d("MAWDexieCastToPromise").dexieCastToPromise(this.db.threads.get({jid:a}).then(function(a){return a==null?d("WAResultOrError").makeError("missing_group"):d("MAWDbParticipantTxns").bulkDeleteParticipantsInThread(e.db,a.chatId,b).then(function(){var f=b.filter(function(a){return a===c&&(a===d("MAWGlobals").getMyUserJid()||a==="@me")}).length>0;if(f)return d("MAWDbThreadTxns").archiveThreads(e.db,[a.chatId],!0);f=b.filter(function(a){return(a===d("MAWGlobals").getMyUserJid()||a==="@me")&&a!==c}).length>0;if(f)return d("MAWDbThreadTxns").unsubscribeFromThreads(e.db,[a.chatId])}).then(function(){return d("WAResultOrError").makeSuccess()})}))};return a}();a.tableLocks={threads:d("MAWTransactionMode").READWRITE,participants:d("MAWTransactionMode").READWRITE};function h(a,b){var c=a.addressable!=null?{addressable:a.addressable}:null;return babelHelpers["extends"]({user:a.userJid,type:a.type,chatJid:b},c)}function i(a,b,c,e,f,g){return{deliveredWatermarkTs:(c=c)!=null?c:d("WATimeUtils").castToUnixTime(0),lastReadWatermarkTs:(c=e)!=null?c:d("WATimeUtils").castToUnixTime(0),id:d("MAWDbParticipant").craftParticipantId(b,a.user),threadId:b,type:a.type,userJid:a.user,addressable:a.addressable,nickname:g,lastReadActionTs:f}}g.MAWParticipantsStore=a},98);
__d("MAWPendingReceiptsStore",["MAWDbPendingReceipt","MAWDexieCastToPromise","MAWTransactionMode"],function(a,b,c,d,e,f,g){"use strict";a=function(){function a(a){this.db=a}var b=a.prototype;b.create=function(a){return d("MAWDexieCastToPromise").dexieCastToPromise(this.db.pendingReceipts.put({id:d("MAWDbPendingReceipt").craftPendingReceiptId(a.id.chat,a.id.externalId,a.id.author),thread:a.id.chat,externalId:a.id.externalId,author:a.id.author,deliveryReceipts:a.deliveryReceipts,readReceipts:a.readReceipts}).then(function(){}))};b.get=function(a){a=d("MAWDbPendingReceipt").craftPendingReceiptId(a.chat,a.externalId,a.author);return d("MAWDexieCastToPromise").dexieCastToPromise(this.db.pendingReceipts.get(a).then(function(a){return a==null?null:{id:{author:a.author,chat:a.thread,externalId:a.externalId},deliveryReceipts:a.deliveryReceipts,readReceipts:a.readReceipts}}))};b["delete"]=function(a){a=d("MAWDbPendingReceipt").craftPendingReceiptId(a.chat,a.externalId,a.author);return d("MAWDexieCastToPromise").dexieCastToPromise(this.db.pendingReceipts["delete"](a))};return a}();a.tableLocks={pendingStanzas:d("MAWTransactionMode").READWRITE};g.MAWPendingReceiptsStore=a},98);
__d("MAWPendingStanzasStore",["MAWDbMsg","MAWDbPendingStanza","MAWDexieCastToPromise","MAWDexieTable","MAWTransactionMode","WAAssertUnreachable","WAErr","WAMsgType"],function(a,b,c,d,e,f,g){"use strict";a=function(){function a(a){this.db=a}var b=a.prototype;b.create=function(a){var b=this,e=a.stanza,f=a.externalId,g=a.deleteTs,h;return d("MAWDexieCastToPromise").dexieCastToPromise(this.db.threads.get({jid:e.id.chat}).then(function(a){if(a==null)throw c("WAErr")("thread does not exist");switch(e.type){case d("WAMsgType").MSG_TYPE.REVOKED:h={externalIdWithType:f+"_"+d("MAWDbPendingStanza").PENDING_REVOKED,pendingContent:{type:d("MAWDbPendingStanza").PENDING_TYPE.REVOKED,content:{type:d("WAMsgType").MSG_TYPE.REVOKED,revokedExternalId:e.revokedExternalId,ts:e.ts,externalId:e.id.externalId,thread:a.chatId,threadJid:e.id.chat,author:e.id.author,ack:e.ack,altIndex:d("MAWDbMsg").UNDEFINED_ALT_INDEX}},deleteTs:g};break;case d("WAMsgType").MSG_TYPE.DELETE_FOR_ME:h={externalIdWithType:f+"_"+d("MAWDbPendingStanza").PENDING_DELETE_FOR_ME,pendingContent:{type:d("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME,content:{type:d("WAMsgType").MSG_TYPE.DELETE_FOR_ME,externalId:e.id.externalId,thread:a.chatId,threadJid:e.id.chat,author:e.id.author,ack:e.ack}},deleteTs:g};break;default:return c("WAAssertUnreachable")(e.type)}return b.db.pendingStanzas.add(h).then(function(){})}))};b.get=function(a,b){b=h(a,b);return d("MAWDexieCastToPromise").dexieCastToPromise(this.db.pendingStanzas.get({externalIdWithType:b}).then(function(b){if(b==null)return null;var c=b.pendingContent;if(c.type===d("MAWDbPendingStanza").REVOKED){var e=c.content;if(e.threadJid==null)return null;e={deleteTs:b.deleteTs,externalId:a,stanza:{type:d("WAMsgType").MSG_TYPE.REVOKED,revokedExternalId:e.revokedExternalId,ts:e.ts,id:{externalId:e.externalId,chat:e.threadJid,author:e.author},ack:e.ack}};return e}else if(c.type===d("MAWDbPendingStanza").DELETE_FOR_ME){e=c.content;if(e.threadJid==null)return null;c={deleteTs:b.deleteTs,externalId:a,stanza:{type:d("WAMsgType").MSG_TYPE.DELETE_FOR_ME,id:{externalId:e.externalId,chat:e.threadJid,author:e.author},ack:e.ack}};return c}else return null}))};b["delete"]=function(a,b){var c=this;a=h(a,b);return d("MAWDexieCastToPromise").dexieCastToPromise(this.db.pendingStanzas.get({externalIdWithType:a}).then(function(a){return a?c.db.pendingStanzas["delete"](a.rowId):d("MAWDexieTable").dexieResolve()}))};return a}();a.tableLocks={pendingStanzas:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READONLY};function h(a,b){if(b===d("WAMsgType").MSG_TYPE.REVOKED)return a+"_"+d("MAWDbPendingStanza").PENDING_REVOKED;else if(b===d("WAMsgType").MSG_TYPE.DELETE_FOR_ME)return a+"_"+d("MAWDbPendingStanza").PENDING_DELETE_FOR_ME;else throw c("WAErr")("Unexpected pending stanza type: "+b)}g.MAWPendingStanzasStore=a},98);
__d("MAWPersonalSenderKeySessionsMetadataStore",["MAWDexieCastToPromise","MAWDexieTable","MAWTransactionMode","WAResultOrError"],function(a,b,c,d,e,f,g){"use strict";a=function(){function a(a){this.db=a}var b=a.prototype;b.create=function(a){a=a;return d("MAWDexieCastToPromise").dexieCastToPromise(this.db.personalSenderKeyStatuses.put(a).then(function(){return d("MAWDexieTable").dexieResolve()}))};b.get=function(a){return d("MAWDexieCastToPromise").dexieCastToPromise(this.db.personalSenderKeyStatuses.get(a)).then(function(a){if(a==null)return;return{groupJid:a.groupJid,senderKeyId:a.senderKeyId,needsSenderKey:a.needsSenderKey,rotateSenderKey:a.rotateSenderKey,senderKeyTs:a.senderKeyTs}})};b.bulkDeleteInGroup=function(a){return d("MAWDexieCastToPromise").dexieCastToPromise(this.db.personalSenderKeyStatuses["delete"](a))};b.update=function(a){return d("MAWDexieCastToPromise").dexieCastToPromise(this.db.personalSenderKeyStatuses.put(a).then(function(){return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeSuccess())}))};return a}();a.tableLocks={personalSenderKeyStatuses:d("MAWTransactionMode").READWRITE};g.MAWPersonalSenderKeySessionsMetadataStore=a},98);
__d("MAWReceiptsStore",["MAWDbMsgTxns","MAWDbParticipant","MAWDbParticipantTxns","MAWDexieCastToPromise","MAWDexieTable","MAWTransactionMode","Promise","WAJids","WAResultOrError","WATimeUtils","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";a=function(){function a(a){this.db=a}var c=a.prototype;c.get=function(a){var b=this;return d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWDexieTable").dexieAll([this.db.threads.get({jid:a.chat}),this.db.messages.where("externalId").equals(a.externalId).toArray()]).then(function(c){var e=c[0];c=c[1];if(e==null)return d("MAWDexieTable").dexieResolve(null);c=c.find(function(b){return b.thread===e.chatId&&b.author===a.author});return c==null?d("MAWDexieTable").dexieResolve(null):b.db.receipts.get(c.msgId).then(function(a){d("MAWDexieTable").dexieResolve(a)})}))};c.create=function(a){var b=this;return d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWDexieTable").dexieAll([this.db.threads.get({jid:a.id.chat}),this.db.messages.where("externalId").equals(a.id.externalId).toArray()]).then(function(c){var e=c[0];c=c[1];if(e==null)return d("WAResultOrError").makeError("missing_chat");c=c.find(function(b){return b.thread===e.chatId&&b.author===a.id.author});return c==null?d("WAResultOrError").makeError("missing_message"):b.db.receipts.put({msgId:c.msgId,statusTsPerUser:a.statusTsPerUser,permittedIdentitiesPerDevice:a.permittedIdentitiesPerDevice,recipientDevices:a.recipientDevices}).then(function(){return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeSuccess())})}))};c.update=function(a,c){var e=this,f,g,k,l,m,n,o,p;return b("regeneratorRuntime").async(function(q){while(1)switch(q.prev=q.next){case 0:q.next=2;return b("regeneratorRuntime").awrap(this.get(a.id));case 2:f=q.sent;if(!(f==null)){q.next=5;break}return q.abrupt("return",d("WAResultOrError").makeError("missing_receipt"));case 5:g=new Set();k=f.statusTsPerUser;l=f.permittedIdentitiesPerDevice;[{receiptType:"delivered",receivers:a.deliveryReceipts},{receiptType:"read",receivers:a.readReceipts}].forEach(function(a){var b=a.receiptType;a=a.receivers;a.forEach(function(a){var c=a.device;a=a.ts;var e=d("WAJids").extractUserJid(c),f=!1,j=k.get(e);if(j==null)return;a=h(j,b,a);k.set(e,a);f=i(j,a);j=l!=null?l["delete"](c):!1;(j||f)&&g.add(e)})});m=babelHelpers["extends"]({},f,{statusTsPerUser:k,permittedIdentitiesPerDevice:j(l)});q.next=12;return b("regeneratorRuntime").awrap(this.create(m));case 12:n=q.sent;if(n.success){q.next=15;break}return q.abrupt("return",n);case 15:o=[];m.statusTsPerUser.forEach(function(a,b){o.push(babelHelpers["extends"]({},a,{userJid:b}))});p=o.map(function(a){var b,g=a.deliveredTs!=null?c:d("WATimeUtils").castToUnixTime(0),h=a.readTs!=null?c:d("WATimeUtils").castToUnixTime(0),i=(b=a.readTs)!=null?b:d("WATimeUtils").castToUnixTime(0);return d("MAWDexieCastToPromise").dexieCastToPromise(e.db.threads.get({jid:f.id.chat})).then(function(b){if(b!=null)return d("MAWDbParticipantTxns").updateParticipantTimestamps(e.db,d("MAWDbParticipant").craftParticipantId(b.chatId,a.userJid),g,h,i)})});return q.abrupt("return",b("Promise").all(p).then(function(){return d("WAResultOrError").makeSuccess({type:g.size>0?"updated":"unchanged",receipt:m,affectedUserJids:g})}));case 19:case"end":return q.stop()}},null,this)};c.bulkDelete=function(a){var b=this;return d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWDbMsgTxns").getMsgsByProtocolMsgId(this.db,a).then(function(a){a=a.msgs;a=a.map(function(a){return a.msgId});return b.db.receipts.bulkDelete(a)}))};return a}();a.tableLocks={messages:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY,receipts:d("MAWTransactionMode").READWRITE};function h(a,b,c){var d=(a==null?void 0:a.deliveredTs)||c;a=a==null?void 0:a.readTs;b==="read"&&a==null&&(a=c);return{deliveredTs:d,readTs:a}}function i(a,b){return((b==null?void 0:b.deliveredTs)||0)>((a==null?void 0:a.deliveredTs)||0)||((b==null?void 0:b.readTs)||0)>((a==null?void 0:a.readTs)||0)}function j(a){return a==null||a.size===0?new Map():a}g.MAWReceiptsStore=a},98);
__d("MAWSenderKeySessionsStore",["MAWDexieCastToPromise","MAWDexieTable","MAWTransactionMode","SignalDbTypes","WAJids"],function(a,b,c,d,e,f,g){"use strict";a=function(){function a(a){this.db=a}var b=a.prototype;b.create=function(a){var b=d("WAJids").extractUserJid(a.deviceJid),c=d("WAJids").extractDeviceId(a.deviceJid),e=d("SignalDbTypes").buildSenderKeySessionId(a.groupJid,b,c);e={id:e,groupJid:a.groupJid,userJid:b,deviceId:c,record:a.record};return d("MAWDexieCastToPromise").dexieCastToPromise(this.db.senderKeySessions.put(e).then(function(){return d("MAWDexieTable").dexieResolve()}))};b.get=function(a,b){var c=d("WAJids").extractUserJid(b),e=d("WAJids").extractDeviceId(b);a=d("SignalDbTypes").buildSenderKeySessionId(a,c,e);return d("MAWDexieCastToPromise").dexieCastToPromise(this.db.senderKeySessions.get(a).then(function(a){if(a==null)return;return{groupJid:a.groupJid,deviceJid:b,record:a.record}}))};b.bulkDeleteInGroup=function(a){return d("MAWDexieCastToPromise").dexieCastToPromise(this.db.senderKeySessions.where("groupJid").equals(a)["delete"]()).then(function(){return void 0})};return a}();a.tableLocks={senderKeySessions:d("MAWTransactionMode").READWRITE};g.MAWSenderKeySessionsStore=a},98);
__d("MAWMakeTransactor",["MAWContactStore","MAWGroupInfoStore","MAWIndexedDb","MAWLLAMigrationUtils","MAWMediaStore","MAWMessageStore","MAWMetaInfoStore","MAWParticipantsStore","MAWPendingReceiptsStore","MAWPendingStanzasStore","MAWPersonalSenderKeySessionsMetadataStore","MAWReceiptsStore","MAWSenderKeySessionsStore","MAWTransactionMode","WAAssertUnreachable","dexie_alpha"],function(a,b,c,d,e,f,g){var h={ContactsStore:d("MAWContactStore").MAWContactsStore.tableLocks,GroupInfoStore:d("MAWGroupInfoStore").MAWGroupInfoStore.tableLocks,MediaStore:d("MAWMediaStore").MAWMediaStore.tableLocks,MessagesStore:d("MAWMessageStore").MAWMessageStore.tableLocks,MetaInfoStore:d("MAWMetaInfoStore").MAWMetaInfoStore.tableLocks,ParticipantsStore:d("MAWParticipantsStore").MAWParticipantsStore.tableLocks,PendingReceiptsStore:d("MAWPendingReceiptsStore").MAWPendingReceiptsStore.tableLocks,PendingStanzasStore:d("MAWPendingStanzasStore").MAWPendingStanzasStore.tableLocks,PersonalSenderKeySessionsMetadataStore:d("MAWPersonalSenderKeySessionsMetadataStore").MAWPersonalSenderKeySessionsMetadataStore.tableLocks,ReceiptsStore:d("MAWReceiptsStore").MAWReceiptsStore.tableLocks,SenderKeySessionsStore:d("MAWSenderKeySessionsStore").MAWSenderKeySessionsStore.tableLocks};a=function(a){return function(b){var e=b.reduce(function(a,b){b=h[b];b=Object.entries(b);for(var c=0;c<b.length;c++){var e=b[c],f=e[0];e=e[1];if(a[f]===d("MAWTransactionMode").READWRITE)continue;a[f]=e}return a},{});return function(f){var g=a!=null?d("MAWLLAMigrationUtils").getTransactorQPLParam(a,!0):[];g=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[e].concat(g))(function(a){for(var e=arguments.length,g=new Array(e>1?e-1:0),h=1;h<e;h++)g[h-1]=arguments[h];var i=b.reduce(function(b,e){switch(e){case"MessagesStore":return babelHelpers["extends"]({},b,{MessagesStore:new(d("MAWMessageStore").MAWMessageStore)(a)});case"ParticipantsStore":return babelHelpers["extends"]({},b,{ParticipantsStore:new(d("MAWParticipantsStore").MAWParticipantsStore)(a)});case"ContactsStore":return babelHelpers["extends"]({},b,{ContactsStore:new(d("MAWContactStore").MAWContactsStore)(a)});case"ReceiptsStore":return babelHelpers["extends"]({},b,{ReceiptsStore:new(d("MAWReceiptsStore").MAWReceiptsStore)(a)});case"GroupInfoStore":return babelHelpers["extends"]({},b,{GroupInfoStore:new(d("MAWGroupInfoStore").MAWGroupInfoStore)(a)});case"MetaInfoStore":return babelHelpers["extends"]({},b,{MetaInfoStore:new(d("MAWMetaInfoStore").MAWMetaInfoStore)(a)});case"SenderKeySessionsStore":return babelHelpers["extends"]({},b,{SenderKeySessionsStore:new(d("MAWSenderKeySessionsStore").MAWSenderKeySessionsStore)(a)});case"PersonalSenderKeySessionsMetadataStore":return babelHelpers["extends"]({},b,{PersonalSenderKeySessionsMetadataStore:new(d("MAWPersonalSenderKeySessionsMetadataStore").MAWPersonalSenderKeySessionsMetadataStore)(a)});case"MediaStore":return babelHelpers["extends"]({},b,{MediaStore:new(d("MAWMediaStore").MAWMediaStore)(a)});case"PendingStanzasStore":return babelHelpers["extends"]({},b,{PendingStanzasStore:new(d("MAWPendingStanzasStore").MAWPendingStanzasStore)(a)});case"PendingReceiptsStore":return babelHelpers["extends"]({},b,{PendingReceiptsStore:new(d("MAWPendingReceiptsStore").MAWPendingReceiptsStore)(a)});default:throw c("WAAssertUnreachable")(e)}},{});return new(c("dexie_alpha").Promise)(function(a){a(f.apply(void 0,[i].concat(g)))})});return g}}};b=a();g.makeQPLTransactor=a;g.makeTransactor=b},98);
__d("MAWPREListeners",["MAWQplProxy","WALogger","WAPREList","WAPREMetrics","qpl"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Received unreachable stage value for the event"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["The QPL event of "," was completed or failed already"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["The QPL event of "," was completed or failed already"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["The QPL event of "," was completed or failed already"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["WA PRE implementation sends duplicated instance ids on START stage"]);l=function(){return a};return a}function a(){d("WAPREMetrics").subscribe(n)}var m=new Map();function n(a){switch(a.name){case d("WAPREList").PRE_METRIC.SAVE_SIGNAL_SESSION_RETRIES:o(c("qpl")._(25309040,"8112"),a);break;case d("WAPREList").PRE_METRIC.FRANKING_VALIDATION:o(c("qpl")._(25299246,"150"),a);break;case d("WAPREList").PRE_METRIC.RETRY_RECEIPTS_SENT:o(c("qpl")._(25301644,"165"),a);break;case d("WAPREList").PRE_METRIC.QUERY_GROUPS:o(c("qpl")._(25304433,"6303"),a);break;case d("WAPREList").PRE_METRIC.QUERY_GROUP:o(c("qpl")._(25310326,"6339"),a);break;case d("WAPREList").PRE_METRIC.OFFLINE_RETRY:o(c("qpl")._(25309990,"124"),a);break;case d("WAPREList").PRE_METRIC.MEDIA_UPLOAD:o(c("qpl")._(25313100,"131"),a);break;case d("WAPREList").PRE_METRIC.GET_DEVICES:o(c("qpl")._(25307483,"127"),a);break;case d("WAPREList").PRE_METRIC.MESSAGE_DECRYPTION:o(c("qpl")._(25306682,"11176"),a);break;case d("WAPREList").PRE_METRIC.DECRYPT_MESSAGE_FINAL:o(c("qpl")._(25307464,"300"),a);break;case d("WAPREList").PRE_METRIC.MESSAGE_ENCRYPTION:o(c("qpl")._(25299294,"12933"),a);break;case d("WAPREList").PRE_METRIC.OFFLINE_QUEUE:o(c("qpl")._(25306361,"5664"),a);break;case d("WAPREList").PRE_METRIC.SAVE_SESSION_RETRIES:o(c("qpl")._(25309040,"8112"),a);break;case d("WAPREList").PRE_METRIC.SYNCD_FATAL_ERROR:o(c("qpl")._(25310891,"540"),a);break}}function o(a,b){switch(b.stage){case"START":if(m.has(b.instanceKey)){d("WALogger").ERROR(l());return}a=d("MAWQplProxy").startQplUserFlow(a,b.annotations);m.set(b.instanceKey,a);break;case"POINT":a=m.get(b.instanceKey);if(a==null){d("WALogger").WARN(k(),b.name);return}a.addPoint(b.reason);break;case"SUCCESS":a=m.get(b.instanceKey);if(a==null){d("WALogger").WARN(j(),b.name);return}a.endSuccess(b.annotations);m["delete"](b.instanceKey);break;case"FAIL":a=m.get(b.instanceKey);if(a==null){d("WALogger").WARN(i(),b.name);return}a.endFail(b.reason,b.annotations);m["delete"](b.instanceKey);break;default:d("WALogger").ERROR(h());break}}g.initializeWAPREMetrics=a},98);
__d("MAWDeleteOrphanedReactionsApi",["MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";var h=90*d("WATimeUtils").DAY_SECONDS;a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{reactions:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("deleteOrphanedReactions",!1)))(function(a){var b=d("WATimeUtils").unixTime();return a.reactions.filter(function(a){return a.reactToMsgId==null&&a.ts<b-h}).toArray().then(function(b){var c=b.map(function(a){return a.rowId});c=a.reactions.bulkDelete(c);return d("MAWDexieTable").dexieAll(c).then(function(){return d("MAWDexieTable").dexieResolve(b.length)})})});g.DELETE_ORPHANED_TIMESPAN=h;g.deleteOrphanedReactions=a},98);
__d("MAWPreKeysCleaner",["WACryptoManagerUtils","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";var h=60*d("WATimeUtils").DAY_SECONDS;function a(){return d("WACryptoManagerUtils").getPreKeyGenerationsTimestamps().then(function(a){a=i(a);if(a.length>0)return d("WACryptoManagerUtils").deletePreKeyGenerations(a)})}function i(a){var b=[];for(var c=0;c+2<a.length;++c)d("WATimeUtils").happenedWithin(a[c+2].timestamp,h)||b.push(a[c].id);return b}g.EXPIRATION_SECONDS=h;g.clearExpiredPreKeys=a},98);
__d("MAWTaskDefinitions",["MAWAbProps","MAWDbTasks","MAWDeleteOrphanedReactionsApi","MAWGating.re","MAWGlobals","MAWJobDefinitions","MAWPreKeysCleaner","MAWRotateCAT","Promise","WALogger","WATaskScheduler","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["rotateCAT skip first run"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["DeleteExpiredPreKeys skip first run"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["RotateKeyTask skip first run"]);j=function(){return a};return a}var k=27*d("WATimeUtils").DAY_SECONDS,l=7*d("WATimeUtils").DAY_SECONDS,m=d("WATimeUtils").DAY_SECONDS/2,n=Object.keys(d("MAWDbTasks").Tasks);function o(){return{scheduledTimeResolver:{get:function(a){return d("MAWGlobals").getDbImpls().getTaskScheduledTime(a)},set:function(a,b){return d("MAWGlobals").getDbImpls().setTaskScheduledTime(a,b)}}}}function a(){d("WATaskScheduler").startScheduler(o()),n.forEach(function(a){var b=p(a);d("WATaskScheduler").registerTask(a,b)})}function p(a){switch(a){case"rotateKey":return function(a){a?(d("WALogger").LOG(j()),a=b("Promise").resolve()):a=d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.rotateSignedPreKey());return a.then(function(){return k})};case"syncAbProps":return function(a){a=!a;return d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.syncAbProps(a)).then(function(){return d("MAWAbProps").getRefreshSecs()})};case"deleteExpiredKeys":return function(a){a?(d("WALogger").LOG(i()),a=b("Promise").resolve()):a=d("MAWPreKeysCleaner").clearExpiredPreKeys();return a.then(function(){return l})};case"rotateCAT":return function(a){a?(d("WALogger").LOG(h()),a=b("Promise").resolve()):a=d("MAWRotateCAT").tryRotateCAT();return a.then(function(){return m})};case"generatePrekeys":return function(a){a?a=d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.generateAndUploadPreKeys()):a=b("Promise").resolve();return a.then(function(){return d("WATimeUtils").DUMMY_UNIXTIME})};case"queryGroups":return function(a){var c=d("MAWGating.re").isOccamadillo()&&d("MAWGating.re").isOccamadilloInitSyncEnabled();a&&!c?a=d("MAWGlobals").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.queryGroups()):a=b("Promise").resolve();return a.then(function(){return d("WATimeUtils").DUMMY_UNIXTIME})};case"deleteOrphanedReactions":return function(){var a=d("MAWGating.re").isReactionsCleanerEnabled()?d("MAWDeleteOrphanedReactionsApi").deleteOrphanedReactions():b("Promise").resolve();return a.then(function(){return d("WATimeUtils").DAY_SECONDS})}}}g.ROTATE_SIGNED_PRE_KEY_TIMESPAN=k;g.DELETE_EXPIRED_KEYS_TIMESPAN=l;g.ROTATE_CAT_TIMESPAN=m;g.GENERATE_PRE_KEYS_TIMESPAN=d("WATimeUtils").DUMMY_UNIXTIME;g.QUERY_GROUPS_TIMESPAN=d("WATimeUtils").DUMMY_UNIXTIME;g.GENERATE_HMAC_KEY_TIMESPAN=d("WATimeUtils").DUMMY_UNIXTIME;g.DELETE_ORPHANED_REACTIONS_TIMESPAN=d("WATimeUtils").DAY_SECONDS;g.TASK_TYPES=n;g.getSchedulerOptions=o;g.registerTasks=a;g.getTaskExecution=p},98);
__d("MAWBackend",["MAWAbProps","MAWCommsConfig","MAWDebug","MAWDebugDefineFunctions","MAWDefinePersistedJob","MAWDeleteForMeMsgContentCleaner","MAWEphemeralCleaner","MAWGating.re","MAWGlobals","MAWHandleStanza","MAWJobHandlers","MAWMakeTransactor","MAWPREListeners","MAWPendingStanzaCleaner","MAWQplProxy","MAWTaskDefinitions","MAWUnsendMsgContentCleaner","Promise","WAArrayBufferUtils","WAComms","WACryptoCurve25519","WACryptoCurve25519Dependencies","WACryptoManagerUtils","WADebugTools","WAGlobals","WAGzip","WAInfoStore","WALogger","WAPersistedJobManager","WAResolvable","WASendChatState","WASendPing","WASendPresenceStatus","WASendPresenceSubscription","WATimeUtils","WATransactions","WAUploadMedia","gkx","promiseDone","qpl","regeneratorRuntime"],function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["deviceJid: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["initWAInfra"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["ensureWaInfo: set WA_INFO"]);j=function(){return a};return a}b("MAWDebug");function k(a){return b("Promise").resolve(d("WAGzip").inflate(a))}function l(){return d("WAInfoStore").WA_INFO.isDefined()?b("Promise").resolve():new(d("WACryptoCurve25519").Curve25519)(d("WACryptoCurve25519Dependencies").CURVE25519_SIGNAL_DEPENDENCIES).keyPair.then(function(a){var b=new Uint8Array(24);self.crypto.getRandomValues(b);d("WAInfoStore").WA_INFO.set({recoveryToken:b.buffer,staticKeyPair:a});d("WALogger").LOG(j())})}function a(a,e,f,g,j){var m,n,o,p,q,r,s;return b("regeneratorRuntime").async(function(t){while(1)switch(t.prev=t.next){case 0:d("WALogger").LOG(i());d("WALogger").LOG(h(),a.deviceJid);m=new(d("WAResolvable").Resolvable)();n=new(d("WAPersistedJobManager").PersistedJobManager)({accessors:g.jobPersistenceAccessors,unfinishedJobEntries:m.promise.then(function(){return g.loadAllJobs()}),isRestartAfterCrash:!1,listeners:{onJobStarted:function(){},onJobFinished:function(){return null}},deprecatedJobs:{}});o=d("WACryptoManagerUtils").createCryptoManager(g.crypto);p=d("WATransactions").createTransactions(d("MAWMakeTransactor").makeQPLTransactor);d("MAWGlobals").setGlobals({myJids:{deviceJid:a.deviceJid,userJid:a.userJid},fbCat:d("WAArrayBufferUtils").stringToArrayBuffer(a.fbCat),db:g.dbCallbacks,jobResultConverter:g.jobResultConverters,persistedJobs:{api:g.persistedJobs,manager:n},jidUtils:g.jidUtils,hmacKey:e,transactions:p,crypto:o,config:j});d("MAWDefinePersistedJob").setMsgrJobImplementations(d("MAWJobHandlers").getJobHandlers());c("promiseDone")(m.promise.then(function(){return d("MAWTaskDefinitions").registerTasks()}));f.setHandlers("backend",babelHelpers["extends"]({},g.bridgeHandlers,{runJob:function(a){var b=a.id;return m.promise.then(function(){return n.loadAndRunJobFromId(b)})},uploadMedia:d("WAUploadMedia").uploadMedia,sendChatState:d("WASendChatState").sendChatState,sendPresenceSubscription:d("WASendPresenceSubscription").sendPresenceSubscription}));d("MAWPREListeners").initializeWAPREMetrics();if(!d("WAGlobals").getConfig().transactions.getClockSkew){t.next=17;break}t.next=14;return b("regeneratorRuntime").awrap(d("WAGlobals").getTransactions().getClockSkew());case 14:t.t0=t.sent;t.next=20;break;case 17:t.next=19;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().getClockSkew());case 19:t.t0=t.sent;case 20:q=t.t0;r=q.clockSkew;d("WATimeUtils").setClockSkew(r);d("MAWEphemeralCleaner").startEphemeralCleaner({getNextTs:g.dbCallbacks.getNextExpirationTs,removeExpired:g.dbCallbacks.removeExpiredMsgsFromUI,purgeEnabled:d("MAWGating.re").isEphemeralMessagesEnabled},{getNextTs:g.dbCallbacks.getNextDeletionTs,removeExpired:j.transactions.deleteExpiredMsgs?p.deleteExpiredMsgs:g.dbCallbacks.deleteExpiredMsgs,purgeEnabled:d("MAWGating.re").isEphemeralMessagesEnabled});d("MAWUnsendMsgContentCleaner").startUnsendMsgContentCleaner({getNextTs:g.dbCallbacks.getNextDeleteUnsendContentTs,removeExpired:g.dbCallbacks.removeExpiredUnsendMsgsContent,purgeEnabled:d("MAWGating.re").isUnsendGlobalEnabled});d("MAWDeleteForMeMsgContentCleaner").startDeleteForMeMsgContentCleaner({getNextTs:g.dbCallbacks.getNextDeleteDFMContentTs,removeExpired:g.dbCallbacks.removeExpiredDFMMsgsContent,purgeEnabled:d("MAWGating.re").isUnsendLocallyEnabled});d("MAWPendingStanzaCleaner").startPendingStanzaCleaner({getNextTs:g.dbCallbacks.getNextDeletePendingStanzaTs,removeExpired:g.dbCallbacks.removeExpiredPendingStanzas,purgeEnabled:d("MAWGating.re").isUnsendLocallyEnabled||d("MAWGating.re").isUnsendGlobalEnabled});t.next=29;return b("regeneratorRuntime").awrap(d("MAWAbProps").initAbProps());case 29:c("gkx")("5421")&&d("WADebugTools").initDebugFunctions(d("MAWDebugDefineFunctions").getAllDebugFunctions());s=null;return t.abrupt("return",l().then(function(){var a;return b("regeneratorRuntime").async(function(e){while(1)switch(e.prev=e.next){case 0:e.next=2;return b("regeneratorRuntime").awrap(d("MAWCommsConfig").getCommsConfig({onOptimisticConnectionChange:function(a){a==="connected"?(d("WASendPresenceStatus").sendPresenceStatus({status:"available"}),s!=null&&(s.endSuccess(),s=null)):a==="disconnected"&&(d("WASendPresenceStatus").sendPresenceStatus({status:"unavailable"}),s!=null&&(s.endFail("disconnected"),s=null))}}));case 2:a=e.sent,s=d("MAWQplProxy").startQplUserFlow(c("qpl")._(25312111,"2151")),d("WAComms").startComms(d("MAWHandleStanza").handleStanza,d("WASendPing").sendPing,a,k);case 5:case"end":return e.stop()}},null,this)}).then(function(){return m.resolve()}));case 32:case"end":return t.stop()}},null,this)}g.startWABackend=a},98);
__d("MAWFTS",["FBLogger","MAWBackendBridge.re","MAWBridgeTypes","MAWDataSyncQueue","MAWDexieTable","MAWGating.re","MAWIndexedDb","MAWTransactionMode","MAWVault","Promise","WAGlobals","WALogger","WAMsgType","gkx","minisearch","regeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error fetching participants ",""]);h=function(){return a};return a}var i=1e4,j=new(c("minisearch"))({fields:["content"],searchOptions:{prefix:!0,fuzzy:.2}}),k=new Set(["contacts","groupInfo","messages","participants"]),l=new Map(),m=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY,groupInfo:d("MAWTransactionMode").READONLY,contacts:d("MAWTransactionMode").READONLY,participants:d("MAWTransactionMode").READONLY,ftsBackloggedMessages:d("MAWTransactionMode").READWRITE}),n=c("gkx")("4164");function o(a){var b=l.get(a);b&&(j.remove(b),l["delete"](a))}function p(a){l.set(a.id,a),j.add(a)}function q(a,b){return a+":"+b}function r(a){var b=a.name;if(b==null)return;b={id:q("groupInfo",a.groupJid),content:b,raw:a,type:"DbGroupInfo"};p(b)}function s(a,b){var c;c=(c=a.nickname)!=null?c:b==null?void 0:b.nameForSearch;if(c==null||a.userJid===d("WAGlobals").getMyUserJid())return;b={id:q("participants",a.id),content:c,raw:a,type:"DbParticipant"};p(b)}function t(a){switch(a.type){case d("WAMsgType").TEXT:a={id:q("messages",a.rowId),content:d("MAWVault").unvault(a.msgContent.content),raw:a,type:"DbMsg"};p(a);return;default:return}}function u(a){if(a.nameForSearch==null)return;var b=a.nameForSearch;b={id:q("contacts",a.contactJid),content:b,raw:a,type:"DbContact"};p(b)}var v=m((function(a,b){var c=q(b.tableName,b.key);switch(b.tableName){case"contacts":if(n!==!0)return a.contacts.get(b.key).then(function(a){o(c);if(a==null)return;u(a)});break;case"groupInfo":return a.groupInfo.get(b.key).then(function(a){o(c);if(a==null)return;r(a)});case"messages":return a.messages.get(b.key).then(function(a){o(c);if(a==null)return;t(a)});case"participants":return a.participants.get(b.key).then(function(b){if((b==null?void 0:b.userJid)==null)return;return a.contacts.get(b==null?void 0:b.userJid).then(function(a){o(c);if(b==null)return;s(b,a)})})}return d("MAWDexieTable").dexieResolve()})),w=m((function(a,b,c){var e=c==null?void 0:c.values;return c.tableName!=="messages"||b!=="put"&&b!=="add"||e==null?d("MAWDexieTable").dexieResolve():a.ftsBackloggedMessages.bulkPut(e.map(function(a){if(typeof a!=="object")return;a=a==null?void 0:a.rowId;if(a==null||typeof a!=="number")return;return{rowId:a}}).filter(Boolean))})),x=m((function(a,b,c){return c.tableName!=="messages"||b==="delete"||typeof c.key!=="number"?d("MAWDexieTable").dexieResolve():a.ftsBackloggedMessages["delete"](c.key)})),y=function(a,c){return b("regeneratorRuntime").async(function(d){while(1)switch(d.prev=d.next){case 0:if(k.has(c.tableName)){d.next=2;break}return d.abrupt("return",b("Promise").resolve());case 2:d.next=4;return b("regeneratorRuntime").awrap(v(c));case 4:d.next=6;return b("regeneratorRuntime").awrap(x(a,c));case 6:d.next=8;return b("regeneratorRuntime").awrap(w(a,c));case 8:case"end":return d.stop()}},null,this)},z=m((function(a){var b=[a.groupInfo.toCollection().reverse().each(r),a.messages.toCollection().reverse().limit(i).each(t),a.participants.toCollection().each(function(b){if(b==null)return;a.contacts.get(b==null?void 0:b.userJid).then(function(a){return s(b,a)})["catch"](function(a){d("WALogger").ERROR(h(),a)})}),n!==!0&&a.contacts.toCollection().each(u)].filter(Boolean);return d("MAWDexieTable").dexieAll(b).then(function(){})}));function a(){if(!d("MAWGating.re").isSearchEnabled())return b("Promise").resolve();d("MAWDataSyncQueue").registerDataSyncCallback(y);return z()["catch"](function(a){c("FBLogger")("messenger_e2ee_web").catching(a).mustfix("Error paging results from MAWDB for FTS, searching messages will not work this session")})}function e(a){a=a.search;return!d("MAWGating.re").isSearchEnabled()?[]:j.search(a).map(function(a){a=a.id;a=l.get(a);if(a==null)return;switch(a.type){case"DbGroupInfo":return d("MAWBackendBridge.re").bridgeGroupInfo(d("MAWBridgeTypes").createBridgeGroupInfo(a.raw));case"DbMsg":if(!d("MAWGating.re").isContentSearchEnabled())return;return d("MAWBackendBridge.re").bridgeMsg(d("MAWBridgeTypes").createBridgeMsg(a.raw));case"DbContact":return d("MAWBackendBridge.re").bridgeContact(d("MAWBridgeTypes").createBridgeContact(a.raw));case"DbParticipant":return d("MAWBackendBridge.re").bridgeParticipant(d("MAWBridgeTypes").createBridgeParticipant(a.raw));default:a.type}}).filter(Boolean)}function f(){j.removeAll(),l.clear()}g.initFTSSync=a;g.search=e;g.clearFTS_FOR_TESTING_DO_NOT_USE=f}),98);
__d("MAWGetAppDataApi",["MAWAckLevel.re","MAWIndexedDb","MAWTransactionMode"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor({appData:d("MAWTransactionMode").READONLY})(function(a,b){return a.appData.get({externalId:b}).then(function(a){if(a==null)return{type:"missing"};else if(a.ack>=d("MAWAckLevel.re").ACK.sent)return{type:"already_sent",appData:a.contents,permittedIdentitiesPerDevice:a.permittedIdentitiesPerDevice};else return{type:"not_sent",appData:a.contents,permittedIdentitiesPerDevice:a.permittedIdentitiesPerDevice}})});g.getAppData=a},98);
__d("MAWGetAppDataForResendApi",["MAWDbIdentityTxns","MAWGlobals","MAWIndexedDb","MAWTransactionMode","MAWUpdateDevicesForUserApi"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor({appData:d("MAWTransactionMode").READWRITE,identity:d("MAWTransactionMode").READONLY})(function(a,b){return a.appData.get({externalId:b}).then(function(b){return b==null?{type:"missing"}:d("MAWUpdateDevicesForUserApi").getAllDeviceJidsForUser(a,d("MAWGlobals").getMyUserJid()).then(function(a){var c=d("MAWGlobals").getMyDeviceJid();return a.filter(function(a){return c!==a&&!b.recipientDevices.has(a)&&!b.permittedIdentitiesPerDevice.has(a)})}).then(function(b){return d("MAWDbIdentityTxns").getIdentitiesForDevices(a,b)}).then(function(c){if(c.size===0)return{type:"already_sent",appData:b.contents,permittedIdentitiesPerDevice:c};var d=new Map([].concat(Array.from(b.permittedIdentitiesPerDevice),Array.from(c))),e=new Set([].concat(Array.from(b.recipientDevices),Array.from(d.keys())));return a.appData.update(b.appDataId,{permittedIdentitiesPerDevice:d,recipientDevices:e}).then(function(){return{type:"not_sent",appData:b.contents,permittedIdentitiesPerDevice:c}})})})});g.getAppDataForResend=a},98);
__d("MAWGetAppDataForRetryApi",["MAWIndexedDb","MAWTransactionMode","WATimeUtils"],function(a,b,c,d,e,f,g){var h=30*d("WATimeUtils").DAY_SECONDS;a=d("MAWIndexedDb").makeMsgrTransactor({appData:d("MAWTransactionMode").READONLY})(function(a,b,c){return a.appData.get({externalId:b}).then(function(a){if(a==null)return{type:"missing"};var b=a.permittedIdentitiesPerDevice.get(c);return b==null||!d("WATimeUtils").happenedWithin(a.ts,h)?{type:"unauthorized"}:{type:"unacked",appData:a.contents,permittedIdentitiesPerDevice:a.permittedIdentitiesPerDevice,deviceIdentity:b}})});g.getAppDataForRetry=a},98);
__d("MAWHandleEncryptedBackupsSecretsApi",["MAWDbHistorySyncQRCodeData","MAWIndexedDb","MAWTransactionMode"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor({historySyncQRCodeData:d("MAWTransactionMode").READWRITE})(function(a,b){var c=b.backupId,e=b.serverDataId,f=b.tempOcmfClientState,g=b.mailboxRootKey,i=b.obliviousValidationToken,j=b.epoch;return a.historySyncQRCodeData.get(d("MAWDbHistorySyncQRCodeData").qrCodeRowId).then(function(b){if(!(b==null?void 0:b.isQRScanned))return a.historySyncQRCodeData.put({rowId:d("MAWDbHistorySyncQRCodeData").qrCodeRowId,isQRScanned:!0}).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"CallFinishAddDevice",value:{backupId:c.toString(),serverDataId:e.toString(),tempOcmfClientState:f,mailboxRootKey:g,obliviousValidationToken:i,epoch:h(j)}});return})["catch"](function(b){return a.historySyncQRCodeData.put({rowId:d("MAWDbHistorySyncQRCodeData").qrCodeRowId,isQRScanned:!1}).then(function(){})})})});function h(a){return a.map(function(a){var b=a.id,c=a.anonId,d=a.rootKey;a=a.status;return{epoch_id:b.toString(),epoch_anon_id:c,epoch_root_key:d,epoch_status:a.toString()}})}g.handleEncryptedBackupsSecret=a},98);
__d("MAWMarkAppDataDroppedApi",["MAWIndexedDb","MAWTransactionMode"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor({appData:d("MAWTransactionMode").READWRITE})(function(a,b){return a.appData.get({externalId:b}).then(function(b){if(b!=null)return a.appData["delete"](b.appDataId)})});g.markAppDataDropped=a},98);
__d("MAWMarkAppDataSendFailedApi",["MAWIndexedDb","MAWTransactionMode"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor({appData:d("MAWTransactionMode").READWRITE})(function(a,b){return a.appData.where("externalId").equals(b)["delete"]().then(function(){})});g.markAppDataSendFailed=a},98);
__d("MAWMarkAppDataSentApi",["MAWAckLevel.re","MAWDbAppDataTxns","MAWIndexedDb","MAWTransactionMode"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor({appData:d("MAWTransactionMode").READWRITE})(function(a,b){return d("MAWDbAppDataTxns").updateAppDataSystemAck(a,b,d("MAWAckLevel.re").ACK.sent).then(function(){})});g.markAppDataSent=a},98);
__d("MAWWriteAppDataReceiptsApi",["MAWDexieTable","MAWIndexedDb","MAWTransactionMode"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({appData:d("MAWTransactionMode").READWRITE})(function(a,b,c){return h(a,b,c)});function h(a,b,c){return d("MAWDexieTable").dexieAll(b.map(function(b){return i(a,b,c)})).then(function(){})}function i(a,b,c){return a.appData.get({externalId:b}).then(function(b){if(b==null)return;var d=b.permittedIdentitiesPerDevice;for(var e=0;e<c.length;e++){var f=c[e];d["delete"](f)}if(d.size===0)return a.appData["delete"](b.appDataId).then(function(){});else return a.appData.update(b.appDataId,{permittedIdentitiesPerDevice:d}).then(function(){})})}g.writeAppDataReceipts=a;g.writeAppDataReceiptsInternal=h},98);
__d("MAWWriteAppDataRetryApi",["MAWIndexedDb","MAWTransactionMode"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor({appData:d("MAWTransactionMode").READWRITE})(function(a,b,c,d){return a.appData.get({externalId:b}).then(function(b){if(b==null)return;var e=b.permittedIdentitiesPerDevice,f=e.get(c);if(f==null)return;f.baseKey=d;e.set(c,f);return a.appData.update(b.appDataId,{permittedIdentitiesPerDevice:e}).then(function(){})})});g.writeAppDataRetry=a},98);
__d("MAWWriteMetaSyncsApi",["MAWDexieTable","MAWIndexedDb","MAWTransactionMode","MAWWriteMetaSyncsTxns"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({threads:d("MAWTransactionMode").READWRITE,participants:d("MAWTransactionMode").READWRITE,groupInfo:d("MAWTransactionMode").READWRITE,messages:d("MAWTransactionMode").READWRITE,media:d("MAWTransactionMode").READWRITE,chunk:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READONLY,unrenderedMessages:d("MAWTransactionMode").READWRITE,pendingStanzas:d("MAWTransactionMode").READWRITE,receipts:d("MAWTransactionMode").READWRITE,reactions:d("MAWTransactionMode").READWRITE})(function(a,b){return d("MAWDexieTable").dexieAll(b.map(function(b){return d("MAWWriteMetaSyncsTxns").handleMetaSyncAction(a,b)})).then(function(){})});g.writeMetaSyncs=a},98);
__d("MAWWriteOutgoingAppDataApi",["MAWAckLevel.re","MAWBridge","MAWDbIdentityTxns","MAWDexieTable","MAWIndexedDb","MAWThreadTypes","MAWTransactionMode","MAWUpdateDevicesForUserApi","MAWWriteMetaSyncsTxns","WAGlobals","WAOdsEnums"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor(babelHelpers["extends"]({appData:d("MAWTransactionMode").READWRITE,identity:d("MAWTransactionMode").READONLY},d("MAWThreadTypes").ThreadRelatedTablesPermissions))(function(a,b,c,e){return a.appData.get({externalId:b}).then(function(f){if(f!=null)if(f.ack>=d("MAWAckLevel.re").ACK.sent)return d("MAWDexieTable").dexieResolve({type:"already_sent",appDataExternalId:b});else return d("MAWDexieTable").dexieResolve({type:"not_sent",appDataExternalId:b});e.contents.type==="meta_sync"?f=d("MAWDexieTable").dexieAll(e.contents.actions.map(function(b){b.messageAction&&b.messageAction.type==="delete_for_me"&&d("MAWBridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:d("WAOdsEnums").Entity.C2C_META_SYNC,key:"delete_for_me"});return d("MAWWriteMetaSyncsTxns").handleMetaSyncAction(a,b)})):(e.contents.type,f=d("MAWDexieTable").dexieResolve([]));return d("MAWDexieTable").dexieAll([d("MAWUpdateDevicesForUserApi").getAllDeviceJidsForUser(a,d("WAGlobals").getMyUserJid()),f]).then(function(b){b=b[0];return d("MAWDbIdentityTxns").getIdentitiesForDevices(a,b)}).then(function(f){var g=d("WAGlobals").getMyDeviceJid();f["delete"](g);return f.size===0?{type:"no_devices"}:a.appData.add(babelHelpers["extends"]({externalId:b,ts:c},e,{permittedIdentitiesPerDevice:f,recipientDevices:new Set(f.keys()),ack:d("MAWAckLevel.re").ACK.clock})).then(function(){return{type:"not_sent",appDataExternalId:b}})})})});g.writeOutgoingAppData=a},98);
__d("MAWArchiveThreadApi",["MAWDbThreadTxns","MAWIndexedDb","MAWTransactionMode"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor({threads:d("MAWTransactionMode").READWRITE})(function(a,b){return d("MAWDbThreadTxns").archiveThreads(a,[b],!1).then(function(){})});g.archiveThread=a},98);
__d("MAWBackfillThreadsForOccamadilloApi",["MAWBridgeTypes","MAWDbAppMeta","MAWDexieTable","MAWIndexedDb","MAWTransactionMode","WALogger"],function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[Occamadillo] Backfilled "," threads"]);h=function(){return a};return a}a=d("MAWIndexedDb").makeMsgrTransactor({appMeta:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READONLY})(function(a){return a.appMeta.get(d("MAWDbAppMeta").AppMetaKeysEnum.isBackfilledForOccamadillo).then(function(b){return(b==null?void 0:b.value.isBackfilledForOccamadillo)===!0?d("MAWDexieTable").dexieResolve():a.threads.toArray().then(function(b){b.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:d("MAWBridgeTypes").createBridgeThread(a)})});return a.appMeta.put({key:d("MAWDbAppMeta").AppMetaKeysEnum.isBackfilledForOccamadillo,value:{isBackfilledForOccamadillo:!0}}).then(function(){d("WALogger").LOG(h(),b.length)})})})});g.backfillThreadsForOccamadillo=a},98);
__d("MAWChangeSecurityAlertSettingApi",["MAWDbMsgTypeVersionTxns","MAWIndexedDb","MAWTransactionMode"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor({appMeta:d("MAWTransactionMode").READWRITE})(function(a,b){return d("MAWDbMsgTypeVersionTxns").updateSecurityAlertValue(a,b)});g.changeSecurityAlertSetting=a},98);
__d("MAWCreateThreadApi",["MAWIndexedDb","MAWJids","MAWThreadManagementTxns","MAWTransactionMode"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor({threads:d("MAWTransactionMode").READWRITE,participants:d("MAWTransactionMode").READWRITE,messages:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READONLY,groupInfo:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY})(function(a,b,c){return d("MAWThreadManagementTxns").getOrSetupOneToOneThread(a,d("MAWJids").toUserJid(b),null,c).then(function(a){return{chatId:a.chatId,jid:a.jid}})});g.createThread=a},98);
__d("MAWCreateThreadByJidApi",["MAWDbParticipantTxns","MAWDbThreadTxns","MAWGlobals","MAWGroupManagementTxns","MAWIndexedDb","MAWJids","MAWLoadThreadsTxns","MAWThreadManagementTxns","MAWTransactionMode","WAJids","WAResultOrError","WATimeUtils","err"],function(a,b,c,d,e,f,g){a=d("MAWGlobals").getJidUtilsApi();var h=a.toUserJid;function i(a,b,c){var e=b.participantContacts.map(function(a){return d("WAResultOrError").makeSuccess({user:h(a.fbid),type:a.participantType,addressable:a.waAddressable})});return{jid:a,creationTs:c,subject:{content:b.threadName},participants:e}}function j(a,b,e,f,g){return d("MAWDbParticipantTxns").getParticipantsInThread(a,b.chatId).then(function(h){h=h.map(function(a){return{fbid:d("MAWJids").userIdFromJid(a.userJid),participantType:a.type,waAddressable:a.addressable=!0}});e.participantContacts=h;h=i(f,e,g);return d("MAWGroupManagementTxns").createGroupInternal(a,h,"queried",g,null,null,!0).then(function(e){if(e==null)throw c("err")("Chat jid should not be null");d("MAWLoadThreadsTxns").loadContentsForThreads(a,[b],10)})})}function k(a,b,e,f){e=i(e,b,f);return d("MAWGroupManagementTxns").createGroupInternal(a,e,"queried",f,null,null,!0).then(function(b){if(b==null)throw c("err")("Chat jid should not be null");return d("MAWDbThreadTxns").getThreadByJid(a,b).then(function(b){if(!b.success)throw c("err")("DB thread should not be null");d("MAWLoadThreadsTxns").loadContentsForThreads(a,[b.value],10)})})}b=d("MAWIndexedDb").makeMsgrTransactor({contacts:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE,reactions:d("MAWTransactionMode").READONLY,participants:d("MAWTransactionMode").READWRITE,groupInfo:d("MAWTransactionMode").READWRITE,personalSenderKeyStatuses:d("MAWTransactionMode").READWRITE,chunk:d("MAWTransactionMode").READWRITE,media:d("MAWTransactionMode").READWRITE})(function(a,b){var e=b.chatJid,f=b.groupInfo;b=b.lastActivityTimestampMs;var g=d("WATimeUtils").castToUnixTime(b/1e3);return d("WAJids").switchOnMsgrChatJidType(e,{user:function(b){return d("MAWThreadManagementTxns").getOrSetupOneToOneThread(a,b,null,null,g,!0).then(function(b){d("MAWLoadThreadsTxns").loadContentsForThreads(a,[b],10)})},group:function(b){if(f==null)throw c("err")("Expected groupInfo to not be null");return d("MAWDbThreadTxns").getThreadByJid(a,e).then(function(c){if(c.success)return j(a,c.value,f,b,g);else return k(a,f,b,g)})}})});g.createThreadByJid=b},98);
__d("MAWDeleteThreadApi",["MAWIndexedDb","MAWThreadManagementTxns","MAWTransactionMode","WALogger","err"],function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Successfully deleted thread ",""]);h=function(){return a};return a}a=d("MAWIndexedDb").makeMsgrTransactor({chunk:d("MAWTransactionMode").READWRITE,media:d("MAWTransactionMode").READWRITE,messages:d("MAWTransactionMode").READWRITE,participants:d("MAWTransactionMode").READWRITE,receipts:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READONLY,groupInfo:d("MAWTransactionMode").READWRITE,unrenderedMessages:d("MAWTransactionMode").READWRITE,pendingStanzas:d("MAWTransactionMode").READWRITE,reactions:d("MAWTransactionMode").READWRITE,senderKeySessions:d("MAWTransactionMode").READWRITE,personalSenderKeyStatuses:d("MAWTransactionMode").READWRITE})(function(a,b){return a.threads.get(b).then(function(e){if(e==null)throw c("err")("There was no thread to delete in local delete thread");return d("MAWThreadManagementTxns").deleteAllThreadData(a,e).then(function(){d("WALogger").LOG(h(),b)})})});g.deleteThread=a},98);
__d("MAWFetchExistingThreadApi",["MAWIndexedDb","MAWLoadThreadsTxns","MAWTransactionMode"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({contacts:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY,groupInfo:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READONLY,participants:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READONLY})(function(a,b){b=b.threadId;return a.threads.get(b).then(function(b){b!=null&&d("MAWLoadThreadsTxns").loadContentsForThreads(a,[b],10)})});g.fetchExistingThread=a},98);
__d("MAWFetchExistingThreadForContactApi",["MAWIndexedDb","MAWLoadThreadsTxns","MAWTransactionMode"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({contacts:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY,groupInfo:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READONLY,participants:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READONLY})(function(a,b){var c=b.userJid,e=b.offlineThreadingId;return a.threads.get({jid:c}).then(function(b){if(b==null)return;d("MAWLoadThreadsTxns").loadContentsForThreads(a,[b],10,new Map([[b.jid,e]]))})});g.fetchExistingThreadForContact=a},98);
__d("MAWMediaDownloadManager",[],function(a,b,c,d,e,f){var g=new Map(),h=[],i=1e4;function a(a,b){k(),g.set(a,b),h.push(a)}function b(a){return g.get(a)}function c(a){g["delete"](a);var b=h.filter(function(b){return b!==a});j(b)}function j(a){h=a}function k(){if(h.length>=i){var a=h.shift();g["delete"](a)}}f.setToMediaDownloadManager=a;f.getFromMediaDownloadManager=b;f.removeFromMediaDownloadManager=c},66);
__d("MAWGetBlobDataUrlByMediaIdApi",["FBLogger","MAWIndexedDb","MAWMaybeWithTimeout","MAWMediaDownloadManager","MAWTimedJob","MAWTransactionMode","Promise","WALogger"],function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["getBlobDataUrlByMediaIdDbCall cannot find chunk with mediaId: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["getBlobDataUrlByMediaIdDbCall cannot find media with mediaId: ",""]);i=function(){return a};return a}a=function(a){return j(a).then(function(e){if(e==null)return d("MAWMaybeWithTimeout").maybeWithTimeout(new(b("Promise"))(function(b){d("MAWMediaDownloadManager").setToMediaDownloadManager(a,b)}).then(function(a){return a}),d("MAWTimedJob").DEFAULT_TIMEOUT_MS,function(){throw c("FBLogger")("messenger_e2ee_web").mustfixThrow("Failed to getBlobDataUrlByMediaId in time")});else return e})};var j=d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READONLY})(function(a,b){return a.media.get(b).then(function(c){if(c==null){d("WALogger").ERROR(i(),b);return}return a.chunk.where("hashedPlaintextHash").equals(c.hashedPlaintextHash).first().then(function(a){if(a==null){d("WALogger").ERROR(h(),b);return}return new Blob([a.blobData],{type:a.mimetype})})})});g.getBlobDataUrlByMediaId=a},98);
__d("MAWGetBlobDataUrlByXMAIdApi",["MAWGetBlobDataUrlByMediaIdApi","MAWIndexedDb","MAWTransactionMode","WALogger","regeneratorRuntime"],function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["getMediaIdByXMAIdDbCall does not have valid information type - ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["getMediaIdByXMAIdDbCall cannot find xma with xmaId "," and info type ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["getBlobDataUrlByXMAId cannot find xma chunk with mediaId "," and info type ",""]);j=function(){return a};return a}a=function(a,c){var e;return b("regeneratorRuntime").async(function(f){while(1)switch(f.prev=f.next){case 0:f.next=2;return b("regeneratorRuntime").awrap(k(a,c));case 2:e=f.sent;if(!(e==null)){f.next=6;break}d("WALogger").WARN(j(),e,c);return f.abrupt("return");case 6:return f.abrupt("return",d("MAWGetBlobDataUrlByMediaIdApi").getBlobDataUrlByMediaId(e));case 7:case"end":return f.stop()}},null,this)};var k=d("MAWIndexedDb").makeMsgrTransactor({xma:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READONLY})(function(a,b,c){return a.xma.get(b).then(function(a){if(a==null){d("WALogger").ERROR(i(),b,c);return}var e;switch(c){case"preview":e=a.defaultPreviewMediaId;break;case"header":e=a.headerMediaId;break;case"favicon":e=a.faviconMediaId;break;default:d("WALogger").ERROR(h(),c);return}return e})});g.getBlobDataUrlByXMAId=a},98);
__d("MAWGetCurrentUserDeviceInfo",["MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","SignalDbTypes","WASignalKeys","err"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{meta:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getCurrentUserDeviceInfo",!1)))(function(a){return a.meta.bulkGet([d("SignalDbTypes").MetaKeysEnum.deviceId,d("SignalDbTypes").MetaKeysEnum.identityKeyPair]).then(function(a){var b=a[0];a=a[1];b=b==null?void 0:b.value.deviceId;a=a==null?void 0:a.value.identityKeyPair;if(b==null||a==null)throw c("err")("DeviceId or IdentityKey was null");a=d("WASignalKeys").serializePubKey(a);return{deviceId:b,identityKey:a}})});g.getCurrentUserDeviceInfo=a},98);
__d("MAWGetGroupSuperAdminApi",["MAWIndexedDb","MAWTransactionMode","WAJids"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor({participants:d("MAWTransactionMode").READONLY})(function(a,b){return a.participants.where("threadId").equals(b).filter(function(a){return a.type==="superadmin"}).first().then(function(a){if(a)return d("WAJids").extractUserId(a.userJid);else return null})});g.getGroupSuperAdmin=a},98);
__d("MAWGetIdentityKeys",["MAWIndexedDb","MAWTransactionMode","SignalDbTypes","WASignalKeys","err"],function(a,b,c,d,e,f,g){var h="IdentityKey was null";a=d("MAWIndexedDb").makeMsgrTransactor({meta:d("MAWTransactionMode").READONLY})(function(a){return a.meta.get(d("SignalDbTypes").MetaKeysEnum.identityKeyPair).then(function(a){a=a==null?void 0:a.value.identityKeyPair;if(a==null)throw c("err")(h);var b=d("WASignalKeys").serializePubKey(a);a=a.privateKey;return{identityPublicKey:b,identityPrivateKey:a}})});g.errNullKey=h;g.getIdentityKeys=a},98);
__d("MAWGetSecurityAlertSettingApi",["MAWDbMsgTypeVersionTxns","MAWIndexedDb","MAWTransactionMode"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor({appMeta:d("MAWTransactionMode").READONLY})(function(a){return d("MAWDbMsgTypeVersionTxns").maybeGetSecuritySetting(a)});g.getSecurityAlertSetting=a},98);
__d("MAWGetThreadDevicesInfoApi",["MAWIndexedDb","MAWSignalUtils","MAWTransactionMode","WAJids","WATimeUtils"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor({identity:d("MAWTransactionMode").READONLY})(function(a,b){b=b.fbid;return a.identity.where("deviceJid").startsWith(b+":").toArray().then(function(a){return a.map(function(a){return{deviceId:d("WAJids").extractDeviceId(a.deviceJid),identityKey:d("MAWSignalUtils").getHexRepresentation(a.identity),firstSeenTs:a.firstSeenTs!=null?d("WATimeUtils").toDate(a.firstSeenTs):null}})})});g.getThreadDevicesInfo=a},98);
__d("MAWGetThumbnailBlobDataUrlByMediaIdApi",["MAWDbChunkTxns","MAWDbMedia","MAWDexieTable","MAWIndexedDb","MAWTransactionMode","WALogger","blobToDataUri","regeneratorRuntime"],function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot generate thumbnail for non image or video mediaType for mediaId: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["getThumbnailBlobDataUrlByMediaIdDbCall cannot find media with mediaId: ",""]);i=function(){return a};return a}a=function(a){var d;return b("regeneratorRuntime").async(function(e){while(1)switch(e.prev=e.next){case 0:e.next=2;return b("regeneratorRuntime").awrap(k(a));case 2:d=e.sent;if(!(d==null)){e.next=7;break}return e.abrupt("return");case 7:return e.abrupt("return",c("blobToDataUri")(d));case 8:case"end":return e.stop()}},null,this)};var j=function(a,b){var c;return((c=b.validatedImageInfo)==null?void 0:c.jpegThumbnail)==null?d("MAWDbChunkTxns").maybeGetChunkFromHash(a,b.hashedPlaintextHash).then(function(a){if(a==null)return;return new Blob([a.blobData],{type:a.mimetype})}):d("MAWDexieTable").dexieResolve(new Blob([(c=b.validatedImageInfo)==null?void 0:c.jpegThumbnail]))},k=d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READONLY})(function(a,b){return a.media.get(b).then(function(c){if(c==null){d("WALogger").ERROR(i(),b);return}switch(c.mediaType){case d("MAWDbMedia").MEDIA_TYPE.IMAGE:return j(a,c);case d("MAWDbMedia").MEDIA_TYPE.VIDEO:return new Blob([(c=c.validatedVideoInfo)==null?void 0:c.jpegThumbnail]);default:d("WALogger").ERROR(h(),b);return}})});g.getThumbnailBlobDataUrlByMediaId=a},98);
__d("MAWInitSyncApi",["MAWBridgeTypes.re","MAWDexieTable","MAWFolderTypes","MAWGating.re","MAWIndexedDb","MAWLoadThreadsTxns","MAWTransactionMode","WATimeUtils"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor({contacts:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY,groupInfo:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READONLY,participants:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READONLY})(function(a,b,c){if(d("MAWGating.re").isOccamadillo()&&d("MAWGating.re").isOccamadilloInitSyncEnabled()){d("MAWIndexedDb").afterTransaction({tag:"InitSyncComplete",value:void 0});return d("MAWDexieTable").dexieResolve()}return d("MAWDexieTable").dexieAll([h(a,b,c,d("MAWFolderTypes").FOLDER_ID.INBOX),h(a,b,c,d("MAWFolderTypes").FOLDER_ID.PENDING)]).then(function(){d("MAWIndexedDb").afterTransaction({tag:"InitSyncComplete",value:void 0})})});function h(a,b,c,e){return a.threads.orderBy("threadOrder").filter(function(a){return e===d("MAWFolderTypes").FOLDER_ID.INBOX?a.folder==null||a.folder===d("MAWFolderTypes").FOLDER_ID.INBOX:a.folder===e}).reverse().limit(b).toArray().then(function(b){return d("MAWLoadThreadsTxns").loadContentsForThreads(a,b,c)}).then(function(a){if(a.length===0){d("MAWIndexedDb").afterTransaction({tag:"ThreadsLoaded",value:d("MAWBridgeTypes.re").makeThreadRangeNoThreads({folderId:e})});return}var c=a[0],f=a[a.length-1];d("MAWIndexedDb").afterTransaction({tag:"ThreadsLoaded",value:d("MAWBridgeTypes.re").makeInitialThreadRange({minThreadId:f.chatId,minLastActivityTs:(f=f.newestMsgTs)!=null?f:d("WATimeUtils").castToUnixTime(0),maxThreadId:c.chatId,maxLastActivityTs:(f=c.newestMsgTs)!=null?f:d("WATimeUtils").castToUnixTime(0),hasMore:a.length>=b,folderId:e})})})}g.initSync=a;g.loadThreadsByFolderId=h},98);
__d("MAWInsertAdminMessageInCutoverThreadsApi",["MAWAdminMsgBuildTxns","MAWDbThreadTxns","MAWIndexedDb","MAWTransactionMode"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READONLY,groupInfo:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY})(function(a,b){var c=b.threadJid;return d("MAWAdminMsgBuildTxns").writeCutoverThreadAdminMsg(a,c).then(function(b){b=b.needsMarkThreadAsMigrated;if(b)return d("MAWDbThreadTxns").markCutoverThreadAsMigratedLocally(a,c)}).then(function(){return!0})});g.insertAdminMessageInCutoverThreads=a},98);
__d("MAWLoadMediaApi",["MAWBridgeTypes","MAWDbChunkTxns","MAWDbMediaTxns","MAWDbMsg","MAWDexieTable","MAWIndexedDb","MAWTransactionMode","WALogger","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unable to load media for thread. ThreadId "," does not exist"]);h=function(){return a};return a}var i=20,j=0;a=d("MAWIndexedDb").makeMsgrTransactor({threads:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READONLY})(function(a,b){var c=b.threadId,e=b.minRowId;return a.threads.get(c).then(function(b){if(b==null)throw d("WALogger").ERROR(h(),c);return a.messages.where("msgId").between(d("MAWDbMsg").msgIdsInChatLowerBound(b.chatId),d("MAWDbMsg").craftMsgId(b.chatId,e)).filter(function(a){var b=d("WATimeUtils").unixTime(),c=d("MAWDbMsg").isMediaMsg(a);a=a.messageExpirationTs==null||a.messageExpirationTs>b;return c&&a}).limit(i).reverse().toArray()}).then(function(b){var e=b.length===i,f=b[b.length-1];f=f?d("MAWDbMsg").getInChatMsgIdFromMsgId(f.msgId):j;d("MAWIndexedDb").afterTransaction({tag:"NewMediaRange",value:d("MAWBridgeTypes").createBridgeMediaRange(c,f,e)});return d("MAWDbMediaTxns").getMediaFromMsgs(a,b).then(function(b){d("MAWDexieTable").dexieAll(b.map(function(b){return d("MAWDbChunkTxns").hasMediaChunk(a,b.hashedPlaintextHash).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:d("MAWBridgeTypes").createBridgeMedia(c,b,a)})})}))})})});g.loadMoreMedia=a},98);
__d("MAWLoadMsgsApi",["MAWIndexedDb","MAWLoadMsgsTxns","MAWTransactionMode"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({threads:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READONLY})(function(a,b,c,e){return d("MAWLoadMsgsTxns").loadMsgsAndMediaFromOffset(a,b,c,e).then(function(a){a=a.hasMore;return{hasMore:a}})});g.loadMsgs=a},98);
__d("MAWLoadThreadsApi",["MAWBridgeTypes.re","MAWDbThread","MAWFolderTypes","MAWIndexedDb","MAWInitSyncApi","MAWLoadThreadsTxns","MAWTransactionMode","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({threads:d("MAWTransactionMode").READONLY,contacts:d("MAWTransactionMode").READONLY,groupInfo:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READONLY,participants:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READONLY})(function(a,b,c,e,f){return!b?d("MAWInitSyncApi").loadThreadsByFolderId(a,c,e,f):a.threads.get(b).then(function(b){if(b==null)return;return a.threads.where("threadOrder").between(d("MAWDbThread").MIN_THREAD_ORDER,b.threadOrder,!0,!1).filter(function(a){return f===d("MAWFolderTypes").FOLDER_ID.INBOX?a.folder===null||a.folder===d("MAWFolderTypes").FOLDER_ID.INBOX:a.folder===f}).reverse().limit(c).toArray().then(function(b){return d("MAWLoadThreadsTxns").loadContentsForThreads(a,b,e)}).then(function(a){var b=a.length>=c;if(a.length===0){d("MAWIndexedDb").afterTransaction({tag:"ThreadsLoaded",value:d("MAWBridgeTypes.re").makeThreadRangeNoThreads({folderId:f})});return}a=a[a.length-1];d("MAWIndexedDb").afterTransaction({tag:"ThreadsLoaded",value:d("MAWBridgeTypes.re").makeThreadRangeForLoadBefore({minThreadId:a.chatId,minLastActivityTs:(a=a.newestMsgTs)!=null?a:d("WATimeUtils").castToUnixTime(0),hasMore:b,folderId:f})})})})});g.loadMoreThreads=a},98);
__d("MAWMarkThreadAsUnreadApi",["MAWBridgeTypes","MAWIndexedDb","MAWTransactionMode","WATimeUtils"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor({threads:d("MAWTransactionMode").READWRITE})(function(a,b){return a.threads.get(b).then(function(c){if(c!=null&&c.newestMsgTs){var e=c.newestMsgTs,f=d("WATimeUtils").castToUnixTime(0);return a.threads.update(b,{lastReadMsgTs:f,lastReadMsg:null}).then(function(a){a===1&&d("MAWIndexedDb").afterTransaction({tag:"ThreadTimestampsUpdated",value:d("MAWBridgeTypes").createBridgeThreadTimestampsUpdated(b,f,e)})})}})});g.markThreadAsUnread=a},98);
__d("MAWSendChatStateFromComposerApi",["MAWBridge","MAWDbThreadTxns","MAWIndexedDb","MAWTransactionMode"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({threads:d("MAWTransactionMode").READONLY})(function(a,b){var c=b.threadId,e=b.state;return d("MAWDbThreadTxns").getThread(a,c).then(function(a){if(!a.success)return;a=a.value.jid;d("MAWBridge").getBridge().fireAndForget("backend","sendChatState",{chatJid:a,state:e})})});g.sendChatStateFromComposer=a},98);
__d("MAWUnarchiveThreadApi",["MAWDbThreadTxns","MAWIndexedDb","MAWTransactionMode"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor({threads:d("MAWTransactionMode").READWRITE})(function(a,b){return d("MAWDbThreadTxns").unarchiveThreads(a,[b]).then(function(){})});g.unarchiveThread=a},98);
__d("MAWUpdateContactApi",["MAWIndexedDb","MAWJids","MAWTransactionMode"],function(a,b,c,d,e,f,g){"use strict";var h=0;a=d("MAWIndexedDb").makeMsgrTransactor({contacts:d("MAWTransactionMode").READWRITE})(function(a,b){var c=b.fbid,e=b.name,f=b.isBlocked,g=b.isRestricted,i=b.relationship,j=d("MAWJids").toUserJid(c);return a.contacts.update(j,{nameForSearch:e,isBlocked:f,isRestricted:g,relationship:i}).then(function(b){if(b===h)return a.contacts.put({contactJid:j,devices:[],dhash:null,nameForSearch:e,isBlocked:f,isRestricted:g,relationship:i}).then(function(a){})})});g.updateContact=a},98);
__d("MAWUpdateParticipantNameApi",["MAWDbParticipant","MAWIndexedDb","MAWTransactionMode"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({participants:d("MAWTransactionMode").READWRITE})(function(a,b){var c=b.contactId,e=b.threadKey;b=b.nickname;e=d("MAWDbParticipant").craftParticipantId(e,c);return a.participants.update(e,{nickname:b}).then(function(a){})});g.updateParticipantName=a},98);
__d("MAWUpdateThreadMuteSettingApi",["MAWBridgeTypes","MAWIndexedDb","MAWTransactionMode","WATimeUtils"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor({threads:d("MAWTransactionMode").READWRITE})(function(a,b){var c=b.threadId;b=b.muteDuration;var e=b!==0&&b!==-1?d("WATimeUtils").futureUnixTime(b)*1e3:b;return a.threads.update(c,{muteExpireTimeMs:e}).then(function(){d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypes").createBridgeUpdatedThread({threadId:c,muteExpireTimeMs:e})})})});g.updateThreadMuteSetting=a},98);
__d("MAWFlushCacheToDbApi",["Promise"],function(a,b,c,d,e,f){"use strict";function a(){return b("Promise").resolve()}f.flushCacheToDb=a},66);
__d("MAWGetContactAndIdentitiesApi",["MAWDbContactsTxns","MAWDbIdentityTxns","MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WAResultOrError"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{contacts:d("MAWTransactionMode").READONLY,identity:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getContactAndIdentitiesForUser",!1)))(function(a,b){return d("MAWDexieTable").dexieAll([d("MAWDbContactsTxns").getContact(a,b),d("MAWDbIdentityTxns").getIdentitiesForUser(a,b)]).then(function(a){var b=a[0];a=a[1];if(b==null)return d("WAResultOrError").makeError("missing_contact");else{b={contact:{devices:b.devices,dhash:b.dhash,icdcInfo:b.icdcInfo},identities:a.map(function(a){return{deviceJid:a.deviceJid,identity:a.identity}})};return d("WAResultOrError").makeSuccess(b)}})});g.getContactAndIdentitiesForUser=a},98);
__d("MAWGetKnownDHashesApi",["MAWDbContactsTxns","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{contacts:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getKnownDHashes",!1)))(function(a,b){return d("MAWDbContactsTxns").getContacts(a,b).then(function(a){var b=new Map();a.forEach(function(a){var c=a.contactJid;a=a.dhash;a!=null&&b.set(c,a)});return b})});g.getKnownDHashes=a},98);
__d("MAWHandleNewSessionIfMatchesApi",["MAWDbIdentityTxns","MAWDbPrekeyTxns","MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WACryptoUtils","WAResultOrError","WASignalOther"],function(a,b,c,d,e,f,g){function h(a,b,c){return b!=null?a.identity.get(c).then(function(e){return e!=null&&d("WACryptoUtils").uint8ArraysEqual(e.identity,b)?!1:d("MAWDbIdentityTxns").bulkPutIdentities(a,[{deviceJid:c,identity:b}]).then(function(){return!0})}):d("MAWDexieTable").dexieResolve(!1)}a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{session:d("MAWTransactionMode").READWRITE,identity:d("MAWTransactionMode").READWRITE,prekey:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("handleNewSessionIfMatches",!1)))(function(a,b,c,e,f,g){return a.session.get(b).then(function(i){i=i?d("WASignalOther").castToSessionHash(i.session.buffer):null;if(i!=null&&c==null||i==null&&c!=null||i!=null&&c!=null&&!d("WASignalOther").areSessionHashesEqual(i,c))return d("WAResultOrError").makeError("mismatch");i=a.session.put({id:b,session:e});var j=g!=null?d("MAWDbPrekeyTxns").bulkDeletePreKeys(a,[g]):null;return d("MAWDexieTable").dexieAll([h(a,f,b),i,j]).then(function(a){var b=a[0];a[1];a[2];b;return d("WAResultOrError").makeSuccess(void 0)})})});g.handleNewSessionIfMatches=a},98);
__d("MAWSessionApi",["MAWDbSessionTxns","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WAResultOrError","WASignalOther"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{session:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("loadSession",!1)))(function(a,b){return a.session.get({id:b}).then(function(a){if(a==null)return null;var b=d("WASignalOther").castToSessionHash(a.session.buffer);a=a.session;return{hash:b,encodedSession:a}})});b=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{session:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("saveSessionIfMatches",!1)))(function(a,b,c,e){return d("MAWDbSessionTxns").bulkCheckSessionsMatch(a,[{id:b,oldHash:c}]).then(function(c){return!c.success?c:d("MAWDbSessionTxns").bulkSaveSessions(a,[{id:b,session:e}]).then(function(){return d("WAResultOrError").makeSuccess()})})});g.loadSession=a;g.saveSessionIfMatches=b},98);
__d("MAWSetDevicesApi",["MAWDexieTable","MAWIndexedDb","MAWJids","MAWLLAMigrationUtils","MAWTransactionMode","WALogger"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["User with "," cannot be found in the DB to make ICDC payload updated"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Updated ICDC info for ",". New seq: ",""]);i=function(){return a};return a}a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{contacts:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("setDevices",!1)))(function(a,b){var c=new Map(),e=[];b.map(function(a){var b=a.devices.map(function(b){return d("MAWJids").toDeviceJid(a.jid,b)});e.push({contactJid:a.jid,devices:b,dhash:a.dhash,icdcInfo:a.icdcInfo||void 0,lastSyncTs:a.lastSyncTs});a.resetICDCError!=null&&c.set(a.jid,a.resetICDCError)});return d("MAWDexieTable").dexieAll(e.map(function(b){return a.contacts.get(b.contactJid).then(function(d){if(d==null)return a.contacts.put(b);else return a.contacts.put(babelHelpers["extends"]({},d,{contactJid:b.contactJid,devices:b.devices,dhash:b.dhash,icdcInfo:b.icdcInfo,lastSyncTs:b.lastSyncTs,icdcFails:c.get(d.contactJid)===!0?void 0:d.icdcFails}))})})).then(function(){})});b=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{contacts:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("updateICDCForUser",!1)))(function(a,b,c){return a.contacts.get(b).then(function(b){if(b==null)return;else return a.contacts.put(babelHelpers["extends"]({},b,{icdcInfo:c}))}).then(function(a){a!=null?d("WALogger").DEV(i(),b,c.sequence):d("WALogger").DEV(h(),a)})});g.setDevices=a;g.updateICDCForUser=b},98);
__d("MAWClearSignalAndTempStores",["MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{jobs:d("MAWTransactionMode").READWRITE,meta:d("MAWTransactionMode").READWRITE,prekey:d("MAWTransactionMode").READWRITE,prekeyGeneration:d("MAWTransactionMode").READWRITE,session:d("MAWTransactionMode").READWRITE,signedPrekey:d("MAWTransactionMode").READWRITE,tasks:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("clearSignalAndTempStores",!1)))(function(a){return d("MAWDexieTable").dexieAll([a.jobs.clear(),a.meta.clear(),a.prekey.clear(),a.prekeyGeneration.clear(),a.session.clear(),a.signedPrekey.clear(),a.tasks.clear()]).then(function(){})});g.clearSignalAndTempStores=a},98);
__d("MAWGetMyDevicesApi",["MAWGlobals","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","MAWUpdateDevicesForUserApi"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{identity:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getMyDevices",!1)))(function(a){return d("MAWUpdateDevicesForUserApi").getAllDeviceJidsForUser(a,d("MAWGlobals").getMyUserJid())});g.getMyDevices=a},98);
__d("MAWGetAllThreadsAsJsonApi",["MAWAckLevel.re","MAWDbChunkTxns","MAWDbMedia","MAWDbMediaTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbParticipantTxns","MAWDbReactionsTxns","MAWDbThreadTxns","MAWDexieTable","MAWGlobals","MAWIndexedDb","MAWTransactionMode","MAWVault","WAJids","WAMsgType"],function(a,b,c,d,e,f,g){"use strict";var h=function(a,b,c,d){return[{uri:a!=null?"messages/inbox/"+b+"/"+c+"/"+d[a.toString()]:""}]},i=function(a,b,c,e){switch(a.type){case d("WAMsgType").MSG_TYPE.TEXT:return{tag:"TextMsg",value:{common:b,content:d("MAWVault").unvault(a.msgContent.content)}};case d("WAMsgType").MSG_TYPE.IMAGE:return{tag:"PhotoMsg",value:{common:b,photos:h(a.mediaId,c,"photos",e)}};case d("WAMsgType").MSG_TYPE.VIDEO:return{tag:"VideoMsg",value:{common:b,videos:h(a.mediaId,c,"videos",e)}};case d("WAMsgType").MSG_TYPE.PTT:return{tag:"AudioMsg",value:{common:b,audio_files:h(a.mediaId,c,"audio",e)}};case d("WAMsgType").MSG_TYPE.GIF:return{tag:"GifMsg",value:{common:b,gifs:h(a.mediaId,c,"gifs",e)}};case d("WAMsgType").MSG_TYPE.STICKER:return{tag:"StickerMsg",value:{common:b,sticker:{uri:a.mediaId!=null?"messages/stickers_used/"+e[a.mediaId.toString()]:""}}};default:return null}},j=function(a,b,c){a=a.toString();return c[d("WAJids").isAuthorMe(a)?b:a]},k=function(a,b,e){var f=d("MAWGlobals").getMyUserJid().toString(),g=b.chatId,h=b.nextInChatMsgId,k={messages:[],participants:[],threadName:"",photos:{},videos:{},audio:{},gifs:{},stickers:{}};b=b.newestMsg!=null?b.newestMsg:d("MAWDbMsg").craftMsgId(g,0);return d("MAWDexieTable").dexieAll([d("MAWDbParticipantTxns").getParticipantsInThread(a,g),d("MAWDbMsgTxns").getMsgsFromOffset(a,g,b,h,!0,!1)]).then(function(b){var h=b[0];b=b[1];var l=b.msgs;b.hasMore;var m=l.filter(function(a){return a.ephemeralSetting===void 0});b=m.map(function(a){return a.msgId});var n={},o={},p={},q={};return d("MAWDexieTable").dexieAll([d("MAWDbMediaTxns").getMediaFromMsgs(a,m),d("MAWDbReactionsTxns").getReactionsFromMessages(a,b)]).then(function(b){var l=b[0];b=b[1];b.forEach(function(a){var b=a.reactToMsgId,c=a.reaction;a=a.author;if(b!=null&&c!=null){b=b.toString();b in q||(q[b]=[]);q[b].push({reaction:c,actor:j(a,f,e)})}});return d("MAWDexieTable").dexieAll(l.map(function(b){var c=b.hashedPlaintextHash,e=b.mediaId.toString();n[e]=c.toString();p[c.toString()]={mediaType:b.mediaType,mediaId:e};return d("MAWDbChunkTxns").maybeGetChunkFromHash(a,c)})).then(function(a){a.filter(Boolean).forEach(function(a){var b=a.mimetype.split("/");b[0];b=b[1];var c=a.hashedPlaintextHash.toString();b=c+"."+b;c=p[c];var e=c.mediaType;c=c.mediaId;o[c]=b;switch(e){case d("MAWDbMedia").MEDIA_TYPE.GIF:k.gifs[b]=a.blobData;break;case d("MAWDbMedia").MEDIA_TYPE.IMAGE:k.photos[b]=a.blobData;break;case d("MAWDbMedia").MEDIA_TYPE.STICKER:k.stickers[b]=a.blobData;break;case d("MAWDbMedia").MEDIA_TYPE.VIDEO:k.videos[b]=a.blobData;break;case d("MAWDbMedia").MEDIA_TYPE.PTT:k.audio[b]=a.blobData;break;default:break}});k.threadName=e[h.filter(function(a){return a.userJid.toString()!==f})[0].userJid.toString()].toLowerCase().replaceAll(" ","")+("_"+g);m.forEach(function(a){var b={sender_name:j(a.author,f,e),timestamp_ms:a.ts,type:a.type,is_unsent:a.ack<c("MAWAckLevel.re").ACK.sent},d=a.msgId.toString();d in q&&(b=babelHelpers["extends"]({},b,{reactions:q[d]}));d=i(a,b,k.threadName,o);d!=null&&k.messages.push(d)});k.participants=h.map(function(a){return{name:e[a.userJid.toString()]}});return k})})})};a=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY,participants:d("MAWTransactionMode").READONLY,contacts:d("MAWTransactionMode").READONLY,receipts:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READONLY})(function(a){var b={};return d("MAWDexieTable").dexieAll([d("MAWDbThreadTxns").getAllThreadsForUser(a,d("MAWGlobals").getMyUserJid()),a.contacts.toArray()]).then(function(c){var e=c[0];c=c[1];var f={};c.forEach(function(a){f[a.contactJid.toString()]=a.nameForSearch});return d("MAWDexieTable").dexieAll(e.map(function(b){return k(a,b,f)})).then(function(a){a.forEach(function(a){b[a.threadName]=a});return b})})});g.getAllThreadsAsJson=a},98);
__d("MAWHandleEchoMsgsRestoreApi",["EchoMessage","FBLogger","MAWAckLevel.re","MAWAuthor","MAWDbMsg","MAWDbThreadTxns","MAWDexieTable","MAWGating.re","MAWHandleEchoMediaMsgsRestore","MAWIndexedDb","MAWJids","MAWRestoreMsgsTxns","MAWTransactionMode","MAWWriteReactionTxns","Promise","WAGlobals","WAJids","WALogger","WAMsgType","WAResultOrError","WAStanzaUtils","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["reaction fields in backup data uneven in length"]);h=function(){return a};return a}function i(a){var b=a.contentType;switch(b){case d("EchoMessage").EchoMessageContentType.TEXT:return d("WAMsgType").MSG_TYPE.TEXT;case d("EchoMessage").EchoMessageContentType.MEDIA:if(d("MAWGating.re").isAttachmentBackupEnabled())return j(a);break;default:c("FBLogger")("labyrinth_web").mustfix("thread has unsupported message content type: %s",d("EchoMessage").EchoMessageContentType.getName(b))}return null}function j(a){a=a.mediaData;if(a!=null){switch(a.attachmentType){case d("EchoMessage").AttachmentType.IMAGE:return d("WAMsgType").MSG_TYPE.IMAGE;case d("EchoMessage").AttachmentType.STICKER:return d("WAMsgType").MSG_TYPE.STICKER;case d("EchoMessage").AttachmentType.VIDEO:return d("WAMsgType").MSG_TYPE.VIDEO;case d("EchoMessage").AttachmentType.GIF:return d("WAMsgType").MSG_TYPE.GIF;case d("EchoMessage").AttachmentType.PTT:return d("WAMsgType").MSG_TYPE.PTT}c("FBLogger")("labyrinth_web").mustfix("thread has unsupported message type: %s",d("EchoMessage").AttachmentType.getName(a.attachmentType))}return null}function k(a,b,c,e){var f=a.from;if(f==null)return null;var g=i(a);if(g==null)return null;switch(g){case d("WAMsgType").MSG_TYPE.TEXT:return n(a,b,c,f,g,e);case d("WAMsgType").MSG_TYPE.IMAGE:case d("WAMsgType").MSG_TYPE.VIDEO:case d("WAMsgType").MSG_TYPE.STICKER:case d("WAMsgType").MSG_TYPE.GIF:case d("WAMsgType").MSG_TYPE.PTT:if(d("MAWGating.re").isAttachmentBackupEnabled())return l(a,b,c,f,g,e)}return null}function l(a,b,c,d,e,f){a=o(a,b,c,d,e,f);return m(e,a)}function m(a,b){switch(a){case d("WAMsgType").MSG_TYPE.IMAGE:return babelHelpers["extends"]({},b,{type:d("WAMsgType").MSG_TYPE.IMAGE});case d("WAMsgType").MSG_TYPE.STICKER:return babelHelpers["extends"]({},b,{type:d("WAMsgType").MSG_TYPE.STICKER});case d("WAMsgType").MSG_TYPE.VIDEO:return babelHelpers["extends"]({},b,{type:d("WAMsgType").MSG_TYPE.VIDEO});case d("WAMsgType").MSG_TYPE.GIF:return babelHelpers["extends"]({},b,{type:d("WAMsgType").MSG_TYPE.GIF});case d("WAMsgType").MSG_TYPE.PTT:return babelHelpers["extends"]({},b,{type:d("WAMsgType").MSG_TYPE.PTT})}}function n(a,b,c,e,f,g){var h=a.text;if(h==null)return null;a=o(a,b,c,e,f,g);return babelHelpers["extends"]({},a,{msgContent:{content:h},type:d("WAMsgType").MSG_TYPE.TEXT})}function o(a,b,c,e,f,g){e=A(e);f={type:f,ts:d("WATimeUtils").castToUnixTime(a.displayTimestampMs/1e3),externalId:g,isForwarded:a.isForwarded,thread:b,threadJid:c,author:e,ack:e===d("WAJids").AUTHOR_ME?d("MAWAckLevel.re").ACK.sent:d("MAWAckLevel.re").ACK.received,altIndex:d("MAWDbMsg").UNDEFINED_ALT_INDEX,sortOrderMs:a.sortOrderMs};a.authoritativeTimestampMs!=null&&(f.serverTs=d("WATimeUtils").castToUnixTime(a.authoritativeTimestampMs/1e3));return f}var p=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE,receipts:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READWRITE,groupInfo:d("MAWTransactionMode").READWRITE,reactions:d("MAWTransactionMode").READWRITE})(function(a,b,e){return d("MAWWriteReactionTxns").writeReaction(a,b,e).then(function(a){a==="missing_thread"&&c("FBLogger")("labyrinth_web","reaction_persistence_failed").mustfix("failed to persist reaction during restore")})});function q(a,b,d){if((a==null?void 0:a.length)===0){c("FBLogger")("labyrinth_web","null_reaction_msg").mustfix("reaction string is not a single character");return!1}if(b==null){c("FBLogger")("labyrinth_web","reaction_external_id_missing").mustfix("reaction external id missing");return!1}if(d==null){c("FBLogger")("labyrinth_web","reaction_toAuthor_missing").mustfix("reactToAuthor field is null");return!1}return!0}function r(a,b){a=a.get(b.dbMsg.externalId);if(a==null){c("FBLogger")("labyrinth_web","reactions_echo_document_absent").mustfix("echo document is absent for a restored msg");return!1}if(d("WAJids").isAuthorSystem(b.dbMsg.author)){c("FBLogger")("labyrinth_web","reactions_for_system_author").mustfix("Cannot have reactions for system author");return!1}if(d("MAWAuthor").getAuthorUserJid(b.dbMsg.author)==null){c("FBLogger")("labyrinth_web","reactions_for_system_author").mustfix("Cannot have reactions empty author");return!1}return!0}function s(a,b,c){return(a||[]).map(function(a,e){if(c==null||b==null||(c==null?void 0:c.length)<=e||(b==null?void 0:b.length)<=e){d("WALogger").DEV(h());return[]}return[a,b[e],c[e]]})}function t(a,b){var c=d("MAWAuthor").getAuthorUserJid(a.dbMsg.author);if(b==null||c==null)return[];var e=b.reactionAuthoritativeTimestampMs;e=e===void 0?[]:e;var f=b.reactionXOfflineThreadingIds;f=f===void 0?[]:f;b=b.reactions;return s(b,f,e).filter(function(b){var c=b[0];b=b[1];return b!=null&&q(c.displayName,b.displayName,d("MAWAuthor").getAuthorUserJid(a.dbMsg.author))}).map(function(b){var e=b[0],f=b[1];b=b[2];var g=e.displayName;e=A(e);return{ack:e===d("WAJids").AUTHOR_ME?d("MAWAckLevel.re").ACK.sent:d("MAWAckLevel.re").ACK.received,author:e,externalId:d("WAStanzaUtils").toStanzaId(f.displayName||""),reactToExternalId:a.dbMsg.externalId,reactToAuthor:c,reactToMsgId:a.dbMsg.msgId,threadJid:a.threadJId,reaction:g,groupingKey:g,ts:d("WATimeUtils").castToUnixTime(Number(b.displayName)/1e3)}})}function u(a){var c=a.restoredMsgs,d=a.echoMsgMap;return b("Promise").all(c.map(function(a){return a.then(function(a){a=a.restoredMessages;a=a.filter(function(a){var b=d.get(a.dbMsg.externalId);return r(d,a)&&b!=null&&z(b)});return b("Promise").all(a.flatMap(function(a){var b=d.get(a.dbMsg.externalId);return t(a,b).filter(Boolean).map(function(b){return p(b,a.threadJId)})}))})}))}var v=function(a){d("MAWGating.re").isAttachmentBackupEnabled()&&x(a);return b("Promise").resolve()};a=function(a){a=w(a);return a.then(function(a){u(a);v(a);return b("Promise").resolve(d("WAResultOrError").makeSuccess({pendingRestoreSortKeys:[]}))})};var w=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READWRITE,groupInfo:d("MAWTransactionMode").READWRITE,media:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READONLY})(function(a,b){var c=d("MAWDexieTable").dexieAll(Array.from(b.keys(),function(b){return d("MAWDbThreadTxns").getThreadByJidPrimaryId(a,b).then(function(a){return babelHelpers["extends"]({},a,{threadJidPrimaryId:b})})})).then(function(a){var b=new Map();a.forEach(function(a){a.success&&b.set(a.threadJidPrimaryId,a.value)});return b}),e=[],f=new Set(),g=new Map(),h=[];c=c.then(function(c){c.forEach(function(a,c){c=b.get(c);var i=[];c!=null&&c.length>0&&(c.forEach(function(b){b=d("EchoMessage").decodeEchoMessage(b,[]);if(b==null)return;var c=b.xOfflineThreadingId;if(c==null||f.has(c))return;f.add(c);c=d("WAStanzaUtils").toStanzaId(c);var e=k(b,a.chatId,a.jid,c);e!=null&&(i.push(e),g.set(c,b));c=b==null?void 0:b.quoteData;c!=null&&(h.push(c.quoteSortOrderInMs.toString()),e!=null&&(e.quoteExternalId=d("WAStanzaUtils").toStanzaId(c.quoteMessageId)))}),e.push({messagesToAdd:i,dbThread:a}))});c=e.map(function(b){var c=b.messagesToAdd;b=b.dbThread;return d("MAWRestoreMsgsTxns").restoreMsgsForThread(a,c,b)});return c});return c.then(function(a){a=a.map(function(a){return a});return{restoredMsgs:a,echoMsgMap:g,quotesToBeRestored:h}})});function x(a){var b=a.restoredMsgs;b.map(function(b){return b.then(function(b){b=b.restoredMessages;b.map(function(b){b=y(b,a.echoMsgMap);b&&d("MAWHandleEchoMediaMsgsRestore").downloadMediaAndWriteToMediaStore(b)})})})}function y(a,b){var e=a.dbMsg;b=b.get(e.externalId);if(b==null)return;var f=b.mediaData;if(f==null)return;else{var g,h=b.from;if(h==null)c("FBLogger")("labyrinth_web").warn("from field is missing from message");else{h=d("MAWJids").toUserJid(h.localKey);h===d("WAGlobals").getMyUserJid()?g=d("WAJids").AUTHOR_ME:g=h;h=e.externalId;e=e.msgId;a=a.threadJId;b=b.authoritativeTimestampMs;if(b==null){c("FBLogger")("labyrinth_web").warn("timestamp field should not be null as it is required for attachment download retry");return}return{author:g,externalId:h,msgId:e,threadJId:a,mediaData:f,messageTimestamp:d("WATimeUtils").castToUnixTime(b)}}}}function z(a){return a.reactions!=null&&a.reactions.length!==0&&a.reactionXOfflineThreadingIds!=null&&a.reactionXOfflineThreadingIds.length!==0&&a.reactionAuthoritativeTimestampMs!=null&&a.reactionAuthoritativeTimestampMs.length!==0}function A(a){a=d("MAWJids").toUserJid(a.localKey);return a===d("WAGlobals").getMyUserJid()?d("WAJids").AUTHOR_ME:a}g.getUnstoredDbMessageFromEchoMessage=k;g.handleEchoMsgsRestore=a;g.getMediaMetadataForDownload=y},98);
__d("MAWHandleEchoThreadsRestoreApi",["EchoThread","MAWDexieTable","MAWIndexedDb","MAWThreadManagementTxns","MAWTransactionMode"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE,participants:d("MAWTransactionMode").READWRITE,groupInfo:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY})(function(a,b){var c=new Set();b=b.reduce(function(b,e){var f;e=d("EchoThread").decodeEchoThread(e);if(e==null)return b;f=(f=e.xThreadId)!=null?f:e.threadId;if(c.has(f))return b;c.add(f);return[].concat(b,[d("MAWThreadManagementTxns").getOrCreateThreadFromEchoThread(a,e)])},[]);return d("MAWDexieTable").dexieAll(b).then(function(){return Array.from(c)})});g.handleEchoThreadsRestore=a},98);
__d("MAWDeleteExpiredMsgsApi",["MAWDbMsg","MAWDbReactionsTxns","MAWDbXMATxns","MAWDexieTable","MAWGating.re","MAWIndexedDb","MAWJidUtils","MAWLLAMigrationUtils","MAWTransactionMode","WAArmadilloApplication.pb","WALogger","WASortedLists","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Successfully deleted: "," XMA rows"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Successfully deleted: "," media rows, "," chunk rows."]);i=function(){return a};return a}function j(a,b){return a.media.bulkGet(b.map(function(a){return a[0]})).then(function(c){var e=[],f=[];c.forEach(function(a,c){if(a!=null){var g=b[c][1];a.msgIds=d("WASortedLists").filter(a.msgIds,function(a){return a!==g});a.mediaEntries["delete"](g);a.msgIds.length===0&&a.mediaEntries.size===0&&(a.hashedPlaintextHash!=null&&e.push(a.hashedPlaintextHash),f.push(a.mediaId))}});c=a.media.bulkDelete(f);var g=a.chunk.where("hashedPlaintextHash").anyOf(e)["delete"]();return d("MAWDexieTable").dexieAll([c,g]).then(function(){d("WALogger").LOG(i(),f.length,e.length)})})}function k(a,b){var e=[];if(c("MAWGating.re").isXMAFeedPostShareEnabled()){var f=b.map(function(b){return d("MAWDbXMATxns").maybeGetXMAFromProtocolMsgId(a,b[0])});return d("MAWDexieTable").dexieAll(f).then(function(c){c.forEach(function(a,c){if(a!=null){var d=b[c][1];a.faviconMediaId!=null&&e.push([a.faviconMediaId,d]);a.headerMediaId!=null&&e.push([a.headerMediaId,d]);if(a.previewMediaIds!=null){(c=a.previewMediaIds)==null?void 0:c.forEach(function(a){e.push([a,d])})}}});c=a.xma.bulkDelete(c.filter(Boolean).map(function(a){a=a.xmaId;return a}));var f=j(a,e);return d("MAWDexieTable").dexieAll([f,c]).then(function(){d("WALogger").LOG(h(),b.length)})})}else return d("MAWDexieTable").dexieResolve()}a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{media:d("MAWTransactionMode").READWRITE,messages:d("MAWTransactionMode").READWRITE,receipts:d("MAWTransactionMode").READWRITE,chunk:d("MAWTransactionMode").READWRITE,reactions:d("MAWTransactionMode").READWRITE,xma:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("deleteExpiredMsgs",!1)))(function(a){var b=d("WATimeUtils").unixTime();return a.messages.where("messageDeleteTs").belowOrEqual(b).toArray().then(function(b){var c=[],e=[],f=[],g=[],h=[];b.forEach(function(a){a.mediaId!=null&&c.push([a.mediaId,a.msgId]);if(d("MAWDbMsg").isXMAMsg(a)){var b=d("MAWJidUtils").maybeToProtocolMsgId(a.author,a.threadJid,a.externalId);b!=null&&h.push([b,a.msgId])}if(a.quote!=null&&a.quote.content.xmaMessageType===d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_EXTENDED_CONTENT_MESSAGE_EXTENDEDCONTENTTYPE.FB_STORY_REPLY){b=d("MAWJidUtils").maybeToProtocolMsgId(a.author,a.threadJid,a.quote.content.externalId);b!=null&&h.push([b,a.msgId])}e.push(a.msgId);f.push({chatId:a.thread,author:a.author,externalId:a.externalId});g.push(a.rowId)});b=a.messages.bulkDelete(g);var i=a.receipts.bulkDelete(e),l=j(a,c),m=k(a,h),n=d("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(a,f);return d("MAWDexieTable").dexieAll([b,i,n,l,m]).then(function(){return d("MAWDexieTable").dexieResolve(g.length)})})});g.deleteOrUpdateMediaAndChunkForExpiredMsgs=j;g.deleteOrUpdateXMAForExpiredMsgs=k;g.deleteExpiredMsgs=a},98);
__d("MAWGetEphemeralSettingsApi",["MAWDbContactsTxns","MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WAJids","WALogger"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Received invalid chat jid for getting ephemeral settings"]);h=function(){return a};return a}a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{contacts:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getEphemeralSettings",!1)))(function(a,b){b=d("WAJids").interpretAsUserJid(b);if(!b){d("WALogger").ERROR(h());return d("MAWDexieTable").dexieResolve()}return d("MAWDbContactsTxns").getContact(a,b).then(function(a){return a==null?void 0:a.ephemeralSetting})});g.getEphemeralSettings=a},98);
__d("MAWGetNextDeletionTsApi",["MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{messages:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getNextDeletionTs",!1)))(function(a){return a.messages.orderBy("messageDeleteTs").first().then(function(a){return a==null?void 0:a.messageDeleteTs})});g.getNextDeletionTs=a},98);
__d("MAWGetNextExpirationTsApi",["MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{messages:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getNextExpirationTs",!1)))(function(a){var b=d("WATimeUtils").unixTime();return a.messages.orderBy("messageExpirationTs").filter(function(a){return a.messageExpirationTs!=null?a.messageExpirationTs>b:!1}).first().then(function(a){return a==null?void 0:a.messageExpirationTs})});g.getNextExpirationTs=a},98);
__d("MAWGetSyncResponseBackoffInfoByJidApi",["MAWDbContactsTxns","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WAResultOrError"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{contacts:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getSyncResponseBackoffInfoByJid",!1)))(function(a,b){return d("MAWDbContactsTxns").getContact(a,b).then(function(a){return a==null?d("WAResultOrError").makeError("missing_contact"):d("WAResultOrError").makeSuccess(a.ephemeralSyncResponseBackoffInfo)})});g.getSyncResponseBackoffInfoByJid=a},98);
__d("MAWRemoveExpiredMsgsFromUIApi",["MAWBridgeTypes","MAWDbMsg","MAWDbXMATxns","MAWDexieTable","MAWEphemeralMsgTxns","MAWGating.re","MAWIndexedDb","MAWJidUtils","MAWLLAMigrationUtils","MAWTransactionMode","MAWUpdateQuotedMsgTxns","MAWXMAUtils","WAMsgType","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{media:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READONLY,groupInfo:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READWRITE,xma:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("removeExpiredMsgsFromUI",!1)))(function(a){return a.messages.where("messageExpirationTs").belowOrEqual(d("WATimeUtils").unixTime()).filter(function(a){return a.ephemeralMsgDisappeared!==!0}).toArray().then(function(b){if(b.length===0)return 0;var c=b.reduce(function(a,b){var c;c=(c=a.get(b.thread))!=null?c:new Set();c.add(b.msgId);a.set(b.thread,c);return a},new Map()),e=b.map(function(a){return babelHelpers["extends"]({},a,{ephemeralMsgDisappeared:!0})}),f=a.messages.bulkPut(e);b=b.map(function(b){return d("MAWUpdateQuotedMsgTxns").disassociateQuotedMsg(a,b.thread,b.externalId,b.author,d("WAMsgType").MSG_TYPE.EXPIRED_EPHEMERAL)});return d("MAWDexieTable").dexieAll([f,d("MAWEphemeralMsgTxns").updateThreadsOnMessagesExpiredFromUi(a,c)].concat(b)).then(function(){var b=[];e.forEach(function(c){d("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:d("MAWBridgeTypes").createBridgeDeleteMessages(c.thread,[c])});if(d("MAWDbMsg").isMediaMsg(c)){var e=c.mediaId;e!=null&&d("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:d("MAWBridgeTypes").createBridgeMediaExpired(c,e)})}d("MAWXMAUtils").isXMAShare(c.xmaMessageType)&&d("MAWGating.re").isXMAFeedPostShareEnabled()&&b.push(d("MAWDbXMATxns").maybeGetXMAFromProtocolMsgId(a,d("MAWJidUtils").maybeToProtocolMsgId(c.author,c.threadJid,c.externalId)).then(function(a){a!=null&&d("MAWIndexedDb").afterTransaction({tag:"XMAShareExpired",value:d("MAWBridgeTypes").createBridgeXMAShareExpired(c,a.xmaId)})}))});return d("MAWDexieTable").dexieAll(b).then(function(a){return e.length})})})});g.removeExpiredMsgsFromUI=a},98);
__d("MAWUpdateEphemeralityOnMarkMsgsFromOtherAsReadApi",["MAWEphemeralMsgTxns","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{messages:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("updateEphemeralityOnMarkMsgsFromOtherAsRead",!1)))(function(a,b,c){b=b.map(function(a){return{msgId:a,ts:c}});return d("MAWEphemeralMsgTxns").bulkMarkEphemeralMessageAsRead(a,b)});g.updateEphemeralityOnMarkMsgsFromOtherAsRead=a},98);
__d("MAWAddGroupParticipantsApi",["MAWBridgeTypes","MAWDbPersonalSenderKeyStatusTxns","MAWDexieTable","MAWGating.re","MAWGroupManagementTxns","MAWIndexedDb","MAWLLAMigrationUtils","MAWThreadFetchAndEmitTxns","MAWTransactionMode","WAResultOrError"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{threads:d("MAWTransactionMode").READWRITE,participants:d("MAWTransactionMode").READWRITE,groupInfo:d("MAWTransactionMode").READWRITE,personalSenderKeyStatuses:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READWRITE,xma:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("addGroupParticipants",!1)))(function(a,b,c,e,f,g,h,i){return d("MAWThreadFetchAndEmitTxns").fetchAndEmitThread(a,c).then(function(c){if(c==null||c.groupInfo==null)return d("WAResultOrError").makeError("mismatch");var i=c.thread;c=c.groupInfo;return d("MAWDexieTable").dexieAll([d("MAWGroupManagementTxns").addParticipantsAndUpdateGroupInfo(a,b,c,i.chatId,f,e,g),d("MAWDbPersonalSenderKeyStatusTxns").addNewDevicesToPersonalSenderKeyStatus(a,c.groupJid,f)]).then(function(a){a=a[0];h&&d("MAWGating.re").isOccamadillo()&&d("MAWIndexedDb").afterTransaction({tag:"UpdateE2EEMetadataParticipants",value:d("MAWBridgeTypes").createBridgeUpdateE2EEMetadataParticipants(i.chatId)});return a?d("WAResultOrError").makeError(a):d("WAResultOrError").makeSuccess()})})});g.addGroupParticipants=a},98);
__d("MAWChangeAdminStatusApi",["MAWAdminMsgBuildTxns","MAWDbGroupInfoTxns","MAWDbParticipantTxns","MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWThreadFetchAndEmitTxns","MAWTransactionMode","WAResultOrError"],function(a,b,c,d,e,f,g){"use strict";a=function(a,b,c,d){return h(a,b,c,d,"participant")};b=function(a,b,c,d){return h(a,b,c,d,"admin")};var h=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{groupInfo:d("MAWTransactionMode").READWRITE,participants:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READWRITE,media:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READWRITE,xma:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("changeAdminStatus",!1)))(function(a,b,c,e,f,g){return d("MAWThreadFetchAndEmitTxns").fetchAndEmitThread(a,c).then(function(c){if(c==null||c.groupInfo==null)return d("WAResultOrError").makeError("missing_group");c=c.groupInfo;if(b!=null&&c.participantVersion!==b.previous)return d("WAResultOrError").makeError("mismatch");var h=f.map(function(a){return a.user});return d("MAWDexieTable").dexieAll([d("MAWDbParticipantTxns").setParticipantTypesForUsers(a,c.threadId,h,g),b==null?d("MAWDexieTable").dexieResolve():d("MAWDexieTable").dexieAll([d("MAWDbGroupInfoTxns").updateGroupInfo(a,babelHelpers["extends"]({},c,{participantVersion:b.current})),d("MAWAdminMsgBuildTxns").writePromoteOrDemoteParticipantAdminMsg(a,h[0],e,c.threadId,g)])]).then(function(){return d("WAResultOrError").makeSuccess()})})});g.demoteGroupParticipants=a;g.promoteGroupParticipants=b},98);
__d("MAWCreateGroupApi",["MAWDexieTable","MAWGroupManagementTxns","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{threads:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READWRITE,participants:d("MAWTransactionMode").READWRITE,groupInfo:d("MAWTransactionMode").READWRITE,personalSenderKeyStatuses:d("MAWTransactionMode").READWRITE,reactions:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("createGroup",!1)))(d("MAWGroupManagementTxns").createGroupInternal);b=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{threads:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READWRITE,participants:d("MAWTransactionMode").READWRITE,groupInfo:d("MAWTransactionMode").READWRITE,personalSenderKeyStatuses:d("MAWTransactionMode").READWRITE,reactions:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("createGroups",!1)))(function(a,b){return d("MAWDexieTable").dexieAll(b.map(function(b){return d("MAWGroupManagementTxns").createGroupInternal(a,b,"queried",d("WATimeUtils").unixTime())})).then(function(){})});g.createGroup=a;g.createGroups=b},98);
__d("MAWDeleteGroupsApi",["MAWDbThreadTxns","MAWDexieTable","MAWGroupManagementTxns","MAWIndexedDb","MAWLLAMigrationUtils","MAWThreadTypes","WAResultOrError"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[d("MAWThreadTypes").ThreadRelatedTablesPermissions].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("deleteGroups",!1)))(function(a,b){return d("MAWDexieTable").dexieAll(b.map(function(b){var c=b.group;return d("MAWDbThreadTxns").getThreadByJid(a,c).then(function(b){return!b.success?d("WAResultOrError").makeError("Missing group thread id"):d("MAWGroupManagementTxns").deleteGroup(a,c,b.value)})})).then(function(){})});g.deleteGroups=a},98);
__d("MAWGetGroupParticipantDevicesApi",["MAWDbGroupInfoTxns","MAWIndexedDb","MAWLLAMigrationUtils","MAWRecipientDevicesTxns","MAWTransactionMode","WAResultOrError"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{groupInfo:d("MAWTransactionMode").READONLY,participants:d("MAWTransactionMode").READONLY,contacts:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getGroupParticipantDevices",!1)))(function(a,b){return d("MAWDbGroupInfoTxns").getGroupInfo(a,b).then(function(b){if(!b.success)return d("WAResultOrError").makeError("missing");b=b.value;return d("MAWRecipientDevicesTxns").getRecipientDevicesByThread(a,b.threadId).then(function(a){return!a.success?d("WAResultOrError").makeError("missing"):d("WAResultOrError").makeSuccess({deviceJids:new Set(a.value)})})})});g.getGroupParticipantDevices=a},98);
__d("MAWGetGroupSubjectByJidApi",["MAWDbGroupInfoTxns","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WAResultOrError"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{groupInfo:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getGroupSubjectByJid",!1)))(function(a,b){return d("MAWDbGroupInfoTxns").getGroupInfo(a,b).then(function(a){if(!a.success)return d("WAResultOrError").makeError("missing_group");return a.value.name==null?d("WAResultOrError").makeError("unnamed_group"):d("WAResultOrError").makeSuccess(a.value.name)})});g.getGroupSubjectByJid=a},98);
__d("MAWGetInviterByGroupJidApi",["MAWDbGroupInfoTxns","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WAResultOrError"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{groupInfo:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getInviterByGroupJid",!1)))(function(a,b){return d("MAWDbGroupInfoTxns").getGroupInfo(a,b).then(function(a){if(!a.success)return d("WAResultOrError").makeError("missing_group");return a.value.inviter==null?d("WAResultOrError").makeError("no_inviter"):d("WAResultOrError").makeSuccess(a.value.inviter)})});g.getInviterByGroupJid=a},98);
__d("MAWGetSenderKeyStatusApi",["MAWDbPersonalSenderKeyStatusTxns","MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{personalSenderKeyStatuses:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getSenderKeyStatus",!1)))(function(a,b){return a.personalSenderKeyStatuses.get(b).then(function(c){c!=null?c=d("MAWDexieTable").dexieResolve(c):c=d("MAWDbPersonalSenderKeyStatusTxns").putNewPersonalSenderKeyStatus(a,b);return c.then(function(a){var b=a.senderKeyId,c=a.rotateSenderKey,d=a.needsSenderKey;a=a.senderKeyTs;return{senderKeyId:b,rotateSenderKey:c,needsSenderKey:d,ts:a}})})});g.getSenderKeyStatus=a},98);
__d("MAWLeaveGroupsApi",["MAWDbGroupInfoTxns","MAWDbParticipantTxns","MAWDbPersonalSenderKeyStatusTxns","MAWDbThreadTxns","MAWDexieTable","MAWGlobals","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{participants:d("MAWTransactionMode").READWRITE,groupInfo:d("MAWTransactionMode").READONLY,personalSenderKeyStatuses:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("leaveGroups",!1)))(function(a,b){var c=b.groupJids;return d("MAWDbGroupInfoTxns").getGroupInfos(a,c).then(function(b){b=b.filter(Boolean);b=b.map(function(a){return a.threadId});var e=d("MAWGlobals").getMyUserJid();return d("MAWDexieTable").dexieAll([d("MAWDbParticipantTxns").bulkDeleteParticipantAcrossThreads(a,b,e),d("MAWDbThreadTxns").archiveThreads(a,b,!0),d("MAWDbPersonalSenderKeyStatusTxns").bulkDeletePersonalSenderKeyStatus(a,c)]).then(function(){})})});g.leaveGroups=a},98);
__d("MAWLoadSenderKeySessionApi",["MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","SignalDbTypes","WAJids","WAResultOrError"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{senderKeySessions:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("loadSenderKeySession",!1)))(function(a,b,c){var e=d("WAJids").extractUserJid(c);c=d("WAJids").extractDeviceId(c);b=d("SignalDbTypes").buildSenderKeySessionId(b,e,c);return a.senderKeySessions.get({id:b}).then(function(a){return a!=null?d("WAResultOrError").makeSuccess(a.record):d("WAResultOrError").makeError("errLoadSenderKeySession")})});g.loadSenderKeySession=a},98);
__d("MAWMarkParticipantNeedsKeyApi",["MAWDbGroupInfoTxns","MAWDbParticipantTxns","MAWDbPersonalSenderKeyStatusTxns","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WAJids","WAResultOrError"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{personalSenderKeyStatuses:d("MAWTransactionMode").READWRITE,groupInfo:d("MAWTransactionMode").READONLY,participants:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("markParticipantNeedsKey",!1)))(function(a,b,c){return d("MAWDbGroupInfoTxns").getGroupInfo(a,b).then(function(e){if(!e.success)return d("WAResultOrError").makeError("missing");e=e.value;return d("MAWDbParticipantTxns").getParticipant(a,e.threadId,d("WAJids").extractUserJid(c)).then(function(e){return!e.success?d("WAResultOrError").makeError("missing"):d("MAWDbPersonalSenderKeyStatusTxns").addDevicesToMultiplePersonalSenderKeyStatuses(a,[b],[c]).then(function(){return d("WAResultOrError").makeSuccess()})})})});g.markParticipantNeedsKey=a},98);
__d("MAWMarkSenderKeyAsRotatedApi",["MAWDbGroupInfoTxns","MAWDbPersonalSenderKeyStatusTxns","MAWIndexedDb","MAWLLAMigrationUtils","MAWRecipientDevicesTxns","MAWTransactionMode","WAResultOrError"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{participants:d("MAWTransactionMode").READWRITE,groupInfo:d("MAWTransactionMode").READONLY,contacts:d("MAWTransactionMode").READONLY,personalSenderKeyStatuses:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("markSEnderKeyAsRotated",!1)))(function(a,b,c,e){return d("MAWDbGroupInfoTxns").getGroupInfo(a,b).then(function(b){if(!b.success)return d("WAResultOrError").makeError("missing");b=b.value;return d("MAWRecipientDevicesTxns").getRecipientDevicesByThread(a,b.threadId)}).then(function(f){return!f.success?d("WAResultOrError").makeError("missing_devices"):d("MAWDbPersonalSenderKeyStatusTxns").updateSenderKeyStatusAsRotated(a,b,c,e,f.value).then(function(a){return d("WAResultOrError").makeSuccess({needsSenderKey:a.needsSenderKey})})})});g.markSenderKeyAsRotated=a},98);
__d("MAWMarkSenderKeyAsSentApi",["MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{personalSenderKeyStatuses:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("markSenderKeyAsSent",!1)))(function(a,b,c,d){return a.personalSenderKeyStatuses.get(b).then(function(b){if(b==null)return;if(b.senderKeyId!=c)return;d.forEach(function(a){b.needsSenderKey["delete"](a)});return a.personalSenderKeyStatuses.put(b).then(function(){})})});g.markSenderKeyAsSent=a},98);
__d("MAWRemoveGroupParticipantsApi",["MAWBridgeTypes","MAWDbPersonalSenderKeyStatusTxns","MAWDexieTable","MAWGating.re","MAWGroupManagementTxns","MAWIndexedDb","MAWLLAMigrationUtils","MAWThreadFetchAndEmitTxns","MAWTransactionMode","WAResultOrError"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{threads:d("MAWTransactionMode").READWRITE,participants:d("MAWTransactionMode").READWRITE,groupInfo:d("MAWTransactionMode").READWRITE,personalSenderKeyStatuses:d("MAWTransactionMode").READWRITE,messages:d("MAWTransactionMode").READWRITE,reactions:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READONLY,contacts:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("removeGroupParticipants",!1)))(function(a,b,c,e,f,g,h){return d("MAWThreadFetchAndEmitTxns").fetchAndEmitThread(a,c).then(function(c){if(c==null||c.groupInfo==null)return d("WAResultOrError").makeError("mismatch");var i=c.thread;c=c.groupInfo;return d("MAWDexieTable").dexieAll([d("MAWGroupManagementTxns").removeParticipantsAndUpdateGroupInfo(a,b,c,i.chatId,f,e,g),d("MAWDbPersonalSenderKeyStatusTxns").setRotateSenderKeyToTrue(a,c.groupJid)]).then(function(a){a=a[0];h&&d("MAWGating.re").isOccamadillo()&&d("MAWIndexedDb").afterTransaction({tag:"UpdateE2EEMetadataParticipants",value:d("MAWBridgeTypes").createBridgeUpdateE2EEMetadataParticipants(i.chatId)});return a?d("WAResultOrError").makeError(a):d("WAResultOrError").makeSuccess()})})});g.removeGroupParticipants=a},98);
__d("MAWResetGroupParticipantInfoApi",["MAWAdminMsgBuildTxns","MAWDbGroupInfoTxns","MAWDbPersonalSenderKeyStatusTxns","MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWParticipantManagementTxns","MAWThreadFetchAndEmitTxns","MAWTransactionMode","WAResultOrError","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{participants:d("MAWTransactionMode").READWRITE,groupInfo:d("MAWTransactionMode").READWRITE,personalSenderKeyStatuses:d("MAWTransactionMode").READWRITE,messages:d("MAWTransactionMode").READWRITE,media:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READONLY,contacts:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READWRITE,xma:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("resetGroupParticipantInfo",!1)))(function(a,b,c,e){return d("MAWThreadFetchAndEmitTxns").fetchAndEmitThread(a,b).then(function(f){if(f==null||f.groupInfo==null)return d("WAResultOrError").makeError("missing");var g=f.groupInfo;f=c.map(function(a){return{userJid:a.user,type:a.type,addressable:a.addressable}});f=d("MAWParticipantManagementTxns").syncParticipantList(a,g.threadId,f);return d("MAWDexieTable").dexieAll([f,e!=null?d("MAWDbGroupInfoTxns").updateGroupInfo(a,babelHelpers["extends"]({},g,{participantVersion:e})):d("MAWDexieTable").dexieResolve()]).then(function(c){c=c[0];var e=c.addedJids,f=c.removedJids;c=c.typeUpdateJids;var h=d("MAWDexieTable").dexieResolve(),i=d("MAWDexieTable").dexieResolve();f.length>0&&(h=d("MAWDbPersonalSenderKeyStatusTxns").setRotateSenderKeyToTrue(a,b),i=i.then(function(){return d("MAWAdminMsgBuildTxns").writeAddOrRemoveParticipantAdminMsg(a,f,null,g.threadId,!1,d("WATimeUtils").unixTime())}));e.length>0&&(i=i.then(function(){return d("MAWAdminMsgBuildTxns").writeAddOrRemoveParticipantAdminMsg(a,e,null,g.threadId,!0,d("WATimeUtils").unixTime())}));c.length>0&&c.forEach(function(b){b.type==="admin"?i=i.then(function(){return d("MAWAdminMsgBuildTxns").writePromoteOrDemoteParticipantAdminMsg(a,b.userJid,null,g.threadId,"admin")}):b.type==="participant"&&(i=i.then(function(){return d("MAWAdminMsgBuildTxns").writePromoteOrDemoteParticipantAdminMsg(a,b.userJid,null,g.threadId,"participant")}))});return h.then(function(){return d("WAResultOrError").makeSuccess()})})})});g.resetGroupParticipantInfo=a},98);
__d("MAWSaveSenderKeySessionApi",["MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","SignalDbTypes","WAJids"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{senderKeySessions:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("saveSenderKeySession",!1)))(function(a,b,c,e){var f=d("WAJids").extractUserJid(c);c=d("WAJids").extractDeviceId(c);var g=d("SignalDbTypes").buildSenderKeySessionId(b,f,c);g={id:g,groupJid:b,userJid:f,deviceId:c,record:e};return a.senderKeySessions.put(g).then(function(){})});g.saveSenderKeySession=a},98);
__d("MAWSaveSenderKeySessionIfMatchesApi",["MAWDbSenderKeySessionTxns","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","SignalDbTypes","WAJids","WAResultOrError"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{senderKeySessions:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("saveSenderKeySessionIfMatches",!1)))(function(a,b,c,e,f){var g=d("WAJids").extractUserJid(c),h=d("WAJids").extractDeviceId(c),i=d("SignalDbTypes").buildSenderKeySessionId(b,g,h);return d("MAWDbSenderKeySessionTxns").bulkCheckSenderKeySessionsMatch(a,[{id:i,record:e}]).then(function(c){return!c.success?c:d("MAWDbSenderKeySessionTxns").bulkPutSenderKeySessions(a,[{userJid:g,deviceId:h,id:i,groupJid:b,record:f}]).then(function(){return d("WAResultOrError").makeSuccess()})})});g.saveSenderKeySessionIfMatches=a},98);
__d("MAWUpdateGroupSubjectApi",["MAWAdminMsgBuildTxns","MAWDbGroupInfoTxns","MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWThreadManagementTxns","MAWTransactionMode","WAResultOrError"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{contacts:d("MAWTransactionMode").READONLY,groupInfo:d("MAWTransactionMode").READWRITE,messages:d("MAWTransactionMode").READWRITE,participants:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE,chunk:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("updateGroupSubject",!1)))(function(a,b,c){return d("MAWDbGroupInfoTxns").getGroupInfo(a,b).then(function(b){if(!b.success)return d("WAResultOrError").makeError("missing_group");b=b.value;return b.nameTs!=null&&(c.ts==null||b.nameTs>c.ts)?d("WAResultOrError").makeSuccess():d("MAWThreadManagementTxns").getOrRepairGroupThread(a,b).then(function(b){var e=b.thread;b=b.groupInfo;b.name=c.content;b.nameOwner=c.user;b.nameTs=c.ts;return d("MAWDexieTable").dexieAll([d("MAWDbGroupInfoTxns").updateGroupInfo(a,b),d("MAWAdminMsgBuildTxns").writeGroupNameChangeInfo(a,b,e)]).then(function(){return d("WAResultOrError").makeSuccess()})})})});g.updateGroupSubject=a},98);
__d("MAWWriteGroupInviteApi",["MAWDbParticipant","MAWIndexedDb","MAWLLAMigrationUtils","MAWLowLevelApiTypes","MAWThreadFetchAndEmitTxns","MAWTransactionMode","MAWWriteGroupInviteTxns","WAResultOrError"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{groupInvites:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE,participants:d("MAWTransactionMode").READWRITE,groupInfo:d("MAWTransactionMode").READWRITE,messages:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READONLY,contacts:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("leaveGroups",!1)))(function(a,b,c){return d("MAWThreadFetchAndEmitTxns").fetchAndEmitThread(a,b).then(function(e){if(e==null||e.groupInfo==null)return d("WAResultOrError").makeError(d("MAWLowLevelApiTypes").WRITE_GROUP_INVITE_ERROR.MISSING_GROUP);var f=d("MAWDbParticipant").craftParticipantId(e.thread.chatId,c.invitedParticipantUserJid);f={inviterJid:c.inviterUserJid,invitedParticipantId:f,inviteCode:c.inviteCode,inviteExpirationTs:c.expiration};return d("MAWWriteGroupInviteTxns").writeGroupInvite(a,f,b).then(function(a){if(a===d("MAWLowLevelApiTypes").WRITE_GROUP_INVITE_ERROR.MISSING_GROUP)return d("WAResultOrError").makeError(d("MAWLowLevelApiTypes").WRITE_GROUP_INVITE_ERROR.MISSING_GROUP);else if(a===d("MAWLowLevelApiTypes").WRITE_GROUP_INVITE_ERROR.EXISTING_GROUP_INVITE)return d("WAResultOrError").makeError(d("MAWLowLevelApiTypes").WRITE_GROUP_INVITE_ERROR.EXISTING_GROUP_INVITE);return d("WAResultOrError").makeSuccess((a=e.groupInfo)==null?void 0:a.name)})})});g.writeGroupInvite=a},98);
__d("MAWConvertCreateGroupResultApi",["MAWDbGroupInfoTxns","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","err"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{groupInfo:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("convertCreateGroupResult",!1)))(function(a,b){return d("MAWDbGroupInfoTxns").getGroupInfo(a,b.jid).then(function(b){if(!b.success)throw c("err")("Tried to convert a createGroup result for a group that has not persisted in the DB");return a.threads.get(b.value.threadId).then(function(a){if(a==null)throw c("err")("Tried to convert a createGroup result for a group but its thread is not in DB");return{type:"msgr",chatJid:a.jid}})})});g.convertCreateGroupResult=a},98);
__d("MAWJobPersistenceAccessorsApi",["MAWIndexedDb","MAWJobActions","MAWTransactionMode"],function(a,b,c,d,e,f,g){"use strict";function a(){var a=d("MAWIndexedDb").makeMsgrTransactor({jobs:d("MAWTransactionMode").READWRITE}),b=d("MAWIndexedDb").makeMsgrTransactor({jobs:d("MAWTransactionMode").READONLY});return{deletePersistedJob:a(d("MAWJobActions").deletePersistedJob),readPersistedJob:b(d("MAWJobActions").readPersistedJob),updatePersistedJob:a(d("MAWJobActions").updatePersistedJob),maybeCreateJob:a(d("MAWJobActions").maybeCreateJob)}}g.getJobPersistenceAccessors=a},98);
__d("MAWLoadAllJobsApi",["MAWIndexedDb","MAWJobActions","MAWTransactionMode"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({jobs:d("MAWTransactionMode").READONLY})(d("MAWJobActions").readAllPersistedJobs);g.loadAllJobs=a},98);
__d("MAWGetDualSendMediaByFileTypeApi",["MAWDbDualSendTxns","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","Promise","WALogger"],function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Received invalid id for fetting dual send media file"]);h=function(){return a};return a}a=function(a){if(a==null){d("WALogger").ERROR(h());return b("Promise").resolve()}else return d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{dualSendMedia:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getDualSendMediaByFileType",!1)))(function(b){return d("MAWDbDualSendTxns").getDualSendMediaRowByFileType(b,a).then(function(a){return a==null?void 0:a.file})})()};g.getDualSendMediaByFileType=a},98);
__d("MAWGetMediaByObjectId",["MAWDbMediaTxns","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WAMediaUtils","WAResultOrError"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{media:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getMediaByObjectId",!1)))(function(a,b){return d("MAWDbMediaTxns").maybeGetMediaFromObjectId(a,d("WAMediaUtils").stringToDeliveryObjectId(b)).then(function(a){return!a?d("WAResultOrError").makeError("media-not-found"):d("WAResultOrError").makeSuccess(a)})});g.getMediaByObjectId=a},98);
__d("MAWGetMediaIfAuthorizedApi",["MAWDbContactsTxns","MAWDbMediaTxns","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WAJids","WALogger","WAResultOrError"],function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["getMediaMsgIfAuthorized: Msg "," mediaEntry no longer exists"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["getMediaMsgIfAuthorized: no media for msg "," with mediaId ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["getMediaMsgIfAuthorized: given device "," was not among the original recipients for this message ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["getMediaMsgIfAuthorized: no receipt for msg ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["getMediaMsgIfAuthorized: no media for msg ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["getMediaMsgIfAuthorized: do not find msg sent by sender with chatJid ",", externalId ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["getMediaMsgIfAuthorized: rejecting request for removed device ",""]);n=function(){return a};return a}a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{media:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READONLY,receipts:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getMediaIfAuthorized",!1)))(function(a,b,c,e){var f=d("WAJids").extractUserJid(e);return d("MAWDexieTable").dexieAll([d("MAWDbContactsTxns").getContact(a,f),d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,{chat:b,externalId:c,author:d("WAJids").AUTHOR_ME})]).then(function(f){var g=f[0],o=f[1];if(g==null||!g.devices.includes(e)){d("WALogger").WARN(n(),e);return d("WAResultOrError").makeError("error-unknown-device")}if(o==null){d("WALogger").WARN(m(),b,c);return d("WAResultOrError").makeError("message-not-found")}if(o.mediaId==null){d("WALogger").WARN(l(),o.msgId);return d("WAResultOrError").makeError("media-not-found")}return d("MAWDexieTable").dexieAll([a.receipts.get({msgId:o.msgId}),d("MAWDbMediaTxns").maybeGetMediaFromMediaId(a,o.mediaId)]).then(function(a){var b=a[0];a=a[1];if(b==null){d("WALogger").WARN(k(),o.msgId);return d("WAResultOrError").makeError("message-not-found")}if(!b.recipientDevices.has(e)){d("WALogger").WARN(j(),e,o.msgId);return d("WAResultOrError").makeError("error-unknown-device")}if(a==null){d("WALogger").WARN(i(),o.msgId,o.mediaId);return d("WAResultOrError").makeError("media-not-found")}b=a.plaintextHash;var f=a.size;a=a.mediaEntries;a=a.get(o.msgId);if(a==null){d("WALogger").LOG(h(),c);return d("WAResultOrError").makeError("media-not-found")}return d("WAResultOrError").makeSuccess({plaintextHash:b,size:f,mediaEntryData:a})})})});g.getMediaIfAuthorized=a},98);
__d("MAWGetMediaKnownEntriesApi",["MAWDbMediaTxns","MAWDexieTable","MAWHMACKey","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WAJids","WAMsgMap"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{media:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getMediaKnownEntries",!1)))(function(a,b){b=d("MAWHMACKey").genHMACPlaintextHash(b);return d("MAWDbMediaTxns").maybeGetMediaFromHash(a,b).then(function(b){return!b?new(d("WAMsgMap").MsgMap)():d("MAWDexieTable").dexieAll(Array.from(b.mediaEntries.keys()).map(function(b){return a.messages.get({msgId:b})})).then(function(a){return a.reduce(function(a,c){if(!c)return a;var e=b.mediaEntries.get(c.msgId),f=c.author,g=c.threadJid;e&&!d("WAJids").isAuthorSystem(f)&&g!=null&&a.set({author:f,externalId:c.externalId,chat:g},e);return a},new(d("WAMsgMap").MsgMap)())})})});g.getMediaKnownEntries=a},98);
__d("MAWGetMediaPlaintextApi",["MAWHMACKey","MAWIndexedDb","MAWLLAMigrationUtils","MAWOptimisticUploadManager","MAWTransactionMode","Promise","WALogger"],function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media blob does not exist for the given hashedPlaintextHash"]);h=function(){return a};return a}a=function(a){var c=d("MAWOptimisticUploadManager").getOptimisticUploadManager();c=c.get(a);if(c==null)return i(a);else return b("Promise").resolve(c.file)};function i(a){return d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{chunk:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getMediaPlaintextFromDb",!1)))(function(b,a){a=d("MAWHMACKey").genHMACPlaintextHash(a);return b.chunk.where("hashedPlaintextHash").equals(a).first().then(function(a){if(!a){d("WALogger").ERROR(h());return null}return new Blob([a.blobData],{type:a.mimetype})})})(a)}g.getMediaPlaintext=a},98);
__d("MAWGetMsgForRequestReuploadMediaApi",["MAWDbMsgTxns","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WAResultOrError"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{messages:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getMsgForREquestReuploadMedia",!1)))(function(a,b){return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b).then(function(a){return a?d("WAResultOrError").makeSuccess("message-found"):d("WAResultOrError").makeError("message-not-found")})});g.getMsgForRequestReuploadMedia=a},98);
__d("MAWHandleMediaDownloadApi",["MAWBridgeTypes","MAWDbChunkTxns","MAWDbMsg","MAWDbMsgTxns","MAWDexieTable","MAWGating.re","MAWHMACKey","MAWIndexedDb","MAWLLAMigrationUtils","MAWMediaDownloadManager","MAWTransactionMode","Promise","WAArmadilloApplication.pb","WAMsgType","err"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{media:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("handleMediaDownload",!1)))(function(a,e,f,g,h){var i=d("MAWHMACKey").genHMACPlaintextHash(e);return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,h),a.media.where("hashedPlaintextHash").equals(i).first(),d("MAWDbChunkTxns").getOrCreateMediaChunk(a,e,i,g,f)]).then(function(a){var e=a[0],h=a[1];a[2];if(h==null)throw c("err")("media is null when storing downloaded blob");a=d("MAWMediaDownloadManager").getFromMediaDownloadManager(h.mediaId);a!=null&&(a(b("Promise").resolve(new Blob([g],{type:f}))),d("MAWMediaDownloadManager").removeFromMediaDownloadManager(h.mediaId));if(e&&(e.type===d("WAMsgType").MSG_TYPE.XMA||((a=e.quote)==null?void 0:a.content.xmaMessageType)===d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_EXTENDED_CONTENT_MESSAGE_EXTENDEDCONTENTTYPE.FB_STORY_REPLY)&&c("MAWGating.re").isXMAFeedPostShareEnabled())return;e=h.msgIds.map(d("MAWDbMsg").getThreadIdFromMsgId);e.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:d("MAWBridgeTypes").createBridgeMedia(a,h,!0)})})})});g.handleMediaDownload=a},98);
__d("MAWCastToServerMediaType",[],function(a,b,c,d,e,f){"use strict";function a(a){switch(a){case"image":case"xma-image":case"video":case"ptt":case"gif":case"sticker":return a;default:return null}}f.castToServerMediaType=a},66);
__d("MAWUpdateMediaEntryForMsgApi",["FBLogger","MAWBridgeTypes","MAWCastToMsgrServerMediaType","MAWCastToServerMediaType","MAWDbMediaTxns","MAWDbMsgTxns","MAWDexieTable","MAWGating.re","MAWHMACKey","MAWIndexedDb","MAWJidUtils","MAWLLAMigrationUtils","MAWMediaApiTypes","MAWTransactionMode","WALogger","WAMediaUtils","err"],function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Nothing to update if updatedMediaEntry is null"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose([""," msgId does not exist within media entries"]);i=function(){return a};return a}a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{media:d("MAWTransactionMode").READWRITE,messages:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("updateMediaEntryForMsg",!1)))(function(a,b,e,f,g,j){var k=d("MAWCastToServerMediaType").castToServerMediaType(j);if(!k){c("FBLogger")("labyrinth_web","unsupported_media").mustfix("unsupported media type");throw c("err")("Media type unsupported: "+((k=j)!=null?k:""))}k=d("MAWHMACKey").genHMACPlaintextHash(b);return d("MAWDexieTable").dexieAll([d("MAWDbMediaTxns").maybeGetMediaFromHash(a,k),d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,e)]).then(function(b){var k=b[0];b=b[1];if(!b)throw c("err")("Message does not exist for the given protocolMsgId");if(!k)throw c("err")("Media does not exist for the given hashedPlaintextHash");if(!k.msgIds.includes(b.msgId)){d("WALogger").LOG(i(),b.msgId);return}var l=k.mediaEntries,m=l.get(b.msgId);m=f(m);if(m==null){d("WALogger").LOG(h());return}k=babelHelpers["extends"]({},k,{mediaEntries:l.set(b.msgId,m)});g!=null&&(k=babelHelpers["extends"]({},k,{objectId:d("WAMediaUtils").stringToDeliveryObjectId(g)}));return a.media.put(k).then(function(){if(d("MAWGating.re").isAttachmentBackupEnabled()){var a=d("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(j);g!=null&&a!=null&&d("MAWIndexedDb").afterTransaction({tag:"UploadAttachment",value:d("MAWBridgeTypes").createBridgeUploadAttachment(g,a,e.externalId,d("MAWMediaApiTypes").MSGR_PRODUCT_TYPE,d("MAWJidUtils").threadIdForChatJid(e.chat))})}})})});g.updateMediaEntryForMsg=a},98);
__d("MAWUpdateMediaEntryForOptimisticUploadApi",["MAWGlobals","MAWOptimisticUploadManager","MAWUpdateMediaEntryForMsgApi","err","regeneratorRuntime"],function(a,b,c,d,e,f,g){a=function(a,e,f,g){var h,i,j,k,l;return b("regeneratorRuntime").async(function(m){while(1)switch(m.prev=m.next){case 0:h=d("MAWOptimisticUploadManager").getOptimisticUploadManager();i=h.get(a);j=i==null?void 0:i.msgId;k=e();if(!j){m.next=13;break}m.next=7;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().getProtocolMsgIdByMsgId(j));case 7:l=m.sent;if(!l){m.next=11;break}m.next=11;return b("regeneratorRuntime").awrap(d("MAWUpdateMediaEntryForMsgApi").updateMediaEntryForMsg(a,l,e,f,g));case 11:m.next=16;break;case 13:if(i){m.next=15;break}throw c("err")("Cannot update mediaEntry without both uploadEntry and msgId");case 15:h.set(a,babelHelpers["extends"]({},i,{mediaEntry:k}));case 16:return m.abrupt("return");case 17:case"end":return m.stop()}},null,this)};g.updateMediaEntryForOptimisticUpload=a},98);
__d("MAWHandleIncomingCiphertextMsgApi",["MAWAckLevel.re","MAWBridge","MAWDbMsg","MAWWriteMsgTxns","WALogger","WAMsgType","WAOdsEnums","WAResultOrError"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleIncomingCiphertextMsg: Message from ",", chat ",""]);h=function(){return a};return a}function a(a,b,c,e){var f=b.chat,g=b.externalId;b=b.author;c={type:d("WAMsgType").MSG_TYPE.CIPHERTEXT,ts:c,serverTs:c,externalId:g,author:b,ack:d("MAWAckLevel.re").ACK.received,altIndex:d("MAWDbMsg").UNDEFINED_ALT_INDEX};d("WALogger").DEV(h(),b,f);return d("MAWWriteMsgTxns").writeIncomingMsg(a,c,f,e).then(function(a){if(a.success){d("MAWBridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:d("WAOdsEnums").Entity.WEB_PLACEHOLDER,key:"ciphertext"});return d("WAResultOrError").makeSuccess(null)}return a})}g.handleIncomingCiphertextMsgInternal=a},98);
__d("MAWHandleIncomingMsgApi",["MAWAbProps","MAWAdminMsgBuildTxns","MAWBridge","MAWDbIdentityTxns","MAWDexieTable","MAWEphemeralMsgTxns","MAWEphemeralSettingsTxns","MAWEphemeralUtil","MAWGating.re","MAWGetMsgQuoteTxn","MAWGlobals","MAWJids","MAWMsgReceiptPreparationTxns","MAWPendingReceiptProcessingTxns","MAWProtoMsgToDbMsg","MAWProtoV3MsgToDbMsg","MAWQplProxy","MAWUnstoredContentToUnstoredDbContentUtils","MAWUpdateDevicesForUserApi","MAWWriteMsgTxns","MAWWriteReactionTxns","WAArmadilloApplication.pb","WAAssertUnreachable","WAE2E.pb","WAICDCUtils","WAJids","WALogger","WAMsgType","WAOdsEnums","WAParseProtocol","WAParseV3Protocol","WAResultOrError","WASignalKeys","WATimeUtils","decodeProtobuf","err","gkx","qpl"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleIncomingMsgInternal: Finished writing the incoming message"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleIncomingMsgInternal: Message from ",", chat ",", type ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleIncomingMsgInternal: Reaction from ",", chat ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["The number of ICDC failures is higher "," than allowed amount ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["ICDCError ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Received non-user jid during ICDC validation"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Received message without ICDC payload"]);n=function(){return a};return a}function o(a){var b=a.msg,c=a.externalId,e=a.author,f=a.serverTs,g=a.chat;a=a.reportingMeta;var h;if(b.version==="v3"&&b.type==="ephemeral")h=d("MAWEphemeralUtil").buildUnstoredDbEphemeralSettingMsgWithoutContentPlaceholder(f);else if(b.version==="v3")h=d("MAWProtoV3MsgToDbMsg").protoV3MsgToDbMsg(b,g,c,e,f);else{var i=d("decodeProtobuf").decodeProtobuf(d("WAE2E.pb").MessageSpec,b.encoded);c={externalId:c,jid:g,author:e,ts:f,proto:i,bytes:b.encoded};h=d("MAWProtoMsgToDbMsg").protoMsgToDbMsg(c)}a!=null&&h.unstoredDbMsg!=null&&(h.unstoredDbMsg.reportingMeta=a);return h}function p(a){var b=a.msg,c=a.externalId,e=a.author,f=a.serverTs,g=a.chat;a=a.reportingMeta;if(b.version==="v3"&&b.type==="ephemeral"){var h=d("MAWEphemeralUtil").buildUnstoredDbEphemeralSettingMsgWithoutContentPlaceholder(f);a!=null&&h.unstoredDbMsg!=null&&(h.unstoredDbMsg.reportingMeta=a);return h}if(b.version==="v3")h=d("WAParseV3Protocol").parseV3Protocol(b,g,c,e,f);else{var i=d("decodeProtobuf").decodeProtobuf(d("WAE2E.pb").MessageSpec,b.encoded);c={externalId:c,jid:g,author:e,ts:f,proto:i,bytes:b.encoded};h=d("WAParseProtocol").parseProtocol(c)}a!=null&&h.unstoredMsg!=null&&(h.unstoredMsg.reportingMeta=a);return d("MAWUnstoredContentToUnstoredDbContentUtils").unstoredContentToUnstoredDbContent(h)}function q(a,b,e,f,g){if(!d("MAWGating.re").isICDCEnabled())return d("MAWDexieTable").dexieResolve([]);if(b.icdc==null){d("WALogger").DEV(n());return d("MAWDexieTable").dexieResolve([])}var h=b.icdc;b=[{jid:f,identity:h.senderIdentity}].concat(h.recipientIdentities.map(function(a,b){return{jid:h.recipientUserJids[b],identity:a}}));f=b.map(function(b){return function(){var f=d("WAJids").interpretAndValidateJid(b.jid),h=b.identity;if(f.jidType!=="msgrUser"){d("WALogger").ERROR(m());return d("MAWDexieTable").dexieResolve(null)}return a.contacts.get(f.userJid).then(function(b){var i;if(b==null)return{jid:f.userJid,icdcResult:{action:"none"}};var j=d("WAICDCUtils").validateICDCInfo(h,b==null?void 0:b.icdcInfo,(b==null?void 0:(i=b.icdcInfo)==null?void 0:i.devices.map(function(a){return d("WASignalKeys").serializeIdentity(a)}))||[]);if(j.action==="error"){d("WALogger").WARN(l(),j);i=j.failureTs;var m=[];(b==null?void 0:b.icdcFails)!=null&&(m=b.icdcFails);if(m.length>0&&d("WATimeUtils").futureUnixTime(d("MAWAbProps").getAbProp("msgrw_icdc_cooldown_interval_in_minutes")*60,m[m.length-1].timeBucket)>i)return{jid:f.userJid,icdcResult:j};while(m.length>0&&m[0].timeBucket<d("WATimeUtils").pastUnixTime(d("MAWAbProps").getAbProp("msgrw_icdc_interval_in_minutes")*60,i))m.shift();var n=d("MAWAbProps").getAbProp("msgrw_icdc_alert_trigger_failure_count"),o=m.length+1>=n&&!m.some(function(a){return a.alert!=null&&a.alert===!0});m.push({timeBucket:i,alert:o});i=d("MAWDexieTable").dexieResolve();o&&(d("WALogger").WARN(k(),m.length,n),d("MAWQplProxy").startQplUserFlow(c("qpl")._(25313187,"549")).endFail("icdc_error"),d("MAWGating.re").isICDCErrorEnabled()&&(i=d("MAWAdminMsgBuildTxns").writeICDCAlert(a,e,f.userJid,g).then(function(){})));return i.then(function(){return a.contacts.put(babelHelpers["extends"]({},b,{icdcFails:m,dhash:j.sync?null:b.dhash})).then(function(){return{jid:f.userJid,icdcResult:j}})})}return{jid:f.userJid,icdcResult:j}})}});return d("MAWDexieTable").dexieSequentialAll(f).then(function(a){var b=[];for(var a=a,c=Array.isArray(a),e=0,a=c?a:a[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var f;if(c){if(e>=a.length)break;f=a[e++]}else{e=a.next();if(e.done)break;f=e.value}f=f;f!=null&&b.push(f)}return d("MAWDexieTable").dexieResolve(b)})}function a(a,b,e,f,g,k,l,m){var n=b.chat,s=b.externalId,t=b.author,u=d("WAJids").isAuthorMe(t)?d("MAWGlobals").getMyUserJid():t,v=d("MAWJids").toDeviceJid(u,e.id);return d("MAWDbIdentityTxns").hasDeviceJid(a,v).then(function(b){return q(a,g,n,u,f).then(function(q){var w=!b,x=c("gkx")("5734")?p({msg:g,externalId:s,author:t,serverTs:f,chat:n,folder:l,reportingMeta:m}):o({msg:g,externalId:s,author:t,serverTs:f,chat:n,folder:l,reportingMeta:m}),y=x.unstoredDbMsg,z=x.unstoredDbMedia,A=x.unstoredDbReaction,B=x.unstoredXMA;if(A!=null){d("WALogger").LOG(j(),t,n);return d("MAWWriteReactionTxns").writeIncomingReactionMsg(a,A,n,w,q)}if(y==null)return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeSuccess({icdcResults:q,protocolMsgId:null,plaintextHashs:null,unknownDevice:w}));k!=null;var C=e.identity;if(w&&C==null)return d("WAResultOrError").makeError("identity_missing");x=d("MAWDexieTable").dexieResolve();C!=null&&(x=d("MAWUpdateDevicesForUserApi").getAllDeviceJidsForUser(a,u).then(function(b){return d("MAWDbIdentityTxns").bulkGetIdentities(a,b).then(function(c){c.push({id:v,identity:C});return d("MAWUpdateDevicesForUserApi").updateDeviceIdentities(a,u,c,b).then(function(){})})}));return x.then(function(){return d("MAWGetMsgQuoteTxn").enhanceMsgWithQuoteInfo(a,y,n).then(function(b){var j;d("WALogger").LOG(i(),t,n,b.type);switch(b.type){case d("WAMsgType").MSG_TYPE.TEXT:case d("WAMsgType").MSG_TYPE.FUTUREPROOF:j=d("MAWWriteMsgTxns").writeIncomingMsg(a,b,n,l).then(function(a){return a.success?d("WAResultOrError").makeSuccess({dbMsg:a.value,dbMedias:null}):a});break;case d("WAMsgType").MSG_TYPE.REVOKED:j=d("MAWWriteMsgTxns").writeIncomingRevokeMsg(a,b,n,l).then(function(a){return a.success?d("WAResultOrError").makeSuccess({dbMsg:a.value,dbMedias:null}):a});break;case d("WAMsgType").MSG_TYPE.IMAGE:case d("WAMsgType").MSG_TYPE.VIDEO:case d("WAMsgType").MSG_TYPE.PTT:case d("WAMsgType").MSG_TYPE.GIF:case d("WAMsgType").MSG_TYPE.STICKER:if(!z)return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeSuccess({icdcResults:q,protocolMsgId:null,plaintextHashs:null,unknownDevice:w}));j=d("MAWWriteMsgTxns").writeIncomingMediaMsg(a,b,z,n,l);break;case d("WAMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:if(g.version==="v3"&&g.type==="ephemeral"){if(!d("MAWGating.re").isEphemeralMessagesEnabled())return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeSuccess({icdcResults:q,protocolMsgId:null,plaintextHashs:null,unknownDevice:w}));j=d("MAWEphemeralSettingsTxns").handleAndWriteIncomingEphemeralSetting(a,u,e,{ephemeralExpirationInSec:g.ephemeralExpirationInSec,ephemeralLastUpdatedOrSetTimestamp:g.ephemeralLastUpdatedOrSetTimestamp},n,f,s).then(function(a){var b;return a.success?d("WAResultOrError").makeSuccess({dbMsg:(b=a.value)==null?void 0:b.dbEphemeralSettingMsg,dbMedias:null,outOfSyncEphemeralSetting:(b=a.value)==null?void 0:b.outOfSyncEphemeralSetting}):a})}else throw c("err")("Unexpected msg type when writing ephemeral setting message");break;case d("WAMsgType").MSG_TYPE.ICDC_ALERT:if(!d("MAWGating.re").isICDCEnabled())return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeSuccess({icdcResults:q,protocolMsgId:null,plaintextHashs:null,unknownDevice:w}));j=d("MAWWriteMsgTxns").writeIncomingICDCAlertMsg(a,n,u,f,l).then(function(a){return a.success?d("WAResultOrError").makeSuccess({dbMsg:a.value,dbMedias:null}):a});break;case d("WAMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:if(!d("MAWGating.re").isEphemeralMessagesEnabled())return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeSuccess({icdcResults:q,protocolMsgId:null,plaintextHashs:null,unknownDevice:w}));j=d("MAWWriteMsgTxns").writeIncomingEphemeralScreenshotActionMsg(a,u,f,n,b.msgContent.screenshotActionType,l,s).then(function(a){return a.success?d("WAResultOrError").makeSuccess({dbMsg:a.value,dbMedias:null}):a});break;case d("WAMsgType").MSG_TYPE.XMA:if(!d("MAWGating.re").isXMAFeedPostShareEnabled()||B==null)return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeSuccess({icdcResults:q,protocolMsgId:null,plaintextHashs:null,unknownDevice:w}));j=r(a,b,B,n,l);break;case d("WAMsgType").MSG_TYPE.CIPHERTEXT:case d("WAMsgType").MSG_TYPE.UNAVAILABLE:case d("WAMsgType").MSG_TYPE.EXPIRED_EPHEMERAL:case d("WAMsgType").MSG_TYPE.ADMIN:throw c("err")("We do not support handleIncomingMsgInternal with msg in "+b.type+" type","messenger_e2ee_web");default:return c("WAAssertUnreachable")(b.type)}return j.then(function(b){if(!b.success)return b;var c=b.value.dbMsg,g=d("MAWDexieTable").dexieResolve(),i=d("MAWDexieTable").dexieResolve();if(c!=null){if(c.type===d("WAMsgType").MSG_TYPE.DELETE_FOR_ME){var j=b.value,k=j.dbMsg;j=j.dbMedias;k=k&&!d("WAJids").isAuthorSystem(k.author)?{author:k.author,chat:n,externalId:k.externalId}:null;j=j!=null?j.map(function(a){return a.plaintextHash}):null;return d("WAResultOrError").makeSuccess({icdcResults:q,protocolMsgId:k,plaintextHashs:j,unknownDevice:w})}c.type===d("WAMsgType").MSG_TYPE.FUTUREPROOF&&d("MAWBridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:d("WAOdsEnums").Entity.WEB_PLACEHOLDER,key:"unknown_futureproof"});i=d("MAWEphemeralMsgTxns").maybeUpdateEphemeralSettingOrCheckOutOfSyncAfterWritingIncomingMsg(a,c,u,n,e,f,b.value.outOfSyncEphemeralSetting);t===d("WAJids").AUTHOR_ME?g=d("MAWMsgReceiptPreparationTxns").prepareReceiptForMsg(a,c.msgId,n,!1).then(function(){return d("MAWPendingReceiptProcessingTxns").processPendingReceipts(a,n,c)}):g=d("MAWPendingReceiptProcessingTxns").processPendingReceipts(a,n,c)}return i.then(function(a){return g.then(function(){d("WALogger").LOG(h());var e=b.value,c=e.dbMsg;e=e.dbMedias;c=c&&!d("WAJids").isAuthorSystem(c.author)?{author:c.author,chat:n,externalId:c.externalId}:null;e=e!=null?e.map(function(a){return a.plaintextHash}):null;return d("WAResultOrError").makeSuccess({icdcResults:q,protocolMsgId:c,plaintextHashs:e,outOfSyncEphemeralSetting:(c=a)!=null?c:void 0,unknownDevice:w})})})})})})})})}function r(a,b,e,f,g){var h=d("MAWDexieTable").dexieResolve();switch(e.unstoredDbXMA.targetType){case d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_EXTENDED_CONTENT_MESSAGE_EXTENDEDCONTENTTYPE.FB_STORY_REPLY:h=d("MAWWriteMsgTxns").writeIncomingXMAReplyMsg(a,b,e,f,g);break;case d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_EXTENDED_CONTENT_MESSAGE_EXTENDEDCONTENTTYPE.FB_FEED_SHARE:case d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_EXTENDED_CONTENT_MESSAGE_EXTENDEDCONTENTTYPE.FB_STORY_SHARE:h=d("MAWWriteMsgTxns").writeIncomingXMAMsg(a,b,e,f,g);break;default:throw c("err")("We do not support XMA type "+e.unstoredDbXMA.targetType)}return h}g.icdcCheck=q;g.handleIncomingMsgInternal=a},98);
__d("MAWHandleUnavailableMsgApi",["MAWAckLevel.re","MAWBridge","MAWDbMsg","MAWWriteMsgTxns","WALogger","WAMsgType","WAOdsEnums","WAResultOrError"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleUnavailableMsg: Message from ",", chat ",""]);h=function(){return a};return a}function a(a,b,c){var e=b.chat,f=b.externalId;b=b.author;c={type:d("WAMsgType").MSG_TYPE.UNAVAILABLE,ts:c,serverTs:c,externalId:f,author:b,ack:d("MAWAckLevel.re").ACK.failed,altIndex:d("MAWDbMsg").UNDEFINED_ALT_INDEX};d("WALogger").DEV(h(),b,e);return d("MAWWriteMsgTxns").writeIncomingMsg(a,c,e).then(function(a){if(a.success){d("MAWBridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:d("WAOdsEnums").Entity.WEB_PLACEHOLDER,key:"unavailable"});return d("WAResultOrError").makeSuccess(null)}return a})}g.handleUnavailableMsgInternal=a},98);
__d("MAWPromiseCastToDexie",[],function(a,b,c,d,e,f){function g(h){return h}f.promiseCastToDexie=g},66);
__d("MAWBulkHandleIncomingMsgApi",["MAWContactStore","MAWDexieTable","MAWGroupInfoStore","MAWHandleIncomingCiphertextMsgApi","MAWHandleIncomingMsgApi","MAWHandleUnavailableMsgApi","MAWIndexedDb","MAWMediaStore","MAWMessageStore","MAWParticipantsStore","MAWPendingReceiptsStore","MAWPendingStanzasStore","MAWPromiseCastToDexie","MAWReceiptsStore","MAWTransactionMode","WAHandleIncomingMsgTransactor","WAResultOrError","gkx","qpl"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE,chunk:d("MAWTransactionMode").READONLY,participants:d("MAWTransactionMode").READWRITE,receipts:d("MAWTransactionMode").READWRITE,pendingReceipts:d("MAWTransactionMode").READWRITE,identity:d("MAWTransactionMode").READONLY,contacts:d("MAWTransactionMode").READWRITE,reactions:d("MAWTransactionMode").READWRITE,meta:d("MAWTransactionMode").READONLY,groupInfo:d("MAWTransactionMode").READWRITE,media:d("MAWTransactionMode").READWRITE,existingUsers:d("MAWTransactionMode").READWRITE,personalSenderKeyStatuses:d("MAWTransactionMode").READWRITE,pendingStanzas:d("MAWTransactionMode").READWRITE,unrenderedMessages:d("MAWTransactionMode").READWRITE,appMeta:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READWRITE},c("qpl")._(25311150,"7077"))(function(a,b){var e=d("MAWDexieTable").dexieResolve(),f=[];b.forEach(function(b){switch(b.type){case"IncomingMsg":var g=b.msg,h=b.folder,i=b.device,j=b.ts,k=b.recipientsCount,l=b.id,m=b.reportingMeta;e=e.then(function(){return(c("gkx")("801")?d("MAWPromiseCastToDexie").promiseCastToDexie(d("WAHandleIncomingMsgTransactor").handleIncomingMsgTransactor({MessagesStore:new(d("MAWMessageStore").MAWMessageStore)(a),ParticipantsStore:new(d("MAWParticipantsStore").MAWParticipantsStore)(a),ReceiptsStore:new(d("MAWReceiptsStore").MAWReceiptsStore)(a),ContactsStore:new(d("MAWContactStore").MAWContactsStore)(a),GroupInfoStore:new(d("MAWGroupInfoStore").MAWGroupInfoStore)(a),PendingStanzasStore:new(d("MAWPendingStanzasStore").MAWPendingStanzasStore)(a),PendingReceiptsStore:new(d("MAWPendingReceiptsStore").MAWPendingReceiptsStore)(a),MediaStore:new(d("MAWMediaStore").MAWMediaStore)(a)},l,i,j,g,h,m)):d("MAWHandleIncomingMsgApi").handleIncomingMsgInternal(a,l,i,j,g,k,h,m)).then(function(b){f.push(b);if(!b.success&&b.error==="identity_missing")return d("MAWHandleIncomingCiphertextMsgApi").handleIncomingCiphertextMsgInternal(a,l,j)}).then(function(){})});break;case"IncomingCiphertextMsg":var n=b.ts,o=b.id;e=e.then(function(){if(!b.createPlaceholder){f.push(d("WAResultOrError").makeSuccess());return d("MAWDexieTable").dexieResolve()}else return d("MAWHandleIncomingCiphertextMsgApi").handleIncomingCiphertextMsgInternal(a,o,n).then(function(a){return f.push(a)})});break;default:var p=b.ts,q=b.id;e=e.then(function(){return d("MAWHandleUnavailableMsgApi").handleUnavailableMsgInternal(a,q,p).then(function(a){return f.push(a)})})}});return e.then(function(){return f})});g.bulkHandleIncomingMsgs=a},98);
__d("MAWGetLastMsgsInChatForSpamReportApi",["MAWDbMediaTxns","MAWDbMsg","MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WAMsgType","err"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{messages:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,unrenderedMessages:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getLastMsgsInChatForSpamReport",!1)))(function(a,b,e){return e===0?d("MAWDexieTable").dexieResolve([]):a.threads.get({jid:b}).then(function(b){if(b==null)throw c("err")("Missing thread");b=b.chatId;var f=a.unrenderedMessages.where("thread").equals(b).filter(function(a){return a.type===d("WAMsgType").MSG_TYPE.DELETE_FOR_ME}).reverse().limit(e).toArray().then(function(a){var b=[];a.forEach(function(a){a.type===d("WAMsgType").MSG_TYPE.DELETE_FOR_ME&&b.push(a)});return b});return a.messages.where("thread").equals(b).filter(function(a){return d("MAWDbMsg").isContentMsg(a)}).reverse().limit(e).toArray().then(function(a){return f.then(function(b){return b.concat(a)})}).then(function(a){return a.sort(function(a,b){return a.msgId<b.msgId?-1:a.msgId>b.msgId?1:0}).slice(0,e)}).then(function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){return d("MAWDbMediaTxns").getAndCheckMediaFromMsg(a,b).then(function(a){return{msg:b,mediaInfo:a.success?a.value:null}})}))})})});g.getLastMsgsInChatForSpamReport=a},98);
__d("MAWGetMsgForRetryApi",["MAWAckLevel.re","MAWAsMessageApplication","MAWDbGroupInviteTxns","MAWDbMediaTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbParticipant","MAWDbReaction","MAWDbReactionsTxns","MAWDbUnrenderedMsgTxns","MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWMediaTypeAttribute","MAWTransactionMode","WAJids","WALogger","WAMsgType","WAResultOrError","WATimeUtils","err"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Found both regular and unrendered message with the same protocol msg ID"]);h=function(){return a};return a}var i=30*24*60*60,j=new Set([d("MAWAckLevel.re").ACK.failed,d("MAWAckLevel.re").ACK.expired,d("MAWAckLevel.re").ACK.contentGone,d("MAWAckLevel.re").ACK.contentTooBig,d("MAWAckLevel.re").ACK.contentUnuploadable]);a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{messages:d("MAWTransactionMode").READONLY,unrenderedMessages:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY,contacts:d("MAWTransactionMode").READONLY,receipts:d("MAWTransactionMode").READWRITE,media:d("MAWTransactionMode").READONLY,groupInvites:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getMsgForRetry",!1)))(function(a,b,c){return m(a,b,c).then(function(a){if(!a.success)return{type:a.error};a=a.value;if(a.type==="message")return d("MAWDexieTable").dexieResolve(k(a));else{a.type;return d("MAWDexieTable").dexieResolve(l(a))}})});function k(a){var b=a.msg,e=a.deviceIdentity,f=a.media,g=a.groupInvite;if(!d("MAWDbMsg").NO_CONTENT_MESSAGE_TYPES_ALLOWLIST.includes(b.type)&&!d("MAWDbMsg").isContentMsg(b))throw c("err")("We do not support converting to protoMsg with "+b.type+" type");f=d("MAWAsMessageApplication").asMessageApplication(b,f,g);var h=null,i=d("MAWMediaTypeAttribute").getMediaType(b),j=b.type===d("WAMsgType").MSG_TYPE.REVOKED;i!=null?h={type:"media",mediaType:i}:b.type===d("WAMsgType").MSG_TYPE.GROUP_INVITE&&g?h={type:"text",isRevoked:!1,invitedParticipantUserJid:d("MAWDbParticipant").getThreadIdAndUserJidFromParticipantId(g.invitedParticipantId).userJid}:h={type:"text",isRevoked:j};if(d("WAJids").isAuthorSystem(b.author))throw c("err")("We do not support sending system messages");return{type:"unacked",messageApplication:f,deviceIdentity:e,messageType:h,protocolMsgId:{externalId:b.externalId,author:b.author,chat:a.chat}}}function l(a){var b=a.reaction,e=a.deviceIdentity,f=d("MAWAsMessageApplication").asReactionMessageApplication(b);if(d("WAJids").isAuthorSystem(b.author))throw c("err")("We do not support sending system messages");return{type:"unacked",messageApplication:f,deviceIdentity:e,messageType:{type:"reaction"},protocolMsgId:{externalId:b.externalId,author:b.author,chat:a.chat}}}function m(a,b,e){return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b),d("MAWDbUnrenderedMsgTxns").maybeGetUnrenderedMsgByProtocolMsgId(a,b),d("MAWDbReactionsTxns").maybeGetReactionByProtocolMsgId(a,b),a.contacts.get(d("WAJids").extractUserJid(e))]).then(function(f){var g=f[0],i=f[1],j=f[2];f=f[3];var k=null,l=null,b=null,m=null,p=null,q=d("MAWDexieTable").dexieResolve(null);if(g!=null)i!=null&&d("WALogger").ERROR(h()),k=g.ack,l=g.ts,b=g.msgId,m=d("MAWDbMediaTxns").getAndCheckMediaFromMsg(a,g),p=g.thread;else if(i!=null)k=i.ack,l=i.ts,b=i.msgId,m=d("WAResultOrError").makeSuccess(),p=i.thread,q=d("MAWDbGroupInviteTxns").getAndCheckGroupInviteFromMsg(a,i);else if(j!=null)k=j.ack,l=j.ts,b=d("MAWDbReaction").reactionIdToMsgId(j.reactionId),m=d("WAResultOrError").makeSuccess();else return d("WAResultOrError").makeError("missing");return n(k,l,f,e)?d("WAResultOrError").makeError("unauthorized"):d("MAWDexieTable").dexieAll([o(a,b,e),m,p?a.threads.get(p):null,q]).then(function(a){var b=a[0],e=a[1],f=a[2];a=a[3];if(!b.success)return b;else if(!e.success)return e;var h=g||i;if(h!=null&&f!=null)return d("WAResultOrError").makeSuccess({type:"message",msg:h,deviceIdentity:b.value,media:e.value,chat:f.jid,groupInvite:a});else if(j!=null)return d("WAResultOrError").makeSuccess({type:"reaction",reaction:j,deviceIdentity:b.value,chat:j.threadJid});else throw c("err")("unknown item for retry")})})}function n(a,b,c,e){return j.has(a)||!d("WATimeUtils").happenedWithin(b,i)||c==null||c.devices.indexOf(e)<0}function o(a,b,c){return a.receipts.get(b).then(function(a){if(a==null)return d("WAResultOrError").makeError("unauthorized");a=a.permittedIdentitiesPerDevice;a=a==null?void 0:a.get(c);return a==null?d("WAResultOrError").makeError("unauthorized"):d("WAResultOrError").makeSuccess(a)})}g.getMsgForRetry=a},98);
__d("MAWGetMsgForSendingApi",["MAWAckLevel.re","MAWAsMessageApplication","MAWDbGroupInviteTxns","MAWDbMediaTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbParticipant","MAWDbThreadTxns","MAWDbUnrenderedMsgTxns","MAWDbXMATxns","MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWMediaTypeAttribute","MAWMsgRecipientsTxns","MAWRecipientDevicesTxns","MAWTransactionMode","MAWXMAUtils","WAJids","WAMsgType","WAResultOrError","err"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{messages:d("MAWTransactionMode").READONLY,unrenderedMessages:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY,contacts:d("MAWTransactionMode").READONLY,receipts:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,identity:d("MAWTransactionMode").READONLY,participants:d("MAWTransactionMode").READONLY,groupInvites:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getMsgForSending",!1)))(function(a,b){return h(a,b).then(function(a){if(!a.success)return{type:a.error};a=a.value;var b=a.msg,e=a.thread,f=a.recipients,g=a.media,h=a.groupInvite,i=a.icdcInfo,j=a.contactsSyncInfo;a=a.xmaPayload;if(!d("MAWDbMsg").NO_CONTENT_MESSAGE_TYPES_ALLOWLIST.includes(b.type)&&!d("MAWDbMsg").isContentMsg(b))throw c("err")("We do not support message sending with "+b.type+" type");g=d("MAWAsMessageApplication").asMessageApplication(b,g,h,a);var k=null,l=d("MAWMediaTypeAttribute").getMediaType(b),m=b.type===d("WAMsgType").MSG_TYPE.REVOKED;l!=null?k={type:"media",mediaType:l}:b.type===d("WAMsgType").MSG_TYPE.GROUP_INVITE&&h?k={type:"text",isRevoked:!1,invitedParticipantUserJid:d("MAWDbParticipant").getThreadIdAndUserJidFromParticipantId(h.invitedParticipantId).userJid}:k={type:"text",isRevoked:m};if(d("WAJids").isAuthorSystem(b.author))throw c("err")("A system message cannot be sent");return{type:"unsent",messageApplication:g,recipients:f,messageType:k,icdcInfo:i,contactsSyncInfo:j,protocolMsgId:{externalId:a!=null&&a.associatedMessage!=null?a.associatedMessage.externalId:b.externalId,author:b.author,chat:e.jid}}})});function h(a,b){return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b),d("MAWDbUnrenderedMsgTxns").maybeGetUnrenderedMsgByProtocolMsgId(a,b)]).then(function(c){var e=c[0];c=c[1];var f=e||c;if(f==null)return d("WAResultOrError").makeError("missing");else if(f.ack>d("MAWAckLevel.re").ACK.clock)return d("WAResultOrError").makeError("sent");var g;f.type===d("WAMsgType").MSG_TYPE.REVOKED?g=d("MAWMsgRecipientsTxns").getRevokedMsgRecipients(a,f.msgId):g=d("MAWMsgRecipientsTxns").getMsgRecipients(a,f.msgId);var h=d("MAWXMAUtils").maybeXMAMessage(e);return d("MAWDexieTable").dexieAll([d("MAWDbThreadTxns").getThread(a,f.thread),e?d("MAWDbMediaTxns").getAndCheckMediaFromMsg(a,e):d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeSuccess()),c?d("MAWDbGroupInviteTxns").getAndCheckGroupInviteFromMsg(a,c):d("MAWDexieTable").dexieResolve(),g,d("MAWRecipientDevicesTxns").getICDCInfoForUsersInThread(a,f.thread),h?d("MAWDbXMATxns").maybeGetXMAPayloadFromProtocolMsgId(a,b):null]).then(function(a){var b=a[0],c=a[1],e=a[2],g=a[3],h=a[4];a=a[5];if(!c.success)return c;if(!b.success||!h.success)return d("WAResultOrError").makeError("missing");if(a!=null&&!a.success)return d("WAResultOrError").makeError("missing");c=c.value;b=b.value;return d("WAResultOrError").makeSuccess({msg:f,thread:b,recipients:g,media:c,groupInvite:e,icdcInfo:h.value.icdcInfoList,contactsSyncInfo:h.value.contactsSyncInfo,xmaPayload:a!=null?a.value:null})})})}g.getMsgForSending=a},98);
__d("MAWGetMsgIdByProtocolMsgId",["MAWDbMsgTxns","MAWDbReactionsTxns","MAWDbUnrenderedMsgTxns","MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WAMsgType"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{messages:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READONLY,unrenderedMessages:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getMsgIdByProtocolMsgId",!1)))(function(a,b){return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b),d("MAWDbReactionsTxns").maybeGetReactionByProtocolMsgId(a,b),d("MAWDbUnrenderedMsgTxns").maybeGetUnrenderedMsgByProtocolMsgId(a,b)]).then(function(a){var b=a[0],c=a[1];a=a[2];if(b!=null)return b.msgId;else if(c!=null)return c.reactionId;else if(a!=null&&a.type===d("WAMsgType").MSG_TYPE.DELETE_FOR_ME)return a.msgId;else return null})});g.getMsgIdByProtocolMsgId=a},98);
__d("MAWGetNextDeleteDFMContentTs",["MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{unrenderedMessages:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getNextDeleteDFMContentTs",!1)))(function(a){var b=d("WATimeUtils").unixTime();return a.unrenderedMessages.orderBy("messageDeleteForMeTs").filter(function(a){return(a==null?void 0:a.messageDeleteForMeTs)!=null?a.messageDeleteForMeTs>=b:!1}).first().then(function(a){return a==null?void 0:a.messageDeleteForMeTs})});g.getNextDeleteDFMContentTs=a},98);
__d("MAWGetNextDeletePendingStanzaTs",["MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{pendingStanzas:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getNextDeletePendingStanzaTs",!1)))(function(a){var b=d("WATimeUtils").unixTime();return a.pendingStanzas.orderBy("deleteTs").filter(function(a){return a.deleteTs!=null?a.deleteTs>b:!1}).first().then(function(a){return a==null?void 0:a.deleteTs})});g.getNextDeletePendingStanzaTs=a},98);
__d("MAWGetNextDeleteUnsendContentTs",["MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{messages:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getNextDeleteUnsendContentTs",!1)))(function(a){var b=d("WATimeUtils").unixTime();return a.messages.orderBy("unsendMsgContentDeleteTs").filter(function(a){return(a==null?void 0:a.unsendMsgContentDeleteTs)!=null?a.unsendMsgContentDeleteTs>=b:!1}).first().then(function(a){return a==null?void 0:a.unsendMsgContentDeleteTs})});g.getNextDeleteUnsendContentTs=a},98);
__d("MAWGetNextExpiredXMATs",["MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{xma:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getNextDeleteUnsendContentTs",!1)))(function(a){var b=d("WATimeUtils").unixTime();return a.xma.orderBy("targetExpiringAtSec").filter(function(a){return(a==null?void 0:a.targetExpiringAtSec)!=null?a.targetExpiringAtSec>=b:!1}).first().then(function(a){return a==null?void 0:a.targetExpiringAtSec})});g.getNextExpiredXMATs=a},98);
__d("MAWGetProtocolMsgIdByMediaMsgId",["MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WAJids"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{messages:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getProtocolMsgIdByMediaMsgId",!1)))(function(a,b){return a.messages.get({msgId:b}).then(function(b){return b==null?null:a.threads.get(b.thread).then(function(a){if(a==null)return null;return d("WAJids").isAuthorSystem(b.author)?null:{externalId:b.externalId,author:b.author,chat:a.jid}})})});g.getProtocolMsgIdByMediaMsgId=a},98);
__d("MAWGetProtocolMsgIdByMsgId",["MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WAJids"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{messages:d("MAWTransactionMode").READONLY,unrenderedMessages:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getProtocolMsgByMsgId",!1)))(function(a,b){return d("MAWDexieTable").dexieAll([a.messages.get({msgId:b}),a.unrenderedMessages.get({msgId:b}),a.reactions.get({reactionId:b})]).then(function(b){var c=b[0],e=b[1];b=b[2];if(b!=null)if(d("WAJids").isAuthorSystem(b.author))return null;else return{externalId:b.externalId,author:b.author,chat:b.threadJid};var f=c||e;return f==null?null:a.threads.get(f.thread).then(function(a){if(a==null)return null;return d("WAJids").isAuthorSystem(f.author)?null:{externalId:f.externalId,author:f.author,chat:a.jid}})})});g.getProtocolMsgIdByMsgId=a},98);
__d("MAWHandleConnectedAdminMsgApi",["MAWAdminMsgBuildTxns","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WALogger"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleConnectedAdminMsg: chat ",""]);h=function(){return a};return a}a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{messages:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READONLY,groupInfo:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("handleConnectedAdminMsg",!1)))(function(a,b){d("WALogger").DEV(h(),b);return d("MAWAdminMsgBuildTxns").writeUsersConnectedAdminMsg(a,b).then(function(){})});g.handleConnectedAdminMsg=a},98);
__d("MAWHandleReachabilityErrorAdminMsgApi",["MAWAdminMsgBuildTxns","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WALogger"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleReachabilityErrorAdminMsg: chat ",""]);h=function(){return a};return a}a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{messages:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READONLY,groupInfo:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("handleReachabilityErrorAdminMsg",!1)))(function(a,b){d("WALogger").DEV(h(),b);return d("MAWAdminMsgBuildTxns").writeReachabilityErrorAdminMsg(a,b).then(function(){})});g.handleReachabilityErrorAdminMsg=a},98);
__d("MAWMarkMsgDroppedApi",["MAWAckLevel.re","MAWDbMsgTxns","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{messages:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE,chunk:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("markMsgDropped",!1)))(function(a,b){return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b).then(function(b){return b==null?"missing":d("MAWDbMsgTxns").updateSystemAck(a,b.msgId,d("MAWAckLevel.re").ACK.expired).then(function(a){return a==null?"missing":a.ack<=d("MAWAckLevel.re").ACK.clock?"dropped":"sent"})})});g.markMsgDropped=a},98);
__d("MAWMarkMsgSentApi",["MAWAckLevel.re","MAWBridgeTypes","MAWDbMsgTxns","MAWDbUnrenderedMsgTxns","MAWDexieTable","MAWEphemeralMsgTxns","MAWEphemeralSettingsTxns","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WALogger","WAMsgType"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Found both regular and unrendered message with the same protocol msg ID"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Msg missing from DB"]);i=function(){return a};return a}a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{messages:d("MAWTransactionMode").READWRITE,unrenderedMessages:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READWRITE,chunk:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("markMsgSent",!1)))(function(a,b,c,e,f){e!=null;return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b),d("MAWDbUnrenderedMsgTxns").maybeGetUnrenderedMsgByProtocolMsgId(a,b)]).then(function(e){var g=e[0],j=e[1];if(g==null&&j==null){d("WALogger").LOG(i());return}else if(g!=null){d("MAWIndexedDb").afterTransaction({tag:"UpdateTrace",value:d("MAWBridgeTypes").createBridgeUpdateTraceData([g.externalId],"ReceivedSent")});j!=null&&d("WALogger").ERROR(h());return d("MAWDbMsgTxns").updateSystemAck(a,g.msgId,d("MAWAckLevel.re").ACK.sent,c,f).then(function(b){return d("MAWEphemeralMsgTxns").maybeUpdateEphemeralMessageWhenMarkedSent(a,b,c)})}else if(j!=null)return d("MAWDbUnrenderedMsgTxns").updateSystemAckForUnrenderedMsg(a,j.msgId,d("MAWAckLevel.re").ACK.sent).then(function(){if(j.type===d("WAMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE)return d("MAWEphemeralSettingsTxns").updateContactWhenEphemeralSettingChangeMarkedSent(a,b.chat,c)})}).then(function(){})});g.markMsgSent=a},98);
__d("MAWProcessFutureproofMsgApi",["MAWConvertFutureproofMsgTxns","MAWDbMsgTxns","MAWDbMsgTypeVersionTxns","MAWDbThreadTxns","MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWProtoV3MsgToDbMsg","MAWTransactionMode","WADecodeIncomingMsg","WAJids","WALogger","WAMsgType"],function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["processFutureProofMsgs doesn't support system message for ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["processFutureProofMsgs called for ephemeral setting msg"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["processFutureProofMsgs called for skdm"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["processFutureProofMsgs tried to decode non plaintext v3 message ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["processFutureProofMsgs get a futureproof message for ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["processFutureProofMsgs got error for message ",", delete this message"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["processFutureProofMsgs thread for "," no longer exists"]);n=function(){return a};return a}a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{messages:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE,appMeta:d("MAWTransactionMode").READWRITE,media:d("MAWTransactionMode").READWRITE,chunk:d("MAWTransactionMode").READONLY,contacts:d("MAWTransactionMode").READONLY,groupInfo:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("processFutureProofMsgs",!1)))(function(a,b){return d("MAWDbMsgTypeVersionTxns").getMsgTypeVersion(a).then(function(c){var e=[];if(c!=null&&c<b){d("MAWDbMsgTypeVersionTxns").updateMsgTypeVersion(a,b);return d("MAWDbMsgTxns").getFutureProofMsgs(a).then(function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){return d("MAWDbThreadTxns").getThread(a,b.thread).then(function(c){if(!c.success){d("WALogger").WARN(n(),b.thread);return}c=c.value;var f=c.jid,g=o(b,f);if(!g)return;if(g.msg.type==="error"){d("WALogger").WARN(m(),b.msgId);return d("MAWDbMsgTxns").deleteDbMsg(a,b.rowId).then(function(){})}f=d("MAWProtoV3MsgToDbMsg").protoV3MsgToDbMsg(g.msg,f,g.externalId,g.author,g.ts);g=f.unstoredDbMsg;f=f.unstoredDbMedia;if(!g)return;if(g.type===d("WAMsgType").MSG_TYPE.FUTUREPROOF){d("WALogger").WARN(l(),b.msgId);return}return d("MAWConvertFutureproofMsgTxns").convertFutureproofMsg(a,g,b,f,c).then(function(a){a!=null&&e.push(a)})})}))}).then(function(){return e})}else if(c==null)return d("MAWDbMsgTypeVersionTxns").addMsgTypeVersion(a,1).then(function(){return e});return e})});function o(a,b){var c=d("WADecodeIncomingMsg").decodeIncomingMsg(new Uint8Array(a.msgContent.protobuf),"v3",a.author===d("WAJids").AUTHOR_ME?b:null);if(c.version!=="v3"){d("WALogger").WARN(k(),a.msgId);return null}else if(c.type==="skdm"||c.type==="msgWithSKDM"){d("WALogger").WARN(j());return null}else if(c.type==="ephemeral"){d("WALogger").WARN(i());return null}var e=a.author;if(d("WAJids").isAuthorSystem(e)){d("WALogger").WARN(h(),a.msgId);return null}return{msg:c,externalId:a.externalId,author:e,ts:a.ts,chat:b}}g.processFutureProofMsgs=a},98);
__d("MAWProcessSpamMsgApi",["MAWBridgeTypes","MAWDbMsg","MAWDbMsgTxns","MAWDbThreadTxns","MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWThreadSnippetBuildTxns","MAWTransactionMode","WADualSendMsgUtils","WALogger","WAMsgType"],function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["processSpamMsgs: "," for thread ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["processSpamMsgs thread for "," no longer exists"]);i=function(){return a};return a}a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{messages:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READONLY,groupInfo:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("processSpamMsgs",!1)))(function(a){return d("MAWDbMsgTxns").getSpamMsgs(a).then(function(b){d("MAWDexieTable").dexieAll(b.map(function(b){var c=b.thread;return d("MAWDbThreadTxns").getThread(a,c).then(function(e){if(!e.success){d("WALogger").WARN(i(),c);return[]}e=e.value;d("WALogger").DEV(h(),b.rowId,e.chatId);b.type===d("WAMsgType").MSG_TYPE.FUTUREPROOF?b.altIndex=d("MAWDbMsg").FUTUREPROOF_ALT_INDEX:b.altIndex=d("MAWDbMsg").UNDEFINED_ALT_INDEX;return d("MAWDexieTable").dexieAll([a.messages.put(b),d("MAWDexieTable").dexieResolve(e),d("MAWThreadSnippetBuildTxns").buildThreadSnippet(a,b,e)])}).then(function(a){a[0];var e=a[1];a=a[2];if(!e)return;var f=e.jid,g=e.newestMsgTs,h=e.lastReadMsgTs;d("MAWIndexedDb").afterTransaction({tag:"StartTrace",value:d("MAWBridgeTypes").createBridgeStartTraceData(b,f)});d("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:d("MAWBridgeTypes").createBridgeMsg(b)});d("MAWIndexedDb").afterTransaction({tag:"ThreadBumped",value:d("MAWBridgeTypes").createBridgeBumpedThread(c,d("WADualSendMsgUtils").isDualSendJid(e.jid),g||b.ts,h,a.snippetType,a.snippetParams,a.snippetSenderContactId,!1)});e.oldestMsg==null&&d("MAWIndexedDb").afterTransaction({tag:"MsgsLoaded",value:d("MAWBridgeTypes").createBridgeMsgsLoadedInfo(c,[b],!0,!1)})})}))})});g.processSpamMsgs=a},98);
__d("MAWRemoveExpiredDFMMsgsContent",["MAWDeleteExpiredMsgsApi","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWLLAMigrationUtils","MAWTransactionMode","MAWXMAUtils","WAArmadilloApplication.pb","WAMsgType","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{media:d("MAWTransactionMode").READWRITE,unrenderedMessages:d("MAWTransactionMode").READWRITE,chunk:d("MAWTransactionMode").READWRITE,xma:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("removeExpiredDFMMsgsContent",!1)))(function(a){var b=d("WATimeUtils").unixTime();return a.unrenderedMessages.where("messageDeleteForMeTs").belowOrEqual(b).toArray().then(function(b){var c=b.map(function(a){if(a.mediaId!=null)return[a.mediaId,a.msgId]}).filter(Boolean),e=b.map(function(a){if(a.type===d("WAMsgType").MSG_TYPE.DELETE_FOR_ME)return babelHelpers["extends"]({},a,{mediaId:void 0,msgContent:void 0,xmaMessageType:void 0,quote:void 0})}).filter(Boolean),f=b.map(function(a){if(d("MAWXMAUtils").isXMAShare(a.xmaMessageType)&&a.externalId!=null){var b=d("MAWJidUtils").maybeToProtocolMsgId(a.author,a.threadJid,a.externalId);if(b!=null)return[b,a.msgId]}else if(a.quote!=null&&a.quote.content.xmaMessageType===d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_EXTENDED_CONTENT_MESSAGE_EXTENDEDCONTENTTYPE.FB_STORY_REPLY){b=d("MAWJidUtils").maybeToProtocolMsgId(a.quote.content.author,a.threadJid,a.quote.content.externalId);if(b!=null)return[b,a.msgId]}}).filter(Boolean);return d("MAWDexieTable").dexieAll([d("MAWDeleteExpiredMsgsApi").deleteOrUpdateXMAForExpiredMsgs(a,f),d("MAWDeleteExpiredMsgsApi").deleteOrUpdateMediaAndChunkForExpiredMsgs(a,c),a.unrenderedMessages.bulkPut(e)]).then(function(){return d("MAWDexieTable").dexieResolve(b.length)})})});g.removeExpiredDFMMsgsContent=a},98);
__d("MAWRemoveExpiredPendingStanzas",["MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{pendingStanzas:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("removeExpiredPendingStanzas",!1)))(function(a){var b=d("WATimeUtils").unixTime();return a.pendingStanzas.where("deleteTs").belowOrEqual(b).toArray().then(function(b){var c=b.map(function(a){return a.rowId});return a.pendingStanzas.bulkDelete(c).then(function(){return c.length})})});g.removeExpiredPendingStanzas=a},98);
__d("MAWRemoveExpiredUnsendMsgsContent",["MAWDeleteExpiredMsgsApi","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWLLAMigrationUtils","MAWTransactionMode","MAWXMAUtils","WAArmadilloApplication.pb","WAMsgType","WATimeUtils"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{media:d("MAWTransactionMode").READWRITE,messages:d("MAWTransactionMode").READWRITE,chunk:d("MAWTransactionMode").READWRITE,xma:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("removeExpiredUnsendMsgsContent",!1)))(function(a){var b=d("WATimeUtils").unixTime();return a.messages.where("unsendMsgContentDeleteTs").belowOrEqual(b).toArray().then(function(b){var c=b.map(function(a){if(a.mediaId!=null)return[a.mediaId,a.msgId]}).filter(Boolean),e=b.map(function(a){if(a.type===d("WAMsgType").MSG_TYPE.REVOKED)return babelHelpers["extends"]({},a,{mediaId:void 0,msgContent:void 0,xmaMessageType:void 0,quote:void 0})}).filter(Boolean),f=b.map(function(a){if(d("MAWXMAUtils").isXMAShare(a.xmaMessageType)&&a.revokedExternalId!=null){var b=d("MAWJidUtils").maybeToProtocolMsgId(a.author,a.threadJid,a.revokedExternalId);if(b!=null)return[b,a.msgId]}else if(a.quote!=null&&a.quote.content.xmaMessageType===d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_EXTENDED_CONTENT_MESSAGE_EXTENDEDCONTENTTYPE.FB_STORY_REPLY){b=d("MAWJidUtils").maybeToProtocolMsgId(a.quote.content.author,a.threadJid,a.quote.content.externalId);if(b!=null)return[b,a.msgId]}}).filter(Boolean);return d("MAWDexieTable").dexieAll([d("MAWDeleteExpiredMsgsApi").deleteOrUpdateXMAForExpiredMsgs(a,f),d("MAWDeleteExpiredMsgsApi").deleteOrUpdateMediaAndChunkForExpiredMsgs(a,c),a.messages.bulkPut(e)]).then(function(){return d("MAWDexieTable").dexieResolve(b.length)})})});g.removeExpiredUnsendMsgsContent=a},98);
__d("MAWRevokeMsgsApi",["MAWAckLevel.re","MAWDbMsg","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWMsgReceiptPreparationTxns","MAWTransactionMode","MAWWriteMsgTxns","WAExternalIdFromRandomHex","WAHex","WAJids","WATimeUtils","err"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{messages:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READONLY,groupInfo:d("MAWTransactionMode").READWRITE,receipts:d("MAWTransactionMode").READWRITE,participants:d("MAWTransactionMode").READWRITE,identity:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("revokeMsgs",!1)))(function(a,b,e){return d("MAWDexieTable").dexieAll(b.map(function(b){return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b),d("MAWDexieTable").dexieResolve(b)])})).then(function(b){return d("MAWDexieTable").dexieAll(b.filter(function(a){a=a[0];return a!=null}).filter(function(a){a=a[0];return(a==null?void 0:a.author)===d("WAJids").AUTHOR_ME}).map(function(b){var f=b[0];b=b[1];if(f==null)throw c("err")("This cannot happen because we filtered it but flow could not refine the type");if(f.type==="Revoked")return{icdcResults:null,protocolMsgId:b,plaintextHashs:null,unknownDevice:!1};var g=d("WAExternalIdFromRandomHex").externalIdFromRandomHex(d("WAHex").randomHex(7));return a.threads.get(f.thread).then(function(b){if(b==null)return{icdcResults:null,protocolMsgId:null,plaintextHashs:null,unknownDevice:!1};var c={type:"Revoked",ack:d("MAWAckLevel.re").ACK.clock,author:d("WAJids").AUTHOR_ME,externalId:g,altIndex:null,revokedExternalId:f.externalId,rowId:f.rowId,ts:e,msgId:f.msgId,thread:f.thread,threadJid:b.jid,originalTs:f.ts,unsendMsgContentDeleteTs:d("WATimeUtils").castToUnixTime(e+d("MAWWriteMsgTxns").REVOKE_CONTENT_EXPIRATION_IN_SEC),mediaId:f.mediaId,msgContent:d("MAWDbMsg").getMsgContent(f),quote:f.quote,xmaMessageType:f.xmaMessageType};return d("MAWDexieTable").dexieAll([d("MAWWriteMsgTxns").markMsgAsRevoke(a,f,c,b,!1),d("MAWMsgReceiptPreparationTxns").prepareReceiptForMsg(a,f.msgId,b.jid,!0,!0)]).then(function(){var a={icdcResults:null,protocolMsgId:{author:d("WAJids").AUTHOR_ME,chat:b.jid,externalId:g},plaintextHashs:null,unknownDevice:!1};return a})})}))})});g.revokeMsgs=a},98);
__d("MAWWriteForwardedMsgApi",["MAWAckLevel.re","MAWBridgeTypes","MAWDbMsg","MAWDbMsgTxns","MAWDbXMATxns","MAWDexieTable","MAWGating.re","MAWIndexedDb","MAWJidUtils","MAWMediaManagementTxns","MAWMsgReceiptPreparationTxns","MAWTransactionMode","MAWWriteMsgTxns","MAWXMAManagementTxns","MAWXMAUtils","WAJids","WAMsgType","err"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({receipts:d("MAWTransactionMode").READWRITE,messages:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE,media:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READONLY,identity:d("MAWTransactionMode").READONLY,participants:d("MAWTransactionMode").READONLY,groupInfo:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READWRITE})(function(a,b,c,e,f,g){return d("MAWDexieTable").dexieAll([a.threads.get({jid:c}),d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,e),a.messages.where("externalId").equals(b).toArray()]).then(function(c){var k=c[0],l=c[1];c=c[2];if(k==null)return{type:"missing_thread"};if(l==null)return{type:"missing_msg"};if(l.ephemeralSetting!=null&&l.ephemeralSetting.ephemeralExpirationInSec!==0)return{type:"forwarding_ephemeral_msg"};c=c.find(function(a){return a.thread===k.chatId&&a.author===d("WAJids").AUTHOR_ME});if(c!=null)return c.ack>=d("MAWAckLevel.re").ACK.sent?{type:"already_sent",protocolMsgId:{externalId:c.externalId,author:d("WAJids").AUTHOR_ME,chat:k.jid}}:{type:"not_sent",protocolMsgId:{externalId:c.externalId,author:d("WAJids").AUTHOR_ME,chat:k.jid}};else{var m;c=d("MAWDbMsg").craftMsgId(k.chatId,k.nextInChatMsgId);m={author:d("WAJids").AUTHOR_ME,externalId:b,thread:k.chatId,threadJid:k.jid,ack:d("MAWAckLevel.re").ACK.clock,ts:f,msgId:c,altIndex:d("MAWDbMsg").UNDEFINED_ALT_INDEX,isForwarded:l.author!==d("WAJids").AUTHOR_ME,forwardingScore:((m=l.forwardingScore)!=null?m:0)+1,mediaId:l.mediaId,msgContent:l.type==="Text"?l.msgContent:void 0,specialTextSize:l.specialTextSize,ephemeralSetting:d("MAWGating.re").isEphemeralMessagesEnabled()&&g!=null?g:void 0};var n=h(l.type,m,l.type==="Text"?l.msgContent:{content:""},l.xmaMessageType);m=l.mediaId;var o=j(a,e,n,l,k.chatId,k.jid);m=i(a,m,n,l,k.chatId);return d("MAWDexieTable").dexieAll([d("MAWWriteMsgTxns").writeMsg(a,n,k).then(function(a){a=a[0];return a}),d("MAWMsgReceiptPreparationTxns").prepareReceiptForMsg(a,c,k.jid),o,m]).then(function(a){return{type:"not_sent",protocolMsgId:{externalId:n.externalId,author:d("WAJids").AUTHOR_ME,chat:k.jid}}})}})});function h(a,b,e,f){switch(a){case"Text":return babelHelpers["extends"]({},b,{type:d("WAMsgType").MSG_TYPE.TEXT,msgContent:e});case"Image":return babelHelpers["extends"]({},b,{type:d("WAMsgType").MSG_TYPE.IMAGE});case"Video":return babelHelpers["extends"]({},b,{type:d("WAMsgType").MSG_TYPE.VIDEO});case"Ptt":return babelHelpers["extends"]({},b,{type:d("WAMsgType").MSG_TYPE.PTT});case"Gif":return babelHelpers["extends"]({},b,{type:d("WAMsgType").MSG_TYPE.GIF});case"Sticker":return babelHelpers["extends"]({},b,{type:d("WAMsgType").MSG_TYPE.STICKER});case"XMA":if(f==null)throw c("err")("XMA type is null in forward msg");return babelHelpers["extends"]({},b,{type:d("WAMsgType").MSG_TYPE.XMA,xmaMessageType:f});default:throw c("err")("Should not be forwarding a message of type: "+a)}}function i(a,b,e,f,g){b=b!=null?a.media.get({mediaId:b}):d("MAWDexieTable").dexieResolve(null);return b.then(function(b){if(b==null&&d("MAWDbMsg").isMediaMsg(e))throw c("err")("Could not find media of forwarded message");return b!=null?d("MAWMediaManagementTxns").linkMedia(a,e.msgId,b.plaintextHash,b.mediaType,b.size,b.mediaEntries.get(f.msgId),{validatedVideoInfo:b.validatedVideoInfo,validatedImageInfo:b.validatedImageInfo,validatedAudioInfo:b.validatedAudioInfo},b.hashedPlaintextHash).then(function(a){a!=null&&d("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:d("MAWBridgeTypes").createBridgeMedia(g,a,!0)})}):d("MAWDexieTable").dexieResolve()})}function j(a,b,e,f,g,h){return!d("MAWGating.re").isXMAFeedPostShareEnabled()||!d("MAWXMAUtils").isXMAShare(f.xmaMessageType)?d("MAWDexieTable").dexieResolve():d("MAWDbXMATxns").maybeGetXMAFromProtocolMsgId(a,b).then(function(b){if(b==null)return;var i=b.defaultPreviewMediaId,j=b.faviconMediaId,k=b.headerMediaId,l=Array.from(new Set([i,j,k].filter(Boolean)));l=l.map(function(b){return a.media.get(b).then(function(a){if(a==null)throw c("err")("Could not find media of forwarded xma message");return a})});return d("MAWDexieTable").dexieAll(l).then(function(l){l=l.map(function(b){return d("MAWMediaManagementTxns").linkMedia(a,e.msgId,b.plaintextHash,b.mediaType,b.size,b.mediaEntries.get(f.msgId),{validatedVideoInfo:b.validatedVideoInfo,validatedImageInfo:b.validatedImageInfo,validatedAudioInfo:b.validatedAudioInfo},b.hashedPlaintextHash,void 0,void 0,!0)});return d("MAWDexieTable").dexieAll(l).then(function(f){f=f.reduce(function(a,b){return a.set(b.mediaId,b)},new Map());var l=i==null?void 0:f.get(i);if(i==null)throw c("err")("Preview Media is missing");f=d("MAWJidUtils").maybeToProtocolMsgId(e.author,h,e.externalId);if(f==null)throw c("err")("ProtocolMsgId is null for forward XMA Share");return d("MAWXMAManagementTxns").saveXMA(a,i,k,j,b.targetType,e.msgId,void 0,f,{targetUsername:b.targetUsername,targetId:b.targetId,targetExpiringAtSec:b.targetExpiringAtSec,xmaLayoutType:b.xmaLayoutType,defaultCTA:b.defaultCTA,titleText:b.titleText,subtitleText:b.subtitleText,maxTitleNumOfLines:b.maxTitleNumOfLines,maxSubtitleNumOfLines:b.maxSubtitleNumOfLines,headerTitle:b.headerTitle,overlayIconGlyph:b.overlayIconGlyph,overlayTitle:b.overlayTitle,overlayDescription:b.overlayDescription}).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:d("MAWBridgeTypes").createBridgeXMA(g,l,a)})})})})})}g.writeForwardedMsg=a;g.maybeLinkMediaMsg=i;g.maybeLinkXMAShareMsg=j},98);
__d("MAWWriteMsgRetryApi",["MAWDbMsgTxns","MAWDbReaction","MAWDbReactionsTxns","MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{messages:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY,receipts:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("writeMsgRetry",!1)))(function(a,b,c,e){return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b),d("MAWDbReactionsTxns").maybeGetReactionByProtocolMsgId(a,b)]).then(function(b){var f=b[0];b=b[1];if(f!=null)f=f.msgId;else if(b!=null)f=d("MAWDbReaction").reactionIdToMsgId(b.reactionId);else return;return h(a,f,c,e)})});function h(a,b,c,d){return a.receipts.get(b).then(function(b){if(b==null||b.permittedIdentitiesPerDevice==null)return;var e=b.permittedIdentitiesPerDevice,f=e.get(c);if(f==null)return;f.baseKey=d;e.set(c,f);return a.receipts.update(b.msgId,{permittedIdentitiesPerDevice:e}).then(function(){})})}g.writeMsgRetry=a},98);
__d("MAWWriteOutgoingMsgApi",["MAWAckLevel.re","MAWAuthor","MAWDbContactsTxns","MAWDbMsg","MAWDbMsgTxns","MAWDexieTable","MAWGating.re","MAWIndexedDb","MAWLLAMigrationUtils","MAWLoadReplyMediaTxns","MAWMsgReceiptPreparationTxns","MAWTransactionMode","MAWWriteMsgTxns","WAAssertUnreachable","WAJids","WAMsgType","WATimeUtils","err"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{receipts:d("MAWTransactionMode").READWRITE,messages:d("MAWTransactionMode").READWRITE,unrenderedMessages:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READONLY,identity:d("MAWTransactionMode").READONLY,participants:d("MAWTransactionMode").READONLY,groupInfo:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("writeOutgoingMsg",!1)))(function(a,b,c,e,f,g){return d("MAWDexieTable").dexieAll([a.threads.get({jid:c}),a.messages.where("externalId").equals(b).toArray(),h(a,f.quote,c)]).then(function(c){var h=c[0],k=c[1];c=c[2];if(h==null)return{type:"missing_thread"};k=k.find(function(a){return a.thread===h.chatId&&a.author===d("WAJids").AUTHOR_ME});if(k!=null)return k.ack>=d("MAWAckLevel.re").ACK.sent?{type:"already_sent",protocolMsgId:{externalId:k.externalId,author:d("WAJids").AUTHOR_ME,chat:h.jid}}:{type:"not_sent",protocolMsgId:{externalId:k.externalId,author:d("WAJids").AUTHOR_ME,chat:h.jid}};else{k=d("MAWDbMsg").craftMsgId(h.chatId,h.nextInChatMsgId);if(!d("MAWDbMsg").isUnrenderedMsgType(g)){var m={author:d("WAJids").AUTHOR_ME,externalId:b,thread:h.chatId,threadJid:h.jid,ack:d("MAWAckLevel.re").ACK.clock,ts:e,msgId:k,altIndex:d("MAWDbMsg").UNDEFINED_ALT_INDEX,ephemeralSetting:d("MAWGating.re").isEphemeralMessagesEnabled()?f.ephemeralSetting:void 0,isForwarded:f.isForwarded,specialTextSize:f.specialTextSize},n=i(g,m,f,c);m=d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,n).then(function(b){return d("MAWWriteMsgTxns").writeMsg(a,n,h,f.optimisticMsg,f.openMessageOtid,b,!0)}).then(function(a){a=a[0];return a})}else{c={author:d("WAJids").AUTHOR_ME,externalId:b,thread:h.chatId,threadJid:h.jid,ack:d("MAWAckLevel.re").ACK.clock,ts:e,msgId:k};c=j(g,c,f);m=d("MAWWriteMsgTxns").writeUnrenderedMsg(a,c,h)}return d("MAWDexieTable").dexieAll([m,d("MAWMsgReceiptPreparationTxns").prepareReceiptForMsg(a,k,h.jid),l(a,g,h.jid,e)]).then(function(){return{type:"not_sent",protocolMsgId:{externalId:b,author:d("WAJids").AUTHOR_ME,chat:h.jid}}})}})});function h(a,b,c){return b==null?d("MAWDexieTable").dexieResolve(null):d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b).then(function(b){return b==null?null:a.threads.get(b.thread).then(function(a){var e=b?k(b):null;b.messageExpirationTs!=null&&b.messageExpirationTs<d("WATimeUtils").unixTime()&&e!=null&&(e=babelHelpers["extends"]({},e,{type:d("WAMsgType").MSG_TYPE.EXPIRED_EPHEMERAL,msgContent:void 0,mediaId:void 0,xmaMessageType:void 0}));if(a==null||a.jid===c)return{content:e,remoteJid:null};a=d("WAJids").interpretAndValidateJid(a.jid);a=a.jidType==="group"?a.groupJid:null;return{content:e,remoteJid:a}})})}function i(a,b,e,f){if(d("MAWDbMsg").isUnrenderedMsgType(a))throw c("err")("getNewMsg called for wrong message type "+a);var g,h;if(e.quote!=null&&(f==null?void 0:f.content)!=null){var i;h=f==null?void 0:(i=f.content)==null?void 0:i.externalId;g={remoteJid:(i=f==null?void 0:f.remoteJid)!=null?i:void 0,content:f==null?void 0:f.content}}i=babelHelpers["extends"]({},b,{quote:g,quoteExternalId:h});switch(a){case"Text":return babelHelpers["extends"]({},i,{type:d("WAMsgType").MSG_TYPE.TEXT,msgContent:{content:e.content!=null?e.content:""}});case"Image":return babelHelpers["extends"]({},i,{type:d("WAMsgType").MSG_TYPE.IMAGE});case"Video":return babelHelpers["extends"]({},i,{type:d("WAMsgType").MSG_TYPE.VIDEO});case"Ptt":return babelHelpers["extends"]({},i,{type:d("WAMsgType").MSG_TYPE.PTT});case"Gif":return babelHelpers["extends"]({},i,{type:d("WAMsgType").MSG_TYPE.GIF});case"Sticker":return babelHelpers["extends"]({},i,{type:d("WAMsgType").MSG_TYPE.STICKER});case"XMA":if(e.xmaMessageType==null)throw c("err")("XMA Message Missing xmaMessageType");return babelHelpers["extends"]({},i,{type:d("WAMsgType").MSG_TYPE.XMA,xmaMessageType:e.xmaMessageType});case"Revoked":case"DeleteForMe":case"Ciphertext":case"Futureproof":case"Unavailable":case"Admin":case"ExpiredEphemeral":case"EphemeralSettingAdmin":case"EphemeralScreenshotAction":case"AlertICDC":case"GroupInvite":case"Reaction":throw c("err")("Should not be writing ciphertext, futureproof, unsent, admin,\n        ephemeral setting messages, ephemeral screenshot action or group invite");default:throw c("WAAssertUnreachable")(a)}}function j(a,b,e){if(!d("MAWDbMsg").isUnrenderedMsgType(a))throw c("err")("getNewUnrenderedMsg called for wrong message type "+a);switch(a){case"EphemeralSyncResponse":if(e.ephemeralSetting==null)throw c("err")("Ephemeral Sync Response without ephemeral settings");return babelHelpers["extends"]({},b,{ephemeralSetting:e.ephemeralSetting,type:d("WAMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE});case"EphemeralSettingChangeFromCurrentDevice":if(e.ephemeralSetting==null)throw c("err")("Ephemeral Setting Change without ephemeral settings");return babelHelpers["extends"]({},b,{ephemeralSetting:e.ephemeralSetting,type:d("WAMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE});case"GroupInvite":var f=d("WAJids").interpretAsGroupJid(b.threadJid);if(f==null)throw c("err")("Group Invite without valid group jid");if(e.invitedParticipantUserJid==null)throw c("err")("Group Invite without invited user jid");return babelHelpers["extends"]({},b,{invitedParticipantUserJid:e.invitedParticipantUserJid,groupName:e.groupName==null?void 0:e.groupName,type:d("WAMsgType").MSG_TYPE.GROUP_INVITE});default:throw c("WAAssertUnreachable")(a)}}function k(a){var b={ts:a.ts,externalId:a.externalId,author:d("MAWAuthor").getAuthorUserJid(a.author)||d("WAJids").AUTHOR_ME,msgId:a.msgId,mediaId:a.mediaId,xmaMessageType:a.xmaMessageType,specialTextSize:a.specialTextSize};switch(a.type){case d("WAMsgType").MSG_TYPE.IMAGE:return babelHelpers["extends"]({},b,{type:d("WAMsgType").MSG_TYPE.IMAGE,msgContent:a.msgContent});case d("WAMsgType").MSG_TYPE.VIDEO:return babelHelpers["extends"]({},b,{type:d("WAMsgType").MSG_TYPE.VIDEO,msgContent:a.msgContent});case d("WAMsgType").MSG_TYPE.PTT:return babelHelpers["extends"]({},b,{type:d("WAMsgType").MSG_TYPE.PTT,msgContent:a.msgContent});case d("WAMsgType").MSG_TYPE.TEXT:return babelHelpers["extends"]({},b,{type:d("WAMsgType").MSG_TYPE.TEXT,msgContent:a.msgContent});case d("WAMsgType").MSG_TYPE.STICKER:return babelHelpers["extends"]({},b,{type:d("WAMsgType").MSG_TYPE.STICKER,msgContent:a.msgContent});case d("WAMsgType").MSG_TYPE.GIF:return babelHelpers["extends"]({},b,{type:d("WAMsgType").MSG_TYPE.GIF,msgContent:a.msgContent});case d("WAMsgType").MSG_TYPE.XMA:return babelHelpers["extends"]({},b,{type:d("WAMsgType").MSG_TYPE.XMA,msgContent:a.msgContent,xmaMessageType:a.xmaMessageType});default:throw c("err")("Trying to reply to a message type that does not support replies")}}function l(a,b,c,e){if(b===d("WAMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE)return d("WAJids").switchOnMsgrChatJidType(c,{user:function(b){return d("MAWDbContactsTxns").getContact(a,b).then(function(b){var c;if(b==null)return d("MAWDexieTable").dexieResolve();b.ephemeralSyncResponseBackoffInfo={syncResponseSentTs:e,syncResponseRetries:((c=(c=b.ephemeralSyncResponseBackoffInfo)==null?void 0:c.syncResponseRetries)!=null?c:0)+1};return a.contacts.put(b)}).then(function(){})},group:function(){return d("MAWDexieTable").dexieResolve()}});return b===d("WAMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE?d("WAJids").switchOnMsgrChatJidType(c,{user:function(b){return d("MAWDbContactsTxns").getContact(a,b).then(function(b){if(b==null||b.ephemeralSyncResponseBackoffInfo==null)return d("MAWDexieTable").dexieResolve();b.ephemeralSyncResponseBackoffInfo=void 0;return a.contacts.put(b).then(function(){})})},group:function(){return d("MAWDexieTable").dexieResolve()}}):d("MAWDexieTable").dexieResolve()}g.writeOutgoingMsg=a},98);
__d("MAWGetAbPropsApi",["MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","SignalDbTypes"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{meta:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getAbProps",!1)))(function(a){return a.meta.get(d("SignalDbTypes").MetaKeysEnum.abProps).then(function(a){a=a==null?void 0:a.value.abProps;return{abProps:a==null?null:a}})});g.getAbProps=a},98);
__d("MAWGetClockSkewApi",["MAWDbMetaTxns","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{meta:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getClockSkew",!1)))(function(a){return d("MAWDbMetaTxns").maybeGetClockSkew(a).then(function(a){return{clockSkew:a==null?0:a}})});g.getClockSkew=a},98);
__d("MAWGetRoutingInfoApi",["MAWDbMetaTxns","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{meta:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getRoutingInfo",!1)))(function(a){return d("MAWDbMetaTxns").maybeGetEdgeInfo(a).then(function(a){return{edgeInfo:a==null?null:a}})});g.getRoutingInfo=a},98);
__d("MAWSetAbPropsApi",["MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","SignalDbTypes"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{meta:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("setAbProps",!1)))(function(a,b){return a.meta.put({key:d("SignalDbTypes").MetaKeysEnum.abProps,value:{abProps:b}}).then(function(){})});g.setAbProps=a},98);
__d("MAWSetClockSkewApi",["MAWBridge","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","SignalDbTypes"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{meta:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("setClockSkew",!1)))(function(a,b){var c=b.clockSkew;return a.meta.put({key:d("SignalDbTypes").MetaKeysEnum.clockSkew,value:{clockSkew:c}}).then(function(){d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"ClockSkewUpdated",value:c}]})})});g.setClockSkew=a},98);
__d("MAWSetRoutingInfoApi",["MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","SignalDbTypes","err"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{meta:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("setRoutingInfo",!1)))(function(a,b){b=b.edgeInfo;if(b==null)throw c("err")("EdgeInfo was null when trying to set");return a.meta.put({key:d("SignalDbTypes").MetaKeysEnum.edgeInfo,value:{edgeInfo:b}}).then(function(){})});g.setRoutingInfo=a},98);
__d("MAWDeletePreKeyGenerationsApi",["MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWSignalUtils","MAWTransactionMode","WALogger"],function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Attempting to delete non-existent prekey generation"]);h=function(){return a};return a}a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{prekeyGeneration:d("MAWTransactionMode").READWRITE,prekey:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("deletePreKeyGenerations",!1)))(function(a,b){return a.prekeyGeneration.bulkGet(b).then(function(c){var e=[];c.forEach(function(a){if(a==null){d("WALogger").WARN(h());return}d("MAWSignalUtils").getPrekeyIdsInRange(a.startingId,a.endingId).forEach(function(a){e.push(a)})});c=a.prekeyGeneration.bulkDelete(b);var f=a.prekey.bulkDelete(e);return d("MAWDexieTable").dexieAll([c,f]).then(function(){})})});g.deletePreKeyGenerations=a},98);
__d("MAWGetLastPreKeyGenerationIdApi",["MAWDbMetaTxns","MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","err"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{meta:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getLastPreKeyGenerationId",!1)))(function(a){var b=d("MAWDbMetaTxns").maybeGetLastPrekeyId(a);a=d("MAWDbMetaTxns").maybeGetLastPrekeyGenerationId(a);return d("MAWDexieTable").dexieAll([b,a]).then(function(a){var b=a[0];a=a[1];if(b==null&&a!=null||b!=null&&a==null)throw c("err")("Last prekey id and Last prekey generation id should both be non-null");if(b!=null&&a!=null)return{lastGenerationId:a,lastPreKeyId:b};else return null})});g.getLastPreKeyGenerationId=a},98);
__d("MAWGetPreKeyGenerationsTimestampsApi",["MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{prekeyGeneration:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getPreKeyGenerationsTimestamps",!1)))(function(a){return a.prekeyGeneration.toArray().then(function(a){return a.map(function(a){return{id:a.generationId,timestamp:a.createdTs}})})});g.getPreKeyGenerationsTimestamps=a},98);
__d("MAWLoadLatestSignedPreKeyApi",["MAWDbSignedPrekeyTxns","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{meta:d("MAWTransactionMode").READONLY,signedPrekey:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("loadLatestSignedPreKey",!1)))(d("MAWDbSignedPrekeyTxns").getLatestSignedPreKey);g.loadLatestSignedPreKey=a},98);
__d("MAWLoadOneTimePreKeyApi",["MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{prekey:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("loadOneTimePreKey",!1)))(function(a,b){return a.prekey.get(b).then(function(a){return a==null?void 0:a.encoded})});g.loadOneTimePreKey=a},98);
__d("MAWLoadPreKeysApi",["MAWDbMetaTxns","MAWDbPrekeyTxns","MAWDbSignedPrekeyTxns","MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WASignalSignatures","err"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{meta:d("MAWTransactionMode").READONLY,prekey:d("MAWTransactionMode").READONLY,prekeyGeneration:d("MAWTransactionMode").READONLY,signedPrekey:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("loadPreKeys",!1)))(function(a,b){return d("MAWDbSignedPrekeyTxns").getLatestSignedPreKey(a).then(function(e){var f=d("WASignalSignatures").deserializeSignedPreKey(e);if(f==null)throw c("err")("Failed to deserialize signed prekey");e=b!=null?d("MAWDexieTable").dexieResolve(b):d("MAWDbMetaTxns").maybeGetLastPrekeyGenerationId(a);return e.then(function(b){if(b==null)throw c("err")("No last prekey generation id");return d("MAWDbPrekeyTxns").getPrekeysForGeneration(a,b).then(function(a){return{preKeys:a,signedPreKey:f}})})})});g.loadPreKeys=a},98);
__d("MAWLoadSignedPreKeyApi",["MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{signedPrekey:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("loadSignedPreKey",!1)))(function(a,b){return a.signedPrekey.get(b).then(function(a){return a==null?void 0:a.encoded})});g.loadSignedPreKey=a},98);
__d("MAWSaveOneTimePreKeyIfMatchesApi",["MAWDbMetaTxns","MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","SignalDbTypes","WAResultOrError"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{meta:d("MAWTransactionMode").READWRITE,prekey:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("saveOneTimePreKeyIfMatches",!1)))(function(a,b,c){return d("MAWDbMetaTxns").maybeGetLastPrekeyId(a).then(function(e){if(e==null)return d("WAResultOrError").makeError("missing_last_prekey");return e!==b?d("WAResultOrError").makeError("mismatch"):d("MAWDexieTable").dexieAll([a.prekey.put(c),a.meta.put({key:d("SignalDbTypes").MetaKeysEnum.lastPrekeyId,value:{lastPrekeyId:c.keyId}})]).then(function(){return d("WAResultOrError").makeSuccess()})})});g.saveOneTimePreKeyIfMatches=a},98);
__d("MAWSavePreKeysGenerationIfMatchesApi",["MAWDbMetaTxns","MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","SignalDbTypes","WAResultOrError","WATimeUtils"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{meta:d("MAWTransactionMode").READWRITE,prekey:d("MAWTransactionMode").READWRITE,prekeyGeneration:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("savePreKeysGenerationIfMatches",!1)))(function(a,b,c,e){return d("MAWDbMetaTxns").maybeGetLastPrekeyGenerationId(a).then(function(f){if(e.length==0||f==null&&b!=null||f!=null&&b==null||f!=null&&b!=null&&f!==b)return d("WAResultOrError").makeError("mismatch");f=e[0].keyId;var g=e[e.length-1].keyId,h=a.prekey.bulkPut(e),i=a.meta.bulkPut([{key:d("SignalDbTypes").MetaKeysEnum.lastPrekeyId,value:{lastPrekeyId:g}},{key:d("SignalDbTypes").MetaKeysEnum.lastPrekeyGenerationId,value:{lastPrekeyGenerationId:c}}]);f=a.prekeyGeneration.put({generationId:c,startingId:f,endingId:g,createdTs:d("WATimeUtils").unixTime()});return d("MAWDexieTable").dexieAll([h,i,f]).then(function(){return d("WAResultOrError").makeSuccess()})})});g.savePreKeysGenerationIfMatches=a},98);
__d("MAWSaveSignedPreKeyIfNewApi",["MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","SignalDbTypes","WASignalSignatures"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{meta:d("MAWTransactionMode").READWRITE,signedPrekey:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("saveSignedPreKeyIfNew",!1)))(function(a,b,c){return a.signedPrekey.get(b).then(function(e){if(e!=null){e=d("WASignalSignatures").deserializeSignedPreKey(e.encoded);if(e!=null)return{type:"duplicate",key:e}}e=a.signedPrekey.put({keyId:b,encoded:c});var f=a.meta.put({key:d("SignalDbTypes").MetaKeysEnum.lastSignedPrekeyId,value:{lastSignedPrekeyId:b}});return d("MAWDexieTable").dexieAll([e,f]).then(function(){return{type:"success"}})})});g.saveSignedPreKeyIfNew=a},98);
__d("MAWGetReactionForSending",["MAWAckLevel.re","MAWAsMessageApplication","MAWDbReactionsTxns","MAWDbThreadTxns","MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWMsgRecipientsTxns","MAWRecipientDevicesTxns","MAWTransactionMode","WAJids","WAResultOrError","err"],function(a,b,c,d,e,f,g){"use strict";function h(a,b){return d("MAWDbReactionsTxns").getReaction(a,b).then(function(b){if(b==null)return d("WAResultOrError").makeError("missing");else if(b.ack>d("MAWAckLevel.re").ACK.clock)return d("WAResultOrError").makeError("sent");return d("MAWDbThreadTxns").getThreadByJid(a,b.threadJid).then(function(c){return!c.success?d("WAResultOrError").makeError(c.error):d("MAWDexieTable").dexieAll([d("MAWMsgRecipientsTxns").getMsgRecipients(a,b.reactionId),d("MAWRecipientDevicesTxns").getICDCInfoForUsersInThread(a,c.value.chatId)]).then(function(a){var c=a[0];a=a[1];return!a.success?d("WAResultOrError").makeError("missing"):d("WAResultOrError").makeSuccess({msg:b,recipients:c,contactsSyncInfo:a.value.contactsSyncInfo,icdcInfo:a.value.icdcInfoList})})})})}a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{reactions:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY,contacts:d("MAWTransactionMode").READONLY,receipts:d("MAWTransactionMode").READONLY,participants:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,identity:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getReactionForSending",!1)))(function(a,b){return h(a,b).then(function(a){if(!a.success)return{type:a.error};a=a.value;var b=a.msg,e=a.recipients,f=a.icdcInfo;a=a.contactsSyncInfo;var g=d("MAWAsMessageApplication").asReactionMessageApplication(b);if(d("WAJids").isAuthorSystem(b.author))throw c("err")("This cannot happen because there are no system reactions");return{type:"unsent",messageApplication:g,chat:b.threadJid,recipients:e,externalId:b.externalId,messageType:{type:"reaction"},icdcInfo:f,contactsSyncInfo:a,protocolMsgId:{externalId:b.externalId,author:b.author,chat:b.threadJid}}})});g.getReactionForSending=a},98);
__d("MAWWriteReactionMsgApi",["MAWIndexedDb","MAWLLAMigrationUtils","MAWMsgReceiptPreparationTxns","MAWTransactionMode","MAWWriteReactionTxns","WAJids"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{reactions:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE,messages:d("MAWTransactionMode").READONLY,receipts:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READONLY,identity:d("MAWTransactionMode").READONLY,participants:d("MAWTransactionMode").READONLY,groupInfo:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("writeReactionMsg",!1)))(function(a,b,c,e,f,g){g===void 0&&(g=d("WAJids").AUTHOR_ME);var h=e.reactToExternalId,i=e.reaction,j=e.groupingKey;e=e.reactToAuthor;var k={externalId:b,reactToExternalId:h,reaction:i,groupingKey:j,reactToAuthor:e,ts:f,author:g};return a.threads.get({jid:c}).then(function(b){return b==null?"missing_thread":d("MAWWriteReactionTxns").writeReaction(a,k,b.jid)}).then(function(b){return b==="missing_thread"?{type:"missing_thread"}:d("MAWMsgReceiptPreparationTxns").prepareReceiptForMsg(a,b.reactionId,c).then(function(){return{type:"not_sent",protocolMsgId:{externalId:b.externalId,author:g,chat:c}}})})});g.writeReactionMsg=a},98);
__d("MAWWritePeerMsgReceiptsApi",["MAWDbMsgTxns","MAWDbPendingReceiptTxns","MAWDexieTable","MAWEphemeralMsgTxns","MAWGlobals","MAWIndexedDb","MAWLLAMigrationUtils","MAWMarkThreadAsReadTxns","MAWTransactionMode","WAJids","WALogger","WAMsgType"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Processing "," receipt for messages not from me"]);h=function(){return a};return a}function i(a,b,c){return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b).then(function(a){return a==null||a.type===d("WAMsgType").MSG_TYPE.CIPHERTEXT?{type:"missing",msg:b,readReceipt:c}:{type:"found",dbMsg:a,msg:b,readReceipt:c}})}function j(a){var b=new Map();a.forEach(function(a){if(a.type==="missing")return;var c=a.dbMsg.thread;a=a.dbMsg.msgId;var d=b.get(c);(d==null||a>d)&&b.set(c,a)});return b}function k(a,b){b=b.map(function(a){d("WALogger").DEV(h(),a.type);if(a.type==="delivered")return;var b={device:void 0,ts:void 0};a.receivers.forEach(function(a){var c=a.device;a=a.ts;var e=d("WAJids").extractUserJid(c);e===d("MAWGlobals").getMyUserJid()&&(b.ts==null||a<b.ts)&&(b.device=c,b.ts=a)});if(b.device!=null&&b.ts!=null)return babelHelpers["extends"]({},a,{receivers:{device:b.device,ts:b.ts}});else return}).filter(Boolean);if(b.length==0)return d("MAWDexieTable").dexieResolve();var c=[];b.forEach(function(a){a.msgs.forEach(function(b){c.push([b,a.receivers])})});return d("MAWDexieTable").dexieAll(c.map(function(b){var c=b[0];b=b[1];return i(a,c,b)})).then(function(b){var c=[],e=[];b.map(function(a){a.type==="missing"?c.push({thread:a.msg.chat,externalId:a.msg.externalId,author:a.msg.author,deliveryReceipts:[],readReceipts:[a.readReceipt]}):e.push({msgId:a.msg,ts:a.readReceipt.ts})});var f=j(b);b=Array.from(f.keys()).map(function(a){var b=f.get(a);if(b!=null)return{threadId:a,upToMsgId:b};else return null}).filter(Boolean);return d("MAWDexieTable").dexieAll([d("MAWDbPendingReceiptTxns").bulkAddPendingReceipts(a,c),d("MAWMarkThreadAsReadTxns").bulkMarkThreadAsReadUpToMsgId(a,b),d("MAWEphemeralMsgTxns").bulkMarkEphemeralMessageAsRead(a,e)]).then(function(){})})}a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{messages:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READWRITE,pendingReceipts:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("writePeerReceiptsForMsgsNotFromMe",!1)))(function(a,b,c,d){return k(a,[{msgs:b,type:c,receivers:d}])});g.bulkWritePeerReceiptsForMsgsNotFromMeInternal=k;g.writePeerReceiptsForMsgsNotFromMe=a},98);
__d("MAWBulkWriteReceiptsApi",["MAWDexieTable","MAWIncomingReceiptTxns","MAWIndexedDb","MAWTransactionMode","MAWWriteAppDataReceiptsApi","MAWWritePeerMsgReceiptsApi","qpl"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({receipts:d("MAWTransactionMode").READWRITE,messages:d("MAWTransactionMode").READWRITE,unrenderedMessages:d("MAWTransactionMode").READWRITE,participants:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE,pendingReceipts:d("MAWTransactionMode").READWRITE,appData:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READONLY,chunk:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READONLY},c("qpl")._(25297955,"552"))(function(a,b){if(b.length===0)return d("MAWDexieTable").dexieResolve();var c=[],e=[],f=[];b.forEach(function(a){switch(a.type){case"msg-receipt":c.push(a.params);break;case"not-from-me":e.push(a.params);break;default:f.push(a.params);break}});var g=d("MAWDexieTable").dexieResolve();f.forEach(function(b){var c=b.externalIds,e=b.receivers;g=g.then(function(){return d("MAWWriteAppDataReceiptsApi").writeAppDataReceiptsInternal(a,c,e)})});return d("MAWDexieTable").dexieAll([c.length>0?d("MAWIncomingReceiptTxns").bulkHandleIncomingReceipts(a,c):d("MAWDexieTable").dexieResolve(),e.length>0?d("MAWWritePeerMsgReceiptsApi").bulkWritePeerReceiptsForMsgsNotFromMeInternal(a,e):d("MAWDexieTable").dexieResolve(),g]).then(function(){})});g.bulkWriteReceipts=a},98);
__d("MAWGetUnreadMsgsApi",["MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WAJids","WAMsgType"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{messages:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getUnreadMsgs",!1)))(function(a,b,c){return a.threads.get({jid:b}).then(function(b){if(b==null)return{type:"missing"};var e=d("MAWDbMsgTxns").maybeGetMsg(a,b.lastReadMsg);return e.then(function(e){if(b.lastReadMsg==null)return{type:"none"};var f=(e=e==null?void 0:e.msgId)!=null?e:b.lastReadMsg;return d("MAWDbMsgTxns").getMsgsNeedingRetroactiveReadReceiptsUpTo(a,b.chatId,f).then(function(e){var g=b.oldestMsg,i=b.lastReadMsgReceiptSent,j=b.jid,k=d("MAWDexieTable").dexieResolve(),l=c-e.length;if(g==null||i!=null&&f<=i||l<=0){if(e.length===0)return{type:"none"}}else{var m=i==null;k=a.messages.where("msgId").between(i||g,f,m,!0).limit(l).toArray().then(function(b){var c=h(b,j);return c.length===0?a.messages.where("msgId").between(i||g,f,m,!0).toArray().then(function(b){var a=h(b,j);return{unreadNextMsgs:a.slice(0,l),nextMsgs:b.slice(0,l)}}):{unreadNextMsgs:c,nextMsgs:b}})}return k.then(function(a){var b,d;a==null?(b=e,d=h(b,j)):(b=[].concat(e,a.nextMsgs),d=[].concat(h(e,j),a.unreadNextMsgs));if(b.length==0||d.length===0)return{type:"none"};a=b[b.length-1];var g=d[d.length-1];return{type:"found",unreadMsgs:d,loadedUpTo:{externalId:g.externalId,author:g.author,chat:j},maybeMore:a.msgId!==f&&b.length===c}})})})})});function h(a,b){var c=[];a.forEach(function(a){var e=a.author,f=a.externalId;a=a.type;a=a!==d("WAMsgType").MSG_TYPE.CIPHERTEXT&&a!==d("WAMsgType").MSG_TYPE.UNAVAILABLE&&a!==d("WAMsgType").MSG_TYPE.FUTUREPROOF;!d("WAJids").isAuthorMe(e)&&!d("WAJids").isAuthorSystem(e)&&a&&c.push({chat:b,author:e,externalId:f})});return c}g.getUnreadMsgs=a},98);
__d("MAWMarkReadReceiptsSentUpToApi",["MAWBridge","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WAOdsEnums"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{messages:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("markReadReceiptsSentUpTo",!1)))(function(a,b,c){h("success");return d("MAWDexieTable").dexieAll([a.threads.get({jid:b}),d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,c)]).then(function(b){var c=b[0],e=b[1];if(c==null){h("missingThread");return{type:"missing_thread"}}else if(e==null){h("invalidMsg");return{type:"invalid_msg"}}return d("MAWDbMsgTxns").clearRetroactiveReadReceiptStatusFromMsgsUpTo(a,c.chatId,e.msgId).then(function(){if(e.thread!==c.chatId){h("invalidMsg");return{type:"invalid_msg"}}var b=c.lastReadMsgReceiptSent;if(b!=null&&e.msgId<b){h("unchanged");return{type:"unchanged"}}return a.threads.put(babelHelpers["extends"]({},c,{lastReadMsgReceiptSent:e.msgId})).then(function(){h("updateLastReadMsgReceiptSent");return{type:"success"}})})})});function h(a){d("MAWBridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:d("WAOdsEnums").Entity.SEND_READ_RECEIPTS,key:a})}g.markReadReceiptsSentUpTo=a},98);
__d("MAWMarkThreadAsReadUpToApi",["MAWIndexedDb","MAWLLAMigrationUtils","MAWMarkThreadAsReadTxns","MAWTransactionMode"],function(a,b,c,d,e,f,g){a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{threads:d("MAWTransactionMode").READWRITE,messages:d("MAWTransactionMode").READWRITE,contacts:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("markThreadAsReadUpTo",!1)))(function(a,b,c){return a.threads.get({jid:b}).then(function(b){if(b==null)return{type:"missing",shouldSendReadReceipts:!1};return b.newestMsg==null?{type:"missing",shouldSendReadReceipts:!1}:d("MAWMarkThreadAsReadTxns").markThreadAsReadUpToMsgId(a,b.chatId,b.newestMsg)})});g.markThreadAsReadUpTo=a},98);
__d("MAWWriteMsgReceiptsApi",["MAWIncomingReceiptTxns","MAWIndexedDb","MAWTransactionMode","WALogger","qpl"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Processing "," receipt"]);h=function(){return a};return a}a=d("MAWIndexedDb").makeMsgrTransactor({receipts:d("MAWTransactionMode").READWRITE,messages:d("MAWTransactionMode").READWRITE,unrenderedMessages:d("MAWTransactionMode").READWRITE,participants:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READONLY,pendingReceipts:d("MAWTransactionMode").READWRITE,chunk:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READONLY},c("qpl")._(25299660,"7057"))(function(a,b,c,e){d("WALogger").LOG(h(),c);return d("MAWIncomingReceiptTxns").bulkHandleIncomingReceipts(a,[{msgs:b,type:c,receivers:e}])});g.writeMsgReceipts=a},98);
__d("MAWTaskScheduleApi",["MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WALogger"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["setTaskScheduledTime "," ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["getTaskScheduledTime ",""]);i=function(){return a};return a}var j=new Map();e=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{tasks:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getTasksScheduledTime",!1)))(function(a,b){d("WALogger").DEV(i(),b);return j.has(b)?d("MAWDexieTable").dexieResolve(j.get(b)):a.tasks.get(b).then(function(a){if(a==null)return null;j.set(b,a.scheduledTime);return j.get(b)})});f=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{tasks:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("setTaskScheduledTime",!1)))(function(a,b,c){d("WALogger").DEV(h(),b,c);j.set(b,c);return a.tasks.put({taskName:b,scheduledTime:c}).then(function(){})});function a(){return j}function b(a,b){j.set(a,b)}function c(){j.clear()}g.getTaskScheduledTime=e;g.setTaskScheduledTime=f;g.getTaskScheduleCache=a;g.setTaskScheduleCache=b;g.clearTaskScheduleCache=c},98);
__d("MAWBulkSaveSignalDataApi",["MAWDbIdentityTxns","MAWDbPrekeyTxns","MAWDbSenderKeySessionTxns","MAWDbSessionTxns","MAWDexieTable","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","SignalDbTypes","WAJids","WAResultOrError","WASignalOther"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{session:d("MAWTransactionMode").READWRITE,senderKeySessions:d("MAWTransactionMode").READWRITE,identity:d("MAWTransactionMode").READWRITE,prekey:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("bulkSaveSignalData",!1)))(function(a,b){var c=b.sessionUpdate,e=b.senderKeySessionUpdate,f=b.identityUpdate,g=b.preKeyRemove;b=c.map(function(a){var b=a.id;a=a.original;return{id:b,oldHash:a?d("WASignalOther").castToSessionHash(a.buffer):null}});var h=c.map(function(a){var b=a.id;a=a.updated;return{id:b,session:a}}),i=[],j=[];e.forEach(function(a){var b=a.groupId,c=a.author,e=a.original;a=a.updated;var f=d("WAJids").extractUserJid(c);c=d("WAJids").extractDeviceId(c);var g=d("SignalDbTypes").buildSenderKeySessionId(b,f,c);i.push({id:g,record:e});j.push({id:g,userJid:f,deviceId:c,groupJid:b,record:a})});return d("MAWDexieTable").dexieAll([c.length>0?d("MAWDbSessionTxns").bulkCheckSessionsMatch(a,b):d("WAResultOrError").makeSuccess(),e.length>0?d("MAWDbSenderKeySessionTxns").bulkCheckSenderKeySessionsMatch(a,i):d("WAResultOrError").makeSuccess()]).then(function(b){for(var i=0;i<b.length;i++){var k=b[i];if(!k.success)return k}return d("MAWDexieTable").dexieAll([c.length>0?d("MAWDbSessionTxns").bulkSaveSessions(a,h):d("MAWDexieTable").dexieResolve(),e.length>0?d("MAWDbSenderKeySessionTxns").bulkPutSenderKeySessions(a,j):d("MAWDexieTable").dexieResolve(),f.length>0?d("MAWDbIdentityTxns").bulkPutIdentities(a,f.map(function(a){var b=a.id;a=a.identity;return{deviceJid:b,identity:a}})):d("MAWDexieTable").dexieResolve(),g.length>0?d("MAWDbPrekeyTxns").bulkDeletePreKeys(a,g.map(function(a){a=a.id;return a})):d("MAWDexieTable").dexieResolve()]).then(function(){return d("WAResultOrError").makeSuccess()})})});g.bulkSaveSignalData=a},98);
__d("MAWGetSyncActionApi",["Promise"],function(a,b,c,d,e,f){"use strict";a=function(){return b("Promise").resolve()};f.getSyncAction=a},66);
__d("MAWGetSyncActionsByCollectionsApi",["Promise"],function(a,b,c,d,e,f){"use strict";a=function(){return b("Promise").resolve([])};f.getSyncActionsByCollections=a},66);
__d("MAWGetSyncActionsByIndexMacApi",["Promise"],function(a,b,c,d,e,f){"use strict";a=function(){return b("Promise").resolve([])};f.getSyncActionsByIndexMac=a},66);
__d("MAWGetSyncActiveKeyApi",["err"],function(a,b,c,d,e,f,g){"use strict";a=function(){throw c("err")("getSyncActiveKey is not implemented")};g.getSyncActiveKey=a},98);
__d("MAWGetSyncCollectionLtHashApi",["Promise"],function(a,b,c,d,e,f){"use strict";a=function(){return b("Promise").resolve(new ArrayBuffer(0))};f.getSyncCollectionLtHash=a},66);
__d("MAWGetSyncCollectionVersionAndMutationsApi",["Promise"],function(a,b,c,d,e,f){"use strict";a=function(){return b("Promise").resolve([void 0,[]])};f.getSyncCollectionVersionAndMutations=a},66);
__d("MAWGetSyncCollectionVersionApi",["Promise"],function(a,b,c,d,e,f){"use strict";a=function(){return b("Promise").resolve()};f.getSyncCollectionVersion=a},66);
__d("MAWGetSyncCollectionsWithMutationsAndHashApi",["Promise"],function(a,b,c,d,e,f){"use strict";a=function(){return b("Promise").resolve([])};f.getSyncCollectionsWithMutationsAndHash=a},66);
__d("MAWGetSyncKeyDataApi",["Promise"],function(a,b,c,d,e,f){"use strict";a=function(){return b("Promise").resolve()};f.getSyncKeyData=a},66);
__d("MAWGetThreadInfoForDeletionApi",["MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WALogger","err"],function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);h=function(){return a};return a}a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{threads:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getThreadInfoForDeletion",!1)))(function(a,b){return a.threads.get(b).then(function(a){if(a==null){var b="Thread was null when getting thread for deletion";d("WALogger").ERROR(h(),b);throw c("err")(b)}return{chatJid:a.jid,newestMsgTs:(b=a.newestMsgTs)!=null?b:void 0}})});g.getThreadInfoForDeletion=a},98);
__d("MAWGetThreadsInfoApi",["MAWDbThreadTxns","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WALogger"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["getThreadIdByJid ",""]);h=function(){return a};return a}a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{threads:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getThreadIdByJid",!1)))(function(a,b){d("WALogger").DEV(h(),b);return d("MAWDbThreadTxns").getThreadByJid(a,b).then(function(a){return a.success?a.value.chatId:null})});b=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{threads:d("MAWTransactionMode").READONLY}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("getThreadJidByChatId",!1)))(function(a,b){return a.threads.get(b).then(function(a){return a==null?void 0:a.jid})});g.getThreadIdByJid=a;g.getThreadJidByChatId=b},98);
__d("MAWUpdateThreadFolderApi",["MAWBridgeTypes","MAWDbThreadTxns","MAWIndexedDb","MAWLLAMigrationUtils","MAWTransactionMode","WALogger"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Update thread "," folder with folder id ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Update thread ",""]);i=function(){return a};return a}a=d("MAWIndexedDb").makeMsgrTransactor.apply(void 0,[{threads:d("MAWTransactionMode").READWRITE}].concat(d("MAWLLAMigrationUtils").getTransactorQPLParam("updateThreadFolder",!1)))(function(a,b,c){d("WALogger").LOG(i(),b);return d("MAWDbThreadTxns").getThreadByJid(a,b).then(function(b){if(!b.success)return;var e=b.value.chatId;return a.threads.update(e,{folder:c}).then(function(a){d("WALogger").LOG(h(),e,c);d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypes").createBridgeUpdatedThread({threadId:e,folder:c})});return})})});g.updateThreadFolder=a},98);
__d("MAWOptimisticUploadMedia",["MAWBridge","MAWGlobals","MAWMediaUtils","MAWOptimisticUploadManager","WAMediaUtils","regeneratorRuntime"],function(a,b,c,d,e,f,g){function a(a){var c,e,f,g,h,i,j,k,l,m;return b("regeneratorRuntime").async(function(n){while(1)switch(n.prev=n.next){case 0:c=a.file,e=a.threadId;f=d("MAWMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(c.type),g=f.serverMediaType;n.next=4;return b("regeneratorRuntime").awrap(d("MAWMediaUtils").hashBlob(c));case 4:h=n.sent;i=d("WAMediaUtils").toPlaintextHash(h);j=d("MAWOptimisticUploadManager").getOptimisticUploadManager();k=j.get(i);if(!(k!=null)){n.next=10;break}return n.abrupt("return");case 10:n.next=12;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().getThreadJidByChatId(e));case 12:l=n.sent;m=d("MAWBridge").getBridge().sendAndReceive("backend","uploadMedia",{chatJid:l,hash:i,type:g,size:c.size,msgId:null});j.set(i,{file:c,optimisticUploadPromise:m});return n.abrupt("return");case 16:case"end":return n.stop()}},null,this)}g.optimisticUploadMedia=a},98);
__d("MAWRetryUploadMedia",["MAWAckLevel.re","MAWBridge","MAWDbChunkTxns","MAWDbMediaTxns","MAWDbMsgTxns","MAWGlobals","MAWIndexedDb","MAWJobDefinitions","MAWMediaUtils","MAWTransactionMode","WALogger","err","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to upload media again for "," mediaId"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["retryUploadMedia for "," msgId"]);i=function(){return a};return a}function a(a){var e,f,g,k,l,m,n,o;return b("regeneratorRuntime").async(function(p){while(1)switch(p.prev=p.next){case 0:e=a.msgId;d("WALogger").DEV(i(),e);p.next=4;return b("regeneratorRuntime").awrap(d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY})(d("MAWDbMsgTxns").maybeGetMsg)(e));case 4:f=p.sent;if(f){p.next=7;break}throw c("err")("No message associated with the given msgId");case 7:p.next=9;return b("regeneratorRuntime").awrap(d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READONLY})(d("MAWDbMediaTxns").maybeGetMediaFromMediaId)(f.mediaId));case 9:g=p.sent;if(g){p.next=12;break}throw c("err")("No media entry associated with the given mediaId");case 12:p.next=14;return b("regeneratorRuntime").awrap(d("MAWIndexedDb").makeMsgrTransactor({chunk:d("MAWTransactionMode").READONLY})(d("MAWDbChunkTxns").maybeGetChunkFromHash)(g.hashedPlaintextHash));case 14:k=p.sent;if(k){p.next=17;break}throw c("err")("No chunk/blob associated with media entry");case 17:l=d("MAWMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(k.mimetype),m=l.serverMediaType;p.next=20;return b("regeneratorRuntime").awrap(d("MAWGlobals").getDbImpls().getProtocolMsgIdByMediaMsgId(e));case 20:n=p.sent;if(n){p.next=23;break}throw c("err")("Db missing message with msgId: "+e);case 23:p.next=25;return b("regeneratorRuntime").awrap(d("MAWBridge").getBridge().sendAndReceive("backend","uploadMedia",{chatJid:n.chat,msgId:e,hash:g.plaintextHash,type:m,size:new Blob([k.blobData],{type:k.mimetype}).size}));case 25:o=p.sent;if(o.success){p.next=29;break}d("WALogger").LOG(h(),g.mediaId);return p.abrupt("return",j(e,d("MAWAckLevel.re").ACK.failed));case 29:p.next=31;return b("regeneratorRuntime").awrap(j(e,d("MAWAckLevel.re").ACK.clock));case 31:p.next=33;return b("regeneratorRuntime").awrap(d("MAWGlobals").getJobManager().waitUntilPersisted(d("MAWJobDefinitions").jobSerializers.sendWrittenMsg(n)));case 33:case"end":return p.stop()}},null,this)}var j=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READWRITE,chunk:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READONLY})(function(a,b,c){return d("MAWDbMsgTxns").updateSystemAck(a,b,c).then(function(){})});g.retryUploadMedia=a},98);
__d("MAWTransactionsConfig",["gkx"],function(a,b,c,d,e,f,g){"use strict";a={addGroupParticipants:c("gkx")("3741"),changeGroupParticipantAdminStatus:c("gkx")("5697"),createGroupInfo:c("gkx")("3741"),createGroups:c("gkx")("3741"),deleteGroupInfo:c("gkx")("3741"),deleteExpiredMsgs:c("gkx")("827"),getAbProps:c("gkx")("924"),getClockSkew:c("gkx")("924"),getContacts:c("gkx")("1175"),getCurrentUserDeviceInfo:c("gkx")("1221"),getGroupInfo:c("gkx")("3741"),getRoutingInfo:c("gkx")("924"),leaveGroup:c("gkx")("3741"),removeGroupParticipants:c("gkx")("1813"),setClockSkew:c("gkx")("924"),setContacts:c("gkx")("1175"),setAbProps:c("gkx")("924"),setRoutingInfo:c("gkx")("924"),updateGroupSubject:c("gkx")("5916"),updateMessageStatus:c("gkx")("5231"),writeForwardedMsg:c("gkx")("5231"),writeOutgoingMsg:c("gkx")("5231"),getGroupParticipantDevices:c("gkx")("2278"),resetGroupParticipantInfo:c("gkx")("5697")};g.transactions=a},98);
__d("MAWWebWorkerLogger",["MAWAbProps","MAWAbPropsTypes","MAWBridge","MAWLeakDetection","MAWMainThreadLogger","WAJids","WALogger","err","fb-error"],function(a,b,c,d,e,f,g){"use strict";var h=3;function a(){d("WALogger").initializeWaLogger(i)}var i={debug:function(a){d("MAWMainThreadLogger").logToConsole("log",a)},info:function(a){k("log",a),d("MAWMainThreadLogger").logToConsole("info",a)},warn:function(a){k("warn",a),d("MAWMainThreadLogger").logToConsole("warn",a)},error:function(a,b){a=d("MAWLeakDetection").maybeReplaceVaultedString(a);if(b){var e=0;if(b.taalOpcodes!=null){var f;(f=b.taalOpcodes)==null?void 0:f.forEach(function(a){a===c("fb-error").TAALOpcode.PREVIOUS_FRAME&&e++})}l(a,b,e)}else l("web worker",c("err")(d("WAJids").maybeSanitizeLogLineText(a)),h)},devConsole:function(a,b){for(var c=arguments.length,e=new Array(c>2?c-2:0),f=2;f<c;f++)e[f-2]=arguments[f];switch(a){case"DEV":d("MAWMainThreadLogger").logToConsole.apply(void 0,["log",b].concat(e));break;case"DEV_XMPP":d("MAWMainThreadLogger").logToConsole.apply(void 0,["log",b].concat(e));break;case"LOG":d("MAWMainThreadLogger").logToConsole.apply(void 0,["info",b].concat(e));break;case"WARN":d("MAWMainThreadLogger").logToConsole.apply(void 0,["warn",b].concat(e));break;case"ERROR":d("MAWMainThreadLogger").logToConsole.apply(void 0,["error",b].concat(e));break;case"CATCHING":d("MAWMainThreadLogger").logToConsole.apply(void 0,["error",b].concat(e));break}}};function j(){try{return d("MAWAbProps").getAbProp("msgrw_logger_entries")}catch(a){return d("MAWAbPropsTypes").getAbDefault("msgrw_logger_entries")}}function k(a,b){d("MAWBridge").getBridge().fireAndForget("event","log",{logLevel:a,logString:b},!0)}function l(a,b,c){d("MAWBridge").getBridge().fireAndForget("event","logError",{message:b.message,stack:b.stack,logString:a,framesToPop:c,entriesToReport:j()},!0)}g.setupWebWorkerWaLogger=a},98);
__d("MAWDualSendMediaUtils",["Promise","bx"],function(a,b,c,d,e,f,g){"use strict";var h="generic_file";function i(a){if(a==="png")return"image/png";else if(a==="m4a")return"audio/m4a";else return"video/mov"}function a(a){switch(a){case"audio":return"audio";case"image":return"image";case"video":return"video";default:return null}}function d(a){switch(a){case"audio":return k();case"image":return j();case"video":return l()}}function j(){var a=c("bx").getURL(c("bx")("5359"));return m(a,"png")}function k(){var a=c("bx").getURL(c("bx")("5360"));return m(a,"m4a")}function l(){var a=c("bx").getURL(c("bx")("5361"));return m(a,"mov")}function m(a,c){var d=new XMLHttpRequest();return new(b("Promise"))(function(b,e){d.open("GET",a,!0),d.responseType="blob",d.onload=function(){var a=this.response;a=new File([a],h+"."+c,{type:i(c)});b(a)},d.onerror=function(a){return e("Failed to download dual send media")},d.send()})}g.convertStringToDualSendMediaType=a;g.downloadImageByFileType=d;g.downloadImageFile=j;g.downloadAudioFile=k;g.downloadVideoFile=l},98);
__d("MAWCommonLowLevelApiBridgeHandlers",["MAWArchiveThreadApi","MAWBackfillThreadsForOccamadilloApi","MAWChangeSecurityAlertSettingApi","MAWClearSignalAndTempStores","MAWCreateThreadApi","MAWCreateThreadByJidApi","MAWDeleteThreadApi","MAWDualSendMediaUtils","MAWFTS","MAWFetchExistingThreadApi","MAWFetchExistingThreadForContactApi","MAWGetAllThreadsAsJsonApi","MAWGetBlobDataUrlByMediaIdApi","MAWGetBlobDataUrlByXMAIdApi","MAWGetCurrentUserDeviceInfo","MAWGetDualSendMediaByFileTypeApi","MAWGetEphemeralSettingsApi","MAWGetGroupSuperAdminApi","MAWGetIdentityKeys","MAWGetProtocolMsgIdByMediaMsgId","MAWGetProtocolMsgIdByMsgId","MAWGetSecurityAlertSettingApi","MAWGetThreadDevicesInfoApi","MAWGetThreadsInfoApi","MAWGetThumbnailBlobDataUrlByMediaIdApi","MAWInitSyncApi","MAWInsertAdminMessageInCutoverThreadsApi","MAWLoadMediaApi","MAWLoadMsgsApi","MAWLoadThreadsApi","MAWMarkThreadAsUnreadApi","MAWOptimisticUploadMedia","MAWRetryUploadMedia","MAWSendChatStateFromComposerApi","MAWSetEphemeralSettingsFromFrontendApi","MAWUnarchiveThreadApi","MAWUpdateContactApi","MAWUpdateParticipantNameApi","MAWUpdateThreadMuteSettingApi","err","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";a={archiveThread:function(a){return d("MAWArchiveThreadApi").archiveThread(a.threadId)},backfillThreadsForOccamadillo:function(){return d("MAWBackfillThreadsForOccamadilloApi").backfillThreadsForOccamadillo()},changeSecurityAlertSetting:function(a){return d("MAWChangeSecurityAlertSettingApi").changeSecurityAlertSetting(a.isEnableAlert)},clearSignalAndTempStores:function(a){return d("MAWClearSignalAndTempStores").clearSignalAndTempStores()},createThread:function(a){return d("MAWCreateThreadApi").createThread(a.contactFbid,a.offlineThreadingId)},createThreadThroughMI:function(a){return d("MAWCreateThreadByJidApi").createThreadByJid(a).then(function(){var e;return b("regeneratorRuntime").async(function(f){while(1)switch(f.prev=f.next){case 0:f.next=2;return b("regeneratorRuntime").awrap(d("MAWGetThreadsInfoApi").getThreadIdByJid(a.chatJid));case 2:e=f.sent;if(!(e==null)){f.next=5;break}throw c("err")("This should not happen because the chat was just created");case 5:return f.abrupt("return",e);case 6:case"end":return f.stop()}},null,this)})},deleteThread:function(a){return d("MAWDeleteThreadApi").deleteThread(a.threadId)},getBlobDataUrlByMediaId:function(a){return d("MAWGetBlobDataUrlByMediaIdApi").getBlobDataUrlByMediaId(a.mediaId)},getBlobDataUrlByXMAId:function(a){return d("MAWGetBlobDataUrlByXMAIdApi").getBlobDataUrlByXMAId(a.xmaId,a.infoType)},getCurrentUserDeviceInfo:function(a){return d("MAWGetCurrentUserDeviceInfo").getCurrentUserDeviceInfo()},getEphemeralSettings:function(a){return d("MAWGetEphemeralSettingsApi").getEphemeralSettings(a.threadId)},getGroupSuperAdmin:function(a){return d("MAWGetGroupSuperAdminApi").getGroupSuperAdmin(a.threadId)},getIdentityKeys:function(a){return d("MAWGetIdentityKeys").getIdentityKeys()},getSecurityAlertSetting:function(a){return d("MAWGetSecurityAlertSettingApi").getSecurityAlertSetting()},getThumbnailBlobDataUrlByMediaId:function(a){return d("MAWGetThumbnailBlobDataUrlByMediaIdApi").getThumbnailBlobDataUrlByMediaId(a.mediaId)},getThreadDevicesInfo:function(a){return d("MAWGetThreadDevicesInfoApi").getThreadDevicesInfo(a)},initSync:function(a){return d("MAWInitSyncApi").initSync(a.numThreads,a.numMsgsPerThread)},loadMoreThreads:function(a){return d("MAWLoadThreadsApi").loadMoreThreads(a.offsetThreadId,a.numThreads,a.numMsgsPerThread,a.folderId)},loadMoreMsgs:function(a){return d("MAWLoadMsgsApi").loadMsgs(a.threadId,a.offsetMsgId,a.numMsgs)},markThreadAsUnread:function(a){return d("MAWMarkThreadAsUnreadApi").markThreadAsUnread(a.threadId)},updateThreadMuteSetting:function(a){return d("MAWUpdateThreadMuteSettingApi").updateThreadMuteSetting({threadId:a.threadId,muteDuration:a.muteDuration})},loadMoreMedia:function(a){return d("MAWLoadMediaApi").loadMoreMedia(a)},retryUploadMedia:function(a){return d("MAWRetryUploadMedia").retryUploadMedia({msgId:a.msgId})},optimisticUploadMedia:function(a){return d("MAWOptimisticUploadMedia").optimisticUploadMedia(a)},unarchiveThread:function(a){return d("MAWUnarchiveThreadApi").unarchiveThread(a.threadId)},updateContact:function(a){return d("MAWUpdateContactApi").updateContact(a)},updateParticipantName:function(a){return d("MAWUpdateParticipantNameApi").updateParticipantName(a)},search:function(a){return d("MAWFTS").search(a)},fetchExistingThread:function(a){return d("MAWFetchExistingThreadApi").fetchExistingThread(a)},sendChatStateFromComposer:function(a){return d("MAWSendChatStateFromComposerApi").sendChatStateFromComposer(a)},getAllThreadsAsJson:function(){return d("MAWGetAllThreadsAsJsonApi").getAllThreadsAsJson()},getThreadJidByChatId:function(a){return d("MAWGetThreadsInfoApi").getThreadJidByChatId(a.threadId)},getProtocolMsgIdByMediaMsgId:function(a){return d("MAWGetProtocolMsgIdByMediaMsgId").getProtocolMsgIdByMediaMsgId(a.msgId)},getProtocolMsgIdByMsgId:function(a){return d("MAWGetProtocolMsgIdByMsgId").getProtocolMsgIdByMsgId(a.msgId)},getThreadIdByChatJid:function(a){return d("MAWGetThreadsInfoApi").getThreadIdByJid(a.chatJid)},getDualSendMediaByFileType:function(a){return d("MAWGetDualSendMediaByFileTypeApi").getDualSendMediaByFileType(d("MAWDualSendMediaUtils").convertStringToDualSendMediaType(a.fileType))},setEphemeralSettingsFromFrontend:function(a){return d("MAWSetEphemeralSettingsFromFrontendApi").setEphemeralSettingsFromFrontend(a)},insertAdminMessageInCutoverThreads:function(a){return d("MAWInsertAdminMessageInCutoverThreadsApi").insertAdminMessageInCutoverThreads(a)},fetchExistingThreadForContact:function(a){return d("MAWFetchExistingThreadForContactApi").fetchExistingThreadForContact(a)}};g.commonBridgeHandlers=a},98);
__d("MAWCommonLowLevelApiLogWrapper",["Promise","WALogger"],function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["LowLevelApi : (",")': failed"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["LowLevelApi : (",")': finished"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["LowLevelApi : (",")': starting"]);j=function(){return a};return a}function a(a){Object.keys(a).forEach(function(c){var e=a[c];a[c]=function(){d("WALogger").DEV(j(),c);return b("Promise").resolve(e.apply(void 0,arguments)).then(function(a){d("WALogger").DEV(i(),c);return a})["catch"](function(a){d("WALogger").LOG(h(),c);throw a})}});return a}g.lowLevelApiLogWrapper=a},98);
__d("MAWUploadRetroactiveThreadsAndMessagesApi",["FBLogger","MAWDbMsg","MAWDbMsgTxns","MAWDbThreadTxns","MAWDexieTable","MAWGlobals","MAWIndexedDb","MAWMailboxUpload","MAWTransactionMode","Promise","WALogger","qex"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["upload threads for user "," and thread ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["got msgs from offset "," and boolean ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["uploading messages for user "," and thread "," with offset "," and next in chat id ",""]);j=function(){return a};return a}function k(a,b,e){d("WALogger").DEV(j(),d("MAWGlobals").getMyUserJid(),b.chatId,e,b.nextInChatMsgId);var f=b.nextInChatMsgId;e=d("MAWDbMsgTxns").getMsgsFromOffset(a,b.chatId,d("MAWDbMsg").craftMsgId(b.chatId,e),f,!0,!1);e.then(function(b){var c=b.msgs;b=b.hasMore;d("WALogger").DEV(i(),c.length,b);c.forEach(function(b){d("MAWMailboxUpload").encodeAndSendEchoMessage(a,b)})})["catch"](function(a){a instanceof Error?c("FBLogger")("labyrinth_web").catching(a).mustfix("Error uploading messages for thread "+b.chatId):c("FBLogger")("labyrinth_web").mustfix("Unknown error uploading messages for thread "+b.chatId)})["finally"](function(){})}function a(a){d("MAWDbThreadTxns").getAllThreadsForUser(a,d("MAWGlobals").getMyUserJid()).then(function(b){b.forEach(function(b){d("WALogger").DEV(h(),d("MAWGlobals").getMyUserJid(),b.chatId),d("MAWMailboxUpload").encodeAndSendEchoThread(a,b),k(a,b,b.nextInChatMsgId-1)})})["catch"](function(a){a instanceof Error?c("FBLogger")("labyrinth_web").catching(a).mustfix("Error uploading thread and messages for user "+d("MAWGlobals").getMyUserJid()):c("FBLogger")("labyrinth_web").mustfix("Unknown error uploading thread and messages for user "+d("MAWGlobals").getMyUserJid())})["finally"](function(){});return d("MAWDexieTable").dexieResolve()}var l=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY,participants:d("MAWTransactionMode").READONLY,contacts:d("MAWTransactionMode").READONLY,receipts:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READONLY})(a);e=function(){var a;a=(a=c("qex")._("921"))!=null?a:!1;a&&l();return b("Promise").resolve()};g.uploadRetroactiveThreadsAndMessages=e},98);
__d("MAWCommonLowLevelApiDbCallbacks",["MAWAddGroupParticipantsApi","MAWBulkHandleIncomingMsgApi","MAWBulkWriteReceiptsApi","MAWChangeAdminStatusApi","MAWClearSignalAndTempStores","MAWCommonLowLevelApiLogWrapper","MAWCreateGroupApi","MAWDeleteExpiredMsgsApi","MAWDeleteGroupsApi","MAWFlushCacheToDbApi","MAWGetAbPropsApi","MAWGetAllThreadsAsJsonApi","MAWGetAppDataApi","MAWGetAppDataForResendApi","MAWGetAppDataForRetryApi","MAWGetClockSkewApi","MAWGetContactAndIdentitiesApi","MAWGetCurrentUserDeviceInfo","MAWGetGroupParticipantDevicesApi","MAWGetGroupSubjectByJidApi","MAWGetIdentityKeys","MAWGetInviterByGroupJidApi","MAWGetKnownDHashesApi","MAWGetLastMsgsInChatForSpamReportApi","MAWGetMediaByObjectId","MAWGetMediaIfAuthorizedApi","MAWGetMediaKnownEntriesApi","MAWGetMediaPlaintextApi","MAWGetMsgForRequestReuploadMediaApi","MAWGetMsgForRetryApi","MAWGetMsgForSendingApi","MAWGetMsgIdByProtocolMsgId","MAWGetMyDevicesApi","MAWGetNextDeleteDFMContentTs","MAWGetNextDeletePendingStanzaTs","MAWGetNextDeleteUnsendContentTs","MAWGetNextDeletionTsApi","MAWGetNextExpirationTsApi","MAWGetNextExpiredXMATs","MAWGetProtocolMsgIdByMediaMsgId","MAWGetProtocolMsgIdByMsgId","MAWGetReactionForSending","MAWGetRoutingInfoApi","MAWGetSenderKeyStatusApi","MAWGetSyncActionApi","MAWGetSyncActionsByCollectionsApi","MAWGetSyncActionsByIndexMacApi","MAWGetSyncActiveKeyApi","MAWGetSyncCollectionLtHashApi","MAWGetSyncCollectionVersionAndMutationsApi","MAWGetSyncCollectionVersionApi","MAWGetSyncCollectionsWithMutationsAndHashApi","MAWGetSyncKeyDataApi","MAWGetSyncResponseBackoffInfoByJidApi","MAWGetThreadInfoForDeletionApi","MAWGetThreadsInfoApi","MAWGetUnreadMsgsApi","MAWHandleConnectedAdminMsgApi","MAWHandleEchoMsgsRestoreApi","MAWHandleEchoThreadsRestoreApi","MAWHandleEncryptedBackupsSecretsApi","MAWHandleMediaDownloadAndRestoreApi","MAWHandleMediaDownloadApi","MAWHandleReachabilityErrorAdminMsgApi","MAWLeaveGroupsApi","MAWLoadRecentParticipantsApi","MAWMarkAppDataDroppedApi","MAWMarkAppDataSendFailedApi","MAWMarkAppDataSentApi","MAWMarkMsgDroppedApi","MAWMarkMsgSentApi","MAWMarkParticipantNeedsKeyApi","MAWMarkReadReceiptsSentUpToApi","MAWMarkSenderKeyAsRotatedApi","MAWMarkSenderKeyAsSentApi","MAWMarkThreadAsReadUpToApi","MAWProcessFutureproofMsgApi","MAWProcessSpamMsgApi","MAWRemoveExpiredDFMMsgsContent","MAWRemoveExpiredMsgsFromUIApi","MAWRemoveExpiredPendingStanzas","MAWRemoveExpiredUnsendMsgsContent","MAWRemoveGroupParticipantsApi","MAWResetGroupParticipantInfoApi","MAWRevokeMsgsApi","MAWSetAbPropsApi","MAWSetClockSkewApi","MAWSetDevicesApi","MAWSetRoutingInfoApi","MAWTaskScheduleApi","MAWUpdateEphemeralityOnMarkMsgsFromOtherAsReadApi","MAWUpdateGroupSubjectApi","MAWUpdateMediaEntryForMsgApi","MAWUpdateMediaEntryForOptimisticUploadApi","MAWUpdateThreadFolderApi","MAWUploadRetroactiveThreadsAndMessagesApi","MAWWriteAppDataReceiptsApi","MAWWriteAppDataRetryApi","MAWWriteForwardedMsgApi","MAWWriteGroupInviteApi","MAWWriteMetaSyncsApi","MAWWriteMsgReceiptsApi","MAWWriteMsgRetryApi","MAWWriteOutgoingAppDataApi","MAWWriteOutgoingMsgApi","MAWWritePeerMsgReceiptsApi","MAWWriteReactionMsgApi","Promise","WAResultOrError","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";a=d("MAWCommonLowLevelApiLogWrapper").lowLevelApiLogWrapper({addGroupParticipants:d("MAWAddGroupParticipantsApi").addGroupParticipants,bulkWriteReceipts:d("MAWBulkWriteReceiptsApi").bulkWriteReceipts,clearSignalAndTempStores:d("MAWClearSignalAndTempStores").clearSignalAndTempStores,createGroup:d("MAWCreateGroupApi").createGroup,createGroups:d("MAWCreateGroupApi").createGroups,deleteExpiredMsgs:d("MAWDeleteExpiredMsgsApi").deleteExpiredMsgs,deleteGroups:d("MAWDeleteGroupsApi").deleteGroups,demoteGroupParticipants:d("MAWChangeAdminStatusApi").demoteGroupParticipants,flushCacheToDb:d("MAWFlushCacheToDbApi").flushCacheToDb,getAbProps:d("MAWGetAbPropsApi").getAbProps,getAppData:d("MAWGetAppDataApi").getAppData,getAppDataForResend:d("MAWGetAppDataForResendApi").getAppDataForResend,getAppDataForRetry:d("MAWGetAppDataForRetryApi").getAppDataForRetry,getClockSkew:d("MAWGetClockSkewApi").getClockSkew,getContactAndIdentitiesForUser:d("MAWGetContactAndIdentitiesApi").getContactAndIdentitiesForUser,getCurrentUserDeviceInfo:d("MAWGetCurrentUserDeviceInfo").getCurrentUserDeviceInfo,getGroupParticipantDevices:d("MAWGetGroupParticipantDevicesApi").getGroupParticipantDevices,getGroupSubjectByJid:d("MAWGetGroupSubjectByJidApi").getGroupSubjectByJid,getIdentityKeys:d("MAWGetIdentityKeys").getIdentityKeys,getInviterByGroupJid:d("MAWGetInviterByGroupJidApi").getInviterByGroupJid,getKnownDHashes:d("MAWGetKnownDHashesApi").getKnownDHashes,getLastMsgsInChatForSpamReport:d("MAWGetLastMsgsInChatForSpamReportApi").getLastMsgsInChatForSpamReport,getMediaByObjectId:d("MAWGetMediaByObjectId").getMediaByObjectId,getMediaKnownEntries:d("MAWGetMediaKnownEntriesApi").getMediaKnownEntries,getMediaPlaintext:d("MAWGetMediaPlaintextApi").getMediaPlaintext,getMediaMsgForRedownload:function(){return b("Promise").resolve(d("WAResultOrError").makeError("message-not-found"))},getMediaIfAuthorized:d("MAWGetMediaIfAuthorizedApi").getMediaIfAuthorized,getMsgForRequestReuploadMedia:d("MAWGetMsgForRequestReuploadMediaApi").getMsgForRequestReuploadMedia,getMsgForRetry:d("MAWGetMsgForRetryApi").getMsgForRetry,getMsgForSending:d("MAWGetMsgForSendingApi").getMsgForSending,getNextExpirationTs:d("MAWGetNextExpirationTsApi").getNextExpirationTs,getNextDeletionTs:d("MAWGetNextDeletionTsApi").getNextDeletionTs,getMyDevices:d("MAWGetMyDevicesApi").getMyDevices,getPrimaryPlatform:function(){return void 0},getReactionForSending:d("MAWGetReactionForSending").getReactionForSending,getRoutingInfo:d("MAWGetRoutingInfoApi").getRoutingInfo,getSenderKeyStatus:d("MAWGetSenderKeyStatusApi").getSenderKeyStatus,getSyncAction:d("MAWGetSyncActionApi").getSyncAction,getSyncActionsByCollections:d("MAWGetSyncActionsByCollectionsApi").getSyncActionsByCollections,getSyncActionsByIndexMac:d("MAWGetSyncActionsByIndexMacApi").getSyncActionsByIndexMac,getSyncActiveKey:d("MAWGetSyncActiveKeyApi").getSyncActiveKey,getSyncCollectionLtHash:d("MAWGetSyncCollectionLtHashApi").getSyncCollectionLtHash,getSyncCollectionVersion:d("MAWGetSyncCollectionVersionApi").getSyncCollectionVersion,getSyncCollectionVersionAndMutations:d("MAWGetSyncCollectionVersionAndMutationsApi").getSyncCollectionVersionAndMutations,getSyncCollectionsWithMutationsAndHash:d("MAWGetSyncCollectionsWithMutationsAndHashApi").getSyncCollectionsWithMutationsAndHash,getSyncKeyData:d("MAWGetSyncKeyDataApi").getSyncKeyData,getTaskScheduledTime:d("MAWTaskScheduleApi").getTaskScheduledTime,getThreadInfoForDeletion:d("MAWGetThreadInfoForDeletionApi").getThreadInfoForDeletion,getThreadIdByJid:d("MAWGetThreadsInfoApi").getThreadIdByJid,getThreadJidByChatId:d("MAWGetThreadsInfoApi").getThreadJidByChatId,getAllThreadsAsJson:d("MAWGetAllThreadsAsJsonApi").getAllThreadsAsJson,getProtocolMsgIdByMediaMsgId:d("MAWGetProtocolMsgIdByMediaMsgId").getProtocolMsgIdByMediaMsgId,getProtocolMsgIdByMsgId:d("MAWGetProtocolMsgIdByMsgId").getProtocolMsgIdByMsgId,getMsgIdByProtocolMsgId:d("MAWGetMsgIdByProtocolMsgId").getMsgIdByProtocolMsgId,getNextDeleteDFMContentTs:d("MAWGetNextDeleteDFMContentTs").getNextDeleteDFMContentTs,getNextDeletePendingStanzaTs:d("MAWGetNextDeletePendingStanzaTs").getNextDeletePendingStanzaTs,getNextDeleteUnsendContentTs:d("MAWGetNextDeleteUnsendContentTs").getNextDeleteUnsendContentTs,getNextExpiredXMATs:d("MAWGetNextExpiredXMATs").getNextExpiredXMATs,getSyncResponseBackoffInfoByJid:d("MAWGetSyncResponseBackoffInfoByJidApi").getSyncResponseBackoffInfoByJid,getUnreadMsgs:d("MAWGetUnreadMsgsApi").getUnreadMsgs,handleConnectedAdminMsg:d("MAWHandleConnectedAdminMsgApi").handleConnectedAdminMsg,handleEchoMsgsRestore:d("MAWHandleEchoMsgsRestoreApi").handleEchoMsgsRestore,handleEchoThreadsRestore:d("MAWHandleEchoThreadsRestoreApi").handleEchoThreadsRestore,handleEncryptedBackupsSecret:d("MAWHandleEncryptedBackupsSecretsApi").handleEncryptedBackupsSecret,bulkHandleIncomingMsgs:d("MAWBulkHandleIncomingMsgApi").bulkHandleIncomingMsgs,writeCdnUrlAndBakeDownloadPayload:d("MAWHandleMediaDownloadAndRestoreApi").writeCdnUrlAndBakeDownloadPayload,handleMediaDownload:d("MAWHandleMediaDownloadApi").handleMediaDownload,handleReachabilityErrorAdminMsg:d("MAWHandleReachabilityErrorAdminMsgApi").handleReachabilityErrorAdminMsg,leaveGroups:d("MAWLeaveGroupsApi").leaveGroups,loadRecentParticipants:d("MAWLoadRecentParticipantsApi").loadRecentParticipants,markAppDataDropped:d("MAWMarkAppDataDroppedApi").markAppDataDropped,markAppDataSendFailed:d("MAWMarkAppDataSendFailedApi").markAppDataSendFailed,markAppDataSent:d("MAWMarkAppDataSentApi").markAppDataSent,markMsgDropped:d("MAWMarkMsgDroppedApi").markMsgDropped,markMsgSendFailed:function(a){var c;return b("regeneratorRuntime").async(function(e){while(1)switch(e.prev=e.next){case 0:e.next=2;return b("regeneratorRuntime").awrap(d("MAWMarkMsgDroppedApi").markMsgDropped(a));case 2:c=e.sent;if(!(c==="dropped")){e.next=7;break}return e.abrupt("return",d("WAResultOrError").makeSuccess());case 7:return e.abrupt("return",d("WAResultOrError").makeError("missing"));case 8:case"end":return e.stop()}},null,this)},markMsgSent:d("MAWMarkMsgSentApi").markMsgSent,markParticipantNeedsKey:d("MAWMarkParticipantNeedsKeyApi").markParticipantNeedsKey,markReadReceiptsSentUpTo:d("MAWMarkReadReceiptsSentUpToApi").markReadReceiptsSentUpTo,markSenderKeyAsSent:d("MAWMarkSenderKeyAsSentApi").markSenderKeyAsSent,markSenderKeyAsRotated:d("MAWMarkSenderKeyAsRotatedApi").markSenderKeyAsRotated,markThreadAsReadUpTo:d("MAWMarkThreadAsReadUpToApi").markThreadAsReadUpTo,processFutureProofMsgs:d("MAWProcessFutureproofMsgApi").processFutureProofMsgs,processSpamMsgs:d("MAWProcessSpamMsgApi").processSpamMsgs,promoteGroupParticipants:d("MAWChangeAdminStatusApi").promoteGroupParticipants,removeExpiredMsgsFromUI:d("MAWRemoveExpiredMsgsFromUIApi").removeExpiredMsgsFromUI,removeExpiredDFMMsgsContent:d("MAWRemoveExpiredDFMMsgsContent").removeExpiredDFMMsgsContent,removeExpiredPendingStanzas:d("MAWRemoveExpiredPendingStanzas").removeExpiredPendingStanzas,removeExpiredUnsendMsgsContent:d("MAWRemoveExpiredUnsendMsgsContent").removeExpiredUnsendMsgsContent,removeGroupParticipants:d("MAWRemoveGroupParticipantsApi").removeGroupParticipants,resetGroupParticipantInfo:d("MAWResetGroupParticipantInfoApi").resetGroupParticipantInfo,setAbProps:d("MAWSetAbPropsApi").setAbProps,setClockSkew:d("MAWSetClockSkewApi").setClockSkew,setDevices:d("MAWSetDevicesApi").setDevices,setRoutingInfo:d("MAWSetRoutingInfoApi").setRoutingInfo,setTaskScheduledTime:d("MAWTaskScheduleApi").setTaskScheduledTime,updateGroupSubject:d("MAWUpdateGroupSubjectApi").updateGroupSubject,updateMediaEntryForMsg:d("MAWUpdateMediaEntryForMsgApi").updateMediaEntryForMsg,updateMediaEntryForOptimisticUpload:d("MAWUpdateMediaEntryForOptimisticUploadApi").updateMediaEntryForOptimisticUpload,updateThreadFolder:d("MAWUpdateThreadFolderApi").updateThreadFolder,updateEphemeralityOnMarkMsgsFromOtherAsRead:d("MAWUpdateEphemeralityOnMarkMsgsFromOtherAsReadApi").updateEphemeralityOnMarkMsgsFromOtherAsRead,updateICDCForUser:d("MAWSetDevicesApi").updateICDCForUser,uploadRetroactiveThreadsAndMessages:d("MAWUploadRetroactiveThreadsAndMessagesApi").uploadRetroactiveThreadsAndMessages,writeAppDataReceipts:d("MAWWriteAppDataReceiptsApi").writeAppDataReceipts,writeAppDataRetry:d("MAWWriteAppDataRetryApi").writeAppDataRetry,writeMetaSyncs:d("MAWWriteMetaSyncsApi").writeMetaSyncs,writeMsgReceipts:d("MAWWriteMsgReceiptsApi").writeMsgReceipts,writeMsgRetry:d("MAWWriteMsgRetryApi").writeMsgRetry,writePeerReceiptsForMsgsNotFromMe:d("MAWWritePeerMsgReceiptsApi").writePeerReceiptsForMsgsNotFromMe,writeOutgoingAppData:d("MAWWriteOutgoingAppDataApi").writeOutgoingAppData,writeOutgoingMsg:d("MAWWriteOutgoingMsgApi").writeOutgoingMsg,writeForwardedMsg:d("MAWWriteForwardedMsgApi").writeForwardedMsg,writeReactionMsg:d("MAWWriteReactionMsgApi").writeReactionMsg,revokeMsgs:d("MAWRevokeMsgsApi").revokeMsgs,writeGroupInvite:d("MAWWriteGroupInviteApi").writeGroupInvite});g.dbCallbacks=a},98);
__d("MAWCommonWorkerActions",["MAWDbDualSendTxns","MAWDbMsgTypeVersionTxns","MAWDexieTable","MAWDualSendMediaUtils","MAWDualSendSimplePermissionsManager.re","MAWIndexedDb","MAWJids","MAWTransactionMode","Promise","SignalDbTypes","WALogger","unrecoverableViolation"],function(a,b,c,d,e,f,g){function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["worker: got db data"]);i=function(){return a};return a}function j(a){return a.meta.bulkGet([d("SignalDbTypes").MetaKeysEnum.fbid,d("SignalDbTypes").MetaKeysEnum.deviceId,d("SignalDbTypes").MetaKeysEnum.cat,d("SignalDbTypes").MetaKeysEnum.regId,d("SignalDbTypes").MetaKeysEnum.identityKeyPair]).then(function(a){var b=a[0],e=a[1],f=a[2],g=a[3];a=a[4];d("WALogger").LOG(i());b=b==null?void 0:b.value.fbid;e=e==null?void 0:e.value.deviceId;f=f==null?void 0:f.value.cat;g=g==null?void 0:g.value.regId;a=a==null?void 0:a.value.identityKeyPair;if(b==null)throw c("unrecoverableViolation")("fbid not set","messenger_e2ee_web");if(e==null)throw c("unrecoverableViolation")("deviceId not set","messenger_e2ee_web");if(f==null)throw c("unrecoverableViolation")("fbCat not set","messenger_e2ee_web");if(g==null||a==null)throw c("unrecoverableViolation")("regInfo not set","messenger_e2ee_web");return{deviceJid:d("MAWJids").toDeviceJid(d("MAWJids").toUserJid(b),e),fbCat:f.encrypted_serialized_cat,regInfo:{regId:g,staticKeyPair:a},userJid:d("MAWJids").toUserJid(b)}})}function a(){return d("MAWIndexedDb").makeMsgrTransactor({meta:d("MAWTransactionMode").READONLY})(j)()}function e(){return d("MAWIndexedDb").makeMsgrTransactor({appMeta:d("MAWTransactionMode").READONLY})(function(a){return d("MAWDbMsgTypeVersionTxns").getHMACKey(a).then(function(a){if(a==null){var b="HMACKey not set";d("WALogger").ERROR(h(),b);throw b}return a})})()}function f(){if(c("MAWDualSendSimplePermissionsManager.re").isDualSendUser())return d("MAWIndexedDb").makeMsgrTransactor({isDualSend:d("MAWTransactionMode").READWRITE})(function(a){return d("MAWDbDualSendTxns").markAsDualSend(a,!0).then(function(a){})})();else return d("MAWIndexedDb").makeMsgrTransactor({isDualSend:d("MAWTransactionMode").READWRITE,chunk:d("MAWTransactionMode").READWRITE,media:d("MAWTransactionMode").READWRITE,messages:d("MAWTransactionMode").READWRITE,participants:d("MAWTransactionMode").READWRITE,receipts:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE})(function(a){return d("MAWDbDualSendTxns").getIsDualSendInstallation(a).then(function(b){if(b!=null&&b.isEnabled)return d("MAWDbDualSendTxns").deleteAllThreadsBecauseUserWasInDualSend(a).then(function(b){return d("MAWDbDualSendTxns").markAsDualSend(a,!1)}).then(function(a){});else return d("MAWDexieTable").dexieResolve()})})()}function k(){var a=["audio","image","video"],e=function(b){return a.map(function(a){return d("MAWDbDualSendTxns").getDualSendMediaRowByFileType(b,a).then(function(b){return{fileType:a,fileExists:!!b}})})},f=function(a){return b("Promise").all(a.filter(function(a){a=a.fileExists;return!a}).map(function(a){var b=a.fileType;return d("MAWDualSendMediaUtils").downloadImageByFileType(b).then(function(a){return{fileType:b,file:a}})}))};if(c("MAWDualSendSimplePermissionsManager.re").isDualSendMediaUser())return d("MAWIndexedDb").makeMsgrTransactor({dualSendMedia:d("MAWTransactionMode").READWRITE})(function(a){return d("MAWDexieTable").dexieAll(e(a))["catch"](function(a){throw a}).then(function(b){f(b).then(function(b){b.map(function(b){var c=b.fileType;b=b.file;return d("MAWDbDualSendTxns").addFileToDualSendMediaTable(a,b,c)})})["catch"](function(a){throw a})["finally"](function(a){})})})();else return d("MAWIndexedDb").makeMsgrTransactor({dualSendMedia:d("MAWTransactionMode").READWRITE})(function(a){return d("MAWDbDualSendTxns").deleteDualSendMediaTable(a)})()}g.loadAllRegistrationMetaInTransaction=a;g.loadHMACKeyInTransaction=e;g.deleteThreadsIfWasPreviouslyInDualSend=f;g.downloadAndAddAllMissingDualSendMedia=k},98);
__d("MAWCommonMainWebWorker",["FBLogger","MAWBackend","MAWBridge","MAWCommonWorkerActions","MAWEncyptionIndexedDb","MAWEncyptionIndexedDbV2","MAWFTS","MAWGating.re","MAWIndexedDb","MAWKeychain","MAWKeychainV2","MAWMailboxUpload","MAWVaultMaterials","MAWWebWorkerLogger","WACrossWorkerPortal","WADevToolsBridge","WALogger","WorkerMessagePort","WorkerSelf","err","gkx","regeneratorRuntime"],function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["worker receive invalid message: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Missing DevTool port. Not able to setup DevTool"]);i=function(){return a};return a}d("MAWWebWorkerLogger").setupWebWorkerWaLogger();e=function(a){babelHelpers.inheritsLoose(b,a);function b(b,c){var e;e=a.call(this,b,c)||this;e.onmessage=null;d("WorkerSelf").init(babelHelpers.assertThisInitialized(e));e.$BridgeAdaptor1=b;e.onUnhandledMessage.add(function(a){e.onmessage&&e.onmessage({data:a})});return e}var c=b.prototype;c.getBridgePort=function(){return this};return b}(d("WorkerMessagePort").WorkerSyncedMessagePort);function j(a,e,f,g,h,j){var k,l,m,n,o;return b("regeneratorRuntime").async(function(p){while(1)switch(p.prev=p.next){case 0:if(!c("gkx")("334")){p.next=7;break}p.next=3;return b("regeneratorRuntime").awrap(d("MAWEncyptionIndexedDbV2").makeEncryptionDB(a));case 3:p.next=5;return b("regeneratorRuntime").awrap(d("MAWKeychainV2").fetchEARKeyChainForWorker(e));case 5:p.next=11;break;case 7:p.next=9;return b("regeneratorRuntime").awrap(d("MAWEncyptionIndexedDb").makeEncryptionDB(a));case 9:p.next=11;return b("regeneratorRuntime").awrap(d("MAWKeychain").fetchEARKeyChainForWorker(e));case 11:d("MAWIndexedDb").makeDB(a,c("gkx")("334")?d("MAWKeychainV2").getDbEncryptionKey:d("MAWKeychain").getDbEncryptionKey);k=d("MAWBridge").getBridge();p.next=15;return b("regeneratorRuntime").awrap(d("MAWCommonWorkerActions").loadAllRegistrationMetaInTransaction());case 15:l=p.sent;p.next=18;return b("regeneratorRuntime").awrap(d("MAWCommonWorkerActions").loadHMACKeyInTransaction());case 18:m=p.sent;p.prev=19;p.next=22;return b("regeneratorRuntime").awrap(d("MAWCommonWorkerActions").downloadAndAddAllMissingDualSendMedia());case 22:p.next=27;break;case 24:p.prev=24,p.t0=p["catch"](19),c("FBLogger")("messenger_web_product").catching(p.t0).mustfix("Failed to add/delete dual send media");case 27:p.prev=27;p.next=30;return b("regeneratorRuntime").awrap(d("MAWCommonWorkerActions").deleteThreadsIfWasPreviouslyInDualSend());case 30:p.next=35;break;case 32:p.prev=32,p.t1=p["catch"](27),c("FBLogger")("messenger_web_product").catching(p.t1).mustfix("Failed to delete dual send messages");case 35:n=d("WACrossWorkerPortal").attachPortal(k,["event","threadEvent"],function(a,b){var c=a.length>0?a[a.length-1]:null;c!=null&&c.type==="request"&&c.content.name==="uiUpdate"&&c.content.arg.events&&b.type==="request"&&b.content.name==="uiUpdate"?Array.prototype.push.apply(c.content.arg.events,b.content.arg.events):a.push(b);return a}),d("MAWBackend").startWABackend(l,m,k,g(l.regInfo),h),n.setPort(f),c("gkx")("5147")&&(j==null?d("WALogger").ERROR(i()):(o=d("WACrossWorkerPortal").attachPortal(d("WADevToolsBridge").getDevToolBridge(),["devtool"],function(a,b){a.push(b);return a}),o.setPort(j)));case 39:case"end":return p.stop()}},null,this,[[19,24],[27,32]])}function a(a,e,f){a.addMessageListener("worker-setup",function(g){var i,k;return b("regeneratorRuntime").async(function(l){while(1)switch(l.prev=l.next){case 0:if(!(g!=null&&g.type!=="worker-setup")){l.next=3;break}d("WALogger").WARN(h(),g);return l.abrupt("return");case 3:l.prev=3;l.next=6;return b("regeneratorRuntime").awrap(j(g.content.fbId,g.content.latestKeyVersionForEAR,a.getBridgePort(),e,f,g.content.devToolMessageChannelPort2));case 6:i=null;k=null;if(!d("MAWGating.re").isVaultingEnabled()){l.next=20;break}if(!c("gkx")("3174")){l.next=15;break}k=g.content.vaultMaterialsPersistedLSDB;if(!(k==null)){l.next=13;break}throw c("err")("Vault materials was null in persisted LSDB setup");case 13:l.next=19;break;case 15:k=d("MAWVaultMaterials").hasVaultBeenSetup()?d("MAWVaultMaterials").getVaultMaterials():d("MAWVaultMaterials").createVaultMaterials();if(!(k==null||k.encryptionKey==null||k.prefixAndSuffix==null)){l.next=18;break}throw c("err")("Vault materials was null in worker setup");case 18:i=d("MAWVaultMaterials").fromMaterialsToString(k);case 19:d("MAWVaultMaterials").hasVaultBeenSetup()||d("MAWVaultMaterials").setVaultMaterialsForWorkerScope(k);case 20:d("MAWFTS").initFTSSync();d("MAWMailboxUpload").initMailboxUpload();a.postMessage({type:"worker-setup",status:"success",vaultMaterials:i});l.next=29;break;case 25:l.prev=25;l.t0=l["catch"](3);a.postMessage({type:"worker-setup",status:"failure",vaultMaterials:null,msg:l.t0.message});throw c("err")(l.t0);case 29:case"end":return l.stop()}},null,this,[[3,25]])})}g.BridgeAdaptor=e;g.initWorker=a},98);